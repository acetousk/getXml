<!--Transition Screen Location component://SimpleScreens/screen/SimpleScreens/Accounting/OrgSettings/FinAcctTypes.xml Transition Name getGlAccountListPaginated--><transition name="getGlAccountListPaginated"><parameter name="partyId" required="true"/><parameter name="organizationPartyId"/><parameter name="invoiceId"/><parameter name="onlyPostingAllowed"/><parameter name="pageIndex"/><parameter name="pageSize"/><parameter name="term"/><actions><!--always-actions at component://webroot/screen/webroot.xml--><set field="html_scripts" from="new LinkedHashSet()"/><set field="footer_scripts" from="new LinkedHashSet()"/><set field="html_stylesheets" from="new LinkedHashSet()"/><!--always-actions at component://PopCommerce/screen/PopCommerceAdmin.xml--><set field="appRoot" value="PopcAdmin"/><set field="searchIndexName" value="mantle"/><set field="searchLinkSets" value="PopcAdmin"/><set field="searchProductDocType" value="MantleProduct"/><set field="searchPartyDocType" value="MantleParty"/><set field="appUserGroupTypeEnumId" value="UgtPopcAdmin"/><service-call name="mantle.party.PartyServices.setup#UserOrganizationInfo" out-map="context"/><!--transition actions--><set field="glAccountCodeMask" from="ec.user.getPreference('GlAccountCodeMask')"/><set field="accountCodeFormatter" from="masker(glAccountCodeMask, '0')"/><set field="pageIndex" from="pageIndex ?: 0"/><set field="pageSize" from="pageSize ?: 20"/><set field="term" from="term ?: ''"/><if condition="invoiceId && !term"><entity-find-one entity-name="mantle.account.invoice.Invoice" value-field="invoice"/><entity-find-count entity-name="mantle.party.PartyRole" count-field="fromOrgInternalCount"><econdition field-name="partyId" from="invoice.fromPartyId"/><econdition field-name="roleTypeId" value="OrgInternal"/></entity-find-count><set field="isFromOrgInternal" from="fromOrgInternalCount > 0"/><entity-find entity-name="mantle.account.invoice.InvoiceItemSummary" list="itemSummaryList" limit="20"><econdition field-name="fromPartyId" from="invoice.fromPartyId" ignore="isFromOrgInternal"/><econdition field-name="toPartyId" from="invoice.toPartyId" ignore="!isFromOrgInternal"/><econdition field-name="overrideGlAccountId" operator="is-not-null"/><select-field field-name="overrideGlAccountId,quantityTotal"/><order-by field-name="-quantityTotal,overrideGlAccountId"/></entity-find><if condition="itemSummaryList"><set field="outList" from="[]"/><iterate list="itemSummaryList" entry="itemSummary"><entity-find-one entity-name="mantle.ledger.account.GlAccount" value-field="glAccount" cache="true"><field-map field-name="glAccountId" from="itemSummary.overrideGlAccountId"/></entity-find-one><script><![CDATA[outList.add([value:glAccount.glAccountId, label:ec.resource.expand('GlAccountNameTemplate','',glAccount.getMap())])]]></script></iterate><script><![CDATA[ec.web.sendJsonResponse([options:outList])]]></script><return/></if></if><entity-find-one entity-name="mantle.ledger.account.GlAccount" value-field="glAccount" cache="true"><field-map field-name="glAccountId" from="term"/></entity-find-one><if condition="glAccount"><then><set field="glaList" from="[glAccount]"/></then><else><entity-find entity-name="mantle.ledger.account.GlAccountAndOrganization" list="glaList" cache="false"><search-form-inputs default-order-by="accountCode" skip-fields="disallowPosting"/><econdition field-name="disallowPosting" value="N" or-null="true" ignore="onlyPostingAllowed != 'true'"/><econditions combine="or"><econdition field-name="glAccountId" operator="like" value="%${term}%" ignore-case="true"/><econdition field-name="accountCode" operator="like" value="%${term}%" ignore-case="true"/><econdition field-name="accountName" operator="like" value="%${term}%" ignore-case="true"/></econditions><select-field field-name="glAccountId,accountCode,accountName"/><order-by field-name="accountCode"/></entity-find></else></if><script><![CDATA[def outList = []
                for (gla in glaList) {
                    Map glaMap = gla.getMap()
                    // GlAccountNameTemplate uses accountCodeFormatter if present so no need for explicit mask
                    outList.add([value:gla.glAccountId, label:ec.resource.expand('GlAccountNameTemplate','',glaMap)])
                }
                ec.web.sendJsonResponse([options:outList, pageSize:pageSize, count:(glaListCount?:glaList.size())])]]></script></actions></transition>