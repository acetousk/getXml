<!--Transition Screen Location component://coarchy/screen/coarchy-com/c/Login.xml Transition Name login--><transition name="login"><parameter name="username" required="true"/><parameter name="password" required="true"/><parameter name="code"/><parameter name="templateOrgId"/><parameter name="organizationName"/><actions><!--always-actions at component://webroot/screen/webroot.xml--><set field="html_scripts" from="new LinkedHashSet()"/><set field="footer_scripts" from="new LinkedHashSet()"/><set field="html_stylesheets" from="new LinkedHashSet()"/><!--transition actions--><set field="loggedIn" from="ec.user.loginUser(username, password)"/><if condition="ec.message.hasError()"><script><![CDATA[ec.web.sendJsonResponse([loggedIn:false])]]></script></if><if condition="ec.web.sessionAttributes.moquiAuthcFactorRequired"><then><if condition="code"><then><service-call name="org.moqui.impl.UserServices.validate#ExternalUserAuthcCode" in-map="[code:code]" out-map="validateOut"/><if condition="validateOut.verified"><then><script><![CDATA[ec.user.internalLoginUser(validateOut.username)]]></script><return/></then><else><message type="danger" public="true"><![CDATA[Authentication code is not valid]]></message></else></if></then></if><service-call name="org.moqui.impl.UserServices.get#ExternalUserAuthcFactorInfo" out-map="factorInfoOut"/><script><![CDATA[ec.web.sendJsonResponse(factorInfoOut)]]></script></then><else><script><![CDATA[ec.web.sendJsonResponse([loggedIn:loggedIn])]]></script></else></if><if condition="loggedIn"><entity-find-count entity-name="mantle.party.PartyClassificationAppl" count-field="partyClassificationCount"><econdition field-name="partyId" from="ec.user.userAccount.partyId"/></entity-find-count><entity-find entity-name="mantle.party.PartyClassificationAppl" list="partyClassificationList"><econdition field-name="partyId" from="ec.user.userAccount.partyId"/><econdition field-name="partyClassificationId" operator="in" from="['ColdLead','Prospect']"/><date-filter/></entity-find><if condition="partyClassificationList.size() > 0 || (partyClassificationCount == 0 && partyClassificationList.size() == 0)"><service-call name="coarchy.CoarchyServices.set#PartyClassification" in-map="[partyClassificationId:'HotLead']" out-map="context"/></if><if condition="templateOrgId?.length()"><entity-find-one entity-name="mantle.party.Party" value-field="templateOrg"><field-map field-name="partyId" from="templateOrgId"/></entity-find-one><if condition="!templateOrg || (templateOrg.visibilityEnumId!='PvPublic')"><return error="true" message="Invalid template"/></if><if condition="!organizationName.strip()"><return error="true" message="Please specify an organization name"/></if><service-call name="coarchy.CoarchyServices.create#Organization" in-map="[organizationId:templateOrgId,organizationName:organizationName,copyProducts:'copy']" disable-authz="true"/></if></if></actions></transition>