<!--Service Location mantle.work.TimeServices.store#TimeEntry--><service verb="store" noun="TimeEntry"><in-parameters><parameter name="timeEntryId" entity-name="mantle.work.time.TimeEntry" field-name="timeEntryId"><description><![CDATA[If specified updates the record, if not creates a new one]]></description></parameter><parameter name="parentEntryId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.work.time.TimeEntry" field-name="parentEntryId"/><parameter name="timesheetId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.work.time.TimeEntry" field-name="timesheetId"/><parameter name="partyId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.work.time.TimeEntry" field-name="partyId" default="(!timeEntryId && !partyId)?ec.user.userAccount.partyId:null"/><parameter name="teamPartyId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.work.time.TimeEntry" field-name="teamPartyId"/><parameter name="vendorPartyId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.work.time.TimeEntry" field-name="vendorPartyId"/><parameter name="clientPartyId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.work.time.TimeEntry" field-name="clientPartyId"/><parameter name="rateTypeEnumId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.work.time.TimeEntry" field-name="rateTypeEnumId" default-value="RatpStandard"/><parameter name="rateModifierEnumId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.work.time.TimeEntry" field-name="rateModifierEnumId"/><parameter name="workTypeEnumId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.work.time.TimeEntry" field-name="workTypeEnumId"/><parameter name="emplPositionClassId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.work.time.TimeEntry" field-name="emplPositionClassId"/><parameter name="hasModifiedRates" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.work.time.TimeEntry" field-name="hasModifiedRates"/><parameter name="rateAmountId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.work.time.TimeEntry" field-name="rateAmountId"/><parameter name="clientHourRate" type="java.math.BigDecimal" required="false" allow-html="none" entity-name="mantle.work.time.TimeEntry" field-name="clientHourRate"/><parameter name="vendorRateAmountId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.work.time.TimeEntry" field-name="vendorRateAmountId"/><parameter name="vendorHourRate" type="java.math.BigDecimal" required="false" allow-html="none" entity-name="mantle.work.time.TimeEntry" field-name="vendorHourRate"/><parameter name="fromDate" type="java.sql.Timestamp" required="false" allow-html="none" entity-name="mantle.work.time.TimeEntry" field-name="fromDate"/><parameter name="thruDate" type="java.sql.Timestamp" required="false" allow-html="none" entity-name="mantle.work.time.TimeEntry" field-name="thruDate"/><parameter name="hours" type="java.math.BigDecimal" required="false" allow-html="none" entity-name="mantle.work.time.TimeEntry" field-name="hours"/><parameter name="breakHours" type="java.math.BigDecimal" required="false" allow-html="none" entity-name="mantle.work.time.TimeEntry" field-name="breakHours"/><parameter name="pieceCount" type="java.math.BigDecimal" required="false" allow-html="none" entity-name="mantle.work.time.TimeEntry" field-name="pieceCount"/><parameter name="pieceRateTypeEnumId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.work.time.TimeEntry" field-name="pieceRateTypeEnumId"/><parameter name="pieceRateAmountId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.work.time.TimeEntry" field-name="pieceRateAmountId"/><parameter name="clientPieceRate" type="java.math.BigDecimal" required="false" allow-html="none" entity-name="mantle.work.time.TimeEntry" field-name="clientPieceRate"/><parameter name="vendorPieceRateAmountId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.work.time.TimeEntry" field-name="vendorPieceRateAmountId"/><parameter name="vendorPieceRate" type="java.math.BigDecimal" required="false" allow-html="none" entity-name="mantle.work.time.TimeEntry" field-name="vendorPieceRate"/><parameter name="comments" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.work.time.TimeEntry" field-name="comments"/><parameter name="facilityId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.work.time.TimeEntry" field-name="facilityId"/><parameter name="workEffortId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.work.time.TimeEntry" field-name="workEffortId"/><parameter name="invoiceId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.work.time.TimeEntry" field-name="invoiceId"/><parameter name="invoiceItemSeqId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.work.time.TimeEntry" field-name="invoiceItemSeqId"/><parameter name="vendorInvoiceId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.work.time.TimeEntry" field-name="vendorInvoiceId"/><parameter name="vendorInvoiceItemSeqId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.work.time.TimeEntry" field-name="vendorInvoiceItemSeqId"/><parameter name="lastUpdatedStamp" type="java.sql.Timestamp" required="false" allow-html="none" entity-name="mantle.work.time.TimeEntry" field-name="lastUpdatedStamp"/><parameter name="vendorHourRateIncrement" type="BigDecimal"/><parameter name="vendorPieceRateIncrement" type="BigDecimal"/><parameter name="clientHourRateIncrement" type="BigDecimal"/><parameter name="clientPieceRateIncrement" type="BigDecimal"/><parameter name="remainingWorkTime" type="BigDecimal"/></in-parameters><out-parameters><parameter name="timeEntryId" entity-name="mantle.work.time.TimeEntry" field-name="timeEntryId"/></out-parameters><actions><if condition="partyId"><entity-find-one entity-name="mantle.party.Party" value-field="party"/><if condition="party.disabled == 'Y'"><return error="true" message="Time Entry not created, ${party.pseudoId} is not active."/></if></if><set field="entryHasHours" from="false"/><if condition="timeEntryId"><entity-find-one entity-name="mantle.work.time.TimeEntry" value-field="timeEntry" for-update="true"/><if condition="timeEntry != null"><set field="entryHasHours" from="timeEntry.hours != null && timeEntry.hours != 0.0"/><iterate list="timeEntry" entry="fieldValue" key="fieldName"><if condition="fieldValue != null && !context.containsKey(fieldName)"><script><![CDATA[context.put(fieldName, fieldValue)]]></script></if></iterate></if></if><if condition="teamPartyId"><entity-find-one entity-name="mantle.party.PartyDetailAndRole" value-field="teamPartyDetail"><field-map field-name="partyId" from="teamPartyId"/><field-map field-name="roleTypeId" value="OrgTeam"/></entity-find-one><if condition="teamPartyDetail == null"><then><return error="true" message="Team ${teamPartyId} not found or is not in the Team role"/></then><else-if condition="teamPartyDetail.disabled == 'Y'"><return error="true" message="Team ${ec.resource.expand('PartyNameTemplate', '', teamPartyDetail)} is disabled."/></else-if></if></if><if condition="hours && fromDate && !thruDate"><set field="thruDate" from="new Timestamp((Long) (fromDate.time + (hours*60*60*1000) + (breakHours ? (breakHours*60*60*1000) : 0)))"/></if><if condition="thruDate == null"><set field="thruDate" from="ec.user.nowTimestamp"/></if><if condition="hours && !fromDate && thruDate"><set field="fromDate" from="new Timestamp((Long) (thruDate.time - (hours*60*60*1000) - (breakHours ? (breakHours*60*60*1000) : 0)))"/></if><if condition="fromDate && thruDate && fromDate > thruDate"><return error="true" message="From date ${fromDate} is after thru date ${thruDate}"/></if><if condition="hours == null && fromDate && thruDate"><set field="hours" from="((thruDate.time - fromDate.time)/(60*60*1000)) - (breakHours ?: 0)"/></if><if condition="workEffortId"><entity-find-one entity-name="mantle.work.effort.WorkEffort" value-field="taskWorkEffort"><field-map field-name="workEffortId"/></entity-find-one></if><if condition="!emplPositionClassId && taskWorkEffort != null"><entity-find entity-name="mantle.work.effort.WorkEffortParty" list="taskWorkEffortPartyList"><date-filter valid-date="fromDate"/><econdition field-name="partyId"/><econdition field-name="workEffortId"/><order-by field-name="fromDate"/></entity-find><iterate list="taskWorkEffortPartyList" entry="taskWorkEffortParty"><if condition="taskWorkEffortParty.emplPositionClassId"><set field="emplPositionClassId" from="taskWorkEffortParty.emplPositionClassId"/></if></iterate><if condition="!emplPositionClassId"><entity-find entity-name="mantle.work.effort.WorkEffortParty" list="projectWorkEffortPartyList"><date-filter valid-date="fromDate"/><econdition field-name="partyId"/><econdition field-name="workEffortId" from="taskWorkEffort.rootWorkEffortId"/><order-by field-name="fromDate"/></entity-find><iterate list="projectWorkEffortPartyList" entry="projectWorkEffortParty"><if condition="projectWorkEffortParty.emplPositionClassId"><set field="emplPositionClassId" from="projectWorkEffortParty.emplPositionClassId"/></if></iterate></if></if><if condition="!emplPositionClassId"><entity-find entity-name="mantle.party.PartyRelationship" list="employRelList"><date-filter valid-date="fromDate"/><econdition field-name="fromPartyId" from="partyId"/><econdition field-name="toPartyId" from="partyId"/><econdition field-name="relationshipTypeEnumId" value="PrtEmployee"/></entity-find><if condition="employRelList"><entity-find-one entity-name="mantle.humanres.employment.Employment" value-field="employment"><field-map field-name="partyRelationshipId" from="employRelList[0].partyRelationshipId"/></entity-find-one><if condition="employment"><set field="emplPosition" from="employment.'mantle.humanres.position.EmplPosition'"/><set field="emplPositionClassId" from="emplPosition?.emplPositionClassId"/></if></if></if><if condition="!workTypeEnumId && taskWorkEffort != null"><entity-find entity-name="mantle.work.effort.WorkEffortParty" list="taskWorkEffortPartyList"><date-filter valid-date="fromDate"/><econdition field-name="partyId"/><econdition field-name="workEffortId"/><order-by field-name="fromDate"/></entity-find><iterate list="taskWorkEffortPartyList" entry="taskWorkEffortParty"><if condition="taskWorkEffortParty.workTypeEnumId"><set field="workTypeEnumId" from="taskWorkEffortParty.workTypeEnumId"/></if></iterate><if condition="!workTypeEnumId"><entity-find entity-name="mantle.work.effort.WorkEffortParty" list="projectWorkEffortPartyList"><date-filter valid-date="fromDate"/><econdition field-name="partyId"/><econdition field-name="workEffortId" from="taskWorkEffort.rootWorkEffortId"/><order-by field-name="fromDate"/></entity-find><iterate list="projectWorkEffortPartyList" entry="projectWorkEffortParty"><if condition="projectWorkEffortParty.workTypeEnumId"><set field="workTypeEnumId" from="projectWorkEffortParty.workTypeEnumId"/></if></iterate></if></if><if condition="!clientPartyId && timesheetId"><entity-find-one entity-name="mantle.work.time.Timesheet" value-field="timesheet"/><set field="clientPartyId" from="timesheet.clientPartyId"/></if><if condition="!clientPartyId && workEffortId"><entity-find entity-name="mantle.work.effort.WorkEffortParty" list="billToList"><date-filter valid-date="fromDate"/><econdition field-name="workEffortId"/><econdition field-name="roleTypeId" operator="in" value="Customer,CustomerBillTo"/></entity-find><if condition="billToList"><then><set field="clientPartyId" from="billToList[0].partyId"/></then><else><entity-find-one entity-name="mantle.work.effort.WorkEffort" value-field="workEffort"/><if condition="workEffort?.rootWorkEffortId"><entity-find entity-name="mantle.work.effort.WorkEffortParty" list="rootBillToList"><date-filter valid-date="fromDate"/><econdition field-name="workEffortId" from="workEffort.rootWorkEffortId"/><econdition field-name="roleTypeId" operator="in" value="Customer,CustomerBillTo"/></entity-find><if condition="rootBillToList"><set field="clientPartyId" from="rootBillToList[0].partyId"/></if></if></else></if></if><if condition="!clientPartyId && facilityId"><entity-find entity-name="mantle.facility.FacilityParty" list="customerList"><date-filter valid-date="fromDate"/><econdition field-name="facilityId"/><econdition field-name="roleTypeId" operator="in" value="Customer,CustomerBillTo"/></entity-find><if condition="customerList"><then><set field="clientPartyId" from="customerList[0].partyId"/></then><else><entity-find-one entity-name="mantle.facility.Facility" value-field="facility"/><set field="clientPartyId" from="facility?.ownerPartyId"/></else></if></if><if condition="!vendorPartyId && workEffortId"><entity-find entity-name="mantle.work.effort.WorkEffortParty" list="billFromList"><date-filter valid-date="fromDate"/><econdition field-name="workEffortId"/><econdition field-name="roleTypeId" operator="in" value="Vendor,VendorBillFrom"/></entity-find><if condition="billFromList"><then><set field="vendorPartyId" from="billFromList[0].partyId"/></then><else><entity-find-one entity-name="mantle.work.effort.WorkEffort" value-field="workEffort"/><if condition="workEffort?.rootWorkEffortId"><entity-find entity-name="mantle.work.effort.WorkEffortParty" list="rootBillFromList"><date-filter valid-date="fromDate"/><econdition field-name="workEffortId" from="workEffort.rootWorkEffortId"/><econdition field-name="roleTypeId" operator="in" value="Vendor,VendorBillFrom"/></entity-find><if condition="rootBillFromList"><set field="vendorPartyId" from="rootBillFromList[0].partyId"/></if></if></else></if></if><if condition="!vendorPartyId && facilityId"><entity-find entity-name="mantle.facility.FacilityParty" list="vendorList"><date-filter valid-date="fromDate"/><econdition field-name="facilityId"/><econdition field-name="roleTypeId" operator="in" value="Manager,Vendor,VendorBillFrom"/></entity-find><if condition="vendorList"><then><set field="vendorPartyId" from="vendorList[0].partyId"/></then><else><entity-find-one entity-name="mantle.facility.Facility" value-field="facility"/><set field="clientPartyId" from="facility?.ownerPartyId"/></else></if></if><set field="hasModifiedRates" value="N"/><if condition="ec.user.hasPermission('TIME_ENTRY_RATE')"><then><if condition="(clientHourRate && (timeEntry?.hasModifiedRates || clientHourRate != timeEntry?.clientHourRate)) ||                         (vendorHourRate && (timeEntry?.hasModifiedRates || vendorHourRate != timeEntry?.vendorHourRate)) ||                         (clientPieceRate && (timeEntry?.hasModifiedRates || clientPieceRate != timeEntry?.clientPieceRate)) ||                         (vendorPieceRate && (timeEntry?.hasModifiedRates || vendorPieceRate != timeEntry?.vendorPieceRate))"><set field="hasModifiedRates" value="Y"/></if></then><else><set field="clientHourRate" from="null"/><set field="vendorHourRate" from="null"/><set field="clientPieceRate" from="null"/><set field="vendorPieceRate" from="null"/><set field="hasModifiedRates" value="N"/></else></if><service-call name="store#mantle.work.time.TimeEntry" out-map="[timeEntryId:context.timeEntryId,parentEntryId:context.parentEntryId,timesheetId:context.timesheetId,partyId:context.partyId,teamPartyId:context.teamPartyId,vendorPartyId:context.vendorPartyId,clientPartyId:context.clientPartyId,rateTypeEnumId:context.rateTypeEnumId,rateModifierEnumId:context.rateModifierEnumId,workTypeEnumId:context.workTypeEnumId,emplPositionClassId:context.emplPositionClassId,hasModifiedRates:context.hasModifiedRates,rateAmountId:context.rateAmountId,clientHourRate:context.clientHourRate,vendorRateAmountId:context.vendorRateAmountId,vendorHourRate:context.vendorHourRate,fromDate:context.fromDate,thruDate:context.thruDate,hours:context.hours,breakHours:context.breakHours,pieceCount:context.pieceCount,pieceRateTypeEnumId:context.pieceRateTypeEnumId,pieceRateAmountId:context.pieceRateAmountId,clientPieceRate:context.clientPieceRate,vendorPieceRateAmountId:context.vendorPieceRateAmountId,vendorPieceRate:context.vendorPieceRate,comments:context.comments,facilityId:context.facilityId,workEffortId:context.workEffortId,invoiceId:context.invoiceId,invoiceItemSeqId:context.invoiceItemSeqId,vendorInvoiceId:context.vendorInvoiceId,vendorInvoiceItemSeqId:context.vendorInvoiceItemSeqId,lastUpdatedStamp:context.lastUpdatedStamp]" in-map="context"/><service-call name="mantle.work.TimeServices.get#TimeEntryRate" out-map="[rateAmountId:context.rateAmountId,rateAmount:context.rateAmount,vendorRateAmountId:context.vendorRateAmountId,vendorRateAmount:context.vendorRateAmount,pieceRateAmountId:context.pieceRateAmountId,pieceRateAmount:context.pieceRateAmount,vendorPieceRateAmountId:context.vendorPieceRateAmountId,vendorPieceRateAmount:context.vendorPieceRateAmount]" in-map="context"/><if condition="vendorHourRateIncrement || vendorPieceRateIncrement || clientHourRateIncrement || clientPieceRateIncrement"><entity-find-one entity-name="mantle.work.time.TimeEntry" value-field="timeEntry" for-update="true"/><if condition="vendorHourRateIncrement"><set field="timeEntry.vendorHourRate" from="(timeEntry.vendorHourRate?:0.0)+vendorHourRateIncrement"/></if><if condition="vendorPieceRateIncrement"><set field="timeEntry.vendorPieceRate" from="(timeEntry.vendorPieceRate?:0.0)+vendorPieceRateIncrement"/></if><if condition="clientHourRateIncrement"><set field="timeEntry.clientHourRate" from="(timeEntry.clientHourRate?:0.0)+clientHourRateIncrement"/></if><if condition="clientPieceRateIncrement"><set field="timeEntry.clientPieceRate" from="(timeEntry.clientPieceRate?:0.0)+clientPieceRateIncrement"/></if><set field="timeEntry.hasModifiedRates" value="Y"/><entity-update value-field="timeEntry"/></if><if condition="workEffortId"><if condition="remainingWorkTime != null"><then><service-call name="update#mantle.work.effort.WorkEffort" in-map="[workEffortId:workEffortId, remainingWorkTime:remainingWorkTime]"/></then><else-if condition="hours && !entryHasHours"><entity-find-one entity-name="mantle.work.effort.WorkEffort" value-field="task"/><if condition="task?.remainingWorkTime"><set field="task.remainingWorkTime" from="task.remainingWorkTime - hours"/><if condition="task.remainingWorkTime < 0.0"><set field="task.remainingWorkTime" from="0.0"/></if><entity-update value-field="task"/></if></else-if></if></if></actions></service>