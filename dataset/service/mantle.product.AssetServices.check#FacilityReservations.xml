<!--Service Location mantle.product.AssetServices.check#FacilityReservations--><service verb="check" noun="FacilityReservations"><in-parameters><parameter name="facilityId" required="true"/></in-parameters><out-parameters><parameter name="invalidReservationCount" type="Integer"/><parameter name="quantityNotValid" type="BigDecimal"/><parameter name="quantityMoved" type="BigDecimal"/></out-parameters><actions><set field="invalidReservationCount" from="0"/><set field="quantityNotValid" from="0.0"/><set field="quantityMoved" from="0.0"/><entity-find entity-name="mantle.product.issuance.AssetAndReservation" list="assetReservationList"><econdition field-name="facilityId"/><select-field field-name="assetReservationId"/></entity-find><iterate list="assetReservationList" entry="assetReservation"><service-call name="mantle.product.AssetServices.check#AssetReservationValid" out-map="[reservationInvalid:checkValidOut.reservationInvalid,quantityNotValid:checkValidOut.quantityNotValid]" out-map-add-to-existing="false" in-map="[assetReservationId:assetReservation.assetReservationId]"/><if condition="checkValidOut.reservationInvalid"><set field="invalidReservationCount" from="invalidReservationCount + 1"/><set field="quantityNotValid" from="quantityNotValid + (checkValidOut.quantityNotValid ?: 0.0)"/></if></iterate><entity-find entity-name="mantle.product.asset.Asset" list="assetList"><econdition field-name="facilityId"/><econdition field-name="availableToPromiseTotal" operator="greater" from="0.0"/><select-field field-name="assetId"/></entity-find><iterate list="assetList" entry="asset"><service-call name="mantle.product.AssetServices.reserve#IncreasedAsset" out-map="[quantityMoved:reserveOut.quantityMoved]" out-map-add-to-existing="false" in-map="[assetId:asset.assetId]"/><set field="quantityMoved" from="quantityMoved + (reserveOut.quantityMoved ?: 0.0)"/></iterate><if condition="invalidReservationCount"><message><![CDATA[In check facility ${facilityId} reservations found ${invalidReservationCount} invalid reservations with total quantity ${quantityNotValid}]]></message></if><if condition="quantityMoved"><message><![CDATA[In check facility ${facilityId} reservations moved ${quantityMoved} not available reservations to available inventory]]></message></if></actions></service>