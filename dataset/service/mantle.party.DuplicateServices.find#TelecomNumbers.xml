<!--Service Location mantle.party.DuplicateServices.find#TelecomNumbers--><service verb="find" noun="TelecomNumbers"><in-parameters><parameter name="partyId"><description><![CDATA[The Party the ContactMech came from (or is for)]]></description></parameter><parameter name="toPartyId"><description><![CDATA[If specified only looks at this part for matches]]></description></parameter><parameter name="areaCode"/><parameter name="contactNumber" required="true"/><parameter name="contactMechPurposeId"><description><![CDATA[Only used if toPartyId specified to limit match by purpose]]></description></parameter><parameter name="trustLevelEnumId"><description><![CDATA[Only match addresses with this trust level (CmtlGreylisted, CmtlBlacklisted, etc), may be comma separated (no spaces) for multiple]]></description></parameter><parameter name="matchingInfoByPartyId" type="Map"><description><![CDATA[If passed in data will be added to this]]></description></parameter><parameter name="dupTelecomIdsFound" type="Set"><description><![CDATA[If passed in data will be added to this]]></description></parameter></in-parameters><out-parameters><parameter name="telecomNumberList" type="List"><parameter name="telecomNumber" type="Map"/></parameter></out-parameters><actions><script><![CDATA[contactNumber = replaceNonAlphaNumeric(contactNumber, '%' as char)
                // NOTE: the following is USA phone number specific (3 digit area code, 7 digit number with 3/4 separator)
                if (!areaCode && contactNumber.length() > 8) {
                    areaCode = contactNumber.substring(0,3)
                    contactNumber = contactNumber.substring(3)
                    if (contactNumber.charAt(0) == '%') contactNumber = contactNumber.substring(1)
                }
                if (!contactNumber.contains('%') && contactNumber.length() > 3) { contactNumber = contactNumber.substring(0,3) + '%' + contactNumber.substring(3) }
                fullNumber = (areaCode ? areaCode + '%' : '') + contactNumber]]></script><set field="telecomNumberList" from="[]"/><if condition="toPartyId"><then><entity-find entity-name="mantle.party.contact.PartyContactMechTelecomNumber" list="existingList"><date-filter/><econdition field-name="partyId" from="toPartyId"/><econditions combine="or"><econdition field-name="contactNumber" operator="like" from="contactNumber"/><econdition field-name="contactNumber" operator="like" from="fullNumber"/></econditions><econdition field-name="areaCode" from="areaCode" or-null="true" ignore-if-empty="true"/><econdition field-name="contactMechPurposeId" ignore-if-empty="true"/><econdition field-name="trustLevelEnumId" operator="in" ignore-if-empty="true"/></entity-find><script><![CDATA[telecomNumberList.addAll(existingList)]]></script></then><else><entity-find entity-name="mantle.party.contact.ContactMechTelecomNumber" list="dupTelNumList"><econdition field-name="trustLevelEnumId" operator="in" ignore-if-empty="true"/><econditions combine="or"><econdition field-name="contactNumber" operator="like" from="contactNumber"/><econdition field-name="contactNumber" operator="like" from="fullNumber"/></econditions><econdition field-name="areaCode" from="areaCode" or-null="true" ignore-if-empty="true"/><select-field field-name="contactMechId,countryCode,areaCode,contactNumber"/></entity-find><iterate list="dupTelNumList" entry="dupTelNum"><if condition="dupTelecomIdsFound != null && dupTelecomIdsFound.contains(dupTelNum.contactMechId)"><continue/></if><entity-find entity-name="mantle.party.contact.PartyContactMech" list="dupPcmList"><date-filter/><econdition field-name="partyId" operator="not-equals"/><econdition field-name="contactMechId" from="dupTelNum.contactMechId"/></entity-find><if condition="!dupPcmList"><continue/></if><set field="dupPcm" from="dupPcmList[0]"/><if condition="matchingInfoByPartyId == null || !matchingInfoByPartyId.containsKey(dupPcm.partyId)"><entity-find-one entity-name="mantle.party.PartyDetail" value-field="dupPartyDetail"><field-map field-name="partyId" from="dupPcm.partyId"/></entity-find-one><if condition="(firstName && !firstName.equalsIgnoreCase(dupPartyDetail.firstName)) ||                                 (organizationName && !organizationName.equalsIgnoreCase(dupPartyDetail.organizationName))"><continue/></if></if><script><![CDATA[Map dupTelInfo = dupTelNum.getMap()
                        dupTelInfo.put("partyId", dupPcm.partyId)

                        if (matchingInfoByPartyId != null) addToListInMap(dupPcm.partyId, dupTelInfo, matchingInfoByPartyId)
                        if (dupTelecomIdsFound != null) dupTelecomIdsFound.add(dupTelNum.contactMechId)

                        telecomNumberList.add(dupTelInfo)]]></script></iterate></else></if></actions></service>