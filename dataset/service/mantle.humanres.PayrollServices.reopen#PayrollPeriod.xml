<!--Service Location mantle.humanres.PayrollServices.reopen#PayrollPeriod--><service verb="reopen" noun="PayrollPeriod"><in-parameters><parameter name="timePeriodId" required="true"/></in-parameters><out-parameters/><actions><entity-find-one entity-name="mantle.party.time.TimePeriod" value-field="timePeriod" for-update="true"/><if condition="timePeriod.isClosed != 'Y'"><return message="Period ${ec.resource.expand('TimePeriodNameTemplate','',timePeriod)} is not closed"/></if><entity-find-count entity-name="mantle.account.invoice.Invoice" count-field="approvedCount"><econdition field-name="timePeriodId"/><econdition field-name="statusId" operator="in" value="InvoiceApproved,InvoicePmtSent,InvoiceBilledThrough"/></entity-find-count><if condition="approvedCount > 0"><return error="true" message="Found ${approvedCount} invoices in Approved or later status, cannot re-open period"/></if><entity-find entity-name="mantle.humanres.employment.EmploymentPayHistory" list="payHistoryList"><econdition field-name="timePeriodId"/></entity-find><iterate list="payHistoryList" entry="payHistory"><entity-delete-by-condition entity-name="mantle.humanres.employment.EmploymentPayDetail"><econdition field-name="partyRelationshipId" from="payHistory.partyRelationshipId"/><econdition field-name="payDate" from="payHistory.payDate"/></entity-delete-by-condition><entity-delete value-field="payHistory"/></iterate><entity-find entity-name="mantle.account.invoice.Invoice" list="invoiceList"><econdition field-name="timePeriodId"/></entity-find><set field="invoiceCount" from="0"/><iterate list="invoiceList" entry="invoice"><entity-find entity-name="mantle.work.time.TimeEntry" list="timeEntryList"><econdition field-name="invoiceId" from="invoice.invoiceId"/></entity-find><iterate list="timeEntryList" entry="timeEntry"><if condition="timeEntry.hasModifiedRates != 'Y'"><set field="timeEntry.clientHourRate" from="null"/><set field="timeEntry.vendorHourRate" from="null"/><set field="timeEntry.clientPieceRate" from="null"/><set field="timeEntry.vendorPieceRate" from="null"/></if><set field="timeEntry.invoiceId" from="null"/><entity-update value-field="timeEntry"/></iterate><entity-find entity-name="mantle.work.time.TimeEntry" list="vendorTimeEntryList"><econdition field-name="vendorInvoiceId" from="invoice.invoiceId"/></entity-find><iterate list="vendorTimeEntryList" entry="timeEntry"><if condition="timeEntry.hasModifiedRates != 'Y'"><set field="timeEntry.clientHourRate" from="null"/><set field="timeEntry.vendorHourRate" from="null"/><set field="timeEntry.clientPieceRate" from="null"/><set field="timeEntry.vendorPieceRate" from="null"/></if><set field="timeEntry.invoiceId" from="null"/><entity-update value-field="timeEntry"/></iterate><service-call name="mantle.account.InvoiceServices.cancel#Invoice" in-map="[invoiceId:invoice.invoiceId]"/><entity-delete-by-condition entity-name="mantle.account.payment.PaymentApplication"><econdition field-name="invoiceId" from="invoice.invoiceId"/></entity-delete-by-condition><entity-delete-by-condition entity-name="mantle.account.invoice.InvoiceItem"><econdition field-name="invoiceId" from="invoice.invoiceId"/></entity-delete-by-condition><entity-delete-by-condition entity-name="mantle.account.invoice.Invoice"><econdition field-name="invoiceId" from="invoice.invoiceId"/></entity-delete-by-condition><set field="invoiceCount" from="invoiceCount + 1"/></iterate><set field="timePeriod.isClosed" value="N"/><entity-update value-field="timePeriod"/><message><![CDATA[Re-opened period ${ec.resource.expand('TimePeriodNameTemplate','',timePeriod)}, deleted ${invoiceCount} payroll invoices]]></message></actions></service>