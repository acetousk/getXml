<!--Service Location mantle.account.InvoiceServices.create#ProjectInvoiceItems--><service verb="create" noun="ProjectInvoiceItems"><in-parameters><parameter name="invoiceId"><description><![CDATA[If specified add item(s) to this Invoice. If empty an Invoice will be created.]]></description></parameter><parameter name="workEffortId" required="true"/><parameter name="thruDate" type="Timestamp" default="ec.user.nowTimestamp"><description><![CDATA[Only TimeEntry records before this date will be included. Defaults to now.]]></description></parameter><parameter name="invoiceDate" type="Timestamp" default="ec.user.nowTimestamp"/><parameter name="currencyUomId"/><parameter name="ratePurposeEnumId" default-value="RaprClient"><description><![CDATA[Invoice Project Client/Customer (RaprClient) or Vendor/Worker (RaprVendor)]]></description></parameter><parameter name="workerPartyId"><description><![CDATA[If specified only include time entries and expenses from this Party.]]></description></parameter><parameter name="entryGrouping" default-value="entry"><description><![CDATA[Can be per 'entry', per 'worker', or 'all']]></description></parameter></in-parameters><out-parameters><parameter name="invoiceId"/><parameter name="invoiceItemCreatedCount" type="Long"/></out-parameters><actions><set field="createSingleItem" from="entryGrouping == 'all'"/><set field="createItemPerWorker" from="entryGrouping == 'worker'"/><entity-find-one entity-name="mantle.work.effort.WorkEffort" value-field="workEffort"/><entity-find entity-name="mantle.work.effort.WorkEffortParty" list="billToList"><date-filter/><econdition field-name="workEffortId"/><econdition field-name="roleTypeId" operator="in" value="Customer,CustomerBillTo"/></entity-find><set field="billToWep" from="billToList ? billToList[0] : null"/><entity-find entity-name="mantle.work.effort.WorkEffortParty" list="billFromList"><date-filter/><econdition field-name="workEffortId"/><econdition field-name="roleTypeId" operator="in" value="Vendor,VendorBillFrom"/></entity-find><set field="billFromWep" from="billFromList ? billFromList[0] : null"/><set field="vendorPartyId" from="billFromWep?.partyId"/><if condition="workerPartyId"><entity-find-one entity-name="mantle.party.PartyDetail" value-field="workerParty"><field-map field-name="partyId" from="workerPartyId"/></entity-find-one><entity-find entity-name="mantle.party.PartyRelationship" list="employeeRelationshipList"><date-filter/><econdition field-name="fromPartyId" from="workerPartyId"/><econdition field-name="toPartyId" from="vendorPartyId"/><econdition field-name="relationshipTypeEnumId" value="PrtEmployee"/><econdition field-name="fromRoleTypeId" value="Employee"/></entity-find><set field="isEmployee" from="employeeRelationshipList.size() > 0"/></if><if condition="ratePurposeEnumId == 'RaprClient'"><then><set field="invoiceTypeEnumId" value="InvoiceSales"/><set field="itemTypeEnumId" value="ItemTimeEntry"/></then><else><set field="invoiceTypeEnumId" from="workerParty?.partyTypeEnumId == 'PtyPerson' ?                             (isEmployee ? 'InvoicePayroll' : 'InvoicePayrollOther') : 'InvoiceSales'"/><set field="itemTypeEnumId" from="workerParty?.partyTypeEnumId == 'PtyPerson' && isEmployee ? 'ItemHourlyEarnings' : 'ItemTimeEntry'"/></else></if><if condition="!invoiceId"><if condition="!currencyUomId"><entity-find-one entity-name="mantle.ledger.config.PartyAcctgPreference" value-field="partyAcctgPreference"><field-map field-name="organizationPartyId" from="ratePurposeEnumId == 'RaprClient' ? billToWep?.partyId : vendorPartyId"/></entity-find-one><set field="currencyUomId" from="partyAcctgPreference?.baseCurrencyUomId ?: 'USD'"/></if><set field="description" value="Invoice for${workEffort ? ' project ' + ec.resource.expand('WorkEffortNameTemplate','') : ''}${workerParty ? ' worker ' + ec.resource.expand('PartyNameTemplate','',workerParty) : ''}"/><if condition="ratePurposeEnumId == 'RaprClient'"><then><service-call name="mantle.account.InvoiceServices.create#Invoice" out-map="[invoiceId:context.invoiceId]" in-map="[invoiceTypeEnumId:invoiceTypeEnumId, fromPartyId:vendorPartyId, toPartyId:billToWep?.partyId,                                 invoiceDate:invoiceDate, currencyUomId:currencyUomId, description:description]"/></then><else><service-call name="mantle.account.InvoiceServices.create#Invoice" out-map="[invoiceId:context.invoiceId]" in-map="[invoiceTypeEnumId:invoiceTypeEnumId, fromPartyId:workerPartyId, toPartyId:vendorPartyId,                                 invoiceDate:invoiceDate, currencyUomId:currencyUomId, description:description]"/></else></if></if><service-call name="mantle.account.InvoiceServices.create#TimeEntryInvoiceItems" out-map="[invoiceItemCreatedCount:createResult.invoiceItemCreatedCount]" in-map="[invoiceId:invoiceId, workEffortId:workEffortId, thruDate:thruDate,                         currencyUomId:currencyUomId, ratePurposeEnumId:ratePurposeEnumId, itemTypeEnumId:itemTypeEnumId,                         workerPartyId:workerPartyId, vendorPartyId:vendorPartyId,                         createSingleItem:createSingleItem, createItemPerWorker:createItemPerWorker]"/><set field="invoiceItemCreatedCount" from="createResult.invoiceItemCreatedCount"/><if condition="ratePurposeEnumId == 'RaprClient'"><entity-find entity-name="mantle.work.effort.WorkEffortInvoiceDetail" list="weidList"><econdition field-name="workEffortId" ignore-if-empty="true"/><econdition field-name="statusId" value="InvoicePmtSent"/><econdition field-name="invoiceDate" operator="less-equals" from="thruDate"/><econdition field-name="toPartyId" operator="not-equals" from="billToWep?.partyId"/><econdition field-name="fromPartyId" operator="not-equals" from="billFromWep.partyId"/><econdition field-name="fromPartyId" from="workerPartyId" ignore-if-empty="true"/><order-by field-name="-invoiceDate"/></entity-find><iterate list="weidList" entry="weid"><service-call name="mantle.account.InvoiceServices.create#InvoiceBillThroughItems" in-map="[originalInvoiceId:weid.invoiceId, newInvoiceId:invoiceId]" out-map="[invoiceItemCreatedCount:createResult.invoiceItemCreatedCount]"/><set field="invoiceItemCreatedCount" from="invoiceItemCreatedCount + createResult.invoiceItemCreatedCount"/><service-call name="update#mantle.account.invoice.Invoice" in-map="[invoiceId:weid.invoiceId, statusId:'InvoiceBilledThrough']"/></iterate></if><if condition="invoiceItemCreatedCount == 0"><then><message error="true"><![CDATA[No time entries or expenses found for Project ${ec.resource.expand('WorkEffortNameTemplate','',workEffort)}, not creating invoice or adding items to existing invoice.]]></message></then><else><message><![CDATA[Added ${invoiceItemCreatedCount} items to Invoice ${invoiceId}]]></message></else></if></actions></service>