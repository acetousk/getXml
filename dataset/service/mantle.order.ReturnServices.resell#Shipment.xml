<!--Service Location mantle.order.ReturnServices.resell#Shipment--><service verb="resell" noun="Shipment"><in-parameters><parameter name="shipmentId" required="true" entity-name="mantle.shipment.Shipment" field-name="shipmentId"/><parameter name="customerPartyId" required="true"/></in-parameters><out-parameters><parameter name="newOrderId"/><parameter name="newShipmentId"/></out-parameters><actions><entity-find-one entity-name="mantle.shipment.Shipment" value-field="shipment"/><if condition="shipment.shipmentTypeEnumId != 'ShpTpSales'"><return error="true" message="Shipment ${shipmentId} is not a Sales shipment"/></if><if condition="!(shipment.statusId in ['ShipPacked', 'ShipShipped'])"><return error="true" message="Shipment ${shipmentId} is not in the Packed or Shipped status"/></if><set field="vendorPartyId" from="shipment.fromPartyId"/><entity-find entity-name="mantle.shipment.ShipmentRouteSegment" list="srsList"><econdition field-name="shipmentId"/></entity-find><set field="srs" from="srsList[0]"/><set field="facilityId" from="srs.originFacilityId"/><service-call name="mantle.order.OrderServices.create#Order" out-map="[orderId:ordOut.orderId,orderPartSeqId:ordOut.orderPartSeqId]" in-map="[vendorPartyId:vendorPartyId, customerPartyId:customerPartyId, facilityId:facilityId]"/><set field="newOrderId" from="ordOut.orderId"/><entity-find entity-name="mantle.shipment.ShipmentItem" list="shipmentItemList"><econdition field-name="shipmentId"/></entity-find><iterate list="shipmentItemList" entry="shipmentItem"><service-call name="mantle.order.OrderServices.add#OrderProductQuantity" in-map="[orderId:newOrderId,                         productId:shipmentItem.productId, quantity:shipmentItem.quantity]"/></iterate><service-call name="mantle.shipment.ShipmentServices.create#OrderPartShipment" in-map="[orderId:ordOut.orderId, orderPartSeqId:ordOut.orderPartSeqId]" out-map="[shipmentId:shipOut.shipmentId,shipmentPackageSeqId:shipOut.shipmentPackageSeqId]"/><set field="newShipmentId" from="shipOut.shipmentId"/><service-call name="update#mantle.shipment.Shipment" in-map="[shipmentId:shipmentId, statusId:'ShipRejected']"/><service-call name="mantle.product.AssetServices.move#IssuancesToNewShipment" in-map="[shipmentId:shipmentId, newOrderId:newOrderId, newShipmentId:newShipmentId]"/><service-call name="update#mantle.shipment.Shipment" in-map="[shipmentId:newShipmentId, statusId:'ShipPicked']"/></actions></service>