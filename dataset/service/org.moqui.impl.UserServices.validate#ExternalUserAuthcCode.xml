<!--Service Location org.moqui.impl.UserServices.validate#ExternalUserAuthcCode--><service verb="validate" noun="ExternalUserAuthcCode"><in-parameters><parameter name="code" required="true"/></in-parameters><out-parameters><parameter name="verified" type="Boolean"/><parameter name="factorId"/><parameter name="username"/></out-parameters><actions><set field="username" from="ec.web.sessionAttributes.moquiPreAuthcUsername"/><if condition="!username"><return error="true" message="No user pre-authenticated, cannot send code"/></if><entity-find-one entity-name="moqui.security.UserAccount" value-field="userAccount"><field-map field-name="username"/></entity-find-one><if condition="userAccount == null"><return error="true" message="User ${username} not found"/></if><service-call name="org.moqui.impl.UserServices.validate#UserAuthcFactorCode" in-map="[userId:userAccount.userId, code:code]" out-map="[verified:context.verified,factorId:context.factorId]"/></actions></service>