<!--Service Location mantle.shipment.CarrierServices.get#OrderShippingRateLocal--><service verb="get" noun="OrderShippingRateLocal"><in-parameters><parameter name="orderId" required="true"/><parameter name="orderPartSeqId" required="true"/><parameter name="shippingGatewayConfigId" required="true"/><parameter name="createOrderItem" type="Boolean" default="true"/><parameter name="carrierPartyId"><description><![CDATA[Overrides OrderPart.carrierPartyId if specified]]></description></parameter><parameter name="shipmentMethodEnumId"><description><![CDATA[Overrides OrderPart.shipmentMethodEnumId if specified]]></description></parameter><parameter name="postalContactMechId"><description><![CDATA[Overrides OrderPart.postalContactMechId if specified]]></description></parameter><parameter name="packageInfoList" type="List"><description><![CDATA[See get#AutoPackageInfo interface for details]]></description><parameter name="packageInfo" type="Map"/></parameter></in-parameters><out-parameters><parameter name="shippingTotal" required="true"/><parameter name="orderItemSeqId"><description><![CDATA[Return if an OrderItem record was created]]></description></parameter><parameter name="postalContactMechId"><description><![CDATA[Return if address was validated and replaced]]></description></parameter></out-parameters><actions><entity-find entity-name="moqui.basic.EnumGroupMember" list="productItemTypeEgms" cache="true"><econdition field-name="enumGroupEnumId" value="EngItemsProduct"/></entity-find><set field="productItemTypes" from="productItemTypeEgms*.enumId"/><entity-find-one entity-name="mantle.order.OrderHeader" value-field="orderHeader"/><entity-find-one entity-name="mantle.order.OrderPart" value-field="orderPart"/><entity-find entity-name="mantle.order.OrderItem" list="orderItemList"><econdition field-name="orderId"/><econdition field-name="orderPartSeqId"/><econdition field-name="itemTypeEnumId" operator="in" from="productItemTypes"/><order-by field-name="orderItemSeqId"/></entity-find><entity-find-one entity-name="mantle.shipment.carrier.ShippingGatewayConfig" value-field="shippingGatewayConfig" cache="true"/><set field="carrierPartyId" from="carrierPartyId ?: orderPart.carrierPartyId"/><set field="shipmentMethodEnumId" from="shipmentMethodEnumId ?: orderPart.shipmentMethodEnumId"/><set field="postalContactMechId" from="postalContactMechId ?: orderPart.postalContactMechId"/><service-call name="mantle.party.ContactServices.get#PostalAddressGeoIdSet" out-map="[geoIdSet:context.geoIdSet]" in-map="[contactMechId:postalContactMechId]"/><set field="itemCount" from="0.0" type="BigDecimal"/><set field="totalQuantity" from="0.0" type="BigDecimal"/><set field="totalWeight" from="0.0" type="BigDecimal"/><set field="totalAmount" from="0.0" type="BigDecimal"/><iterate list="orderItemList" entry="orderItem"><set field="product" from="orderItem.'mantle.product.Product'"/><set field="typeEnum" from="product?.'ProductType#moqui.basic.Enumeration'"/><if condition="(!product?.chargeShipping || product?.chargeShipping == 'Y') &&                         product?.productTypeEnumId in ['PtAsset', 'PtDigitalAsset', 'PtAssetUse', 'PtPickAssembly']"><set field="itemCount" from="itemCount + 1.0"/><set field="totalQuantity" from="totalQuantity + (orderItem.quantity ?: 1.0)"/><set field="totalAmount" from="totalAmount + ((orderItem.quantity ?: 1.0) * (orderItem.unitAmount ?: 0.0))"/><entity-find-one entity-name="mantle.product.ProductDimension" value-field="shippingWeight"><field-map field-name="productId" from="orderItem.productId"/><field-map field-name="dimensionTypeId" value="ShippingWeight"/></entity-find-one><set field="totalWeight" from="totalWeight + ((shippingWeight?.value ?: 1.0) * orderItem.quantity)"/></if></iterate><if condition="itemCount"><set field="shippingTotal" from="0.0" type="BigDecimal"/><if condition="ec.factory.getToolFactory('KIE')"><then><script><![CDATA[ec.getTool("KIE", null).getStatelessKieSession("OrderShippingRateKS").execute([])]]></script></then><else><log message="KIE not found, not calculating order shipping for order ${orderId}"/></else></if><log level="info" message="Calculated shippingTotal [${shippingTotal}] order part [${orderId}:${orderPartSeqId}] carrier [${carrierPartyId}] method [${shipmentMethodEnumId}] address [${postalContactMechId}] geos [${geoIdSet}] items [${itemCount}] quantity [${totalQuantity}] weight [${totalWeight}]"/><if condition="createOrderItem && shippingTotal > 0.0"><entity-find-one entity-name="mantle.party.PartyDetail" value-field="carrierDetail" cache="true"><field-map field-name="partyId" from="orderPart.carrierPartyId"/></entity-find-one><entity-find-one entity-name="moqui.basic.Enumeration" value-field="shipmentMethodEnum"><field-map field-name="enumId" from="orderPart.shipmentMethodEnumId"/></entity-find-one><set field="carrierName" value="${ec.resource.expand('PartyNameTemplate','',carrierDetail)}"/><set field="itemDescription" value="${orderPart.carrierPartyId == '_NA_' ? '' : (carrierName + ' - ') }${shipmentMethodEnum.description}"/><service-call name="create#mantle.order.OrderItem" in-map="[orderId:orderId, orderPartSeqId:orderPartSeqId,                             itemTypeEnumId:'ItemShipping', quantity:1, unitAmount:shippingTotal, itemDescription:itemDescription]" out-map="[orderId:context.orderId,orderItemSeqId:context.orderItemSeqId,orderPartSeqId:context.orderPartSeqId,parentItemSeqId:context.parentItemSeqId,itemTypeEnumId:context.itemTypeEnumId,productId:context.productId,productFeatureId:context.productFeatureId,otherPartyProductId:context.otherPartyProductId,productParameterSetId:context.productParameterSetId,itemDescription:context.itemDescription,comments:context.comments,quantity:context.quantity,quantityUomId:context.quantityUomId,quantityCancelled:context.quantityCancelled,selectedAmount:context.selectedAmount,priority:context.priority,requiredByDate:context.requiredByDate,unitAmount:context.unitAmount,unitListPrice:context.unitListPrice,isModifiedPrice:context.isModifiedPrice,standardCost:context.standardCost,externalItemSeqId:context.externalItemSeqId,fromAssetId:context.fromAssetId,productPriceId:context.productPriceId,productCategoryId:context.productCategoryId,isPromo:context.isPromo,promoQuantity:context.promoQuantity,promoTimesUsed:context.promoTimesUsed,storePromotionId:context.storePromotionId,promoCodeId:context.promoCodeId,promoCodeText:context.promoCodeText,subscriptionId:context.subscriptionId,finAccountId:context.finAccountId,finAccountTransId:context.finAccountTransId,overrideGlAccountId:context.overrideGlAccountId,salesOpportunityId:context.salesOpportunityId,sourceReferenceId:context.sourceReferenceId,sourcePercentage:context.sourcePercentage,amountAlreadyIncluded:context.amountAlreadyIncluded,exemptAmount:context.exemptAmount,customerReferenceId:context.customerReferenceId,taxAuthorityId:context.taxAuthorityId,lastUpdatedStamp:context.lastUpdatedStamp]"/></if></if></actions></service>