<!--Service Location mantle.account.InvoiceServices.apply#InvoiceItemToShipment--><service verb="apply" noun="InvoiceItemToShipment"><in-parameters><parameter name="invoiceId" required="true"/><parameter name="invoiceItemSeqId" required="true"/><parameter name="shipmentId" required="true"/></in-parameters><out-parameters/><actions><entity-find-one entity-name="mantle.account.invoice.Invoice" value-field="invoice"/><entity-find-one entity-name="mantle.account.invoice.InvoiceItem" value-field="invoiceItem"/><if condition="!invoiceItem.productId"><return message="Invoice ${invoiceId} item ${invoiceItemSeqId} has no product"/></if><entity-find entity-name="moqui.basic.EnumGroupMember" list="productItemTypeEgms" cache="true"><econdition field-name="enumGroupEnumId" value="EngItemsProduct"/></entity-find><set field="productItemTypes" from="productItemTypeEgms*.enumId"/><if condition="!(invoiceItem.itemTypeEnumId in productItemTypes)"><return message="Invoice ${invoiceId} item ${invoiceItemSeqId} is not a product item, cannot apply to shipment"/></if><entity-find-one entity-name="mantle.shipment.Shipment" value-field="shipment"/><if condition="shipment.toPartyId != invoice.toPartyId"><return error="true" message="Shipment to party ${shipment.toPartyId} does not match invoice to party ${invoice.toPartyId}"/></if><if condition="shipment.fromPartyId != invoice.fromPartyId"><return error="true" message="Shipment from party ${shipment.fromPartyId} does not match invoice from party ${invoice.fromPartyId}"/></if><set field="invoiceQtyOrig" from="invoiceItem.quantity != null ? invoiceItem.quantity : 1.0"/><set field="invoiceQtyRemaining" from="invoiceQtyOrig"/><entity-find entity-name="mantle.shipment.ShipmentItemSource" list="invoiceSisList"><econdition field-name="invoiceId"/><econdition field-name="invoiceItemSeqId"/><select-field field-name="quantity"/></entity-find><set field="invoiceShippedQuantity" from="invoiceSisList*.quantity.sum() ?: 0.0"/><set field="invoiceQtyRemaining" from="invoiceQtyRemaining - invoiceShippedQuantity"/><if condition="invoiceQtyRemaining > 0.0"><then><entity-find entity-name="mantle.shipment.ShipmentItemSource" list="shipmentItemSourceList"><econdition field-name="shipmentId"/><econdition field-name="productId" from="invoiceItem.productId"/><order-by field-name="-quantity"/></entity-find><iterate list="shipmentItemSourceList" entry="shipmentItemSource"><if condition="!shipmentItemSource.invoiceId && invoiceQtyRemaining >= shipmentItemSource.quantity"><set field="shipmentItemSource.invoiceId" from="invoiceId"/><set field="shipmentItemSource.invoiceItemSeqId" from="invoiceItemSeqId"/><entity-update value-field="shipmentItemSource"/><set field="quantityNotShipSourced" from="invoiceQtyRemaining - shipmentItemSource.quantity"/></if></iterate></then><else><message><![CDATA[Invoice ${invoiceId} item ${invoiceItemSeqId} already fully applied to shipments]]></message></else></if><entity-find entity-name="mantle.shipment.ShipmentItemSource" list="invoiceSisFullList"><econdition field-name="invoiceId"/><econdition field-name="invoiceItemSeqId"/></entity-find><iterate list="invoiceSisFullList" entry="invoiceSis"><entity-find entity-name="mantle.product.issuance.AssetIssuance" list="sisIssuanceList"><econdition field-name="shipmentItemSourceId" from="invoiceSis.shipmentItemSourceId"/><econdition field-name="invoiceId" operator="is-null"/></entity-find><iterate list="sisIssuanceList" entry="sisIssuance"><set field="sisIssuance.invoiceId" from="invoiceSis.invoiceId"/><set field="sisIssuance.invoiceItemSeqId" from="invoiceSis.invoiceItemSeqId"/><entity-update value-field="sisIssuance"/></iterate></iterate></actions></service>