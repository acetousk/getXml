<!--Service Location mantle.order.OrderServices.update#OrderItem--><service verb="update" noun="OrderItem"><in-parameters><parameter name="orderId" type="java.lang.String" required="true" allow-html="none" entity-name="mantle.order.OrderItem" field-name="orderId"/><parameter name="orderItemSeqId" type="java.lang.String" required="true" allow-html="none" entity-name="mantle.order.OrderItem" field-name="orderItemSeqId"/><parameter name="orderPartSeqId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.order.OrderItem" field-name="orderPartSeqId"/><parameter name="parentItemSeqId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.order.OrderItem" field-name="parentItemSeqId"/><parameter name="itemTypeEnumId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.order.OrderItem" field-name="itemTypeEnumId"/><parameter name="productId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.order.OrderItem" field-name="productId"/><parameter name="productFeatureId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.order.OrderItem" field-name="productFeatureId"/><parameter name="otherPartyProductId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.order.OrderItem" field-name="otherPartyProductId"/><parameter name="productParameterSetId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.order.OrderItem" field-name="productParameterSetId"/><parameter name="itemDescription" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.order.OrderItem" field-name="itemDescription"/><parameter name="comments" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.order.OrderItem" field-name="comments"/><parameter name="quantity" type="java.math.BigDecimal" required="false" allow-html="none" entity-name="mantle.order.OrderItem" field-name="quantity"/><parameter name="quantityUomId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.order.OrderItem" field-name="quantityUomId"/><parameter name="quantityCancelled" type="java.math.BigDecimal" required="false" allow-html="none" entity-name="mantle.order.OrderItem" field-name="quantityCancelled"/><parameter name="selectedAmount" type="java.math.BigDecimal" required="false" allow-html="none" entity-name="mantle.order.OrderItem" field-name="selectedAmount"/><parameter name="priority" type="java.lang.Long" required="false" allow-html="none" entity-name="mantle.order.OrderItem" field-name="priority"/><parameter name="requiredByDate" type="java.sql.Timestamp" required="false" allow-html="none" entity-name="mantle.order.OrderItem" field-name="requiredByDate"/><parameter name="unitAmount" type="java.math.BigDecimal" required="false" allow-html="none" entity-name="mantle.order.OrderItem" field-name="unitAmount"/><parameter name="unitListPrice" type="java.math.BigDecimal" required="false" allow-html="none" entity-name="mantle.order.OrderItem" field-name="unitListPrice"/><parameter name="isModifiedPrice" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.order.OrderItem" field-name="isModifiedPrice"/><parameter name="standardCost" type="java.math.BigDecimal" required="false" allow-html="none" entity-name="mantle.order.OrderItem" field-name="standardCost"/><parameter name="externalItemSeqId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.order.OrderItem" field-name="externalItemSeqId"/><parameter name="fromAssetId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.order.OrderItem" field-name="fromAssetId"/><parameter name="productPriceId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.order.OrderItem" field-name="productPriceId"/><parameter name="productCategoryId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.order.OrderItem" field-name="productCategoryId"/><parameter name="isPromo" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.order.OrderItem" field-name="isPromo"/><parameter name="promoQuantity" type="java.math.BigDecimal" required="false" allow-html="none" entity-name="mantle.order.OrderItem" field-name="promoQuantity"/><parameter name="promoTimesUsed" type="java.math.BigDecimal" required="false" allow-html="none" entity-name="mantle.order.OrderItem" field-name="promoTimesUsed"/><parameter name="storePromotionId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.order.OrderItem" field-name="storePromotionId"/><parameter name="promoCodeId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.order.OrderItem" field-name="promoCodeId"/><parameter name="promoCodeText" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.order.OrderItem" field-name="promoCodeText"/><parameter name="subscriptionId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.order.OrderItem" field-name="subscriptionId"/><parameter name="finAccountId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.order.OrderItem" field-name="finAccountId"/><parameter name="finAccountTransId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.order.OrderItem" field-name="finAccountTransId"/><parameter name="overrideGlAccountId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.order.OrderItem" field-name="overrideGlAccountId"/><parameter name="salesOpportunityId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.order.OrderItem" field-name="salesOpportunityId"/><parameter name="sourceReferenceId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.order.OrderItem" field-name="sourceReferenceId"/><parameter name="sourcePercentage" type="java.math.BigDecimal" required="false" allow-html="none" entity-name="mantle.order.OrderItem" field-name="sourcePercentage"/><parameter name="amountAlreadyIncluded" type="java.math.BigDecimal" required="false" allow-html="none" entity-name="mantle.order.OrderItem" field-name="amountAlreadyIncluded"/><parameter name="exemptAmount" type="java.math.BigDecimal" required="false" allow-html="none" entity-name="mantle.order.OrderItem" field-name="exemptAmount"/><parameter name="customerReferenceId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.order.OrderItem" field-name="customerReferenceId"/><parameter name="taxAuthorityId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.order.OrderItem" field-name="taxAuthorityId"/><parameter name="lastUpdatedStamp" type="java.sql.Timestamp" required="false" allow-html="none" entity-name="mantle.order.OrderItem" field-name="lastUpdatedStamp"/><parameter name="unitAmount_changeReason"/><parameter name="quantity_changeReason"/><parameter name="requireInventory" type="Boolean"><description><![CDATA[If true make sure inventory is available, if false don't check. If null defer to ProductStore setting.]]></description></parameter></in-parameters><out-parameters/><actions><entity-find-one entity-name="mantle.order.OrderItem" value-field="orderItem" for-update="true"/><set field="productId" from="productId ?: orderItem.productId"/><set field="quantity" from="quantity != null ? quantity : orderItem.quantity"/><set field="orderPartSeqId" from="orderPartSeqId ?: orderItem.orderPartSeqId"/><set field="isProductItem" from="false"/><if condition="productId"><if condition="productId != orderItem.productId"><entity-find-one entity-name="mantle.product.Product" value-field="product" cache="true"/><if condition="product == null"><return error="true" message="Product ${productId} not found"/></if><if condition="product.productTypeEnumId == 'PtVirtual'"><return error="true" message="Product ${productId} is a Virtual product and may not be used on an Order"/></if></if><entity-find entity-name="moqui.basic.EnumGroupMember" list="productItemTypeEgms" cache="true"><econdition field-name="enumGroupEnumId" value="EngItemsProduct"/></entity-find><set field="productItemTypes" from="productItemTypeEgms*.enumId"/><set field="isProductItem" from="productItemTypes.contains(orderItem.itemTypeEnumId)"/></if><if condition="isProductItem"><then><if condition="quantity"><service-call name="mantle.order.OrderServices.check#AvailableInventory" in-map="[productId:productId, quantity:quantity, orderId:orderId, orderPartSeqId:orderPartSeqId,                             orderItemSeqId:orderItemSeqId, requireInventory:requireInventory]"/><entity-find entity-name="mantle.product.issuance.AssetIssuance" list="itemAssetIssuanceList"><econdition field-name="orderId"/><econdition field-name="orderItemSeqId"/></entity-find><set field="itemQuantityIssued" from="0.0"/><iterate list="itemAssetIssuanceList" entry="itemAssetIssuance"><set field="itemQuantityIssued" from="itemQuantityIssued + itemAssetIssuance.quantity"/></iterate><if condition="quantity < itemQuantityIssued"><set field="quantity" from="itemQuantityIssued"/><message type="warning" public="true"><![CDATA[Quantity requested ${quantity} is less than quantity already shipped ${itemQuantityIssued}, setting to quantity shipped]]></message></if></if><if condition="unitAmount == null && isProductItem"><then><entity-find-one entity-name="mantle.order.OrderHeader" value-field="orderHeader" for-update="true"/><set field="orderPart" from="orderItem.part"/><service-call name="mantle.product.PriceServices.get#OrderProductPrice" out-map="[price:priceMap.price,productPriceId:priceMap.productPriceId,listPrice:priceMap.listPrice,listProductPriceId:priceMap.listProductPriceId,priceUomId:priceMap.priceUomId]" in-map="[productId:productId, quantity:quantity, orderId:orderId, orderPartSeqId:orderPartSeqId]"/><set field="unitAmount" from="priceMap.price"/><set field="unitListPrice" from="priceMap.listPrice"/><set field="isModifiedPrice" value="N"/></then><else><set field="isModifiedPrice" value="Y"/></else></if><if condition="quantity != null && quantity != orderItem.quantity"><entity-find entity-name="mantle.shipment.ShipmentAndItemSource" list="shipmentItemSourceList"><econdition field-name="orderId"/><econdition field-name="orderItemSeqId"/><econdition field-name="shipmentStatusId" operator="in" value="ShipInput,ShipScheduled"/><order-by field-name="shipmentId"/></entity-find><if condition="shipmentItemSourceList"><set field="sourceQuantityTotal" from="0"/><iterate list="shipmentItemSourceList" entry="shipmentItemSource"><set field="sourceQuantityTotal" from="sourceQuantityTotal + shipmentItemSource.quantity"/></iterate><if condition="quantity > sourceQuantityTotal"><then><set field="quantityIncrease" from="quantity - sourceQuantityTotal"/><set field="shipmentItemSource" from="shipmentItemSourceList[0]"/><service-call name="update#mantle.shipment.ShipmentItemSource" in-map="[shipmentItemSourceId:shipmentItemSource.shipmentItemSourceId,                                           quantity:(shipmentItemSource.quantity + quantityIncrease),                                           quantityNotHandled:(shipmentItemSource.quantityNotHandled + quantityIncrease)]"/><entity-find-one entity-name="mantle.shipment.ShipmentItem" value-field="shipmentItem"><field-map field-name="shipmentId" from="shipmentItemSource.shipmentId"/><field-map field-name="productId" from="orderItem.productId"/></entity-find-one><service-call name="update#mantle.shipment.ShipmentItem" in-map="[shipmentId:shipmentItem.shipmentId, productId:shipmentItem.productId,                                           quantity:(shipmentItem.quantity + quantityIncrease)]"/></then><else><set field="quantityReduceRemaining" from="sourceQuantityTotal - quantity"/><iterate list="shipmentItemSourceList" entry="shipmentItemSource"><set field="quantityReduce" from="quantityReduceRemaining > shipmentItemSource.quantityNotHandled ?                                     shipmentItemSource.quantityNotHandled : quantityReduceRemaining"/><if condition="quantityReduce == 0"><break/></if><service-call name="update#mantle.shipment.ShipmentItemSource" in-map="[shipmentItemSourceId:shipmentItemSource.shipmentItemSourceId,                                         quantity:(shipmentItemSource.quantity - quantityReduce),                                         quantityNotHandled:(shipmentItemSource.quantityNotHandled - quantityReduce)]"/><set field="quantityReduceRemaining" from="quantityReduceRemaining - quantityReduce"/><entity-find-one entity-name="mantle.shipment.ShipmentItem" value-field="shipmentItem"><field-map field-name="shipmentId" from="shipmentItemSource.shipmentId"/><field-map field-name="productId" from="orderItem.productId"/></entity-find-one><set field="newItemQuantity" from="shipmentItem.quantity > quantityReduce ?                                     shipmentItem.quantity - quantityReduce : 0.0"/><service-call name="update#mantle.shipment.ShipmentItem" in-map="[shipmentId:shipmentItem.shipmentId, productId:shipmentItem.productId,                                         quantity:newItemQuantity]"/></iterate></else></if></if></if></then><else><if condition="parentItemSeqId"><if condition="!productId"><entity-find-one entity-name="mantle.order.OrderItem" value-field="parentItem"><field-map field-name="orderId"/><field-map field-name="orderItemSeqId" from="parentItemSeqId"/></entity-find-one><set field="productId" from="parentItem?.productId"/></if></if></else></if><service-call name="update#mantle.order.OrderItem" in-map="context"/></actions></service>