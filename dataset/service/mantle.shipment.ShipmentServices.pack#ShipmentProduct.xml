<!--Service Location mantle.shipment.ShipmentServices.pack#ShipmentProduct--><service verb="pack" noun="ShipmentProduct"><in-parameters><parameter name="productId" required="true"/><parameter name="shipmentId" required="true"/><parameter name="shipmentPackageSeqId"/><parameter name="quantity" type="BigDecimal" required="true"/><parameter name="packDate" type="Timestamp" default="ec.user.nowTimestamp"/><parameter name="assetId"><description><![CDATA[Specify to pack a certain asset, may or may not be reserved.]]></description></parameter></in-parameters><out-parameters><parameter name="quantityRemaining" type="BigDecimal"/></out-parameters><actions><entity-find-one entity-name="mantle.product.Product" value-field="product" cache="true"/><if condition="!(product.productTypeEnumId in ['PtAsset', 'PtDigitalAsset', 'PtAssetUse', 'PtPickAssembly'])"><return message="Not packing Product ${productId}, type ${product.type?.description ?: product.productTypeEnumId} is not a physical product type"/></if><entity-find entity-name="mantle.shipment.ShipmentItemSource" list="shipmentItemSourceList" cache="false"><econdition field-name="shipmentId"/><econdition field-name="productId"/><econdition field-name="quantityNotHandled" operator="not-equals" from="0.0"/></entity-find><set field="quantityRemaining" from="quantity"/><iterate list="shipmentItemSourceList" entry="shipmentItemSource"><set field="quantityToPack" from="shipmentItemSource.quantityNotHandled > quantityRemaining ?                         quantityRemaining : shipmentItemSource.quantityNotHandled"/><set field="quantityRemaining" from="quantityRemaining > shipmentItemSource.quantityNotHandled ?                         quantityRemaining - shipmentItemSource.quantityNotHandled : 0"/><service-call name="mantle.shipment.ShipmentServices.pack#ShipmentItemSource" in-map="[shipmentItemSourceId:shipmentItemSource.shipmentItemSourceId, assetId:assetId,                             shipmentPackageSeqId:shipmentPackageSeqId, packDate:packDate, quantity:quantityToPack]"/></iterate></actions></service>