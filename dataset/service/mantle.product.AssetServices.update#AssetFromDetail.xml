<!--Service Location mantle.product.AssetServices.update#AssetFromDetail--><service verb="update" noun="AssetFromDetail"><in-parameters><parameter name="assetId" required="true"/><parameter name="availableToPromiseDiff" type="BigDecimal"/><parameter name="quantityOnHandDiff" type="BigDecimal"/></in-parameters><out-parameters/><actions><entity-find-one entity-name="mantle.product.asset.Asset" value-field="asset" for-update="true"><field-map field-name="assetId"/></entity-find-one><if condition="ec.transaction.isTransactionCacheActive()"><then><set field="asset.availableToPromiseTotal" from="(asset.availableToPromiseTotal ?: 0.0) + (availableToPromiseDiff ?: 0.0)"/><set field="asset.quantityOnHandTotal" from="(asset.quantityOnHandTotal ?: 0.0) + (quantityOnHandDiff ?: 0.0)"/></then><else><entity-find entity-name="mantle.product.asset.AssetDetailSummary" list="assetDetailSummaryList"><econdition field-name="assetId"/><select-field field-name="availableToPromiseTotal,quantityOnHandTotal"/></entity-find><if condition="assetDetailSummaryList.size() > 0"><then><set field="assetDetailSummary" from="assetDetailSummaryList[0]"/><set field="asset.availableToPromiseTotal" from="assetDetailSummary.availableToPromiseTotal ?: 0.0"/><set field="asset.quantityOnHandTotal" from="assetDetailSummary.quantityOnHandTotal ?: 0.0"/></then><else><set field="asset.availableToPromiseTotal" from="(asset.availableToPromiseTotal ?: 0.0) + (availableToPromiseDiff ?: 0.0)"/><set field="asset.quantityOnHandTotal" from="(asset.quantityOnHandTotal ?: 0.0) + (quantityOnHandDiff ?: 0.0)"/></else></if></else></if><entity-update value-field="asset"/><if condition="asset.quantityOnHandTotal < 0"><service-call name="mantle.product.AssetServices.record#PhysicalInventoryChange" in-map="[productId:asset.productId, facilityId:asset.facilityId, locationSeqId:asset.locationSeqId,                             quantityChange:-asset.quantityOnHandTotal, varianceReasonEnumId:'InVrFound',                             assetList:[asset]]"/></if></actions></service>