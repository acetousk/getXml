<!--Service Location mantle.product.PromotionServices.apply#FlatDiscount--><service verb="apply" noun="FlatDiscount"><in-parameters><parameter name="orderId" required="true"/><parameter name="orderPartSeqId" required="true"/><parameter name="storePromotionId" required="true"/><parameter name="promoCodeId"/><parameter name="useLimit" type="BigDecimal"/><parameter name="itemDescription"/><parameter name="discountAmount" type="BigDecimal" required="true"><description><![CDATA[Required. Discount Amount applied per quantity. Set limits per order and/or customer on promo or code (if no limit specified defaults to 1).]]></description></parameter><parameter name="itemsWithPromo" type="Boolean" default="false"><description><![CDATA[If true apply to product item quantities that already have another promotion (defaults to false)]]></description></parameter><parameter name="includeNonConsumer" type="Boolean" default="false"><description><![CDATA[If true apply when customer has a classification other than Consumer (defaults to false)]]></description></parameter></in-parameters><out-parameters/><actions><entity-find-one entity-name="mantle.order.OrderPart" value-field="orderPart"/><set field="customerPartyId" from="orderPart?.customerPartyId"/><if condition="customerPartyId && !includeNonConsumer"><entity-find entity-name="mantle.party.PartyClassificationAndAppl" list="classApplList"><date-filter/><econdition field-name="partyId" from="customerPartyId"/><econdition field-name="classificationTypeEnumId" value="PcltCustomer"/></entity-find><iterate list="classApplList" entry="classAppl"><if condition="classAppl.partyClassificationId != 'CustConsumer'"><return/></if></iterate></if><entity-find entity-name="mantle.product.store.ProductStorePromoProduct" list="psppList" cache="true"><econdition field-name="storePromotionId"/></entity-find><set field="includeProductIdSet" from="new HashSet()"/><set field="excludeProductIdSet" from="new HashSet()"/><iterate list="psppList" entry="pspp"><if condition="pspp.excludeProduct == 'Y'"><then><script><![CDATA[excludeProductIdSet.add(pspp.productId)]]></script></then><else><script><![CDATA[includeProductIdSet.add(pspp.productId)]]></script></else></if></iterate><entity-find-one entity-name="mantle.product.store.ProductStorePromoCode" value-field="storePromoCode"/><set field="useLimitRemaining" from="!useLimit || useLimit == 1000.0 ? 1.0 : useLimit"/><entity-find entity-name="mantle.order.OrderItem" list="prodItemList"><econdition field-name="orderId"/><econdition field-name="orderPartSeqId"/><econdition field-name="itemTypeEnumId" value="ItemProduct"/><econdition field-name="productId" operator="in" from="includeProductIdSet" ignore-if-empty="true"/><econdition field-name="productId" operator="not-in" from="excludeProductIdSet" ignore-if-empty="true"/></entity-find><iterate list="prodItemList" entry="orderItem"><service-call name="mantle.order.OrderServices.get#OrderItemTotal" out-map-add-to-existing="false" in-map="[orderItem:orderItem, getChildrenTotals:true]" out-map="[combinedAmount:orderItemTotalOut.combinedAmount,combinedQuantity:orderItemTotalOut.combinedQuantity,itemTotal:orderItemTotalOut.itemTotal,childrenTotal:orderItemTotalOut.childrenTotal,itemPlusChildrenTotal:orderItemTotalOut.itemPlusChildrenTotal,childItemCount:orderItemTotalOut.childItemCount,hasPromo:orderItemTotalOut.hasPromo,promoQuantityUsed:orderItemTotalOut.promoQuantityUsed,childOrderItemList:orderItemTotalOut.childOrderItemList]"/><if condition="!orderItemTotalOut.combinedAmount"><continue/></if><if condition="itemsWithPromo"><then><set field="eligibleQuantity" from="orderItem.quantity != null ? orderItem.quantity : 1.0"/></then><else><set field="eligibleQuantity" from="(orderItem.quantity != null ? orderItem.quantity : 1.0) - orderItemTotalOut.promoQuantityUsed"/></else></if><if condition="eligibleQuantity > useLimitRemaining"><set field="eligibleQuantity" from="useLimitRemaining"/></if><set field="useLimitRemaining" from="useLimitRemaining - eligibleQuantity"/><set field="itemQuantity" from="eligibleQuantity"/><set field="promoQuantity" from="eligibleQuantity"/><if condition="eligibleQuantity == 0.0"><continue/></if><if condition="discountAmount > orderItemTotalOut.combinedAmount"><set field="discountAmount" from="orderItemTotalOut.combinedAmount"/></if><service-call name="create#mantle.order.OrderItem" out-map="[orderId:createItemOut.orderId,orderItemSeqId:createItemOut.orderItemSeqId,orderPartSeqId:createItemOut.orderPartSeqId,parentItemSeqId:createItemOut.parentItemSeqId,itemTypeEnumId:createItemOut.itemTypeEnumId,productId:createItemOut.productId,productFeatureId:createItemOut.productFeatureId,otherPartyProductId:createItemOut.otherPartyProductId,productParameterSetId:createItemOut.productParameterSetId,itemDescription:createItemOut.itemDescription,comments:createItemOut.comments,quantity:createItemOut.quantity,quantityUomId:createItemOut.quantityUomId,quantityCancelled:createItemOut.quantityCancelled,selectedAmount:createItemOut.selectedAmount,priority:createItemOut.priority,requiredByDate:createItemOut.requiredByDate,unitAmount:createItemOut.unitAmount,unitListPrice:createItemOut.unitListPrice,isModifiedPrice:createItemOut.isModifiedPrice,standardCost:createItemOut.standardCost,externalItemSeqId:createItemOut.externalItemSeqId,fromAssetId:createItemOut.fromAssetId,productPriceId:createItemOut.productPriceId,productCategoryId:createItemOut.productCategoryId,isPromo:createItemOut.isPromo,promoQuantity:createItemOut.promoQuantity,promoTimesUsed:createItemOut.promoTimesUsed,storePromotionId:createItemOut.storePromotionId,promoCodeId:createItemOut.promoCodeId,promoCodeText:createItemOut.promoCodeText,subscriptionId:createItemOut.subscriptionId,finAccountId:createItemOut.finAccountId,finAccountTransId:createItemOut.finAccountTransId,overrideGlAccountId:createItemOut.overrideGlAccountId,salesOpportunityId:createItemOut.salesOpportunityId,sourceReferenceId:createItemOut.sourceReferenceId,sourcePercentage:createItemOut.sourcePercentage,amountAlreadyIncluded:createItemOut.amountAlreadyIncluded,exemptAmount:createItemOut.exemptAmount,customerReferenceId:createItemOut.customerReferenceId,taxAuthorityId:createItemOut.taxAuthorityId,lastUpdatedStamp:createItemOut.lastUpdatedStamp]" in-map="[orderId:orderId, orderPartSeqId:orderPartSeqId, parentItemSeqId:orderItem.orderItemSeqId,                              itemTypeEnumId:'ItemDiscount', quantity:itemQuantity, unitAmount:-discountAmount, productId:orderItem.productId,                              storePromotionId:storePromotionId, promoCodeId:promoCodeId, promoCodeText:storePromoCode?.promoCode,                              isPromo:'Y', promoQuantity:promoQuantity, promoTimesUsed:eligibleQuantity,                              itemDescription:ec.resource.expand(itemDescription, '')?:('Get ' + ec.l10n.format(discountAmount, '#,##0.00') + ' off')]"/></iterate></actions></service>