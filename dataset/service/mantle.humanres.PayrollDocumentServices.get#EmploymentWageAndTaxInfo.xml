<!--Service Location mantle.humanres.PayrollDocumentServices.get#EmploymentWageAndTaxInfo--><service verb="get" noun="EmploymentWageAndTaxInfo"><in-parameters><parameter name="timePeriodId" required="true"><description><![CDATA[Should be a period for a Tax Year/Quarter/etc]]></description></parameter><parameter name="partyRelationshipId" required="true"/></in-parameters><out-parameters><parameter name="timePeriod" type="Map"/><parameter name="employment" type="Map"/><parameter name="employeeFirstName"/><parameter name="employeeMiddleName"/><parameter name="employeeLastName"/><parameter name="employeeSuffix"/><parameter name="employeeSsn"/><parameter name="employeeHomeContactInfo" type="Map"/><parameter name="employeeHomeStreetString"/><parameter name="employeeHomeCszString"/><parameter name="employeeHomeString"/><parameter name="employerName"/><parameter name="employerEin"/><parameter name="employerContactInfo" type="Map"/><parameter name="employerAddressString"/><parameter name="employerPhoneString"/><parameter name="taxablePayAmount" type="BigDecimal"/><parameter name="socialTaxablePayAmount" type="BigDecimal"/><parameter name="medicalTaxablePayAmount" type="BigDecimal"/><parameter name="currencyUomId"/><parameter name="hasAnyPay" type="Boolean"/><parameter name="wageAndTaxInfoByTaxAuthorityId" type="Map"><description><![CDATA[contains Map with: taxAuthority,
                taxAuthorityGeo, incomeTaxWithheldAmount, socialTaxWithheldAmount, medicalTaxWithheldAmount]]></description></parameter><parameter name="federalTaxAuthorityIdList" type="List"/><parameter name="stateTaxAuthorityIdList" type="List"/><parameter name="localTaxAuthorityIdList" type="List"/></out-parameters><actions><service-call name="mantle.humanres.PayrollDocumentServices.get#EmploymentInfo" in-map="[timePeriodId:timePeriodId, partyRelationshipId:partyRelationshipId]" out-map="[timePeriod:context.timePeriod,employment:context.employment,employeeFirstName:context.employeeFirstName,employeeMiddleName:context.employeeMiddleName,employeeLastName:context.employeeLastName,employeeSuffix:context.employeeSuffix,employeeSsn:context.employeeSsn,employeeHomeContactInfo:context.employeeHomeContactInfo,employeeHomeStreetString:context.employeeHomeStreetString,employeeHomeCszString:context.employeeHomeCszString,employeeHomeString:context.employeeHomeString,employerName:context.employerName,employerEin:context.employerEin,employerContactInfo:context.employerContactInfo,employerAddressString:context.employerAddressString,employerPhoneString:context.employerPhoneString]"/><entity-find entity-name="mantle.humanres.employment.EmploymentPayHistory" list="payHistoryList"><econdition field-name="partyRelationshipId"/><econdition field-name="payDate" operator="greater-equals" from="timePeriod.fromDate"/><econdition field-name="payDate" operator="less-equals" from="timePeriod.thruDate"/><econdition field-name="internalPayroll" value="Y"/></entity-find><set field="taxablePayAmount" from="0.0"/><set field="socialTaxablePayAmount" from="0.0"/><set field="medicalTaxablePayAmount" from="0.0"/><iterate list="payHistoryList" entry="payHistory"><set field="taxablePayAmount" from="taxablePayAmount + payHistory.taxablePayAmount"/><set field="socialTaxablePayAmount" from="socialTaxablePayAmount + payHistory.socialTaxablePayAmount"/><set field="medicalTaxablePayAmount" from="medicalTaxablePayAmount + payHistory.medicalTaxablePayAmount"/><set field="currencyUomId" from="payHistory.currencyUomId"/></iterate><set field="hasAnyPay" from="taxablePayAmount > 0 || socialTaxablePayAmount > 0 || medicalTaxablePayAmount > 0"/><entity-find entity-name="mantle.humanres.employment.EmploymentPayDetail" list="payDetailList"><econdition field-name="partyRelationshipId"/><econdition field-name="payDate" operator="greater-equals" from="timePeriod.fromDate"/><econdition field-name="payDate" operator="less-equals" from="timePeriod.thruDate"/><econdition field-name="isEmployerPaid" operator="not-equals" value="Y" or-null="true"/></entity-find><set field="wageAndTaxInfoByTaxAuthorityId" from="[:]"/><iterate list="payDetailList" entry="payDetail"><if condition="!payDetail.taxAuthorityId"><continue/></if><set field="taxAuthorityId" from="payDetail.taxAuthorityId"/><entity-find-one entity-name="mantle.humanres.employment.PayrollAdjustment" value-field="payrollAdjustment"><field-map field-name="payrollAdjustmentId" from="payDetail.payrollAdjustmentId"/></entity-find-one><set field="wageAndTaxInfo" from="wageAndTaxInfoByTaxAuthorityId.get(taxAuthorityId)"/><if condition="!wageAndTaxInfo"><entity-find-one entity-name="mantle.other.tax.TaxAuthority" value-field="taxAuthority"/><entity-find-one entity-name="moqui.basic.Geo" value-field="taxAuthorityGeo"><field-map field-name="geoId" from="taxAuthority.taxAuthGeoId"/></entity-find-one><set field="wageAndTaxInfo" from="[taxAuthority:taxAuthority, taxAuthorityGeo:taxAuthorityGeo]"/><script><![CDATA[wageAndTaxInfoByTaxAuthorityId.put(taxAuthorityId, wageAndTaxInfo)]]></script></if><script><![CDATA[if (payrollAdjustment.isTax == 'Y') {
                        addToBigDecimalInMap('incomeTaxWithheldAmount', -payDetail.amount, wageAndTaxInfo)
                    } else if (payrollAdjustment.isSocialTax == 'Y') {
                        addToBigDecimalInMap('socialTaxWithheldAmount', -payDetail.amount, wageAndTaxInfo)
                    } else if (payrollAdjustment.isMedicalTax == 'Y') {
                        addToBigDecimalInMap('medicalTaxWithheldAmount', -payDetail.amount, wageAndTaxInfo)
                    }]]></script></iterate><set field="federalTaxAuthorityIdList" from="[]"/><set field="stateTaxAuthorityIdList" from="[]"/><set field="localTaxAuthorityIdList" from="[]"/><iterate list="wageAndTaxInfoByTaxAuthorityId" entry="wageAndTaxInfo" key="taxAuthorityId"><if condition="wageAndTaxInfo.taxAuthority.taxAuthorityTypeEnumId == 'TatFederal'"><then><script><![CDATA[federalTaxAuthorityIdList.add(taxAuthorityId)]]></script></then><else-if condition="wageAndTaxInfo.taxAuthority.taxAuthorityTypeEnumId == 'TatState'"><script><![CDATA[stateTaxAuthorityIdList.add(taxAuthorityId)]]></script></else-if><else-if condition="wageAndTaxInfo.taxAuthority.taxAuthorityTypeEnumId in ['TatCounty', 'TatCity']"><script><![CDATA[localTaxAuthorityIdList.add(taxAuthorityId)]]></script></else-if></if></iterate></actions></service>