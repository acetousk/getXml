<!--Service Location mantle.work.ManufacturingServices.breakDown#Assembly--><service verb="breakDown" noun="Assembly"><in-parameters><parameter name="assetId" required="true"/><parameter name="workEffortId" required="true"/><parameter name="quantityToBreakDown" type="BigDecimal"><description><![CDATA[Defaults to Asset.quantityOnHandTotal]]></description></parameter><parameter name="breakDownDate" type="Timestamp" default="ec.user.nowTimestamp"/><parameter name="asset" type="EntityValue"/><parameter name="unissueAssemblyComponents" type="Boolean" default="true"/></in-parameters><out-parameters><parameter name="quantityBrokenDown" type="BigDecimal"/></out-parameters><actions><if condition="asset == null"><entity-find-one entity-name="mantle.product.asset.Asset" value-field="asset" for-update="true"/></if><if condition="quantityToBreakDown == null"><set field="quantityToBreakDown" from="asset.quantityOnHandTotal"/></if><if condition="!quantityToBreakDown"><return/></if><if condition="quantityToBreakDown > asset.quantityOnHandTotal"><return error="true" message="Quantity to break down ${quantityToBreakDown} is more than Asset ${assetId} on hand ${asset.quantityOnHandTotal}"/></if><entity-find entity-name="mantle.product.receipt.AssetReceipt" list="assetReceiptList"><econdition field-name="assetId"/><econdition field-name="workEffortId"/><order-by field-name="assetReceiptId"/></entity-find><set field="quantityRemaining" from="quantityToBreakDown"/><iterate list="assetReceiptList" entry="assetReceipt"><if condition="quantityRemaining == 0.0"><break/></if><set field="quantityToReduce" from="(assetReceipt.quantityAccepted ?: 0.0) > quantityRemaining ?                             quantityRemaining : assetReceipt.quantityAccepted"/><set field="quantityRemaining" from="quantityRemaining > quantityToReduce ? (quantityRemaining - quantityToReduce) : 0.0"/><service-call name="mantle.product.AssetServices.update#AssetAndReceipt" out-map="[assetDetailId:updateOut.assetDetailId]" out-map-add-to-existing="false" in-map="[assetId:assetId, assetReceiptId:assetReceipt.assetReceiptId, workEffortId:workEffortId,                             quantityAccepted:(assetReceipt.quantityAccepted - quantityToReduce)]"/></iterate><set field="quantityBrokenDown" from="quantityToBreakDown - quantityRemaining"/><if condition="unissueAssemblyComponents"><service-call name="mantle.work.ManufacturingServices.unissue#AssemblyComponents" in-map="[workEffortId:workEffortId, assemblyProductId:asset.productId, assemblyQuantity:quantityBrokenDown]"/></if></actions></service>