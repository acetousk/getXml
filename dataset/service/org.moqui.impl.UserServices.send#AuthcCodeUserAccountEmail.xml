<!--Service Location org.moqui.impl.UserServices.send#AuthcCodeUserAccountEmail--><service verb="send" noun="AuthcCodeUserAccountEmail"><in-parameters><parameter name="username" required="true"/></in-parameters><out-parameters><parameter name="singleUseFactorId"/><parameter name="code"/></out-parameters><actions><entity-find-one entity-name="moqui.security.UserAccount" value-field="userAccount"><field-map field-name="username"/></entity-find-one><set field="userId" from="userAccount.userId"/><set field="emailAddress" from="userAccount.emailAddress"/><service-call name="org.moqui.impl.UserServices.create#SingleUseAuthcFactor" in-map="[userId:userId, fromFactorId:'UserAccountEmail']" out-map="[factorId:createSuFactorOut.factorId,code:createSuFactorOut.code,thruDate:createSuFactorOut.thruDate]"/><set field="singleUseFactorId" from="createSuFactorOut.factorId"/><service-call name="org.moqui.impl.EmailServices.send#EmailTemplate" async="true"><field-map field-name="emailTemplateId" value="SINGLE_USE_CODE"/><field-map field-name="toAddresses" from="emailAddress"/><field-map field-name="bodyParameters" from="[code:createSuFactorOut.code,                         thruDateString:ec.l10n.format(createSuFactorOut.thruDate, null)]"/></service-call><message><![CDATA[Authentication code sent to ${emailAddress}]]></message></actions></service>