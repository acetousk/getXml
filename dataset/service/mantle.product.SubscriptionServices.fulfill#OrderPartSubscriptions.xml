<!--Service Location mantle.product.SubscriptionServices.fulfill#OrderPartSubscriptions--><service verb="fulfill" noun="OrderPartSubscriptions"><in-parameters><parameter name="orderId" required="true"/><parameter name="orderPartSeqId" required="true"/></in-parameters><out-parameters/><actions><entity-find entity-name="mantle.order.OrderItem" list="orderItemList"><econdition field-name="orderId"/><econdition field-name="orderPartSeqId"/><order-by field-name="orderItemSeqId"/></entity-find><set field="fulfilledOrderItemList" from="[]"/><iterate list="orderItemList" entry="orderItem"><entity-find-one entity-name="mantle.product.Product" value-field="product" cache="true"><field-map field-name="productId" from="orderItem.productId"/></entity-find-one><if condition="product?.productTypeEnumId in ['PtDigital', 'PtDigitalAsset']"><entity-find entity-name="mantle.product.subscription.ProductSubscriptionResource" list="productSubscriptionResourceList" cache="true"><econdition field-name="productId" from="product.productId"/></entity-find><iterate list="productSubscriptionResourceList" entry="productSubscriptionResource"><entity-find entity-name="mantle.product.subscription.Subscription" list="existingSubscriptionList"><econdition field-name="orderId" from="orderItem.orderId"/><econdition field-name="orderItemSeqId" from="orderItem.orderItemSeqId"/><econdition field-name="subscriptionResourceId" from="productSubscriptionResource.subscriptionResourceId"/></entity-find><if condition="!existingSubscriptionList"><service-call name="mantle.product.SubscriptionServices.fulfill#ProductSubscriptionResource" in-map="[orderId:orderItem.orderId, orderItemSeqId:orderItem.orderItemSeqId,                                         productId:orderItem.productId,                                         subscriptionResourceId:productSubscriptionResource.subscriptionResourceId,                                         fromDate:productSubscriptionResource.fromDate]"/><script><![CDATA[fulfilledOrderItemList.add(orderItem)]]></script></if></iterate></if></iterate><if condition="fulfilledOrderItemList"><service-call name="mantle.account.InvoiceServices.create#EntireOrderPartInvoice" out-map="[invoiceId:context.invoiceId]" in-map="context + [statusId:'InvoiceFinalized', partialOrderItemList:fulfilledOrderItemList]"/><service-call name="mantle.account.PaymentServices.apply#OrderPaymentsToInvoice" in-map="[orderId:orderId, orderPartSeqId:orderPartSeqId, invoiceId:invoiceId]"/><service-call name="mantle.order.OrderServices.checkComplete#OrderPart" in-map="[orderId:orderId, orderPartSeqId:orderPartSeqId]"/></if></actions></service>