<!--Service Location mantle.ledger.LedgerServices.recalculate#GlAccountOrgTimePeriodAmounts--><service verb="recalculate" noun="GlAccountOrgTimePeriodAmounts"><in-parameters><parameter name="timePeriodId" required="true"/></in-parameters><out-parameters/><actions><entity-find-one entity-name="mantle.party.time.TimePeriod" value-field="timePeriod" for-update="true"/><service-call name="mantle.party.TimeServices.get#TimePeriodInfo" in-map="[timePeriod:timePeriod]" out-map="[timePeriod:periodInfo.timePeriod,fromTimestamp:periodInfo.fromTimestamp,thruTimestamp:periodInfo.thruTimestamp,thruTimestampExclusive:periodInfo.thruTimestampExclusive,thruTimestampLate:periodInfo.thruTimestampLate]"/><set field="fromTimestamp" from="periodInfo.fromTimestamp"/><set field="thruTimestamp" from="periodInfo.thruTimestamp"/><service-call name="mantle.party.TimeServices.getOrCreate#NextTimePeriod" out-map="[nextTimePeriodId:context.nextTimePeriodId,nextTimePeriod:context.nextTimePeriod]" in-map="[timePeriodId:timePeriodId]"/><set field="subsequentPeriodIds" from="[nextTimePeriodId]"/><set field="curSubPeriodId" from="nextTimePeriodId"/><script><![CDATA[while (curSubPeriodId) {
                Map subNextResult = ec.service.sync().name("mantle.party.TimeServices.get#NextTimePeriod")
                        .parameter("timePeriodId", curSubPeriodId).call()
                curSubPeriodId = subNextResult.nextTimePeriodId
                if (curSubPeriodId) subsequentPeriodIds.add(curSubPeriodId)
            }]]></script><entity-find entity-name="mantle.ledger.transaction.AcctgTransAndEntrySummary" list="allTransSummaryList"><econdition field-name="organizationPartyId" from="timePeriod.partyId"/><econdition field-name="transactionDate" operator="greater-equals" from="fromTimestamp"/><econdition field-name="transactionDate" operator="less-equals" from="thruTimestamp"/><econdition field-name="isPosted" value="Y"/><select-field field-name="glAccountId,acctgTransTypeEnumId,debitCreditFlag,amount"/><order-by field-name="glAccountId,acctgTransTypeEnumId,debitCreditFlag"/></entity-find><entity-find entity-name="mantle.ledger.account.GlAccountOrgTimePeriod" list="glAccountOrgTimePeriodList" for-update="true"><econdition field-name="organizationPartyId" from="timePeriod.partyId"/><econdition field-name="timePeriodId"/></entity-find><iterate list="glAccountOrgTimePeriodList" entry="glAccountOrgTimePeriod"><set field="origGlAccountOrgTimePeriod" from="glAccountOrgTimePeriod.cloneValue()"/><set field="transSummaryList" from="allTransSummaryList.cloneList().filterByAnd([glAccountId:glAccountOrgTimePeriod.glAccountId])"/><set field="postedDebits" from="0.0"/><set field="postedCredits" from="0.0"/><set field="postedDebitsNoClosing" from="0.0"/><set field="postedCreditsNoClosing" from="0.0"/><iterate list="transSummaryList" entry="transSummary"><if condition="transSummary.debitCreditFlag == 'D'"><then><set field="postedDebits" from="postedDebits + transSummary.amount"/><if condition="transSummary.acctgTransTypeEnumId != 'AttNetIncomeClosing'"><set field="postedDebitsNoClosing" from="postedDebitsNoClosing + transSummary.amount"/></if></then><else><set field="postedCredits" from="postedCredits + transSummary.amount"/><if condition="transSummary.acctgTransTypeEnumId != 'AttNetIncomeClosing'"><set field="postedCreditsNoClosing" from="postedCreditsNoClosing + transSummary.amount"/></if></else></if></iterate><if condition="postedDebits != glAccountOrgTimePeriod.postedDebits"><set field="glAccountOrgTimePeriod.postedDebits" from="postedDebits"/></if><if condition="postedCredits != glAccountOrgTimePeriod.postedCredits"><set field="glAccountOrgTimePeriod.postedCredits" from="postedCredits"/></if><if condition="postedDebitsNoClosing != glAccountOrgTimePeriod.postedDebitsNoClosing"><set field="glAccountOrgTimePeriod.postedDebitsNoClosing" from="postedDebitsNoClosing"/></if><if condition="postedCreditsNoClosing != glAccountOrgTimePeriod.postedCreditsNoClosing"><set field="glAccountOrgTimePeriod.postedCreditsNoClosing" from="postedCreditsNoClosing"/></if><if condition="glAccountOrgTimePeriod.isModified()"><entity-find-one entity-name="mantle.ledger.account.GlAccount" value-field="glAccount" cache="true"><field-map field-name="glAccountId" from="glAccountOrgTimePeriod.glAccountId"/></entity-find-one><if condition="glAccount.isDebit.equals('Y')"><then><set field="glAccountOrgTimePeriod.endingBalance" from="(glAccountOrgTimePeriod.beginningBalance?:0.0) +                                 (glAccountOrgTimePeriod.postedDebits?:0.0) - (glAccountOrgTimePeriod.postedCredits?:0.0)"/></then><else><set field="glAccountOrgTimePeriod.endingBalance" from="(glAccountOrgTimePeriod.beginningBalance?:0.0) -                                 (glAccountOrgTimePeriod.postedDebits?:0.0) + (glAccountOrgTimePeriod.postedCredits?:0.0)"/></else></if><message><![CDATA[Found GlAccount Org TimePeriod (org ${glAccountOrgTimePeriod.organizationPartyId}, period ${glAccountOrgTimePeriod.timePeriodId}, account ${glAccountOrgTimePeriod.glAccountId}, is debit ${glAccount.isDebit}) with stale posted amounts; beginningBalance=${glAccountOrgTimePeriod.beginningBalance}, postedDebits was ${origGlAccountOrgTimePeriod.postedDebits} is ${glAccountOrgTimePeriod.postedDebits}, postedCredits was ${origGlAccountOrgTimePeriod.postedCredits} is ${glAccountOrgTimePeriod.postedCredits}, endingBalance was ${origGlAccountOrgTimePeriod.endingBalance} is ${glAccountOrgTimePeriod.endingBalance}]]></message><log message="In close#FinancialTimePeriod found GlAccountOrgTimePeriod (organizationPartyId=${glAccountOrgTimePeriod.organizationPartyId}, timePeriodId=${glAccountOrgTimePeriod.timePeriodId}, glAccountId=${glAccountOrgTimePeriod.glAccountId}, is debit ${glAccount.isDebit}) with wrong posted amounts; beginningBalance=${glAccountOrgTimePeriod.beginningBalance}, postedDebits was ${origGlAccountOrgTimePeriod.postedDebits} is ${glAccountOrgTimePeriod.postedDebits}, postedCredits was ${origGlAccountOrgTimePeriod.postedCredits} is ${glAccountOrgTimePeriod.postedCredits}, endingBalance was ${origGlAccountOrgTimePeriod.endingBalance} is ${glAccountOrgTimePeriod.endingBalance}"/><set field="glAccountOrgTimePeriod.balanceLastUpdated" from="ec.user.nowTimestamp"/><entity-update value-field="glAccountOrgTimePeriod"/></if><set field="lastGlAccountOrgTimePeriod" from="glAccountOrgTimePeriod"/><iterate list="subsequentPeriodIds" entry="subsequentPeriodId"><entity-find-one entity-name="mantle.ledger.account.GlAccountOrgTimePeriod" value-field="nextGlAccountOrgTimePeriod" for-update="true"><field-map field-name="glAccountId" from="glAccountOrgTimePeriod.glAccountId"/><field-map field-name="organizationPartyId" from="timePeriod.partyId"/><field-map field-name="timePeriodId" from="subsequentPeriodId"/></entity-find-one><if condition="nextGlAccountOrgTimePeriod == null"><entity-make-value entity-name="mantle.ledger.account.GlAccountOrgTimePeriod" value-field="nextGlAccountOrgTimePeriod" map="[glAccountId:glAccountOrgTimePeriod.glAccountId,  organizationPartyId:timePeriod.partyId,                                 timePeriodId:subsequentPeriodId, beginningBalance:0.0, postedDebits:0.0, postedCredits:0.0,                                 postedDebitsNoClosing:0.0, postedCreditsNoClosing:0.0, endingBalance:0.0]"/></if><set field="nextGlAccountOrgTimePeriod.endingBalance" from="((nextGlAccountOrgTimePeriod.endingBalance ?: 0.0) - (nextGlAccountOrgTimePeriod.beginningBalance ?: 0.0)) +                                 lastGlAccountOrgTimePeriod.endingBalance"/><set field="nextGlAccountOrgTimePeriod.beginningBalance" from="lastGlAccountOrgTimePeriod.endingBalance"/><set field="nextGlAccountOrgTimePeriod.balanceLastUpdated" from="ec.user.nowTimestamp"/><entity-create value-field="nextGlAccountOrgTimePeriod" or-update="true"/><set field="lastGlAccountOrgTimePeriod" from="nextGlAccountOrgTimePeriod"/></iterate></iterate></actions></service>