<!--Service Location coarchy.CoarchyServices.move#Activities--><service verb="move" noun="Activities"><in-parameters><parameter name="activityId" required="true"/><parameter name="moveType" required="true"/><parameter name="organizationId" required="true"/><parameter name="processStoryId" required="true"/><parameter name="insertActivityId"/><parameter name="insertType" required="true"/><parameter name="activityIdNum" required="true" type="Integer"/></in-parameters><out-parameters><parameter name="pageIndex"/><parameter name="activityId"/><parameter name="clipboardEntryId"/></out-parameters><actions><if condition="ec.user.context?.activityIdList==null"><set field="ec.user.context.activityIdList" from="[]"/></if><set field="ec.user.context.activityIdList" from="ec.user.context.activityIdList + [activityId]"/><set field="activityIdList" from="ec.user.context.activityIdList"/><if condition="activityIdList.size() == activityIdNum.toInteger()"><entity-find entity-name="coarchy.ProcessStoryActivityDetail" list="originalProcessStoryActivityList" distinct="true"><date-filter/><econdition field-name="activityId" operator="in" from="activityIdList"/><select-field field-name="processStoryActivityId,sequenceNum,detailProcessStoryId,action,condition,activityId,implementationId"/><order-by field-name="sequenceNum"/></entity-find><set field="activeOrgId" from="ec.user.context?.activeOrgId"/><set field="ec.user.context?.activeOrgId" from="organizationId"/><set field="ec.user.context?.filterOrgIds" from="[organizationId]"/><entity-find entity-name="coarchy.ProcessStoryActivityDetail" list="insertProcessStoryActivityList" distinct="true" limit="1"><date-filter/><econdition field-name="activityId" from="insertActivityId"/><select-field field-name="processStoryActivityId,sequenceNum,detailProcessStoryId,action,condition,activityId,implementationId"/><order-by field-name="sequenceNum"/></entity-find><set field="insertActivity" from="insertProcessStoryActivityList?.getFirst()"/><set field="insertSequenceNum" from="insertActivity?.sequenceNum?:0"/><if condition="insertType=='below'"><set field="pageIndex" from="downPageIndex"/><entity-find entity-name="coarchy.ProcessStoryActivityDetail" list="processStoryActivityMaxList" limit="1"><date-filter/><econdition field-name="processStoryId"/><econdition field-name="sequenceNum" operator="greater" from="insertActivity?.sequenceNum?.toInteger()" ignore="!insertActivity"/><select-field field-name="processStoryActivityId,sequenceNum"/><order-by field-name="sequenceNum"/></entity-find><set field="insertSequenceNum" from="processStoryActivityMaxList?.getFirst()?.sequenceNum?:(insertSequenceNum?:0)"/></if><entity-find entity-name="coarchy.ProcessStoryActivityDetail" list="processStoryActivityList"><date-filter/><econdition field-name="processStoryId"/><econdition field-name="sequenceNum" operator="greater-equals" from="insertSequenceNum?.toInteger()" ignore-if-empty="true"/><select-field field-name="processStoryActivityId,sequenceNum,activityId"/><order-by field-name="-sequenceNum"/></entity-find><iterate list="processStoryActivityList" entry="processStoryActivity"><service-call name="update#coarchy.ProcessStoryActivity" in-map="[processStoryActivityId:                             processStoryActivity.processStoryActivityId,sequenceNum:                             processStoryActivity.sequenceNum+originalProcessStoryActivityList.size()]"/></iterate><set field="actorIdMap" from="[:]"/><set field="valueStatementIdMap" from="[:]"/><if condition="organizationId!=activeOrgId"><set field="ec.user.context?.activeOrgId" from="activeOrgId"/><set field="ec.user.context?.filterOrgIds" from="[activeOrgId]"/></if><entity-find entity-name="coarchy.ActivityActorDetail" list="activityActorList" distinct="true"><econdition field-name="activityId" from="originalProcessStoryActivityList*.activityId"/><select-field field-name="actorId,activityId,name,description"/><order-by field-name="name"/></entity-find><entity-find entity-name="coarchy.ValueStatementActivityDetail" list="statementActivityDetailList" distinct="true"><date-filter/><econdition field-name="activityId" from="originalProcessStoryActivityList*.activityId"/><select-field field-name="valueStatementId,activityId,value,typeEnumId"/><order-by field-name="statementSeqId"/></entity-find><if condition="organizationId!=activeOrgId"><set field="ec.user.context?.activeOrgId" from="organizationId"/><set field="ec.user.context?.filterOrgIds" from="[organizationId]"/></if><iterate list="activityActorList" entry="activityActor"><entity-find entity-name="coarchy.ActivityActorDetail" list="insideActivityActorList" distinct="true" limit="1"><econdition field-name="name" from="activityActor.name" ignore-case="true"/><select-field field-name="actorId,name"/><order-by field-name="name"/></entity-find><if condition="!insideActivityActorList"><then><if condition="!actorIdMap.keys?.contains(activityActor.actorId)"><service-call name="create#coarchy.Actor" in-map="[name:activityActor.name,                                 description:activityActor.description,organizationId:organizationId]" out-map="[actorId:actorContext.actorId,name:actorContext.name,description:actorContext.description,organizationId:actorContext.organizationId,lastUpdatedStamp:actorContext.lastUpdatedStamp]"/><script><![CDATA[actorIdMap.put(activityActor.actorId,actorContext.actorId)]]></script></if></then><else><script><![CDATA[actorIdMap.put(activityActor.actorId,insideActivityActorList.getFirst().actorId)]]></script></else></if></iterate><iterate list="statementActivityDetailList" entry="statementActivity"><entity-find entity-name="coarchy.ValueStatement" list="insideStatementList" distinct="true" limit="1"><econdition field-name="disabled" value="N" or-null="true"/><econdition field-name="replacedByValueStatementId" operator="is-null"/><econdition field-name="value" from="statementActivity.value"/><econdition field-name="typeEnumId" from="statementActivity.typeEnumId"/><select-field field-name="valueStatementId,value,typeEnumId"/><order-by field-name="value"/></entity-find><if condition="!insideStatementList"><then><if condition="!valueStatementIdMap.keys?.contains(statementActivity.valueStatementId)"><service-call name="create#coarchy.ValueStatement" in-map="[value:statementActivity.value,                                     typeEnumId:statementActivity.typeEnumId,organizationId:organizationId]" out-map="[valueStatementId:valueStatementContext.valueStatementId,value:valueStatementContext.value,sequenceNum:valueStatementContext.sequenceNum,typeEnumId:valueStatementContext.typeEnumId,disabled:valueStatementContext.disabled,replacedByValueStatementId:valueStatementContext.replacedByValueStatementId,organizationId:valueStatementContext.organizationId,lastUpdatedStamp:valueStatementContext.lastUpdatedStamp]"/><script><![CDATA[valueStatementIdMap.put(statementActivity.valueStatementId,valueStatementContext?.valueStatementId)]]></script></if></then><else><script><![CDATA[valueStatementIdMap.put(statementActivity.valueStatementId,insideStatementList.getFirst().valueStatementId)]]></script></else></if></iterate><iterate list="originalProcessStoryActivityList" entry="activity"><set field="actorIdList" from="activityActorList.findAll{ it.activityId == activity.activityId }*.actorId"/><set field="statementIdList" from="statementActivityDetailList.findAll{ it.activityId == activity.activityId }*.valueStatementId"/><if condition="organizationId==activeOrgId"><then/><else><set field="actorIdList" from="actorIdList.collect{ actorIdMap[it] }"/><set field="statementIdList" from="statementIdList.collect{ valueStatementIdMap[it] }"/></else></if><service-call name="coarchy.CoarchyServices.create#Activity" in-map="[processStoryId:processStoryId,organizationId:organizationId,condition:activity.condition,action:activity.action,actorIdList:actorIdList,statementIdList:statementIdList,sequenceNum:insertSequenceNum+activity_index,implementationId:activity.implementationId,ignoreNoAction:true]"/></iterate><if condition="moveType=='cut'"><iterate list="activityIdList" entry="activityId"><set field="ec.user.context?.activeOrgId" from="activeOrgId"/><set field="ec.user.context?.filterOrgIds" from="[activeOrgId]"/><service-call name="coarchy.CoarchyServices.delete#Activity" in-map="[activityId:activityId]"/><set field="ec.user.context?.activeOrgId" from="organizationId"/><set field="ec.user.context?.filterOrgIds" from="[organizationId]"/></iterate></if><service-call name="org.moqui.impl.UserServices.set#Preference" in-map="[preferenceKey:'ACTIVE_ORGANIZATION',preferenceValue:organizationId]"/></if></actions></service>