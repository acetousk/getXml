<!--Service Location mantle.ledger.LedgerServices.unpost#AcctgTrans--><service verb="unpost" noun="AcctgTrans"><in-parameters><parameter name="acctgTransId" required="true" entity-name="mantle.ledger.transaction.AcctgTrans" field-name="acctgTransId"/></in-parameters><out-parameters/><actions><entity-find-one entity-name="mantle.ledger.transaction.AcctgTrans" value-field="acctgTrans" for-update="true"/><if condition="acctgTrans.isPosted != 'Y'"><return message="Transaction ${acctgTransId} not posted, not un-posting"/></if><service-call name="mantle.ledger.LedgerServices.find#PartyAcctgPreference" out-map="[partyAcctgPreference:context.partyAcctgPreference]" in-map="[organizationPartyId:acctgTrans.organizationPartyId]"/><set field="doRealTimeGlSummary" from="partyAcctgPreference?.realTimeGlSummary == 'Y'"/><service-call name="mantle.ledger.LedgerServices.get#OrganizationFiscalTimePeriods" out-map="[timePeriodList:context.timePeriodList]" in-map="[organizationPartyId:acctgTrans.organizationPartyId, filterDate:acctgTrans.transactionDate]"/><if condition="!timePeriodList"><message error="true"><![CDATA[Not un-posting transaction ${acctgTransId}, could not find time period for organization ${acctgTrans.organizationPartyId} at ${ec.l10n.format(acctgTrans.transactionDate, null)}.]]></message></if><iterate list="timePeriodList" entry="timePeriod"><if condition="timePeriod.isClosed == 'Y' && !(acctgTrans.acctgTransTypeEnumId in ['AttPeriodClosing', 'AttNetIncomeClosing'])"><message error="true"><![CDATA[Not un-posting transaction ${acctgTransId}, time period closed ${ec.resource.expand('TimePeriodNameTemplate','',timePeriod)}.]]></message></if></iterate><if condition="doRealTimeGlSummary"><service-call name="mantle.ledger.LedgerServices.update#GlAccountOrgSummariesForTx" in-map="[acctgTransId:acctgTransId, timePeriodList:timePeriodList, isUnpost:true]"/></if><check-errors/><set field="acctgTrans.isPosted" value="N"/><set field="acctgTrans.postedDate" from="null"/><entity-update value-field="acctgTrans"/></actions></service>