<!--Service Location mantle.ledger.InvoiceAutoPostServices.post#InvoiceAdjustment--><service verb="post" noun="InvoiceAdjustment"><in-parameters><parameter name="invoiceId" required="true"/><parameter name="invoiceItemSeqId" required="true"/></in-parameters><out-parameters><parameter name="fromAcctgTransId"/><parameter name="toAcctgTransId"/></out-parameters><actions><entity-find entity-name="mantle.ledger.transaction.AcctgTransAndEntry" list="existingTransList"><econdition field-name="invoiceId"/><econdition field-name="invoiceItemSeqId"/><econdition field-name="acctgTransTypeEnumId" value="AttInvoiceAdjust"/><econdition field-name="reversedByAcctgTransId" from="null"/><econdition field-name="reverseOfAcctgTransId" from="null"/></entity-find><if condition="existingTransList"><return message="Invoice Adjustment Item ${invoiceId}:${invoiceItemSeqId} has already been posted in accounting transaction ${existingTransList*.acctgTransId}"/></if><entity-find-one entity-name="mantle.account.invoice.Invoice" value-field="invoice"/><if condition="invoice == null"><return error="true" message="Could not find Invoice with ID ${invoiceId}"/></if><entity-find-one entity-name="mantle.account.invoice.InvoiceItem" value-field="invoiceItem"/><if condition="invoiceItem == null"><return error="true" message="Could not find Invoice Item with ID ${invoiceId}:${invoiceItemSeqId}"/></if><if condition="invoiceItem.isAdjustment != 'Y'"><return error="true" message="Invoice Item with ID ${invoiceId}:${invoiceItemSeqId} is not an Adjustment item, cannot post separately to GL"/></if><entity-find-one entity-name="mantle.party.PartyRole" value-field="fromPartyRole"><field-map field-name="partyId" from="invoice.overrideOrgPartyId ?: invoice.fromPartyId"/><field-map field-name="roleTypeId" value="OrgInternal"/></entity-find-one><if condition="fromPartyRole"><service-call name="mantle.ledger.LedgerServices.find#PartyAcctgPreference" out-map="[partyAcctgPreference:fromPapOut.partyAcctgPreference]" in-map="[organizationPartyId:fromPartyRole.partyId]"/><set field="fromPartyAcctgPreference" from="fromPapOut.partyAcctgPreference"/></if><entity-find-one entity-name="mantle.party.PartyRole" value-field="toPartyRole"><field-map field-name="partyId" from="invoice.overrideOrgPartyId ?: invoice.toPartyId"/><field-map field-name="roleTypeId" value="OrgInternal"/></entity-find-one><if condition="toPartyRole"><service-call name="mantle.ledger.LedgerServices.find#PartyAcctgPreference" out-map="[partyAcctgPreference:toPapOut.partyAcctgPreference]" in-map="[organizationPartyId:toPartyRole.partyId]"/><set field="toPartyAcctgPreference" from="toPapOut.partyAcctgPreference"/></if><if condition="!fromPartyAcctgPreference && !toPartyAcctgPreference"><log level="trace" message="Not posting Invoice Adjustment Item [${invoiceId}:${invoiceItemSeqId}], could not find PartyAcctgPreference for From Party [${invoice.fromPartyId}], To Party [${invoice.toPartyId}], or Invoice Override Party [${invoice.overrideOrgPartyId}]"/><return/></if><set field="useErrorJournal" from="false"/><set field="transactionDate" from="invoiceItem.itemDate ?: invoice.invoiceDate"/><if condition="fromPartyAcctgPreference"><service-call name="mantle.ledger.InvoiceAutoPostServices.get#InvoiceTypeTransType" out-map="[acctgTransTypeEnumId:fromInvoiceTypeTransTypeOut.acctgTransTypeEnumId,glAccountId:fromInvoiceTypeTransTypeOut.glAccountId,glAccountTypeEnumId:fromInvoiceTypeTransTypeOut.glAccountTypeEnumId]" in-map="[invoiceTypeEnumId:invoice.invoiceTypeEnumId, organizationPartyId:invoice.fromPartyId, isPayable:'N']"/><service-call name="mantle.ledger.LedgerServices.create#AcctgTrans" out-map="[acctgTransId:context.acctgTransId]" in-map="[acctgTransTypeEnumId:'AttInvoiceAdjust',                             organizationPartyId:invoice.fromPartyId, otherPartyId:invoice.toPartyId,                             amountUomId:invoice.currencyUomId, invoiceId:invoiceId, transactionDate:transactionDate]"/><entity-find-one entity-name="mantle.ledger.transaction.AcctgTrans" value-field="fromAcctgTrans"/></if><if condition="toPartyAcctgPreference"><service-call name="mantle.ledger.InvoiceAutoPostServices.get#InvoiceTypeTransType" out-map="[acctgTransTypeEnumId:toInvoiceTypeTransTypeOut.acctgTransTypeEnumId,glAccountId:toInvoiceTypeTransTypeOut.glAccountId,glAccountTypeEnumId:toInvoiceTypeTransTypeOut.glAccountTypeEnumId]" in-map="[invoiceTypeEnumId:invoice.invoiceTypeEnumId, organizationPartyId:invoice.toPartyId, isPayable:'Y']"/><service-call name="mantle.ledger.LedgerServices.create#AcctgTrans" out-map="[acctgTransId:context.acctgTransId]" in-map="[acctgTransTypeEnumId:'AttInvoiceAdjust',                             organizationPartyId:invoice.toPartyId, otherPartyId:invoice.fromPartyId,                             amountUomId:invoice.currencyUomId, invoiceId:invoiceId, transactionDate:transactionDate]"/><entity-find-one entity-name="mantle.ledger.transaction.AcctgTrans" value-field="toAcctgTrans"/></if><set field="invoiceTotal" from="0.0"/><set field="itemTotal" from="(invoiceItem.amount ?: 0.0) * (invoiceItem.quantity ?: 1.0)"/><if condition="itemTotal == 0.0"><return/></if><set field="invoiceTotal" from="invoiceTotal + itemTotal"/><set field="entryCommonMap" from="[invoiceItemSeqId:invoiceItem.invoiceItemSeqId,                     productId:invoiceItem.productId, assetId:invoiceItem.assetId]"/><if condition="fromPartyAcctgPreference"><set field="itemGlAccountId" from="invoiceItem.overrideGlAccountId"/><if condition="!itemGlAccountId"><then><service-call name="mantle.ledger.InvoiceAutoPostServices.get#InvoiceItemGlAccount" in-map="[acctgTransTypeEnumId:fromAcctgTrans.acctgTransTypeEnumId,                                 organizationPartyId:fromAcctgTrans.organizationPartyId,                                 otherPartyId:fromAcctgTrans.otherPartyId, itemTypeEnumId:invoiceItem.itemTypeEnumId,                                 productId:invoiceItem.productId, assetId:invoiceItem.assetId, direction:'O']" out-map="[glAccountId:invoiceItemGlAccountOut.glAccountId,glAccountTypeEnumId:invoiceItemGlAccountOut.glAccountTypeEnumId,glAccount:invoiceItemGlAccountOut.glAccount]" out-map-add-to-existing="false"/><set field="itemGlAccountId" from="invoiceItemGlAccountOut?.glAccountId"/><set field="itemGlAccountTypeEnumId" from="invoiceItemGlAccountOut?.glAccountTypeEnumId"/></then><else><entity-find-one entity-name="mantle.ledger.account.GlAccount" value-field="glAccount" cache="true"><field-map field-name="glAccountId" from="itemGlAccountId"/></entity-find-one><set field="itemGlAccountTypeEnumId" from="glAccount?.glAccountTypeEnumId"/></else></if><if condition="!itemGlAccountId"><set field="useErrorJournal" from="true"/></if><service-call name="mantle.ledger.LedgerServices.create#AcctgTransEntry" in-map="entryCommonMap + [amount:itemTotal, acctgTransId:fromAcctgTrans.acctgTransId,                             acctgTrans:fromAcctgTrans, debitCreditFlag:'C', glAccountTypeEnumId:itemGlAccountTypeEnumId,                             glAccountId:itemGlAccountId]"/></if><if condition="toPartyAcctgPreference"><set field="itemGlAccountId" from="invoiceItem.overrideGlAccountId"/><if condition="!itemGlAccountId"><then><service-call name="mantle.ledger.InvoiceAutoPostServices.get#InvoiceItemGlAccount" in-map="[acctgTransTypeEnumId:toAcctgTrans.acctgTransTypeEnumId,                                 organizationPartyId:toAcctgTrans.organizationPartyId,                                 otherPartyId:toAcctgTrans.otherPartyId, itemTypeEnumId:invoiceItem.itemTypeEnumId,                                 productId:invoiceItem.productId, assetId:invoiceItem.assetId, direction:'I']" out-map="[glAccountId:invoiceItemGlAccountOut.glAccountId,glAccountTypeEnumId:invoiceItemGlAccountOut.glAccountTypeEnumId,glAccount:invoiceItemGlAccountOut.glAccount]" out-map-add-to-existing="false"/><set field="itemGlAccountId" from="invoiceItemGlAccountOut?.glAccountId"/><set field="itemGlAccountTypeEnumId" from="invoiceItemGlAccountOut?.glAccountTypeEnumId"/></then><else><entity-find-one entity-name="mantle.ledger.account.GlAccount" value-field="glAccount" cache="true"><field-map field-name="glAccountId" from="itemGlAccountId"/></entity-find-one><set field="itemGlAccountTypeEnumId" from="glAccount?.glAccountTypeEnumId"/></else></if><if condition="!itemGlAccountId"><set field="useErrorJournal" from="true"/></if><service-call name="mantle.ledger.LedgerServices.create#AcctgTransEntry" in-map="entryCommonMap + [amount:itemTotal, acctgTransId:toAcctgTrans.acctgTransId, acctgTrans:toAcctgTrans,                             debitCreditFlag:'D', glAccountTypeEnumId:itemGlAccountTypeEnumId, glAccountId:itemGlAccountId]"/></if><if condition="fromPartyAcctgPreference"><if condition="!fromInvoiceTypeTransTypeOut.glAccountId"><set field="useErrorJournal" from="true"/></if><service-call name="mantle.ledger.LedgerServices.create#AcctgTransEntry" in-map="[amount:invoiceTotal, acctgTransId:fromAcctgTrans.acctgTransId, acctgTrans:fromAcctgTrans,                             debitCreditFlag:'D', glAccountTypeEnumId:fromInvoiceTypeTransTypeOut.glAccountTypeEnumId,                             glAccountId:fromInvoiceTypeTransTypeOut.glAccountId]"/></if><if condition="toPartyAcctgPreference"><if condition="!toInvoiceTypeTransTypeOut.glAccountId"><set field="useErrorJournal" from="true"/></if><service-call name="mantle.ledger.LedgerServices.create#AcctgTransEntry" in-map="[amount:invoiceTotal, acctgTransId:toAcctgTrans.acctgTransId, acctgTrans:toAcctgTrans,                             debitCreditFlag:'C', glAccountTypeEnumId:toInvoiceTypeTransTypeOut.glAccountTypeEnumId,                             glAccountId:toInvoiceTypeTransTypeOut.glAccountId]"/></if><if condition="useErrorJournal"><then><if condition="fromPartyAcctgPreference?.errorGlJournalId"><service-call name="update#mantle.ledger.transaction.AcctgTrans" in-map="[acctgTransId:fromAcctgTrans.acctgTransId,                                 glJournalId:fromPartyAcctgPreference.errorGlJournalId]"/></if><if condition="toPartyAcctgPreference?.errorGlJournalId"><service-call name="update#mantle.ledger.transaction.AcctgTrans" in-map="[acctgTransId:toAcctgTrans.acctgTransId,                                 glJournalId:toPartyAcctgPreference.errorGlJournalId]"/></if></then><else><if condition="fromPartyAcctgPreference"><service-call name="mantle.ledger.LedgerServices.post#AcctgTrans" in-map="[acctgTransId:fromAcctgTrans.acctgTransId]"/></if><if condition="toPartyAcctgPreference"><service-call name="mantle.ledger.LedgerServices.post#AcctgTrans" in-map="[acctgTransId:toAcctgTrans.acctgTransId]"/></if></else></if><set field="invoice.acctgTransResultEnumId" value="AtrSuccess"/><entity-update value-field="invoice"/><set field="fromAcctgTransId" from="fromAcctgTrans?.acctgTransId"/><set field="toAcctgTransId" from="toAcctgTrans?.acctgTransId"/></actions></service>