<!--Service Location ai.get#ScriptureReport--><service verb="get" noun="ScriptureReport"><in-parameters/><out-parameters/><actions><entity-find entity-name="ai.sql.MormonScriptures" list="mormonScripturesList"><econdition field-name="volumeTitle" value="Book of Mormon"/><order-by field-name="volumeId,bookId,chapterId,verseId"/></entity-find><set field="mormonScripturesReportMap" from="[:]"/><set field="elasticClient" from="ec.factory.elastic.getClient((String) 'default')"/><iterate list="mormonScripturesList" entry="mormonScripture"><log level="warn" message="mormonScripture: ${mormonScripture.volumeTitle} ${mormonScripture.verseTitle}"/><set field="inputMap" from="['_source':['exclude':                         ['volumeSubtitle','volumeLdsUrl','_entity','volumeShortTitle','bookLdsUrl','bookLongTitle','volumeId',                         'bookShortTitle','verseShortTitle','bookTitle','scriptureTestEmbedding','volumeTitle','verseId','chapterId',                         'verseNumber','chapterNumber','bookId','_index','_id','bookSubtitle']],                     'query':['hybrid':['queries':[                         ['match':['scriptureText':['query':mormonScripture.scriptureText]]],                         ['neural':['scriptureTestEmbedding':['query_text':'${mormonScripture.scriptureText}','model_id':'by3bvJABBw3NiI4nj1ib','k':100]]],]]],                     'size':10                         ]"/><set field="productSearchOut" from="elasticClient.search('mormon_scriptures', inputMap)"/><set field="maxHitsMap" from="productSearchOut.hits.hits.findAll { it._source.verseTitle != mormonScripture.verseTitle && it._score.toString().getAt(0)!='-' }.max{ it.score }"/><if condition="maxHitsMap._score.toString().getAt(0)=='-'"><log level="warn" message="mormonScripture: ${mormonScripture.volumeTitle} ${mormonScripture.verseTitle} ${mormonScripture.scriptureText}"/><log level="warn" message="productSearchOut.hits.hits: ${groovy.json.JsonOutput.prettyPrint(groovy.json.JsonOutput.toJson(productSearchOut.hits.hits))}"/></if><set field="subMormonScripturesReportMap" from="[verseTitle:mormonScripture.verseTitle,scriptureText:mormonScripture.scriptureText,maxScore:productSearchOut.hits.max_score,_score:maxHitsMap._score,similarVerseTitle:maxHitsMap._source.verseTitle,similarVolumeLongTitle:maxHitsMap._source.volumeLongTitle,similarScriptureText:maxHitsMap._source.scriptureText,similarPercentOfMax:(maxHitsMap._score/productSearchOut.hits.max_score)*100]"/><if condition="subMormonScripturesReportMap._score"><script><![CDATA[mormonScripturesReportMap[mormonScripture.volumeTitle+' '+mormonScripture.verseTitle]=subMormonScripturesReportMap]]></script></if></iterate><script><![CDATA[java.nio.file.Files.write(java.nio.file.Paths.get("/home/user/mormonFullFixed.json"), groovy.json.JsonOutput.prettyPrint(groovy.json.JsonOutput.toJson(mormonScripturesReportMap)).getBytes());]]></script></actions></service>