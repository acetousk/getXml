<!--Service Location mantle.work.ShipmentWorkServices.make#ShipmentLoadOrderConditions--><service verb="make" noun="ShipmentLoadOrderConditions"><in-parameters><parameter name="excludeOnPicklist" type="Boolean" default="true"/><parameter name="inventoryCategoryId"/></in-parameters><out-parameters><parameter name="excludeOnPicklistCond" type="org.moqui.entity.EntityCondition"/><parameter name="inventoryCategoryCond" type="org.moqui.entity.EntityCondition"/></out-parameters><actions><if condition="excludeOnPicklist"><then><set field="excludeOnPicklistCond" from="ec.entity.getConditionFactory().makeConditionWhere('''NOT EXISTS                     (SELECT SHMT.SHIPMENT_ID                      FROM SHIPMENT_ITEM_SOURCE SHIS INNER JOIN SHIPMENT SHMT ON SHIS.SHIPMENT_ID = SHMT.SHIPMENT_ID                      WHERE SHIS.ORDER_ID = OITM.ORDER_ID AND SHIS.ORDER_ITEM_SEQ_ID = OITM.ORDER_ITEM_SEQ_ID                         AND (SHMT.SHIP_WORK_EFFORT_ID IS NOT NULL OR SHMT.STATUS_ID NOT IN ('ShipInput', 'ShipScheduled', 'ShipRejected', 'ShipCancelled'))                         AND SHIS.QUANTITY > 0)''')"/></then><else><set field="excludeOnPicklistCond" from="ec.entity.getConditionFactory().makeConditionWhere('''NOT EXISTS                     (SELECT SHMT.SHIPMENT_ID                      FROM SHIPMENT_ITEM_SOURCE SHIS INNER JOIN SHIPMENT SHMT ON SHIS.SHIPMENT_ID = SHMT.SHIPMENT_ID                      WHERE SHIS.ORDER_ID = OITM.ORDER_ID AND SHIS.ORDER_ITEM_SEQ_ID = OITM.ORDER_ITEM_SEQ_ID                         AND SHMT.STATUS_ID NOT IN ('ShipInput', 'ShipScheduled', 'ShipRejected', 'ShipCancelled') AND SHIS.QUANTITY > 0)''')"/></else></if><if condition="inventoryCategoryId"><set field="categoryIdList" from="inventoryCategoryId.split(',') as List"/><set field="categoryIdSb" from="new StringBuilder()"/><iterate list="categoryIdList" entry="categoryId"><if condition="!categoryId"><continue/></if><if condition="categoryId.contains('\'')"><return error="true" message="Invalid Category ID ${categoryId}"/></if><entity-find-one entity-name="mantle.product.category.ProductCategory" value-field="productCategory"><field-map field-name="productCategoryId" from="categoryId"/></entity-find-one><if condition="productCategory == null"><return error="true" message="Invalid Category ID ${categoryId}"/></if><if condition="categoryIdSb.length() > 0"><script><![CDATA[categoryIdSb.append(",")]]></script></if><script><![CDATA[categoryIdSb.append("'").append((String) categoryId).append("'")]]></script></iterate><if condition="categoryIdSb.length() > 0"><set field="nowString" from="ec.l10n.format(ec.user.nowTimestamp, 'yyyy-MM-dd HH:mm:ss', null, ec.entity.databaseTimeZone)"/><script><![CDATA[inventoryCategoryCond = ec.entity.getConditionFactory().makeConditionWhere("""EXISTS (
                            SELECT OITM_PCM.ORDER_ITEM_SEQ_ID FROM ORDER_ITEM OITM_PCM
                                INNER JOIN PRODUCT_CATEGORY_MEMBER PCM ON PCM.PRODUCT_ID = OITM_PCM.PRODUCT_ID
                            WHERE OITM_PCM.ORDER_ID = OPRT.ORDER_ID AND OITM_PCM.ORDER_PART_SEQ_ID = OPRT.ORDER_PART_SEQ_ID AND OITM_PCM.ITEM_TYPE_ENUM_ID = 'ItemProduct'
                                AND PCM.PRODUCT_CATEGORY_ID IN (${categoryIdSb.toString()})
                                AND (PCM.FROM_DATE IS NULL OR PCM.FROM_DATE <= '${nowString}') AND (PCM.THRU_DATE IS NULL OR PCM.THRU_DATE >= '${nowString}')
                        ) AND NOT EXISTS (
                            SELECT OITM_PCM.ORDER_ITEM_SEQ_ID FROM ORDER_ITEM OITM_PCM
                                INNER JOIN PRODUCT_CATEGORY_MEMBER PCM ON PCM.PRODUCT_ID = OITM_PCM.PRODUCT_ID
                                INNER JOIN PRODUCT_CATEGORY PCAT ON PCM.PRODUCT_CATEGORY_ID = PCAT.PRODUCT_CATEGORY_ID AND PCAT.PRODUCT_CATEGORY_TYPE_ENUM_ID = 'PctInventoryGroup'
                            WHERE OITM_PCM.ORDER_ID = OPRT.ORDER_ID AND OITM_PCM.ORDER_PART_SEQ_ID = OPRT.ORDER_PART_SEQ_ID AND OITM_PCM.ITEM_TYPE_ENUM_ID = 'ItemProduct'
                                AND PCM.PRODUCT_CATEGORY_ID NOT IN (${categoryIdSb.toString()})
                                AND (PCM.FROM_DATE IS NULL OR PCM.FROM_DATE <= '${nowString}') AND (PCM.THRU_DATE IS NULL OR PCM.THRU_DATE >= '${nowString}')
                        ) AND NOT EXISTS (
                            SELECT OITM_PCM.ORDER_ITEM_SEQ_ID FROM ORDER_ITEM OITM_PCM
                            WHERE OITM_PCM.ORDER_ID = OPRT.ORDER_ID AND OITM_PCM.ORDER_PART_SEQ_ID = OPRT.ORDER_PART_SEQ_ID AND OITM_PCM.ITEM_TYPE_ENUM_ID = 'ItemProduct'
                                AND NOT EXISTS (
                                    SELECT PCM.PRODUCT_CATEGORY_ID FROM PRODUCT_CATEGORY_MEMBER PCM
                                        INNER JOIN PRODUCT_CATEGORY PCAT ON PCM.PRODUCT_CATEGORY_ID = PCAT.PRODUCT_CATEGORY_ID AND PCAT.PRODUCT_CATEGORY_TYPE_ENUM_ID = 'PctInventoryGroup'
                                    WHERE PCM.PRODUCT_ID = OITM_PCM.PRODUCT_ID AND
                                        (PCM.FROM_DATE IS NULL OR PCM.FROM_DATE <= '${nowString}') AND (PCM.THRU_DATE IS NULL OR PCM.THRU_DATE >= '${nowString}')
                                )
                        )""")]]></script></if></if></actions></service>