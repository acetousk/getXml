<!--Service Location coarchy.CoarchyServices.signup#Newsletter--><service verb="signup" noun="Newsletter"><in-parameters><parameter name="emailAddress" required="true"><text-email/></parameter></in-parameters><out-parameters><parameter name="signupSuccessful" type="Boolean"/><parameter name="partyId"/><parameter name="emailContactMechId"/></out-parameters><actions><set field="signupSuccessful" value="false"/><entity-find entity-name="mantle.party.contact.PartyContactMechInfo" list="existingPartyList" limit="2"><date-filter/><econdition field-name="contactMechPurposeId" value="EmailPrimary"/><econdition field-name="contactMechTypeEnumId" value="CmtEmailAddress"/><econdition field-name="infoString" from="emailAddress"/></entity-find><if condition="existingPartyList.size() > 1"><log level="warn" message="Multiple parties found for email address ${emailAddress}"/></if><set field="partyId" from="existingPartyList?.getFirst()?.partyId"/><if condition="!partyId"><service-call name="create#mantle.party.Party" in-map="context + [partyTypeEnumId:'PtyPerson']" out-map="[partyId:newPartyOut.partyId,pseudoId:newPartyOut.pseudoId,partyTypeEnumId:newPartyOut.partyTypeEnumId,disabled:newPartyOut.disabled,customerStatusId:newPartyOut.customerStatusId,ownerPartyId:newPartyOut.ownerPartyId,externalId:newPartyOut.externalId,dataSourceId:newPartyOut.dataSourceId,gatewayCimId:newPartyOut.gatewayCimId,comments:newPartyOut.comments,shippingInstructions:newPartyOut.shippingInstructions,hasDuplicates:newPartyOut.hasDuplicates,lastDupCheckDate:newPartyOut.lastDupCheckDate,mergedToPartyId:newPartyOut.mergedToPartyId,visibilityEnumId:newPartyOut.visibilityEnumId,lastUpdatedStamp:newPartyOut.lastUpdatedStamp]"/><set field="partyId" from="newPartyOut.partyId"/><service-call name="create#mantle.party.Person" in-map="[partyId:partyId,firstName:'Not',lastName:'Set']"/><service-call name="mantle.party.ContactServices.create#EmailAddress" out-map="[contactMechId:emailOut.contactMechId]" in-map="[emailAddress:emailAddress, partyId:partyId, contactMechPurposeId:'EmailPrimary']"/><set field="emailContactMechId" from="emailOut.contactMechId"/></if><set field="baseLinkUrl" from="!'production'.equals(System.getProperty('instance_purpose')) ? 'http://localhost:8080' : 'https://coarchy.com'"/><entity-find entity-name="mantle.marketing.contact.ContactListParty" list="contactListPartyList" limit="1" for-update="true"><econdition field-name="contactListId" value="CoarchyNewsletter"/><econdition field-name="statusId" value="CLPT_IN_USE"/><econdition field-name="partyId"/><date-filter/><order-by field-name="-fromDate"/></entity-find><if condition="contactListPartyList.size() == 0"><service-call name="coarchy.CoarchyServices.send#ContactListEmail" in-map="[                     contactListId:'CoarchyNewsletter',emailTemplateId:'NEWSLETTER_WELCOME',                     partyId:partyId,preferredContactMechId:emailContactMechId,toAddresses:emailAddress,                     bodyParameters:[title:'Welcome to the Coarchy Newsletter',baseLinkUrl:baseLinkUrl]]" out-map="[sentEmail:context.sentEmail,emailTemplateId:context.emailTemplateId]"/><message><![CDATA[Successfully subscribed to Newsletter!]]></message><else><message><![CDATA[Already subscribed to Newsletter]]></message></else></if></actions></service>