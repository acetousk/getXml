<!--Service Location mantle.work.ManufacturingServices.set#ProducedProductQuantity--><service verb="set" noun="ProducedProductQuantity"><in-parameters><parameter name="workEffortId" required="true"/><parameter name="productId" required="true"/><parameter name="estimatedQuantity" type="BigDecimal" required="true"/></in-parameters><out-parameters/><actions><entity-find entity-name="mantle.work.effort.WorkEffortProduct" list="produceWepList"><date-filter/><econdition field-name="workEffortId"/><econdition field-name="productId"/><econdition field-name="typeEnumId" value="WeptProduce"/></entity-find><set field="currentQty" from="produceWepList ? produceWepList*.estimatedQuantity.sum() : 0.0"/><if condition="estimatedQuantity > currentQty"><then><if condition="produceWepList"><then><set field="produceWep" from="produceWepList[0]"/><service-call name="update#mantle.work.effort.WorkEffortProduct" in-map="[workEffortId:workEffortId, productId:productId, fromDate:produceWep.fromDate,                                 estimatedQuantity:((produceWep.estimatedQuantity ?: 0.0) + (estimatedQuantity - currentQty))]"/></then><else><service-call name="create#mantle.work.effort.WorkEffortProduct" in-map="[workEffortId:workEffortId, productId:productId, fromDate:new Timestamp(0),                                 typeEnumId:'WeptProduce', statusId:'WepdCreated', estimatedQuantity:estimatedQuantity]"/></else></if><service-call name="mantle.work.ManufacturingServices.recreate#ConsumeProductsFromProduce" in-map="[workEffortId:workEffortId]"/></then><else-if condition="estimatedQuantity < currentQty"><set field="quantityRemaining" from="currentQty - estimatedQuantity"/><iterate list="produceWepList" entry="produceWep"><if condition="quantityRemaining == 0.0"><break/></if><set field="quantityToReduce" from="produceWep.estimatedQuantity > quantityRemaining ?                             quantityRemaining : produceWep.estimatedQuantity"/><set field="quantityRemaining" from="quantityRemaining > quantityToReduce ? (quantityRemaining - quantityToReduce) : 0.0"/><service-call name="update#mantle.work.effort.WorkEffortProduct" in-map="[workEffortId:workEffortId, productId:productId, fromDate:produceWep.fromDate,                                 estimatedQuantity:((produceWep.estimatedQuantity ?: 0.0) - quantityToReduce)]"/></iterate><service-call name="mantle.work.ManufacturingServices.recreate#ConsumeProductsFromProduce" in-map="[workEffortId:workEffortId]"/></else-if></if><service-call name="mantle.work.ManufacturingServices.get#ProducedProductComplete" in-map="[workEffortId:workEffortId]" out-map="[estimatedQtyByProduct:producedCompleteOut.estimatedQtyByProduct,producedQtyByProduct:producedCompleteOut.producedQtyByProduct,allEstimatedProduced:producedCompleteOut.allEstimatedProduced]"/><if condition="producedCompleteOut.allEstimatedProduced"><then><service-call name="update#mantle.work.effort.WorkEffort" in-map="[workEffortId:workEffortId, statusId:'WeComplete', actualCompletionDate:ec.user.nowTimestamp]"/></then><else><service-call name="update#mantle.work.effort.WorkEffort" in-map="[workEffortId:workEffortId, statusId:'WeInProgress', actualCompletionDate:null]"/></else></if></actions></service>