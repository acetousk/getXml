<!--Service Location mantle.account.FinancialAccountServices.calculate#FinancialAccountTotals--><service verb="calculate" noun="FinancialAccountTotals"><in-parameters><parameter name="finAccountId"/><parameter name="finAccountTransId"/><parameter name="finAccountAuthId"/></in-parameters><out-parameters><parameter name="currencyUomId"/><parameter name="actualBalance" type="BigDecimal"/><parameter name="authBalance" type="BigDecimal"/><parameter name="availableBalance" type="BigDecimal"/></out-parameters><actions><if condition="!finAccountId && finAccountTransId"><entity-find-one entity-name="mantle.account.financial.FinancialAccountTrans" value-field="fat"/><set field="finAccountId" from="fat?.finAccountId"/></if><if condition="!finAccountId && finAccountAuthId"><entity-find-one entity-name="mantle.account.financial.FinancialAccountAuth" value-field="faa"/><set field="finAccountId" from="faa?.finAccountId"/></if><if condition="!finAccountId"><return error="true" message="Cannot calculate Financial Account totals, no finAccountId passed"/></if><entity-find-one entity-name="mantle.account.financial.FinancialAccount" value-field="financialAccount" for-update="true"/><set field="currencyUomId" from="financialAccount.currencyUomId"/><if condition="true || ec.transaction.isTransactionCacheActive()"><then><set field="actualBalance" from="0.0"/><entity-find entity-name="mantle.account.financial.FinancialAccountTrans" list="fatList"><econdition field-name="finAccountId"/><select-field field-name="amount"/></entity-find><iterate list="fatList" entry="fat"><set field="actualBalance" from="actualBalance + fat.amount"/></iterate><set field="authBalance" from="0.0"/><entity-find entity-name="mantle.account.financial.FinancialAccountAuth" list="faaList"><econdition field-name="finAccountId"/><econdition field-name="expireDate" operator="greater" from="ec.user.nowTimestamp" or-null="true"/><select-field field-name="amount"/></entity-find><iterate list="faaList" entry="faa"><set field="authBalance" from="authBalance + faa.amount"/></iterate></then><else><entity-find entity-name="mantle.account.financial.FinancialAccountActualView" list="faaList"><econdition field-name="finAccountId"/></entity-find><set field="actualBalance" from="faaList?.first?.actualBalance ?: 0.0"/><entity-find entity-name="mantle.account.financial.FinancialAccountAuthView" list="faaList"><econdition field-name="finAccountId"/><econdition field-name="expireDate" operator="greater" from="ec.user.nowTimestamp" or-null="true"/><select-field field-name="finAccountId"/><select-field field-name="authBalance"/></entity-find><set field="authBalance" from="faaList?.first?.authBalance ?: 0.0"/></else></if><set field="availableBalance" from="actualBalance - authBalance + (financialAccount.negativeBalanceLimit ?: 0.0)"/><set field="financialAccount.actualBalance" from="actualBalance"/><set field="financialAccount.availableBalance" from="availableBalance"/><entity-update value-field="financialAccount"/></actions></service>