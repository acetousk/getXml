<!--Service Location mantle.account.PaymentMethodServices.produce#PaymentMethodFileSystemMessage--><service verb="produce" noun="PaymentMethodFileSystemMessage"><in-parameters><parameter name="paymentMethodFileId" required="true"/><parameter name="systemMessageTypeId"><description><![CDATA[If not specified looked up in PaymentMethodFileType]]></description></parameter><parameter name="systemMessageRemoteId"><description><![CDATA[If not specified looked up in PaymentMethodFileType]]></description></parameter></in-parameters><out-parameters><parameter name="systemMessageId"/></out-parameters><actions><entity-find-one entity-name="mantle.account.method.PaymentMethodFile" value-field="paymentMethodFile"/><if condition="paymentMethodFile == null"><return type="danger" message="File with ID ${paymentMethodFileId} not found"/></if><if condition="!systemMessageTypeId || !systemMessageRemoteId"><set field="paymentMethodFileType" from="paymentMethodFile.paymentMethodFileType"/><if condition="!systemMessageTypeId"><set field="systemMessageTypeId" from="paymentMethodFileType?.systemMessageTypeId"/></if><if condition="!systemMessageRemoteId"><set field="systemMessageRemoteId" from="paymentMethodFileType?.systemMessageRemoteId"/></if></if><if condition="!systemMessageTypeId || !systemMessageRemoteId"><return type="danger" message="Not sending file ${paymentMethodFileId}, no message type or remote specified or configured for payment method ${paymentMethodFile.paymentMethodId} and file type ${paymentMethodFile.fileTypeEnumId}"/></if><entity-find entity-name="moqui.service.message.SystemMessage" list="systemMessageList"><econdition field-name="paymentMethodFileId"/><econdition field-name="systemMessageTypeId"/><econdition field-name="systemMessageRemoteId"/><econdition field-name="statusId" operator="not-in" value="SmsgRejected,SmsgCancelled,SmsgError"/><select-field field-name="systemMessageId"/></entity-find><if condition="systemMessageList"><return type="warning" message="File ${paymentMethodFileId} already sent in SystemMessage ${systemMessageList*.systemMessageId}"/></if><service-call name="org.moqui.impl.SystemMessageServices.queue#SystemMessage" out-map="[systemMessageId:context.systemMessageId]" in-map="[systemMessageTypeId:systemMessageTypeId, systemMessageRemoteId:systemMessageRemoteId,                         messageText:paymentMethodFile.fileText, paymentMethodFileId:paymentMethodFileId]"/><message type="success"><![CDATA[Queued file ${paymentMethodFileId} to send to ${systemMessageRemoteId} in message ${systemMessageId}]]></message></actions></service>