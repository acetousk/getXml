<!--Service Location mantle.ledger.InvoiceAutoPostServices.post#Invoice--><service verb="post" noun="Invoice"><in-parameters><parameter name="invoiceId" required="true" entity-name="mantle.account.invoice.Invoice" field-name="invoiceId"/></in-parameters><out-parameters><parameter name="fromAcctgTransId"/><parameter name="toAcctgTransId"/></out-parameters><actions><set field="allInvoiceTxTypes" from="['AttSalesInvoice', 'AttVendRtnInvoice', 'AttPurchaseInvoice', 'AttCustRtnInvoice',                     'AttCreditMemo', 'AttVendCreditMemo', 'AttPayrollInvoice', 'AttTaxInvoice', 'AttGarnishmentInvoice', 'AttCommissionInvoice']"/><entity-find entity-name="mantle.ledger.transaction.AcctgTrans" list="existingTransList"><econdition field-name="invoiceId"/><econdition field-name="acctgTransTypeEnumId" operator="in" from="allInvoiceTxTypes"/><econdition field-name="reversedByAcctgTransId" from="null"/><econdition field-name="reverseOfAcctgTransId" from="null"/></entity-find><if condition="existingTransList"><return message="Invoice ${invoiceId} has already been posted in accounting transaction ${existingTransList*.acctgTransId}"/></if><entity-find-one entity-name="mantle.account.invoice.Invoice" value-field="invoice" for-update="true"/><if condition="invoice == null"><return error="true" message="Could not find Invoice with ID ${invoiceId}"/></if><if condition="invoice.statusId in ['InvoiceInProcess', 'InvoiceIncoming', 'InvoiceReceived', 'InvoiceCancelled']"><return message="Invoice ${invoiceId} cannot be posted in status ${invoice.statusId}"/></if><entity-find entity-name="mantle.account.invoice.InvoiceItem" list="invoiceItemList"><econdition field-name="invoiceId"/></entity-find><if condition="!invoiceItemList"><return message="Invoice ${invoiceId} has no items, not posting to GL"/></if><service-call name="mantle.ledger.InvoiceAutoPostServices.get#InvoicePartyAcctgPreferences" in-map="[invoice:invoice]" out-map="[fromPartyAcctgPreference:context.fromPartyAcctgPreference,toPartyAcctgPreference:context.toPartyAcctgPreference]"/><if condition="!fromPartyAcctgPreference && !toPartyAcctgPreference"><log level="trace" message="Not posting invoice [${invoiceId}], could not find PartyAcctgPreference for From Party [${invoice.fromPartyId}], To Party [${invoice.toPartyId}], or Invoice Override Party [${invoice.overrideOrgPartyId}]"/><set field="invoice.acctgTransResultEnumId" value="AtrNoAcctgPreference"/><entity-update value-field="invoice"/><return/></if><set field="useErrorJournal" from="false"/><if condition="fromPartyAcctgPreference != null"><service-call name="mantle.ledger.InvoiceAutoPostServices.get#InvoiceTypeTransType" out-map="[acctgTransTypeEnumId:fromInvoiceTypeTransTypeOut.acctgTransTypeEnumId,glAccountId:fromInvoiceTypeTransTypeOut.glAccountId,glAccountTypeEnumId:fromInvoiceTypeTransTypeOut.glAccountTypeEnumId]" in-map="[invoiceTypeEnumId:invoice.invoiceTypeEnumId, organizationPartyId:invoice.fromPartyId, isPayable:'N']"/><if condition="!fromInvoiceTypeTransTypeOut.acctgTransTypeEnumId"><return error="true" message="Cannot post invoice [${invoiceId}], no accounting transaction type for invoice type ${invoice.invoiceTypeEnumId}"/></if><service-call name="mantle.ledger.LedgerServices.create#AcctgTrans" out-map="[acctgTransId:context.acctgTransId]" in-map="[acctgTransTypeEnumId:fromInvoiceTypeTransTypeOut.acctgTransTypeEnumId,                             organizationPartyId:invoice.fromPartyId, otherPartyId:invoice.toPartyId,                             amountUomId:invoice.currencyUomId, invoiceId:invoice.invoiceId, transactionDate:invoice.invoiceDate]"/><entity-find-one entity-name="mantle.ledger.transaction.AcctgTrans" value-field="fromAcctgTrans"/></if><if condition="toPartyAcctgPreference != null"><service-call name="mantle.ledger.InvoiceAutoPostServices.get#InvoiceTypeTransType" out-map="[acctgTransTypeEnumId:toInvoiceTypeTransTypeOut.acctgTransTypeEnumId,glAccountId:toInvoiceTypeTransTypeOut.glAccountId,glAccountTypeEnumId:toInvoiceTypeTransTypeOut.glAccountTypeEnumId]" in-map="[invoiceTypeEnumId:invoice.invoiceTypeEnumId, organizationPartyId:invoice.toPartyId, isPayable:'Y']"/><if condition="!toInvoiceTypeTransTypeOut.acctgTransTypeEnumId"><return error="true" message="Cannot post invoice [${invoiceId}], no accounting transaction type for invoice type ${invoice.invoiceTypeEnumId}"/></if><service-call name="mantle.ledger.LedgerServices.create#AcctgTrans" out-map="[acctgTransId:context.acctgTransId]" in-map="[acctgTransTypeEnumId:toInvoiceTypeTransTypeOut.acctgTransTypeEnumId,                             organizationPartyId:invoice.toPartyId, otherPartyId:invoice.fromPartyId,                             amountUomId:invoice.currencyUomId, invoiceId:invoice.invoiceId, transactionDate:invoice.invoiceDate]"/><entity-find-one entity-name="mantle.ledger.transaction.AcctgTrans" value-field="toAcctgTrans"/></if><set field="invoiceTotal" from="0.0"/><iterate list="invoiceItemList" entry="invoiceItem"><if condition="invoiceItem.isAdjustment == 'Y'"><continue/></if><set field="itemTotal" from="((invoiceItem.quantity != null ? invoiceItem.quantity : 1.0) * (invoiceItem.amount ?: 0.0)).setScale(2, BigDecimal.ROUND_HALF_UP)"/><if condition="itemTotal == 0.0"><continue/></if><set field="invoiceTotal" from="invoiceTotal + itemTotal"/><set field="entryCommonMap" from="[invoiceItemSeqId:invoiceItem.invoiceItemSeqId,                         productId:invoiceItem.productId, assetId:invoiceItem.assetId, description:invoiceItem.description]"/><if condition="fromPartyAcctgPreference != null"><set field="assetTypeGlAccount" from="null"/><if condition="invoiceItem.assetId"><entity-find-one entity-name="mantle.product.asset.Asset" value-field="asset"><field-map field-name="assetId" from="invoiceItem.assetId"/></entity-find-one><if condition="asset.assetTypeEnumId"><entity-find-one entity-name="moqui.basic.Enumeration" value-field="assetTypeEnum"><field-map field-name="enumId" from="asset.assetTypeEnumId"/></entity-find-one><service-call name="mantle.ledger.AssetAutoPostServices.get#AssetTypeGlAccount" out-map="[assetTypeGlAccount:context.assetTypeGlAccount]" in-map="[organizationPartyId:fromPartyAcctgPreference.organizationPartyId,                                         assetTypeEnumId:asset.assetTypeEnumId, classEnumId:asset.classEnumId]"/></if></if><if condition="invoiceItem.itemTypeEnumId == 'ItemAsset' && assetTypeGlAccount && asset.acquireCost &&                             (assetTypeEnum.enumId == 'AstTpFixed' || assetTypeEnum.parentEnumId == 'AstTpFixed')"><set field="issuanceGlAccountTypeEnumId" value="GatUnissuedFixedAsset"/><set field="issuanceGlAccountId" from="assetTypeGlAccount.issuanceGlAccountId"/><if condition="!issuanceGlAccountId"><service-call name="mantle.ledger.LedgerServices.get#DefaultGlAccountByType" out-map="[glAccountId:issuanceGlAccountOut.glAccountId]" out-map-add-to-existing="false" in-map="[glAccountTypeEnumId:issuanceGlAccountTypeEnumId, acctgTransTypeEnumId:fromAcctgTrans.acctgTransTypeEnumId,                                         organizationPartyId:fromAcctgTrans.organizationPartyId, otherPartyId:fromAcctgTrans.otherPartyId]"/><set field="issuanceGlAccountId" from="issuanceGlAccountOut.glAccountId"/></if><if condition="!issuanceGlAccountId"><set field="useErrorJournal" from="true"/></if><service-call name="mantle.ledger.LedgerServices.create#AcctgTransEntry" in-map="entryCommonMap + [amount:asset.acquireCost, acctgTransId:fromAcctgTrans.acctgTransId,                                     acctgTrans:fromAcctgTrans, debitCreditFlag:'C',                                     glAccountTypeEnumId:issuanceGlAccountTypeEnumId, glAccountId:issuanceGlAccountId]"/><if condition="asset.depreciation"><set field="accDepGlAccountTypeEnumId" value="GatFaAccumDepreciation"/><set field="accDepreciationGlAccountId" from="assetTypeGlAccount.accDepreciationGlAccountId"/><if condition="!accDepreciationGlAccountId"><service-call name="mantle.ledger.LedgerServices.get#DefaultGlAccountByType" out-map="[glAccountId:accDepreciationGlAccountOut.glAccountId]" out-map-add-to-existing="false" in-map="[glAccountTypeEnumId:accDepGlAccountTypeEnumId, acctgTransTypeEnumId:fromAcctgTrans.acctgTransTypeEnumId,                                             organizationPartyId:fromAcctgTrans.organizationPartyId, otherPartyId:fromAcctgTrans.otherPartyId]"/><set field="accDepreciationGlAccountId" from="accDepreciationGlAccountOut.glAccountId"/></if><if condition="!accDepreciationGlAccountId"><set field="useErrorJournal" from="true"/></if><service-call name="mantle.ledger.LedgerServices.create#AcctgTransEntry" in-map="entryCommonMap + [amount:asset.depreciation, acctgTransId:fromAcctgTrans.acctgTransId,                                         acctgTrans:fromAcctgTrans, debitCreditFlag:'D',                                         glAccountTypeEnumId:accDepGlAccountTypeEnumId, glAccountId:accDepreciationGlAccountId]"/></if><set field="profitLoss" from="itemTotal - (asset.acquireCost - (asset.depreciation ?: 0.0))"/><if condition="profitLoss > 0.0"><then><set field="itemTotal" from="profitLoss"/></then><else-if condition="profitLoss < 0.0"><set field="itemTotal" from="0.0"/><set field="lossGlAccountId" from="invoiceItem.overrideGlAccountId"/><if condition="!lossGlAccountId && assetTypeGlAccount != null"><set field="lossGlAccountId" from="assetTypeGlAccount.lossGlAccountId"/></if><if condition="!lossGlAccountId"><then><service-call name="mantle.ledger.InvoiceAutoPostServices.get#InvoiceItemGlAccount" in-map="[acctgTransTypeEnumId:fromAcctgTrans.acctgTransTypeEnumId,                                                 organizationPartyId:fromAcctgTrans.organizationPartyId,                                                 otherPartyId:fromAcctgTrans.otherPartyId, itemTypeEnumId:invoiceItem.itemTypeEnumId,                                                 productId:invoiceItem.productId, assetId:invoiceItem.assetId, direction:'O']" out-map="[glAccountId:lossGlAccountOut.glAccountId,glAccountTypeEnumId:lossGlAccountOut.glAccountTypeEnumId,glAccount:lossGlAccountOut.glAccount]" out-map-add-to-existing="false"/><set field="lossGlAccountId" from="lossGlAccountOut?.glAccountId"/><set field="lossGlAccountTypeEnumId" from="lossGlAccountOut?.glAccountTypeEnumId"/></then><else><entity-find-one entity-name="mantle.ledger.account.GlAccount" value-field="glAccount" cache="true"><field-map field-name="glAccountId" from="lossGlAccountId"/></entity-find-one><set field="lossGlAccountTypeEnumId" from="glAccount?.glAccountTypeEnumId"/></else></if><if condition="!lossGlAccountId"><set field="useErrorJournal" from="true"/></if><service-call name="mantle.ledger.LedgerServices.create#AcctgTransEntry" in-map="entryCommonMap + [amount:-profitLoss, acctgTransId:fromAcctgTrans.acctgTransId, acctgTrans:fromAcctgTrans,                                         debitCreditFlag:'D', glAccountTypeEnumId:lossGlAccountTypeEnumId, glAccountId:lossGlAccountId]"/></else-if><else><set field="itemTotal" from="0.0"/></else></if></if><if condition="itemTotal != 0.0"><set field="itemGlAccountId" from="invoiceItem.overrideGlAccountId"/><if condition="!itemGlAccountId && assetTypeGlAccount != null"><set field="itemGlAccountId" from="assetTypeGlAccount.profitGlAccountId"/></if><if condition="!itemGlAccountId"><then><service-call name="mantle.ledger.InvoiceAutoPostServices.get#InvoiceItemGlAccount" in-map="[acctgTransTypeEnumId:fromAcctgTrans.acctgTransTypeEnumId,                                         organizationPartyId:fromAcctgTrans.organizationPartyId,                                         otherPartyId:fromAcctgTrans.otherPartyId, itemTypeEnumId:invoiceItem.itemTypeEnumId,                                         productId:invoiceItem.productId, assetId:invoiceItem.assetId, direction:'O']" out-map="[glAccountId:invoiceItemGlAccountOut.glAccountId,glAccountTypeEnumId:invoiceItemGlAccountOut.glAccountTypeEnumId,glAccount:invoiceItemGlAccountOut.glAccount]" out-map-add-to-existing="false"/><set field="itemGlAccountId" from="invoiceItemGlAccountOut?.glAccountId"/><set field="itemGlAccountTypeEnumId" from="invoiceItemGlAccountOut?.glAccountTypeEnumId"/></then><else><entity-find-one entity-name="mantle.ledger.account.GlAccount" value-field="glAccount" cache="true"><field-map field-name="glAccountId" from="itemGlAccountId"/></entity-find-one><set field="itemGlAccountTypeEnumId" from="glAccount?.glAccountTypeEnumId"/></else></if><if condition="!itemGlAccountId"><set field="useErrorJournal" from="true"/></if><service-call name="mantle.ledger.LedgerServices.create#AcctgTransEntry" in-map="entryCommonMap + [amount:itemTotal, acctgTransId:fromAcctgTrans.acctgTransId,                                     acctgTrans:fromAcctgTrans, debitCreditFlag:'C', glAccountTypeEnumId:itemGlAccountTypeEnumId,                                     glAccountId:itemGlAccountId]"/></if></if><if condition="toPartyAcctgPreference != null"><set field="itemGlAccountId" from="invoiceItem.overrideGlAccountId"/><if condition="!itemGlAccountId"><then><service-call name="mantle.ledger.InvoiceAutoPostServices.get#InvoiceItemGlAccount" in-map="[acctgTransTypeEnumId:toAcctgTrans.acctgTransTypeEnumId,                                     organizationPartyId:toAcctgTrans.organizationPartyId,                                     otherPartyId:toAcctgTrans.otherPartyId, itemTypeEnumId:invoiceItem.itemTypeEnumId,                                     productId:invoiceItem.productId, assetId:invoiceItem.assetId, direction:'I']" out-map="[glAccountId:invoiceItemGlAccountOut.glAccountId,glAccountTypeEnumId:invoiceItemGlAccountOut.glAccountTypeEnumId,glAccount:invoiceItemGlAccountOut.glAccount]" out-map-add-to-existing="false"/><set field="itemGlAccountId" from="invoiceItemGlAccountOut?.glAccountId"/><set field="itemGlAccountTypeEnumId" from="invoiceItemGlAccountOut?.glAccountTypeEnumId"/></then><else><entity-find-one entity-name="mantle.ledger.account.GlAccount" value-field="glAccount" cache="true"><field-map field-name="glAccountId" from="itemGlAccountId"/></entity-find-one><set field="itemGlAccountTypeEnumId" from="glAccount?.glAccountTypeEnumId"/></else></if><if condition="!itemGlAccountId"><set field="useErrorJournal" from="true"/></if><service-call name="mantle.ledger.LedgerServices.create#AcctgTransEntry" in-map="entryCommonMap + [amount:itemTotal, acctgTransId:toAcctgTrans.acctgTransId, acctgTrans:toAcctgTrans,                                 debitCreditFlag:'D', glAccountTypeEnumId:itemGlAccountTypeEnumId, glAccountId:itemGlAccountId]"/></if></iterate><if condition="fromPartyAcctgPreference"><if condition="!fromInvoiceTypeTransTypeOut.glAccountId"><set field="useErrorJournal" from="true"/></if><service-call name="mantle.ledger.LedgerServices.create#AcctgTransEntry" in-map="[amount:invoiceTotal, acctgTransId:fromAcctgTrans.acctgTransId, acctgTrans:fromAcctgTrans,                             debitCreditFlag:'D', glAccountTypeEnumId:fromInvoiceTypeTransTypeOut.glAccountTypeEnumId,                             glAccountId:fromInvoiceTypeTransTypeOut.glAccountId]"/></if><if condition="toPartyAcctgPreference"><if condition="!toInvoiceTypeTransTypeOut.glAccountId"><set field="useErrorJournal" from="true"/></if><service-call name="mantle.ledger.LedgerServices.create#AcctgTransEntry" in-map="[amount:invoiceTotal, acctgTransId:toAcctgTrans.acctgTransId, acctgTrans:toAcctgTrans,                             debitCreditFlag:'C', glAccountTypeEnumId:toInvoiceTypeTransTypeOut.glAccountTypeEnumId,                             glAccountId:toInvoiceTypeTransTypeOut.glAccountId]"/></if><if condition="useErrorJournal"><then><if condition="fromPartyAcctgPreference?.errorGlJournalId"><service-call name="update#mantle.ledger.transaction.AcctgTrans" in-map="[acctgTransId:fromAcctgTrans.acctgTransId, glJournalId:fromPartyAcctgPreference.errorGlJournalId]"/></if><if condition="toPartyAcctgPreference?.errorGlJournalId"><service-call name="update#mantle.ledger.transaction.AcctgTrans" in-map="[acctgTransId:toAcctgTrans.acctgTransId, glJournalId:toPartyAcctgPreference.errorGlJournalId]"/></if></then><else><if condition="fromPartyAcctgPreference"><service-call name="mantle.ledger.LedgerServices.post#AcctgTrans" in-map="[acctgTransId:fromAcctgTrans.acctgTransId]"/></if><if condition="toPartyAcctgPreference"><service-call name="mantle.ledger.LedgerServices.post#AcctgTrans" in-map="[acctgTransId:toAcctgTrans.acctgTransId]"/></if></else></if><set field="invoice.acctgTransResultEnumId" value="AtrSuccess"/><entity-update value-field="invoice"/><set field="fromAcctgTransId" from="fromAcctgTrans?.acctgTransId"/><set field="toAcctgTransId" from="toAcctgTrans?.acctgTransId"/><iterate list="invoiceItemList" entry="invoiceItem"><if condition="invoiceItem.isAdjustment == 'Y'"><service-call name="mantle.ledger.InvoiceAutoPostServices.post#InvoiceAdjustment" in-map="[invoiceId:invoiceItem.invoiceId, invoiceItemSeqId:invoiceItem.invoiceItemSeqId]"/></if></iterate></actions></service>