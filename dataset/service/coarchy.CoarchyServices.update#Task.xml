<!--Service Location coarchy.CoarchyServices.update#Task--><service verb="update" noun="Task"><in-parameters><parameter name="workEffortId" required="true"/><parameter name="assignedPartyIdList" type="List" required="true"/><parameter name="resolutionEnumId"/><parameter name="organizationId" required="true"/></in-parameters><out-parameters/><actions><entity-find-one entity-name="mantle.work.effort.WorkEffort" value-field="task" auto-field-map="[workEffortId:workEffortId]"/><if condition="!task"><return type="warning" message="${ec.resource.expand('CoarchyTaskNotFound', null)}"/></if><entity-find entity-name="mantle.work.effort.WorkEffortParty" list="workEffortPartyList"><date-filter/><econdition field-name="workEffortId"/><econdition field-name="roleTypeId" value="Assignee"/><order-by field-name="-fromDate"/></entity-find><set field="partyIdServerList" from="workEffortPartyList*.partyId"/><if condition="partyIdServerList"><set field="partyIdDeleteList" from="partyIdServerList - assignedPartyIdList?:[]"/><iterate list="partyIdDeleteList" entry="partyIdDelete"><service-call name="update#mantle.work.effort.WorkEffortParty" in-map="[workEffortId:workEffortId,partyId:partyIdDelete,roleTypeId:'Assignee',fromDate:workEffortPartyList.find{it.partyId==partyIdDelete}.fromDate,thruDate:ec.user.nowTimestamp]"/></iterate></if><set field="baseLinkUrl" from="!'production'.equals(System.getProperty('instance_purpose')) ? 'http://localhost:8080' : 'https://coarchy.com'"/><set field="partyIdCreateList" from="assignedPartyIdList?:[] - partyIdDeleteList?:[]"/><if condition="partyIdCreateList instanceof String"><then><service-call name="store#mantle.work.effort.WorkEffortParty" in-map="[workEffortId:workEffortId,partyId:partyIdCreateList,roleTypeId:'Assignee']"/></then><else><iterate list="partyIdCreateList" entry="partyIdCreate"><service-call name="store#mantle.work.effort.WorkEffortParty" in-map="[workEffortId:workEffortId,partyId:partyIdCreate,roleTypeId:'Assignee',fromDate:workEffortPartyList.find{it.partyId==partyIdCreate}?.fromDate?:ec.user.nowTimestamp]"/><entity-find entity-name="mantle.work.effort.WorkEffort" list="taskList" limit="1"><econdition field-name="rootWorkEffortId" from="task.rootWorkEffortId"/><econdition field-name="workEffortId" operator="less" from="workEffortId"/><order-by field-name="-workEffortId"/></entity-find><if condition="ec.user.userAccount.partyId!=partyIdCreate && (taskList.size() == 0 || taskList.getFirst().resolutionEnumId!=null)"><entity-find entity-name="moqui.security.UserAccount" list="userAccountList" limit="1"><econdition field-name="partyId" from="partyIdCreate"/><select-field field-name="emailAddress"/><order-by field-name="-lastUpdatedStamp"/></entity-find><if condition="userAccountList?.getFirst()?.emailAddress == null"><then><message type="danger"><![CDATA[Can't send email to notify about assignment]]></message></then><else><service-call name="coarchy.CoarchyServices.send#ContactListEmail" in-map="[                                 contactListId:'CoarchyTaskReminder',emailTemplateId:'TASK_ASSIGNED_NOTIFICATION',                                 partyId:partyIdCreate,toAddresses:userAccountList.getFirst().emailAddress,                                 bodyParameters:[linkUrl:baseLinkUrl+'/coapp/Checklist?checklistId='+task.rootWorkEffortId,baseLinkUrl:baseLinkUrl,                                 title:'You\'ve been assigned a task'+(ec.user.userAccount.userFullName?' by '+ec.user.userAccount.userFullName:'')]]" out-map="[sentEmail:context.sentEmail,emailTemplateId:context.emailTemplateId]"/></else></if></if></iterate></else></if><if condition="partyIdServerList.containsAll(assignedPartyIdList) && workEffortPartyList.find{it.partyId == ec.user.userAccount.partyId} != null > 0 && resolutionEnumId"><if condition="resolutionEnumId"><set field="actualCompletionDate" from="ec.user.nowTimestamp"/><service-call name="update#mantle.work.effort.WorkEffort" in-map="[workEffortId:workEffortId,resolutionEnumId:resolutionEnumId,actualCompletionDate:actualCompletionDate]"/></if><entity-find-one entity-name="mantle.work.effort.WorkEffort" value-field="project" auto-field-map="[workEffortId:task.rootWorkEffortId]"/><if condition="!project.actualCompletionDate"><entity-find-count entity-name="mantle.work.effort.WorkEffort" count-field="taskCount"><econdition field-name="rootWorkEffortId" from="task.rootWorkEffortId"/></entity-find-count><entity-find-count entity-name="mantle.work.effort.WorkEffort" count-field="taskWithResolutionCount"><econdition field-name="rootWorkEffortId" from="task.rootWorkEffortId"/><econdition field-name="resolutionEnumId" operator="is-not-null"/></entity-find-count><if condition="taskWithResolutionCount == taskCount"><service-call name="update#mantle.work.effort.WorkEffort" in-map="[workEffortId:task.rootWorkEffortId,actualCompletionDate:ec.user.nowTimestamp]"/><else><entity-find entity-name="mantle.work.effort.WorkEffort" list="taskList" limit="1"><econdition field-name="rootWorkEffortId" from="task.rootWorkEffortId"/><econdition field-name="workEffortId" operator="greater"/><order-by field-name="workEffortId"/></entity-find><if condition="taskList?.size() > 0 && taskList?.getFirst()?.resolutionEnumId == null"><entity-find entity-name="mantle.work.effort.WorkEffortAndPartyDetail" list="userAccountList"><date-filter/><econdition field-name="workEffortId" from="taskList?.getFirst()?.workEffortId"/><econdition field-name="roleTypeId" value="Assignee"/><select-field field-name="emailAddress,partyId"/><order-by field-name="-fromDate"/></entity-find><if condition="userAccountList.size() > 0 &&                                         userAccountList?.getFirst()?.partyId != ec.user.userAccount.partyId                                         && userAccountList?.getFirst()?.emailAddress != null"><service-call name="coarchy.CoarchyServices.send#ContactListEmail" in-map="[                                         contactListId:'CoarchyTaskReminder',emailTemplateId:'TASK_NOTIFICATION',                                         partyId:userAccountList?.getFirst()?.partyId,                                         toAddresses:userAccountList.getFirst().emailAddress,                                         bodyParameters:[linkUrl:baseLinkUrl+'/coapp/Checklist?checklistId='+taskList?.getFirst().rootWorkEffortId,                                         baseLinkUrl:baseLinkUrl,                                         title:'Task '+taskList?.getFirst().workEffortName+' is ready']]" out-map="[sentEmail:context.sentEmail,emailTemplateId:context.emailTemplateId]"/></if><entity-find entity-name="mantle.work.effort.WorkEffortAndPartyDetail" list="userAccountOwnerList" limit="1"><date-filter/><econdition field-name="workEffortId" from="task.rootWorkEffortId"/><econdition field-name="roleTypeId" value="Owner"/><select-field field-name="emailAddress,partyId"/><order-by field-name="-fromDate"/></entity-find><if condition="(userAccountList.size() == 0)"><if condition="(userAccountOwnerList.size() > 0) &&                                         userAccountOwnerList?.getFirst()?.partyId != ec.user.userAccount.partyId                                         && userAccountOwnerList?.getFirst()?.emailAddress != null"><service-call name="coarchy.CoarchyServices.send#ContactListEmail" in-map="[                                             contactListId:'CoarchyTaskReminder',emailTemplateId:'TASK_NEEDS_ASSIGNMENT_NOTIFICATION',                                             partyId:userAccountOwnerList?.getFirst()?.partyId,                                             toAddresses:userAccountOwnerList.getFirst().emailAddress,                                             bodyParameters:[linkUrl:baseLinkUrl+'/coapp/Checklist?checklistId='+taskList?.getFirst().rootWorkEffortId,                                             baseLinkUrl:baseLinkUrl,                                             title:'Task '+taskList?.getFirst().workEffortName+' is ready to be assigned']]" out-map="[sentEmail:context.sentEmail,emailTemplateId:context.emailTemplateId]"/></if></if></if></else></if></if></if></actions></service>