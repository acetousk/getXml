<!--Service Location mantle.account.InvoiceServices.apply#InvoiceItemToOrder--><service verb="apply" noun="InvoiceItemToOrder"><in-parameters><parameter name="invoiceId" required="true"/><parameter name="invoiceItemSeqId" required="true"/><parameter name="orderId" required="true"/><parameter name="orderPartSeqId"/></in-parameters><out-parameters/><actions><entity-find-one entity-name="mantle.account.invoice.Invoice" value-field="invoice"/><entity-find-one entity-name="mantle.account.invoice.InvoiceItem" value-field="invoiceItem"/><entity-find entity-name="mantle.order.OrderPart" list="orderPartList"><econdition field-name="orderId"/><econdition field-name="orderPartSeqId" ignore-if-empty="true"/></entity-find><set field="orderPart" from="orderPartList.first()"/><if condition="orderPart.customerPartyId != invoice.toPartyId"><return error="true" message="Order customer ${orderPart.customerPartyId} does not match invoice to party ${invoice.toPartyId}"/></if><if condition="orderPart.vendorPartyId != invoice.fromPartyId"><return error="true" message="Order vendor ${orderPart.vendorPartyId} does not match invoice from party ${invoice.fromPartyId}"/></if><entity-find entity-name="moqui.basic.EnumGroupMember" list="productItemTypeEgms" cache="true"><econdition field-name="enumGroupEnumId" value="EngItemsProduct"/></entity-find><set field="productItemTypes" from="productItemTypeEgms*.enumId"/><entity-find entity-name="mantle.order.OrderItem" list="orderItemList"><econdition field-name="orderId"/><econdition field-name="orderPartSeqId" ignore-if-empty="true"/><econdition field-name="itemTypeEnumId" from="invoiceItem.itemTypeEnumId"/><econdition field-name="productId" from="invoiceItem.productId" ignore-if-empty="true"/></entity-find><set field="invoiceQtyOrig" from="invoiceItem.quantity != null ? invoiceItem.quantity : 1.0"/><set field="invoiceQtyRemaining" from="invoiceQtyOrig"/><entity-find entity-name="mantle.order.OrderItemBillingQuantity" list="oibqList"><econdition field-name="invoiceId"/><econdition field-name="invoiceItemSeqId"/><select-field field-name="quantity"/></entity-find><set field="invoiceBilledQuantity" from="oibqList?.getAt(0)?.quantity ?: 0.0"/><set field="invoiceQtyRemaining" from="invoiceQtyRemaining - invoiceBilledQuantity"/><if condition="invoiceQtyRemaining <= 0.0"><return message="Invoice ${invoiceId} item ${invoiceItemSeqId} already fully applied to orders"/></if><iterate list="orderItemList" entry="orderItem"><entity-find entity-name="mantle.order.OrderItemBillingQuantity" list="oibqList"><econdition field-name="orderId"/><econdition field-name="orderItemSeqId" from="orderItem.orderItemSeqId"/><select-field field-name="quantity"/></entity-find><set field="orderBilledQuantity" from="oibqList?.getAt(0)?.quantity ?: 0.0"/><set field="quantityNotBilled" from="(orderItem.quantity != null ? orderItem.quantity : 1.0) * (orderItem.selectedAmount ?: 1.0)"/><set field="quantityNotBilled" from="quantityNotBilled - orderBilledQuantity"/><if condition="quantityNotBilled <= 0.0"><continue/></if><set field="quantityToBill" from="quantityNotBilled > invoiceQtyRemaining ? invoiceQtyRemaining : quantityNotBilled"/><if condition="invoiceItem.amount != orderItem.unitAmount"><if condition="invoiceItem.itemTypeEnumId in productItemTypes"><then><script><![CDATA[ec.message.addMessage("Invoice ${invoiceId} item ${invoiceItemSeqId} amount ${invoiceItem.amount} different from order ${orderId} item ${orderItem.orderItemSeqId} amount ${orderItem.unitAmount} but is product so applying anyway", 'warning')]]></script></then><else><continue/></else></if></if><set field="curShipmentId" from="null"/><set field="curAssetIssuanceId" from="null"/><set field="curAssetReceiptId" from="null"/><if condition="invoiceItem.itemTypeEnumId in productItemTypes"><set field="quantityNotShipSourced" from="quantityToBill"/><entity-find entity-name="mantle.shipment.ShipmentItemSource" list="shipmentItemSourceList"><econdition field-name="orderId"/><econdition field-name="orderItemSeqId" from="orderItem.orderItemSeqId"/><order-by field-name="-quantity"/></entity-find><iterate list="shipmentItemSourceList" entry="shipmentItemSource"><if condition="!shipmentItemSource.invoiceId && quantityNotShipSourced >= shipmentItemSource.quantity"><set field="shipmentItemSource.invoiceId" from="invoiceId"/><set field="shipmentItemSource.invoiceItemSeqId" from="invoiceItemSeqId"/><entity-update value-field="shipmentItemSource"/><set field="quantityNotShipSourced" from="quantityNotShipSourced - shipmentItemSource.quantity"/><set field="curShipmentId" from="shipmentItemSource.shipmentId"/></if></iterate><if condition="!curShipmentId"><entity-find entity-name="mantle.shipment.ShipmentItemSource" list="invoiceSisList"><econdition field-name="invoiceId"/><econdition field-name="invoiceItemSeqId"/><select-field field-name="shipmentId"/></entity-find><set field="curShipmentId" from="invoiceSisList[0]?.shipmentId"/></if><set field="quantityNotIssuance" from="quantityToBill"/><entity-find entity-name="mantle.product.issuance.AssetIssuance" list="assetIssuanceList"><econdition field-name="orderId"/><econdition field-name="orderItemSeqId" from="orderItem.orderItemSeqId"/></entity-find><iterate list="assetIssuanceList" entry="assetIssuance"><if condition="!assetIssuance.invoiceId && quantityNotIssuance >= assetIssuance.quantity"><set field="assetIssuance.invoiceId" from="invoiceId"/><set field="assetIssuance.invoiceItemSeqId" from="invoiceItemSeqId"/><entity-update value-field="assetIssuance"/><set field="quantityNotIssuance" from="quantityNotIssuance - assetIssuance.quantity"/><set field="curAssetIssuanceId" from="assetIssuance.assetIssuanceId"/></if></iterate><if condition="!curAssetIssuanceId"><entity-find entity-name="mantle.product.issuance.AssetIssuance" list="invoiceAsiList"><econdition field-name="invoiceId"/><econdition field-name="invoiceItemSeqId"/><select-field field-name="assetIssuanceId"/></entity-find><set field="curAssetIssuanceId" from="invoiceAsiList[0]?.assetIssuanceId"/></if><set field="quantityNotReceipt" from="quantityToBill"/><entity-find entity-name="mantle.product.receipt.AssetReceipt" list="assetReceiptList"><econdition field-name="orderId"/><econdition field-name="orderItemSeqId" from="orderItem.orderItemSeqId"/></entity-find><iterate list="assetReceiptList" entry="assetReceipt"><if condition="!assetReceipt.invoiceId && quantityNotReceipt >= assetReceipt.quantityAccepted"><set field="assetReceipt.invoiceId" from="invoiceId"/><set field="assetReceipt.invoiceItemSeqId" from="invoiceItemSeqId"/><entity-update value-field="assetReceipt"/><set field="quantityNotReceipt" from="quantityNotReceipt - assetReceipt.quantityAccepted"/><set field="curAssetReceiptId" from="assetReceipt.assetReceiptId"/></if></iterate><if condition="!curAssetReceiptId"><entity-find entity-name="mantle.product.receipt.AssetReceipt" list="invoiceAsrList"><econdition field-name="invoiceId"/><econdition field-name="invoiceItemSeqId"/><select-field field-name="assetReceiptId"/></entity-find><set field="curAssetReceiptId" from="invoiceAsrList[0]?.assetReceiptId"/></if></if><service-call name="create#mantle.order.OrderItemBilling" in-map="[orderId:orderId, orderItemSeqId:orderItem.orderItemSeqId,                         invoiceId:invoiceId, invoiceItemSeqId:invoiceItemSeqId, quantity:quantityToBill, amount:invoiceItem.amount,                         shipmentId:curShipmentId, assetReceiptId:curAssetReceiptId, assetIssuanceId:curAssetIssuanceId]"/><set field="invoiceQtyRemaining" from="invoiceQtyRemaining - quantityToBill"/></iterate><if condition="invoiceQtyRemaining == 0.0"><then><script><![CDATA[ec.message.addMessage("Invoice ${invoiceId} item ${invoiceItemSeqId} now fully applied", 'success')]]></script></then><else-if condition="invoiceQtyRemaining < invoiceQtyOrig"><script><![CDATA[ec.message.addMessage("Invoice ${invoiceId} item ${invoiceItemSeqId} partially applied", 'warning')]]></script></else-if><else><script><![CDATA[ec.message.addMessage("No order item matches found for invoice ${invoiceId} item ${invoiceItemSeqId}", 'warning')]]></script></else></if></actions></service>