<!--Service Location mantle.product.AssetServices.check#AssetReservationValid--><service verb="check" noun="AssetReservationValid"><in-parameters><parameter name="assetReservationId" required="true"/><parameter name="assetReservation" type="EntityValue"/><parameter name="asset" type="EntityValue"/><parameter name="orderItem" type="EntityValue"/></in-parameters><out-parameters><parameter name="reservationInvalid" type="Boolean"/><parameter name="quantityNotValid" type="BigDecimal"/></out-parameters><actions><set field="reservationInvalid" from="false"/><set field="quantityNotValid" from="0.0"/><if condition="assetReservation == null"><entity-find-one entity-name="mantle.product.issuance.AssetReservation" value-field="assetReservation"/></if><if condition="assetReservation == null"><return message="Reservation not found for ID ${assetReservationId}"/></if><if condition="asset == null"><set field="asset" from="assetReservation.asset"/></if><if condition="asset == null"><return message="Asset not found for ID ${assetId}"/></if><if condition="orderItem == null"><set field="orderItem" from="assetReservation.orderItem"/></if><if condition="!reservationInvalid && asset.statusId != 'AstAvailable'"><log message="AssetReservation ${assetReservationId} for OrderItem ${orderItem.orderId}:${orderItem.orderItemSeqId} is no longer valid for Asset ${asset.assetId} in status ${asset.statusId}"/><set field="reservationInvalid" from="true"/></if><if condition="!reservationInvalid && asset.facilityId"><if condition="orderItem != null"><if condition="orderPart == null"><set field="orderPart" from="orderItem.part"/></if><if condition="orderPart.facilityId"><then><if condition="asset.facilityId != orderPart.facilityId"><log message="AssetReservation ${assetReservationId} for OrderItem ${orderItem.orderId}:${orderItem.orderItemSeqId} is no longer valid for Asset ${asset.assetId} with facilityId ${asset.facilityId}, order part facilityId ${orderPart.facilityId}"/><set field="reservationInvalid" from="true"/></if></then><else><if condition="orderHeader == null"><set field="orderHeader" from="orderItem.header"/></if><set field="productStore" from="orderHeader.productStore"/><set field="facilityIdSet" from="new TreeSet()"/><if condition="productStore.inventoryFacilityId"><script><![CDATA[facilityIdSet.add(productStore.inventoryFacilityId)]]></script></if><entity-find entity-name="mantle.product.store.ProductStoreFacility" list="productStoreFacilityList"><date-filter/><econdition field-name="productStoreId"/></entity-find><if condition="productStoreFacilityList"><script><![CDATA[facilityIdSet.addAll(productStoreFacilityList*.facilityId)]]></script></if><if condition="!facilityIdSet.contains(asset.facilityId)"><log message="AssetReservation ${assetReservationId} for OrderItem ${orderItem.orderId}:${orderItem.orderItemSeqId} is no longer valid for Asset ${asset.assetId} with facilityId ${asset.facilityId}, ProductStore facilities available ${facilityIdSet}"/><set field="reservationInvalid" from="true"/></if></else></if></if></if><if condition="!reservationInvalid && asset.assetPoolId"><if condition="!assetReservation.orderId || !assetReservation.orderItemSeqId"><then><log message="AssetReservation ${assetReservationId} with no orderId or orderItemSeqId to asset ${assetId} with assetPoolId ${asset.assetPoolId} is not valid"/><set field="reservationInvalid" from="true"/></then><else><if condition="orderItem == null"><set field="orderItem" from="assetReservation.orderItem"/></if><if condition="orderPart == null"><set field="orderPart" from="orderItem.part"/></if><if condition="orderHeader == null"><set field="orderHeader" from="orderItem.header"/></if><service-call name="mantle.product.AssetServices.get#AssetPools" out-map="[assetPoolIdSet:poolsOut.assetPoolIdSet]" in-map="[productStoreId:orderHeader.productStoreId, vendorPartyId:orderPart?.vendorPartyId,                                 customerPartyId:orderPart?.customerPartyId]"/><set field="assetPoolIdSet" from="poolsOut.assetPoolIdSet"/><if condition="!assetPoolIdSet || !assetPoolIdSet.contains(asset.assetPoolId)"><log message="AssetReservation ${assetReservationId} for OrderItem ${orderItem.orderId}:${orderItem.orderItemSeqId} is no longer valid for Asset ${asset.assetId} with assetPoolId ${asset.assetPoolId}, available pools ${assetPoolIdSet}"/><set field="reservationInvalid" from="true"/></if></else></if></if><if condition="reservationInvalid"><set field="quantityNotValid" from="assetReservation.quantity"/><service-call name="mantle.product.AssetServices.reduce#AssetReservation" in-map="[assetReservationId:assetReservationId, reserveIncreasedAsset:true]"/><if condition="!assetReservation.orderId || !assetReservation.orderItemSeqId"><then><log level="warn" message="AssetReservation ${assetReservationId} has no order item and is no longer valid but cannot re-reserve"/></then><else><service-call name="mantle.product.AssetServices.reserve#AssetForOrderItem" in-map="[orderId:assetReservation.orderId, orderItemSeqId:assetReservation.orderItemSeqId,                                 skipAssetIds:[asset.assetId]]"/></else></if></if></actions></service>