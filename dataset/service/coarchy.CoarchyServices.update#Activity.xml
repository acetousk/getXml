<!--Service Location coarchy.CoarchyServices.update#Activity--><service verb="update" noun="Activity"><in-parameters><parameter name="activityId" required="true" entity-name="coarchy.Activity" field-name="activityId"/><parameter name="condition" entity-name="coarchy.Activity" field-name="condition"/><parameter name="actorIdList" type="List"/><parameter name="action" entity-name="coarchy.Activity" field-name="action"/><parameter name="implementationId" entity-name="coarchy.Activity" field-name="implementationId"/><parameter name="organizationId" required="true" entity-name="coarchy.Activity" field-name="organizationId"/><parameter name="ignoreCopyOnWrite" type="Boolean" default="false"/></in-parameters><out-parameters/><actions><set field="condition" from="condition?.trim()"/><set field="action" from="action?.trim()"/><if condition="(condition || (actorIdList?.size()>0)) && !action"><return error="true" message="${ec.resource.expand('CoarchyProcessActivityActionUpdateRequired', null)}"/></if><if condition="condition.length() > 0 || actorIdList.size() > 0"><then><if condition="Character.isUpperCase(action.charAt(0))"><set field="action" from="action[0].toLowerCase() + action.substring(1)"/></if></then><else-if condition="Character.isLowerCase(action.charAt(0))"><set field="action" from="action[0].toUpperCase() + action.substring(1)"/></else-if></if><entity-find entity-name="coarchy.product.ProductEvaluationActivityAndDetail" list="existingEvaluationRecords"><econdition field-name="statusId" operator="not-equals" value="PeRequirementsSelection"/><econdition field-name="activityId"/><econdition field-name="excludeFlag" value="N" or-null="true"/><econdition field-name="organizationId"/></entity-find><set field="valueChanged" from="false"/><entity-find-one entity-name="coarchy.Activity" value-field="activity"><field-map field-name="activityId"/></entity-find-one><if condition="(activity.condition?:'') != (condition?:'') || (activity.action?:'') != (action?:'') || (activity.implementationId?:'') != (implementationId?:'')"><set field="valueChanged" from="true"/></if><if condition="!valueChanged"><entity-find entity-name="coarchy.ActivityActor" list="activityActorList"><econdition field-name="activityId"/><econdition field-name="organizationId"/></entity-find><if condition="!activityActorList*.actorId.equals(actorIdList)"><set field="valueChanged" from="true"/></if></if><if condition="!valueChanged"><return/></if><if condition="existingEvaluationRecords && !ignoreCopyOnWrite"><service-call name="create#coarchy.Activity" in-map="activity + [activityId:null, replacedByActivityId:null, condition:condition, action:action, implementationId:implementationId]" out-map="[activityId:newActivityOut.activityId,condition:newActivityOut.condition,action:newActivityOut.action,replacedByActivityId:newActivityOut.replacedByActivityId,implementationId:newActivityOut.implementationId,organizationId:newActivityOut.organizationId,lastUpdatedStamp:newActivityOut.lastUpdatedStamp]"/><set field="newActivityId" from="newActivityOut.activityId"/><entity-find entity-name="coarchy.ActivityActor" list="activityActorList"><econdition field-name="activityId"/><econdition field-name="organizationId"/></entity-find><iterate list="activityActorList" entry="activityActor"><service-call name="create#coarchy.ActivityActor" in-map="activityActor + [activityId:newActivityId]"/></iterate><entity-find entity-name="coarchy.ValueStatementActivity" list="valueStatementActivityList"><econdition field-name="activityId"/><econdition field-name="organizationId"/></entity-find><iterate list="valueStatementActivityList" entry="valueActivity"><service-call name="create#coarchy.ValueStatementActivity" in-map="valueActivity + [valueStatementActivityId:null, activityId:newActivityId, fromDate:ec.user.nowTimestamp]"/><service-call name="update#coarchy.ValueStatementActivity" in-map="[valueStatementActivityId:valueActivity.valueStatementActivityId, thruDate:ec.user.nowTimestamp]"/></iterate><entity-find entity-name="coarchy.ProcessStoryActivity" list="processStoryActivityList" for-update="true"><econdition field-name="activityId"/><econdition field-name="organizationId"/></entity-find><iterate list="processStoryActivityList" entry="processStoryActivity"><service-call name="create#coarchy.ProcessStoryActivity" in-map="processStoryActivity + [processStoryActivityId:null, activityId:newActivityId, fromDate:ec.user.nowTimestamp]"/><set field="processStoryActivity.thruDate" from="ec.user.nowTimestamp"/><entity-update value-field="processStoryActivity"/></iterate><entity-find entity-name="mantle.work.effort.WorkEffort" list="checklistWorkEffortList" for-update="true"><econdition field-name="workEffortTypeEnumId" value="WetChecklistItem"/><econdition field-name="ownerPartyId" from="organizationId"/><econdition field-name="activityId"/></entity-find><iterate list="checklistWorkEffortList" entry="checklistWorkEffort"><set field="checklistWorkEffort.activityId" from="newActivityId"/><entity-update value-field="checklistWorkEffort"/></iterate><entity-find entity-name="coarchy.product.ProductEvaluationActivityAndDetail" list="existingEvaluationActivityList"><econdition field-name="statusId" value="PeRequirementsSelection"/><econdition field-name="activityId"/></entity-find><iterate list="existingEvaluationActivityList" entry="existingEvaluationActivity"><service-call name="create#coarchy.product.ProductEvaluationActivity" in-map="existingEvaluationActivity+[activityId:newActivityId]"/><service-call name="delete#coarchy.product.ProductEvaluationActivity" in-map="[activityId:activityId, productEvaluationId:existingEvaluationActivity.productEvaluationId, processStoryId:existingEvaluationActivity.processStoryId]"/></iterate><service-call name="update#coarchy.Activity" in-map="[activityId:activityId, replacedByActivityId:newActivityId]"/><set field="activityId" from="newActivityId"/><else><service-call name="update#coarchy.Activity" in-map="[activityId:activityId, condition:condition, action:action, implementationId:implementationId]"/></else></if><entity-find entity-name="coarchy.ActivityActorDetail" list="activityActorList"><econdition field-name="activityId"/><order-by field-name="name"/></entity-find><set field="actorIdServerList" from="activityActorList*.actorId"/><if condition="actorIdServerList"><set field="actorIdDeleteList" from="actorIdServerList - actorIdList?:[]"/><iterate list="actorIdDeleteList" entry="actorIdDelete"><service-call name="delete#coarchy.ActivityActor" in-map="[activityId:activityId,actorId:actorIdDelete]"/></iterate></if><set field="actorIdCreateList" from="actorIdList?:[] - actorIdDeleteList?:[]"/><if condition="actorIdCreateList instanceof String"><then><service-call name="store#coarchy.ActivityActor" in-map="[activityId:activityId, actorId:actorIdCreateList, organizationId:organizationId]"/></then><else><iterate list="actorIdCreateList" entry="actorIdCreate"><service-call name="store#coarchy.ActivityActor" in-map="[activityId:activityId, actorId:actorIdCreate, organizationId:organizationId]"/></iterate></else></if></actions></service>