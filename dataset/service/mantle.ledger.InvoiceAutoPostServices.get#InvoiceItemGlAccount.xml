<!--Service Location mantle.ledger.InvoiceAutoPostServices.get#InvoiceItemGlAccount--><service verb="get" noun="InvoiceItemGlAccount"><in-parameters><parameter name="acctgTransTypeEnumId"/><parameter name="organizationPartyId" required="true"/><parameter name="otherPartyId"/><parameter name="itemTypeEnumId" required="true"/><parameter name="productId"/><parameter name="direction" required="true"/></in-parameters><out-parameters><parameter name="glAccountId"/><parameter name="glAccountTypeEnumId"/><parameter name="glAccount" type="EntityValue"/></out-parameters><actions><service-call name="mantle.ledger.LedgerServices.expand#ParentOrganizationList" out-map="[orgPartyIdList:context.orgPartyIdList]" in-map="[organizationPartyId:organizationPartyId]"/><entity-find entity-name="moqui.basic.EnumGroupMember" list="productItemTypeEgms" cache="true"><econdition field-name="enumGroupEnumId" value="EngItemsProduct"/></entity-find><set field="productItemTypes" from="productItemTypeEgms*.enumId"/><if condition="productId && itemTypeEnumId in productItemTypes"><entity-find entity-name="mantle.product.category.ProductCategoryMember" list="productCategoryMemberList"><date-filter/><econdition field-name="productId"/></entity-find><entity-find entity-name="mantle.ledger.config.ProductCategoryGlAccount" list="productCategoryGlAccountList"><econdition field-name="productCategoryId" operator="in" from="productCategoryMemberList.productCategoryId"/><econdition field-name="organizationPartyId" operator="in" from="orgPartyIdList"/></entity-find><set field="glAccountId" from="productCategoryGlAccountList ?                     (direction == 'O' ? productCategoryGlAccountList[0].glAccountId : productCategoryGlAccountList[0].contraGlAccountId) : null"/><if condition="!glAccountId"><entity-find entity-name="mantle.ledger.config.ProductGlAccount" list="productGlAccountList"><econdition field-name="productId"/><econdition field-name="organizationPartyId" operator="in" from="orgPartyIdList"/></entity-find><set field="glAccountId" from="productGlAccountList ?                         (direction == 'O' ? productGlAccountList[0].glAccountId : productGlAccountList[0].contraGlAccountId) : null"/></if><if condition="!glAccountId"><entity-find-one entity-name="mantle.product.Product" value-field="product"><field-map field-name="productId"/></entity-find-one><if condition="product?.assetTypeEnumId"><set field="assetTypeGlAccount" from="null"/><service-call name="mantle.ledger.AssetAutoPostServices.get#AssetTypeGlAccount" out-map="[assetTypeGlAccount:context.assetTypeGlAccount]" in-map="[organizationPartyId:organizationPartyId,                                     assetTypeEnumId:product.assetTypeEnumId, classEnumId:product.assetClassEnumId]"/><set field="glAccountId" from="direction == 'O' ? assetTypeGlAccount?.profitGlAccountId : assetTypeGlAccount?.receiptGlAccountId"/></if></if></if><if condition="!glAccountId"><entity-find entity-name="mantle.ledger.config.ItemTypeGlAccount" list="itemTypeGlAccountList" cache="true"><econdition field-name="organizationPartyId" operator="in" from="orgPartyIdList"/><econdition field-name="itemTypeEnumId"/><econditions combine="or"><econdition field-name="direction"/><econdition field-name="direction" value="E"/></econditions></entity-find><set field="glAccountId" from="itemTypeGlAccountList.first?.glAccountId"/></if><if condition="glAccountId"><entity-find-one entity-name="mantle.ledger.account.GlAccount" value-field="glAccount" cache="true"><field-map field-name="glAccountId"/></entity-find-one><set field="glAccountTypeEnumId" from="glAccount?.glAccountTypeEnumId"/></if></actions></service>