<!--Service Location mantle.account.FinancialAccountServices.authorize#FinancialAccount--><service verb="authorize" noun="FinancialAccount"><in-parameters><parameter name="finAccountId" required="true" entity-name="mantle.account.financial.FinancialAccount" field-name="finAccountId"/><parameter name="amount" type="BigDecimal" required="true"/><parameter name="authorizationDate" type="Timestamp" default="ec.user.nowTimestamp"/><parameter name="paymentId"/></in-parameters><out-parameters><parameter name="preAvailableBalance" type="BigDecimal"/><parameter name="postAvailableBalance" type="BigDecimal"/><parameter name="finAccountAuthId"/><parameter name="responseCode"><description><![CDATA[May be 'success' or 'nsf']]></description></parameter><parameter name="responseMessage"/></out-parameters><actions><entity-find-one entity-name="mantle.account.financial.FinancialAccount" value-field="financialAccount" for-update="true"/><set field="preAvailableBalance" from="financialAccount.availableBalance"/><if condition="preAvailableBalance < amount"><set field="responseCode" value="nsf"/><set field="responseMessage" value="Insufficient funds: ${ec.l10n.format(preAvailableBalance, '0.00')} available, authorize amount ${ec.l10n.format(amount, '0.00')}"/><return/></if><set field="financialAccountType" from="financialAccount.type"/><set field="authValidDays" from="(financialAccountType?.authValidDays) ?: 7"/><script><![CDATA[Calendar expireCal = ec.user.nowCalendar
                expireCal.setTimeInMillis(authorizationDate.time)
                expireCal.add(Calendar.DAY_OF_MONTH, authValidDays as int)
                expireDate = new Timestamp(expireCal.getTimeInMillis())]]></script><service-call name="create#mantle.account.financial.FinancialAccountAuth" in-map="context" out-map="[finAccountAuthId:context.finAccountAuthId,finAccountId:context.finAccountId,amount:context.amount,authorizationDate:context.authorizationDate,expireDate:context.expireDate,paymentId:context.paymentId,lastUpdatedStamp:context.lastUpdatedStamp]"/><service-call name="mantle.account.FinancialAccountServices.calculate#FinancialAccountTotals" in-map="[finAccountId:finAccountId]" out-map="[currencyUomId:totalsOut.currencyUomId,actualBalance:totalsOut.actualBalance,authBalance:totalsOut.authBalance,availableBalance:totalsOut.availableBalance]"/><set field="postAvailableBalance" from="totalsOut.availableBalance"/><set field="differAmount" from="preAvailableBalance - postAvailableBalance"/><if condition="differAmount != amount"><return error="true" message="Error in authorization for financial account ${ec.resource.expand('FinancialAccountNameTemplate','',financialAccount)}, pre balance ${preAvailableBalance} and post balance ${postAvailableBalance} differ by [${differAmount}] and not by auth amount ${amount}"/></if><set field="responseCode" value="success"/><set field="responseMessage" value="Authorized ${ec.l10n.format(amount, '0.00')} for account ${ec.resource.expand('FinancialAccountNameTemplate','',financialAccount)}"/></actions></service>