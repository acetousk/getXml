<!--Service Location mantle.account.PaymentServices.authorize#StorePayment--><service verb="authorize" noun="StorePayment"><in-parameters><parameter name="productStoreId" required="true"/><parameter name="paymentId" required="true"/><parameter name="cardSecurityCode"/><parameter name="payment" type="EntityValue"/></in-parameters><out-parameters><parameter name="paymentGatewayResponseId"/><parameter name="paymentGatewayResponse" type="EntityValue"/></out-parameters><actions><if condition="payment == null"><entity-find-one entity-name="mantle.account.payment.Payment" value-field="payment"/></if><if condition="payment == null"><return message="Payment ${paymentId} not found"/></if><set field="paymentGatewayConfigId" from="payment.paymentGatewayConfigId"/><if condition="payment.paymentMethodId"><set field="paymentMethod" from="payment.method"/><if condition="paymentMethod?.paymentGatewayConfigId"><set field="paymentGatewayConfigId" from="paymentMethod.paymentGatewayConfigId"/></if></if><if condition="!paymentGatewayConfigId"><entity-find-one entity-name="mantle.product.store.ProductStorePaymentGateway" value-field="productStorePaymentGateway" cache="true"><field-map field-name="productStoreId" from="productStoreId"/><field-map field-name="paymentInstrumentEnumId" from="payment.paymentInstrumentEnumId"/></entity-find-one><set field="paymentGatewayConfigId" from="productStorePaymentGateway?.paymentGatewayConfigId"/></if><service-call name="mantle.account.PaymentServices.authorize#SinglePayment" out-map="[paymentGatewayResponseId:context.paymentGatewayResponseId,paymentGatewayResponse:context.paymentGatewayResponse]" in-map="[paymentId:payment.paymentId, cardSecurityCode:cardSecurityCode, payment:payment,                         paymentGatewayConfigId:paymentGatewayConfigId]"/></actions></service>