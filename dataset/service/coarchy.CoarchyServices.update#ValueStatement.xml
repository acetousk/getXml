<!--Service Location coarchy.CoarchyServices.update#ValueStatement--><service verb="update" noun="ValueStatement"><in-parameters><parameter name="valueStatementId" required="true" entity-name="coarchy.ValueStatement" field-name="valueStatementId"/><parameter name="value" required="true" entity-name="coarchy.ValueStatement" field-name="value"/><parameter name="tagIdList" type="List"/><parameter name="typeEnumId" entity-name="coarchy.ValueStatement" field-name="typeEnumId"/><parameter name="sequenceNum" entity-name="coarchy.ValueStatement" field-name="sequenceNum"/><parameter name="organizationId" required="true" entity-name="coarchy.ValueStatement" field-name="organizationId"/><parameter name="ignoreCopyOnWrite" type="Boolean" default="false"/></in-parameters><out-parameters><parameter name="valueStatementId" entity-name="coarchy.ValueStatement" field-name="valueStatementId"/></out-parameters><actions><set field="value" from="value.trim()"/><entity-find entity-name="coarchy.ValueStatement" list="valueStatementList" limit="20"><econdition field-name="disabled" value="N" or-null="true"/><econdition field-name="replacedByValueStatementId" operator="is-null"/><econdition field-name="valueStatementId" operator="not-equals"/><econdition field-name="value" from="value" ignore-case="true"/></entity-find><if condition="valueStatementList"><return type="danger" message="Statement '${valueStatementList?.getFirst()?.value}' already exists"/></if><entity-find entity-name="coarchy.product.ProductEvaluationStatementAndDetail" list="existingEvaluationRecords"><econdition field-name="statusId" operator="not-equals" value="PeRequirementsSelection"/><econdition field-name="statementId" from="valueStatementId"/><econdition field-name="organizationId"/></entity-find><set field="valueChanged" from="false"/><entity-find-one entity-name="coarchy.ValueStatement" value-field="valueStatement"><field-map field-name="valueStatementId"/></entity-find-one><if condition="(valueStatement.value?:'') != (value?.trim()?:'') || (valueStatement.typeEnumId?:'') != (typeEnumId?:'')"><set field="valueChanged" from="true"/></if><if condition="valueChanged"><if condition="existingEvaluationRecords && !ignoreCopyOnWrite"><then><service-call name="create#coarchy.ValueStatement" in-map="valueStatement + [valueStatementId:null, value:value,typeEnumId:typeEnumId]" out-map="[valueStatementId:newStatementOut.valueStatementId,value:newStatementOut.value,sequenceNum:newStatementOut.sequenceNum,typeEnumId:newStatementOut.typeEnumId,disabled:newStatementOut.disabled,replacedByValueStatementId:newStatementOut.replacedByValueStatementId,organizationId:newStatementOut.organizationId,lastUpdatedStamp:newStatementOut.lastUpdatedStamp]"/><set field="newValueStatementId" from="newStatementOut.valueStatementId"/><entity-find entity-name="coarchy.ValueStatementTag" list="statementTagList"><date-filter/><econdition field-name="valueStatementId"/><econdition field-name="organizationId"/></entity-find><iterate list="statementTagList" entry="statementTag"><service-call name="create#coarchy.ValueStatementTag" in-map="statementTag+[valueStatementId:newValueStatementId]"/></iterate><entity-find entity-name="coarchy.product.ProductEvaluationStatementAndDetail" list="existingEvaluationStatementList"><econdition field-name="statusId" value="PeRequirementsSelection"/><econdition field-name="statementId" from="valueStatementId"/></entity-find><iterate list="existingEvaluationStatementList" entry="existingEvaluationStatement"><service-call name="create#coarchy.product.ProductEvaluationStatement" in-map="existingEvaluationStatement+[statementId:newValueStatementId]"/><service-call name="delete#coarchy.product.ProductEvaluationStatement" in-map="[statementId:valueStatementId, productEvaluationId:existingEvaluationStatement.productEvaluationId]"/></iterate><entity-find entity-name="coarchy.ValueStatementActivity" list="valueStatementActivityList"><date-filter/><econdition field-name="valueStatementId"/><econdition field-name="organizationId"/></entity-find><iterate list="valueStatementActivityList" entry="valueActivity"><service-call name="create#coarchy.ValueStatementActivity" in-map="valueActivity + [valueStatementActivityId:null, valueStatementId:newValueStatementId, fromDate:fromDate]"/><service-call name="update#coarchy.ValueStatementActivity" in-map="[valueStatementActivityId:valueActivity.valueStatementActivityId,thruDate:ec.user.nowTimestamp]"/></iterate><service-call name="update#coarchy.ValueStatement" in-map="[valueStatementId:valueStatementId, replacedByValueStatementId:newValueStatementId]"/><set field="valueStatementId" from="newValueStatementId"/></then><else><service-call name="update#coarchy.ValueStatement" in-map="[valueStatementId:valueStatementId,value:value,typeEnumId:typeEnumId,sequenceNum:sequenceNum]" out-map="[valueStatementId:context.valueStatementId,value:context.value,sequenceNum:context.sequenceNum,typeEnumId:context.typeEnumId,disabled:context.disabled,replacedByValueStatementId:context.replacedByValueStatementId,organizationId:context.organizationId,lastUpdatedStamp:context.lastUpdatedStamp]"/></else></if></if><entity-find entity-name="coarchy.ValueStatementTag" list="statementTagList"><date-filter/><econdition field-name="valueStatementId"/><econdition field-name="organizationId"/></entity-find><set field="tagIdServerList" from="statementTagList*.tagId?:[]"/><set field="tagIdDeleteList" from="tagIdServerList - (tagIdList?:[])"/><iterate list="tagIdDeleteList" entry="tagIdDelete"><service-call name="coarchy.CoarchyServices.delete#ValueStatementTag" in-map="[valueStatementId:valueStatementId, tagId:tagIdDelete, organizationId:organizationId]"/></iterate><set field="tagIdCreateList" from="(tagIdList?:[]) - (tagIdDeleteList?:[])"/><iterate list="tagIdCreateList" entry="tagIdCreate"><service-call name="coarchy.CoarchyServices.create#ValueStatementTag" in-map="[valueStatementId:valueStatementId, tagId:tagIdCreate, organizationId:organizationId]"/></iterate></actions></service>