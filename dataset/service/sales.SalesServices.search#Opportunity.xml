<!--Service Location sales.SalesServices.search#Opportunity--><service verb="search" noun="Opportunity"><in-parameters><parameter name="anyField"/><parameter name="accountPartyId"/><parameter name="name"/><parameter name="partyId"/><parameter name="orderByField"/><parameter name="pageIndex" type="Integer" default="0"/><parameter name="pageSize" type="Integer" default="20"/><parameter name="pageNoLimit" type="Boolean" default="false"/></in-parameters><out-parameters><parameter name="queryString"/><parameter name="documentList" type="List"><parameter name="document" type="Map"/></parameter><parameter name="documentListCount" type="Integer"/><parameter name="documentListPageIndex" type="Integer"/><parameter name="documentListPageSize" type="Integer"/><parameter name="documentListPageMaxIndex" type="Integer"/><parameter name="documentListPageRangeLow" type="Integer"/><parameter name="documentListPageRangeHigh" type="Integer"/></out-parameters><actions><set field="indexName" value="mantle_sales_oppy"/><set field="documentType" value="MantleSalesOpportunity"/><if condition="accountPartyId"><set field="queryString" from="(queryString ? queryString + ' AND ' : '' ) + 'accountPartyId:' + accountPartyId"/></if><if condition="name"><set field="queryString" from="(queryString ? queryString + ' AND ' : '' ) + 'name:' + name"/></if><if condition="partyId"><set field="queryString" from="(queryString ? queryString + ' AND ' : '' ) + 'SalesOpportunityParty.partyId:' + partyId"/></if><set field="activeOrgId" from="ec.user.context?.activeOrgId"/><set field="filterOrgIds" from="ec.user.context?.filterOrgIds"/><set field="findFilters" from="ec.artifactExecution.getFindFiltersForUser('mantle.party.Party')"/><if condition="findFilters"><set field="entityFilterSetId" from="findFilters[0].entityFilterSetId"/></if><script><![CDATA[if (queryString) {
                    if ('MANTLE_USER_ORG'.equals(entityFilterSetId)) {
                        queryString = (queryString ? queryString + ' AND ' : '' ) + 'ownerPartyId:(' + (filterOrgIds ? filterOrgIds.join(' OR ') + ' OR ' : '') + '_NA_)'
                    } else if ('MANTLE_ACTIVE_ORG'.equals(entityFilterSetId) && activeOrgId) {
                        queryString = (queryString ? queryString + ' AND ' : '' ) + 'ownerPartyId:(' + activeOrgId + ' OR _NA_)'
                    }
                }]]></script><if condition="!queryString"><set field="queryString" value="*:*"/></if><set field="orderByFields" from="orderByField ? [orderByField.replace('combinedName', 'combinedName.keyword').replace('username', 'userAccounts.username.keyword')] : null"/><service-call name="org.moqui.search.SearchServices.search#DataDocuments" out-map="[documentList:context.documentList,documentListCount:context.documentListCount,documentListPageIndex:context.documentListPageIndex,documentListPageSize:context.documentListPageSize,documentListPageMaxIndex:context.documentListPageMaxIndex,documentListPageRangeLow:context.documentListPageRangeLow,documentListPageRangeHigh:context.documentListPageRangeHigh]" in-map="[indexName:indexName, documentType:documentType, queryString:queryString,orderByFields:orderByFields, highlightFields:highlightFields, nestedQueryMap:nestedQueryMap,                              pageIndex:pageIndex, pageSize:pageSize, pageNoLimit:pageNoLimit]"/><if condition="documentList"><iterate list="documentList" entry="doc"><script><![CDATA[doc.put("formatted_estimated_amount",ec.l10n.formatCurrency(doc.estimatedAmount ?: 0, doc?.currencyUomId))]]></script></iterate></if></actions></service>