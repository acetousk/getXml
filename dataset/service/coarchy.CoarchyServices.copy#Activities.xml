<!--Service Location coarchy.CoarchyServices.copy#Activities--><service verb="copy" noun="Activities"><in-parameters><parameter name="activityId" required="true"/><parameter name="moveTypeEnumId" required="true"/><parameter name="activityIdNum" required="true" type="Integer"/></in-parameters><out-parameters><parameter name="activityId"/><parameter name="clipboardEntryId"/></out-parameters><actions><if condition="!ec.user.context?.clipboardEntryId"><entity-find-count entity-name="moqui.basic.Enumeration" count-field="enumCount"><econdition field-name="enumTypeId" value="ClipboardMoveType"/><econdition field-name="enumId" from="moveTypeEnumId"/></entity-find-count><if condition="enumCount == 0"><log level="warn" message="Invalid moveTypeEnumId ${moveTypeEnumId}"/><return type="danger" error="true" public="true" message="${ec.resource.expand('CoarchyGeneralError', null)}"/></if><entity-find entity-name="coarchy.ClipboardEntry" list="entryList"><econdition field-name="partyId" from="ec.user.userAccount?.partyId"/><order-by field-name="-entryDate"/></entity-find><iterate list="entryList" entry="entry"><if condition="entry_index >= 4"><entity-find entity-name="coarchy.ClipboardActor" list="actorList"><econdition field-name="clipboardEntryId" from="entry.clipboardEntryId"/><order-by field-name="actorSeqId"/></entity-find><iterate list="actorList" entry="actor"><service-call name="delete#coarchy.ClipboardActor" in-map="[clipboardEntryId:entry.clipboardEntryId,                                 actorSeqId:actor.actorSeqId]"/></iterate><entity-find entity-name="coarchy.ClipboardActivity" list="activityList"><econdition field-name="clipboardEntryId" from="entry.clipboardEntryId"/><order-by field-name="activitySeqId"/></entity-find><iterate list="activityList" entry="activity"><entity-find entity-name="coarchy.ClipboardActivityStatement" list="activityStatementList"><econdition field-name="clipboardEntryId" from="entry.clipboardEntryId"/><econdition field-name="activitySeqId" from="activity.activitySeqId"/><order-by field-name="statementSeqId"/></entity-find><iterate list="activityStatementList" entry="activityStatement"><service-call name="delete#coarchy.ClipboardActivityStatement" in-map="[clipboardEntryId:entry.clipboardEntryId,                                     activitySeqId:activity.activitySeqId, statementSeqId:activityStatement.statementSeqId]"/></iterate><service-call name="delete#coarchy.ClipboardActivity" in-map="[clipboardEntryId:entry.clipboardEntryId,                                 activitySeqId:activity.activitySeqId]"/></iterate><service-call name="delete#coarchy.ClipboardEntry" in-map="[clipboardEntryId:entry.clipboardEntryId]"/></if></iterate><service-call name="create#coarchy.ClipboardEntry" in-map="[partyId:ec.user.userAccount?.partyId,                     fromOrganizationId:ec.user.context?.activeOrgId,moveTypeEnumId:moveTypeEnumId,entryDate:                     ec.user.nowTimestamp]" out-map="[clipboardEntryId:context.clipboardEntryId,partyId:context.partyId,moveTypeEnumId:context.moveTypeEnumId,fromOrganizationId:context.fromOrganizationId,entryDate:context.entryDate,lastUpdatedStamp:context.lastUpdatedStamp]"/><set field="ec.user.context.clipboardEntryId" from="clipboardEntryId"/></if><if condition="ec.user.context?.activityIdList==null"><set field="ec.user.context.activityIdList" from="[]"/></if><set field="ec.user.context.activityIdList" from="ec.user.context.activityIdList + [activityId]"/><set field="activityIdList" from="ec.user.context.activityIdList"/><set field="clipboardEntryId" from="ec.user.context.clipboardEntryId"/><entity-find-one entity-name="coarchy.Activity" value-field="activity" auto-field-map="[activityId:activityId]"/><service-call name="create#coarchy.ClipboardActivity" in-map="[clipboardEntryId:clipboardEntryId,                 condition:activity.condition,action:activity.action,implementationId:activity.implementationId]" out-map="[clipboardEntryId:activityOut.clipboardEntryId,activitySeqId:activityOut.activitySeqId,condition:activityOut.condition,action:activityOut.action,implementationId:activityOut.implementationId,lastUpdatedStamp:activityOut.lastUpdatedStamp]"/><entity-find entity-name="ActivityActorDetail" list="actorList" distinct="true"><econdition field-name="activityId"/><select-field field-name="actorId,activityId,name,description"/></entity-find><iterate list="actorList" entry="actor"><service-call name="create#coarchy.ClipboardActor" in-map="[clipboardEntryId:clipboardEntryId,                     activitySeqId:activityOut.activitySeqId,name:actor.name,description:actor.description]"/></iterate><entity-find entity-name="ValueStatementActivityDetail" list="statementActivityDetailList" distinct="true"><econdition field-name="activityId"/><select-field field-name="activityId,valueStatementId,value,typeEnumId,organizationId"/></entity-find><iterate list="statementActivityDetailList" entry="statementActivityDetail"><service-call name="create#coarchy.ClipboardActivityStatement" in-map="[clipboardEntryId:clipboardEntryId,                     activitySeqId:activityOut.activitySeqId,value:statementActivityDetail.value,typeEnumId:statementActivityDetail.typeEnumId]"/></iterate><if condition="moveTypeEnumId=='CbmtCut' && activityIdList.size() == activityIdNum.toInteger()"><iterate list="activityIdList" entry="activityId"><service-call name="coarchy.CoarchyServices.delete#Activity" in-map="[activityId:activityId]"/></iterate></if></actions></service>