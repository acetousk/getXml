<!--Service Location mantle.account.InvoiceServices.update#InvoiceItemAdjustment--><service verb="update" noun="InvoiceItemAdjustment"><in-parameters><parameter name="invoiceId" required="true"/><parameter name="invoiceItemSeqId" required="true"/><parameter name="parentItemSeqId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.invoice.InvoiceItem" field-name="parentItemSeqId"/><parameter name="itemTypeEnumId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.invoice.InvoiceItem" field-name="itemTypeEnumId"/><parameter name="overrideGlAccountId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.invoice.InvoiceItem" field-name="overrideGlAccountId"/><parameter name="assetId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.invoice.InvoiceItem" field-name="assetId"/><parameter name="productId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.invoice.InvoiceItem" field-name="productId"/><parameter name="otherPartyProductId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.invoice.InvoiceItem" field-name="otherPartyProductId"/><parameter name="parentInvoiceId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.invoice.InvoiceItem" field-name="parentInvoiceId"/><parameter name="parentInvoiceItemSeqId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.invoice.InvoiceItem" field-name="parentInvoiceItemSeqId"/><parameter name="taxableFlag" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.invoice.InvoiceItem" field-name="taxableFlag"/><parameter name="quantity" type="java.math.BigDecimal" required="false" allow-html="none" entity-name="mantle.account.invoice.InvoiceItem" field-name="quantity"/><parameter name="quantityUomId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.invoice.InvoiceItem" field-name="quantityUomId"/><parameter name="amount" type="java.math.BigDecimal" required="false" allow-html="none" entity-name="mantle.account.invoice.InvoiceItem" field-name="amount"/><parameter name="description" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.invoice.InvoiceItem" field-name="description"/><parameter name="itemDate" type="java.sql.Timestamp" required="false" allow-html="none" entity-name="mantle.account.invoice.InvoiceItem" field-name="itemDate"/><parameter name="salesOpportunityId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.invoice.InvoiceItem" field-name="salesOpportunityId"/><parameter name="taxAuthorityId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.invoice.InvoiceItem" field-name="taxAuthorityId"/><parameter name="payrollAdjustmentId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.invoice.InvoiceItem" field-name="payrollAdjustmentId"/><parameter name="finAccountId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.invoice.InvoiceItem" field-name="finAccountId"/><parameter name="finAccountTransId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.invoice.InvoiceItem" field-name="finAccountTransId"/><parameter name="billThruVendorName" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.invoice.InvoiceItem" field-name="billThruVendorName"/><parameter name="billThruVendorRef" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.invoice.InvoiceItem" field-name="billThruVendorRef"/><parameter name="lastUpdatedStamp" type="java.sql.Timestamp" required="false" allow-html="none" entity-name="mantle.account.invoice.InvoiceItem" field-name="lastUpdatedStamp"/></in-parameters><out-parameters/><actions><entity-find-one entity-name="mantle.account.invoice.InvoiceItem" value-field="invoiceItem"/><if condition="invoiceItem == null"><return error="true" message="Could not find Invoice Item with ID ${invoiceId}:${invoiceItemSeqId}"/></if><if condition="invoiceItem.isAdjustment != 'Y'"><return error="true" message="Invoice Item with ID ${invoiceId}:${invoiceItemSeqId} is not an Adjustment item"/></if><if condition="(amount != null && amount != invoiceItem.amount) || (quantity != null && quantity != invoiceItem.quantity)"><set field="origTotal" from="(invoiceItem.amount ?: 0.0) * (invoiceItem.quantity ?: 1.0)"/><set field="newTotal" from="(amount != null ? amount : (invoiceItem.amount ?: 0.0)) * (quantity != null ? quantity : (invoiceItem.quantity ?: 1.0))"/><set field="amountDiff" from="newTotal - origTotal"/><service-call name="mantle.account.InvoiceServices.get#InvoiceTotal" in-map="[invoiceId:invoiceId]" out-map="[invoiceTotal:totalOut.invoiceTotal,appliedPaymentsTotal:totalOut.appliedPaymentsTotal,unpaidTotal:totalOut.unpaidTotal]"/><if condition="totalOut.unpaidTotal + amountDiff < 0.0"><return error="true" message="Adjustment item ${invoiceId}:${invoiceItemSeqId} amount difference of ${amountDiff} would make Unpaid Total less than zero"/></if></if><set field="isAdjustment" value="Y"/><service-call name="update#mantle.account.invoice.InvoiceItem" in-map="context" out-map="[invoiceId:context.invoiceId,invoiceItemSeqId:context.invoiceItemSeqId,parentItemSeqId:context.parentItemSeqId,itemTypeEnumId:context.itemTypeEnumId,overrideGlAccountId:context.overrideGlAccountId,assetId:context.assetId,productId:context.productId,otherPartyProductId:context.otherPartyProductId,parentInvoiceId:context.parentInvoiceId,parentInvoiceItemSeqId:context.parentInvoiceItemSeqId,taxableFlag:context.taxableFlag,quantity:context.quantity,quantityUomId:context.quantityUomId,amount:context.amount,description:context.description,itemDate:context.itemDate,isAdjustment:context.isAdjustment,salesOpportunityId:context.salesOpportunityId,taxAuthorityId:context.taxAuthorityId,payrollAdjustmentId:context.payrollAdjustmentId,finAccountId:context.finAccountId,finAccountTransId:context.finAccountTransId,billThruVendorName:context.billThruVendorName,billThruVendorRef:context.billThruVendorRef,lastUpdatedStamp:context.lastUpdatedStamp]"/></actions></service>