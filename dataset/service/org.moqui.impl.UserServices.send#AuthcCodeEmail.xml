<!--Service Location org.moqui.impl.UserServices.send#AuthcCodeEmail--><service verb="send" noun="AuthcCodeEmail"><in-parameters><parameter name="factorId" required="true"/></in-parameters><out-parameters><parameter name="singleUseFactorId"/><parameter name="code"/></out-parameters><actions><entity-find-one entity-name="moqui.security.UserAuthcFactor" value-field="userAuthcFactor"><field-map field-name="factorId"/></entity-find-one><set field="userId" from="userAuthcFactor.userId"/><set field="emailAddress" from="userAuthcFactor.factorOption"/><entity-find-one entity-name="moqui.security.UserAccount" value-field="userAccount"><field-map field-name="userId"/></entity-find-one><service-call name="org.moqui.impl.UserServices.create#SingleUseAuthcFactor" in-map="[userId:userId, fromFactorId:factorId]" out-map="[factorId:createSuFactorOut.factorId,code:createSuFactorOut.code,thruDate:createSuFactorOut.thruDate]"/><set field="singleUseFactorId" from="createSuFactorOut.factorId"/><service-call name="org.moqui.impl.EmailServices.send#EmailTemplate" async="true"><field-map field-name="emailTemplateId" value="SINGLE_USE_CODE"/><field-map field-name="toAddresses" from="emailAddress"/><field-map field-name="bodyParameters" from="[code:createSuFactorOut.code,                         thruDateString:ec.l10n.format(createSuFactorOut.thruDate, null)]"/></service-call><message><![CDATA[Authentication code sent to ${emailAddress}]]></message><if condition="userAccount.emailAddress && userAccount.emailAddress != emailAddress"><service-call name="org.moqui.impl.EmailServices.send#EmailTemplate" async="true"><field-map field-name="emailTemplateId" value="ADDED_EMAIL_AUTHC_FACTOR"/><field-map field-name="toAddresses" from="userAccount.emailAddress"/><field-map field-name="bodyParameters" from="[userEmail:emailAddress,                             thruDateString:ec.l10n.format(createSuFactorOut.thruDate, null)]"/></service-call></if></actions></service>