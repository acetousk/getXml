<!--Service Location mantle.order.OrderServices.update#OrderPartTotal--><service verb="update" noun="OrderPartTotal"><in-parameters><parameter name="orderId" required="true"/><parameter name="orderPartSeqId" required="true"/><parameter name="originalValue" type="Map"/></in-parameters><out-parameters/><actions><set field="totalSum" from="0.0" type="BigDecimal"/><entity-find-one entity-name="mantle.order.OrderHeader" value-field="orderHeader"/><entity-find entity-name="mantle.order.OrderItem" list="orderItemList"><econdition field-name="orderId"/><econdition field-name="orderPartSeqId"/></entity-find><iterate list="orderItemList" entry="orderItem"><service-call name="mantle.order.OrderServices.get#OrderItemTotal" out-map="[combinedAmount:itemTotalOut.combinedAmount,combinedQuantity:itemTotalOut.combinedQuantity,itemTotal:itemTotalOut.itemTotal,childrenTotal:itemTotalOut.childrenTotal,itemPlusChildrenTotal:itemTotalOut.itemPlusChildrenTotal,childItemCount:itemTotalOut.childItemCount,hasPromo:itemTotalOut.hasPromo,promoQuantityUsed:itemTotalOut.promoQuantityUsed,childOrderItemList:itemTotalOut.childOrderItemList]" in-map="[orderItem:orderItem]"/><set field="totalSum" from="totalSum + itemTotalOut.itemTotal"/></iterate><set field="totalSum" from="ec.l10n.roundCurrency(totalSum as BigDecimal, orderHeader? orderHeader.currencyUomId : 'USD')"/><entity-find-one entity-name="mantle.order.OrderPart" value-field="orderPart" for-update="true"/><set field="orderPart.partTotal" from="totalSum"/><entity-update value-field="orderPart"/><entity-find entity-name="mantle.account.payment.Payment" list="paymentList"><econdition field-name="orderId"/><econdition field-name="orderPartSeqId"/><econdition field-name="statusId" operator="in" value="PmntProposed,PmntPromised"/><select-field field-name="paymentId"/></entity-find><if condition="paymentList.size() == 1"><service-call name="update#mantle.account.payment.Payment" in-map="[paymentId:paymentList.get(0).paymentId, amount:totalSum]"/></if><if condition="paymentList.size() == 0"><entity-find entity-name="mantle.account.payment.Payment" list="declinedPaymentList"><econdition field-name="orderId"/><econdition field-name="orderPartSeqId"/><econdition field-name="statusId" operator="in" value="PmntDeclined"/><select-field field-name="paymentId"/></entity-find><if condition="declinedPaymentList.size() == 1"><service-call name="update#mantle.account.payment.Payment" in-map="[paymentId:declinedPaymentList.get(0).paymentId, amount:totalSum]"/></if></if><service-call name="mantle.order.OrderServices.update#OrderHeaderTotal" in-map="[orderId:orderId]"/></actions></service>