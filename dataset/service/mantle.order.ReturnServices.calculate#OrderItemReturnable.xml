<!--Service Location mantle.order.ReturnServices.calculate#OrderItemReturnable--><service verb="calculate" noun="OrderItemReturnable"><in-parameters><parameter name="orderId" required="true"/><parameter name="orderItemSeqId" required="true"/><parameter name="orderItem" type="Map"/><parameter name="orderItemBillingList" type="List"><parameter name="oib" type="Map"/></parameter><parameter name="returnItemList" type="List"><parameter name="returnItem" type="Map"/></parameter></in-parameters><out-parameters><parameter name="isProductItemType" type="Boolean"/><parameter name="orderQuantity" type="BigDecimal"/><parameter name="invoiceQuantity" type="BigDecimal"/><parameter name="returnedQuantity" type="BigDecimal"/><parameter name="returnableQuantity" type="BigDecimal"/><parameter name="orderTotal" type="BigDecimal"/><parameter name="invoiceTotal" type="BigDecimal"/><parameter name="returnedTotal" type="BigDecimal"/><parameter name="returnableTotal" type="BigDecimal"/></out-parameters><actions><if condition="orderItem == null"><entity-find-one entity-name="mantle.order.OrderItem" value-field="orderItem"/></if><if condition="orderItem == null"><return error="true" message="Could not find Order Item ${orderId}:${orderItemSeqId}"/></if><set field="orderQuantity" from="orderItem.quantity != null ? orderItem.quantity : 1.0"/><set field="orderTotal" from="(orderQuantity * (orderItem.unitAmount ?: 0.0)).setScale(2, BigDecimal.ROUND_HALF_UP)"/><entity-find entity-name="moqui.basic.EnumGroupMember" list="productItemTypeEgms" cache="true"><econdition field-name="enumGroupEnumId" value="EngItemsProduct"/></entity-find><set field="productItemTypes" from="productItemTypeEgms*.enumId"/><set field="isProductItemType" from="orderItem.itemTypeEnumId in productItemTypes"/><set field="invoiceQuantity" from="0"/><set field="invoiceTotal" from="0.0"/><if condition="orderItemBillingList == null"><entity-find entity-name="mantle.order.OrderItemBilling" list="orderItemBillingList"><econdition field-name="orderId"/><econdition field-name="orderItemSeqId"/></entity-find></if><iterate list="orderItemBillingList" entry="oib"><if condition="oib.orderId != orderId || oib.orderItemSeqId != orderItemSeqId"><continue/></if><if condition="oib.quantity == 0.0"><continue/></if><set field="invQuantity" from="oib.quantity != null ? oib.quantity : 1.0"/><set field="invoiceQuantity" from="invoiceQuantity + invQuantity"/><entity-find-one entity-name="mantle.account.invoice.InvoiceItem" value-field="invoiceItem"><field-map field-name="invoiceId" from="oib.invoiceId"/><field-map field-name="invoiceItemSeqId" from="oib.invoiceItemSeqId"/></entity-find-one><set field="invoiceTotal" from="invoiceTotal + (invQuantity * (invoiceItem?.amount ?: 0.0)).setScale(2, BigDecimal.ROUND_HALF_UP)"/></iterate><set field="returnedQuantity" from="0.0"/><set field="returnedTotal" from="0.0"/><if condition="returnItemList == null"><entity-find entity-name="mantle.order.return.ReturnItem" list="returnItemList"><econdition field-name="orderId"/><econdition field-name="orderItemSeqId"/><econdition field-name="statusId" operator="not-equals" value="ReturnCancelled"/><order-by field-name="orderItemSeqId"/></entity-find></if><iterate list="returnItemList" entry="returnItem"><if condition="returnItem.orderId != orderId || returnItem.orderItemSeqId != orderItemSeqId"><continue/></if><set field="retQuantity" from="returnItem.returnQuantity != null ? returnItem.returnQuantity : 1.0"/><set field="returnedQuantity" from="returnedQuantity + retQuantity"/><set field="returnedTotal" from="returnedTotal + (returnItem.responseAmount != null ? returnItem.responseAmount :                         (retQuantity * (returnItem.returnPrice ?: orderItem.unitAmount ?: 0.0)).setScale(2, BigDecimal.ROUND_HALF_UP))"/></iterate><set field="returnableQuantity" from="invoiceQuantity - returnedQuantity"/><set field="returnableTotal" from="invoiceTotal - returnedTotal"/></actions></service>