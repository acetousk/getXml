<!--Service Location mantle.ledger.AssetAutoPostServices.post#AssetReceipt--><service verb="post" noun="AssetReceipt"><in-parameters><parameter name="assetReceiptId" required="true" entity-name="mantle.product.receipt.AssetReceipt" field-name="assetReceiptId"/></in-parameters><out-parameters><parameter name="acctgTransId"/></out-parameters><actions><entity-find-one entity-name="mantle.product.receipt.AssetReceipt" value-field="assetReceipt" for-update="true"/><if condition="assetReceipt == null"><return error="true" message="Not posting inventory transaction, could not find Asset Receipt with ID ${assetReceiptId}"/></if><if condition="!assetReceipt.quantityAccepted"><return message="No quantity accepted on receipt, not posting inventory transaction to GL for receipt ${assetReceiptId}"/></if><set field="asset" from="assetReceipt.'mantle.product.asset.Asset'"/><set field="organizationPartyId" from="asset.ownerPartyId"/><service-call name="mantle.ledger.LedgerServices.find#PartyAcctgPreference" out-map="[partyAcctgPreference:papOut.partyAcctgPreference]" in-map="[organizationPartyId:organizationPartyId]"/><set field="partyAcctgPreference" from="papOut.partyAcctgPreference"/><if condition="!partyAcctgPreference"><log level="trace" message="Not posting Asset Receipt ${assetReceiptId}, could not find PartyAcctgPreference for Owner Party ${organizationPartyId}"/><set field="assetReceipt.acctgTransResultEnumId" value="AtrNoAcctgPreference"/><entity-update value-field="assetReceipt"/><return/></if><if condition="asset.acquireCost == null"><log level="warn" message="Not posting Asset Receipt ${assetReceiptId}, Asset ${asset.assetId} has no Acquire Cost"/><set field="assetReceipt.acctgTransResultEnumId" value="AtrNoAcquireCost"/><entity-update value-field="assetReceipt"/><return message="Not posting Asset Receipt ${assetReceiptId}, Asset ${asset.assetId} has no Acquire Cost"/></if><entity-find entity-name="mantle.ledger.transaction.AcctgTrans" list="existingTransList"><econdition field-name="assetReceiptId"/><econdition field-name="acctgTransTypeEnumId" operator="in" from="['AttInventoryReceipt', 'AttAssetReceipt']"/><econdition field-name="reversedByAcctgTransId" from="null"/><econdition field-name="reverseOfAcctgTransId" from="null"/></entity-find><if condition="existingTransList"><return message="Asset Receipt ${assetReceiptId} has already been posted in accounting transaction ${existingTransList*.acctgTransId}"/></if><service-call name="mantle.ledger.AssetAutoPostServices.get#AssetTypeGlAccount" out-map="[assetTypeGlAccount:context.assetTypeGlAccount]" in-map="[organizationPartyId:organizationPartyId, assetTypeEnumId:asset.assetTypeEnumId,                         classEnumId:asset.classEnumId, assetId:asset.assetId]"/><if condition="asset.assetTypeEnumId == 'AstTpInventory'"><then><set field="acctgTransTypeEnumId" from="assetTypeGlAccount?.receiptTransTypeEnumId ?: 'AttInventoryReceipt'"/><set field="receiptGlAccountTypeEnumId" from="assetReceipt.workEffortId ? 'GatWipInventory' : 'GatUnreceivedInventory'"/><set field="assetGlAccountTypeEnumId" value="GatInventory"/></then><else><set field="acctgTransTypeEnumId" from="assetTypeGlAccount?.receiptTransTypeEnumId ?: 'AttAssetReceipt'"/><set field="receiptGlAccountTypeEnumId" value="GatUnreceivedFixedAsset"/><set field="assetGlAccountTypeEnumId" value="GatFixedAsset"/></else></if><set field="receiptGlAccountId" from="assetReceipt.workEffortId ?                     assetTypeGlAccount?.wipAssetGlAccountId : assetTypeGlAccount?.receiptGlAccountId"/><if condition="assetReceipt.shipmentId && assetTypeGlAccount?.transferGlAccountId"><entity-find-one entity-name="mantle.shipment.Shipment" value-field="shipment"><field-map field-name="shipmentId" from="assetReceipt.shipmentId"/></entity-find-one><if condition="shipment?.shipmentTypeEnumId == 'ShpTpTransfer'"><set field="receiptGlAccountId" from="assetTypeGlAccount.transferGlAccountId"/></if></if><if condition="!receiptGlAccountId"><service-call name="mantle.ledger.LedgerServices.get#DefaultGlAccountByType" out-map="[glAccountId:creditGlAccountOut.glAccountId]" in-map="[glAccountTypeEnumId:receiptGlAccountTypeEnumId, acctgTransTypeEnumId:acctgTransTypeEnumId,                             organizationPartyId:organizationPartyId, otherPartyId:null]"/><set field="receiptGlAccountId" from="creditGlAccountOut.glAccountId"/></if><if condition="receiptGlAccountId"><entity-find-one entity-name="mantle.ledger.account.GlAccount" value-field="receiptGlAccount" cache="true"><field-map field-name="glAccountId" from="receiptGlAccountId"/></entity-find-one><set field="receiptGlAccountTypeEnumId" from="receiptGlAccount?.glAccountTypeEnumId"/></if><set field="assetGlAccountId" from="assetTypeGlAccount?.assetGlAccountId"/><if condition="!assetGlAccountId"><service-call name="mantle.ledger.LedgerServices.get#DefaultGlAccountByType" out-map="[glAccountId:assetGlAccountOut.glAccountId]" in-map="[glAccountTypeEnumId:assetGlAccountTypeEnumId, acctgTransTypeEnumId:acctgTransTypeEnumId,                             organizationPartyId:organizationPartyId, otherPartyId:null]"/><set field="assetGlAccountId" from="assetGlAccountOut.glAccountId"/></if><if condition="assetGlAccountId"><entity-find-one entity-name="mantle.ledger.account.GlAccount" value-field="assetGlAccount" cache="true"><field-map field-name="glAccountId" from="assetGlAccountId"/></entity-find-one><set field="assetGlAccountTypeEnumId" from="assetGlAccount?.glAccountTypeEnumId"/></if><set field="amount" from="assetReceipt.quantityAccepted * asset.acquireCost"/><set field="useErrorJournal" from="false"/><set field="otherPartyId" from="null"/><if condition="assetReceipt.shipmentId"><entity-find-one entity-name="mantle.shipment.Shipment" value-field="shipment"><field-map field-name="shipmentId" from="assetReceipt.shipmentId"/></entity-find-one><set field="otherPartyId" from="shipment?.fromPartyId"/></if><service-call name="mantle.ledger.LedgerServices.create#AcctgTrans" out-map="[acctgTransId:context.acctgTransId]" in-map="[acctgTransTypeEnumId:acctgTransTypeEnumId, organizationPartyId:organizationPartyId,                         otherPartyId:otherPartyId, amountUomId:asset.acquireCostUomId, assetReceiptId:assetReceiptId,                         assetId:asset.assetId, shipmentId:assetReceipt.shipmentId, transactionDate:assetReceipt.receivedDate]"/><if condition="!receiptGlAccountId"><set field="useErrorJournal" from="true"/></if><service-call name="mantle.ledger.LedgerServices.create#AcctgTransEntry" in-map="[acctgTransId:acctgTransId, debitCreditFlag:'C', glAccountTypeEnumId:receiptGlAccountTypeEnumId,                         glAccountId:receiptGlAccountId, amount:amount, productId:asset.productId, assetId:asset.assetId]"/><if condition="!assetGlAccountId"><set field="useErrorJournal" from="true"/></if><service-call name="mantle.ledger.LedgerServices.create#AcctgTransEntry" in-map="[acctgTransId:acctgTransId, debitCreditFlag:'D', glAccountTypeEnumId:assetGlAccountTypeEnumId,                         glAccountId:assetGlAccountId, amount:amount, productId:asset.productId, assetId:asset.assetId]"/><if condition="useErrorJournal"><then><if condition="partyAcctgPreference?.errorGlJournalId"><service-call name="update#mantle.ledger.transaction.AcctgTrans" in-map="[acctgTransId:acctgTransId, glJournalId:partyAcctgPreference.errorGlJournalId]"/></if></then><else><service-call name="mantle.ledger.LedgerServices.post#AcctgTrans" in-map="[acctgTransId:acctgTransId]"/></else></if><set field="assetReceipt.acctgTransResultEnumId" value="AtrSuccess"/><entity-update value-field="assetReceipt"/></actions></service>