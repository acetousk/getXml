<!--Service Location mantle.shipment.ShipmentServices.add#OrderPartToShipment--><service verb="add" noun="OrderPartToShipment"><in-parameters><parameter name="orderId" required="true"/><parameter name="orderPartSeqId" required="true"/><parameter name="shipmentId" required="true"/></in-parameters><out-parameters/><actions><entity-find-one entity-name="mantle.shipment.Shipment" value-field="shipment"/><if condition="!(shipment.statusId in ['ShipInput', 'ShipScheduled', 'ShipPicked'])"><return error="true" message="Cannot add Order Part to Shipment in status ${shipment.statusId}"/></if><entity-find-one entity-name="mantle.order.OrderPart" value-field="orderPart"/><if condition="!(orderPart.statusId in ['OrderApproved', 'OrderSent'])"><return error="true" message="Cannot add Order Part in status ${orderPart.statusId} to Shipment"/></if><entity-find entity-name="moqui.basic.EnumGroupMember" list="productItemTypeEgms" cache="true"><econdition field-name="enumGroupEnumId" value="EngItemsProduct"/></entity-find><set field="productItemTypes" from="productItemTypeEgms*.enumId"/><entity-find-related value-field="orderPart" relationship-name="mantle.order.OrderItem" list="orderItemList" order-by-list="['orderItemSeqId']"/><iterate list="orderItemList" entry="orderItem"><if condition="!orderItem.productId || !productItemTypes.contains(orderItem.itemTypeEnumId)"><continue/></if><entity-find-one entity-name="mantle.product.Product" value-field="product" cache="true"><field-map field-name="productId" from="orderItem.productId"/></entity-find-one><if condition="!(product.productTypeEnumId in ['PtAsset', 'PtDigitalAsset', 'PtAssetUse', 'PtPickAssembly'])"><continue/></if><set field="quantityNotShipped" from="(orderItem.quantity != null ? orderItem.quantity : 1.0) * (orderItem.selectedAmount ?: 1.0)"/><entity-find entity-name="mantle.shipment.ShipmentAndItemSource" list="existingSisList"><econdition field-name="orderId"/><econdition field-name="orderItemSeqId" from="orderItem.orderItemSeqId"/><econdition field-name="shipmentStatusId" operator="not-in" value="ShipRejected,ShipCancelled"/><econdition field-name="statusId" operator="not-equals" value="SisCancelled"/></entity-find><iterate list="existingSisList" entry="existingSis"><set field="quantityNotShipped" from="quantityNotShipped - existingSis.quantity"/></iterate><if condition="quantityNotShipped <= 0"><continue/></if><entity-find-one entity-name="mantle.shipment.ShipmentItem" value-field="shipmentItem"><field-map field-name="shipmentId"/><field-map field-name="productId" from="orderItem.productId"/></entity-find-one><if condition="shipmentItem"><then><set field="shipmentItem.quantity" from="shipmentItem.quantity + quantityNotShipped"/><entity-update value-field="shipmentItem"/></then><else><service-call name="create#mantle.shipment.ShipmentItem" in-map="[shipmentId:shipmentId, productId:orderItem.productId, quantity:quantityNotShipped]"/></else></if><entity-find entity-name="mantle.order.OrderItemBilling" list="orderItemBillingList"><econdition field-name="orderId"/><econdition field-name="orderItemSeqId" from="orderItem.orderItemSeqId"/></entity-find><set field="quantityNotBilled" from="(orderItem.quantity != null ? orderItem.quantity : 1.0) * (orderItem.selectedAmount ?: 1.0)"/><iterate list="orderItemBillingList" entry="orderItemBilling"><if condition="!orderItemBilling.shipmentId && quantityNotBilled >= orderItemBilling.quantity"><set field="orderItemBilling.shipmentId" from="shipmentId"/><entity-update value-field="orderItemBilling"/></if><set field="quantityNotBilled" from="quantityNotBilled - orderItemBilling.quantity"/></iterate><set field="singleFullOib" from="null"/><if condition="orderItemBillingList.size() == 1 && quantityNotBilled == 0.0"><set field="singleFullOib" from="orderItemBillingList[0]"/></if><service-call name="create#mantle.shipment.ShipmentItemSource" in-map="[shipmentId:shipmentId, productId:orderItem.productId, statusId:'SisPending',                             quantity:quantityNotShipped, quantityNotHandled:quantityNotShipped,                             orderId:orderItem.orderId, orderItemSeqId:orderItem.orderItemSeqId,                             invoiceId:singleFullOib?.invoiceId, invoiceItemSeqId:singleFullOib?.invoiceItemSeqId]"/></iterate></actions></service>