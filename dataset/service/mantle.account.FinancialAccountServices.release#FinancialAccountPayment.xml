<!--Service Location mantle.account.FinancialAccountServices.release#FinancialAccountPayment--><service verb="release" noun="FinancialAccountPayment"><in-parameters><parameter name="paymentId" required="true" entity-name="mantle.account.payment.Payment" field-name="paymentId"/><parameter name="paymentGatewayConfigId" required="true" entity-name="mantle.account.payment.Payment" field-name="paymentGatewayConfigId"/></in-parameters><out-parameters><parameter name="paymentGatewayResponseId"/></out-parameters><actions><entity-find-one entity-name="mantle.account.payment.Payment" value-field="payment" for-update="true"/><if condition="!payment.finAccountAuthId"><return error="true" message="No authorization associated with Payment ${payment.paymentId}"/></if><service-call name="mantle.account.FinancialAccountServices.expire#FinancialAccountAuth" out-map="[]" in-map="[finAccountAuthId:payment.finAccountAuthId]"/><service-call name="create#mantle.account.method.PaymentGatewayResponse" out-map="[paymentGatewayResponseId:context.paymentGatewayResponseId,paymentGatewayConfigId:context.paymentGatewayConfigId,paymentOperationEnumId:context.paymentOperationEnumId,paymentId:context.paymentId,paymentMethodId:context.paymentMethodId,finAccountId:context.finAccountId,amount:context.amount,amountUomId:context.amountUomId,referenceNum:context.referenceNum,altReference:context.altReference,subReference:context.subReference,approvalCode:context.approvalCode,responseCode:context.responseCode,reasonCode:context.reasonCode,reasonMessage:context.reasonMessage,avsResult:context.avsResult,cvResult:context.cvResult,scoreResult:context.scoreResult,transactionDate:context.transactionDate,transactionStatus:context.transactionStatus,resultSuccess:context.resultSuccess,resultDeclined:context.resultDeclined,resultError:context.resultError,resultNsf:context.resultNsf,resultBadExpire:context.resultBadExpire,resultBadCardNumber:context.resultBadCardNumber,lastUpdatedStamp:context.lastUpdatedStamp]" in-map="[paymentGatewayConfigId:paymentGatewayConfigId, paymentOperationEnumId:'PgoRelease',                         paymentId:paymentId, paymentMethodId:payment.paymentMethodId, finAccountId:finAccountId,                         amount:payment.amount, amountUomId:payment.amountUomId,                         transactionDate:ec.user.nowTimestamp,                         resultSuccess:'Y', resultDeclined:'N', resultError:'N', resultNsf:'N']"/><set field="payment.finAccountAuthId" from="null"/><entity-update value-field="payment"/></actions></service>