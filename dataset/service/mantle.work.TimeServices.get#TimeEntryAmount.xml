<!--Service Location mantle.work.TimeServices.get#TimeEntryAmount--><service verb="get" noun="TimeEntryAmount"><in-parameters><parameter name="timeEntryId" required="true"/><parameter name="timeEntry" type="Map"/><parameter name="ratePurposeEnumId" default-value="RaprVendor"/></in-parameters><out-parameters><parameter name="amountTotal" type="BigDecimal"/><parameter name="amount" type="BigDecimal"/><parameter name="quantity" type="BigDecimal"/><parameter name="currencyUomId"/><parameter name="hourlyAmountTotal" type="BigDecimal"/><parameter name="pieceAmountTotal" type="BigDecimal"/><parameter name="hourlyAmount" type="BigDecimal"/><parameter name="pieceAmount" type="BigDecimal"/><parameter name="hours" type="BigDecimal"/><parameter name="pieceCount" type="BigDecimal"/></out-parameters><actions><if condition="timeEntry == null"><entity-find-one entity-name="mantle.work.time.TimeEntry" value-field="timeEntry"/></if><set field="hours" from="timeEntry.hours ?: 0.0"/><set field="pieceCount" from="timeEntry.pieceCount ?: 0.0"/><if condition="hours"><then><set field="hourlyAmount" from="ratePurposeEnumId == 'RaprVendor' ? timeEntry.vendorHourRate : timeEntry.clientHourRate"/><if condition="hourlyAmount == null"><then><set field="rateAmountId" from="ratePurposeEnumId == 'RaprVendor' ? timeEntry.vendorRateAmountId : timeEntry.rateAmountId"/><if condition="rateAmountId"><then><entity-find-one entity-name="mantle.humanres.rate.RateAmount" value-field="rateAmount" cache="true"><field-map field-name="rateAmountId"/></entity-find-one></then><else><service-call name="mantle.work.TimeServices.get#TimeEntryRate" out-map="[rateAmountId:getTerOut.rateAmountId,rateAmount:getTerOut.rateAmount,vendorRateAmountId:getTerOut.vendorRateAmountId,vendorRateAmount:getTerOut.vendorRateAmount,pieceRateAmountId:getTerOut.pieceRateAmountId,pieceRateAmount:getTerOut.pieceRateAmount,vendorPieceRateAmountId:getTerOut.vendorPieceRateAmountId,vendorPieceRateAmount:getTerOut.vendorPieceRateAmount]" in-map="[timeEntryId:timeEntryId]"/><set field="timeEntry.rateAmountId" from="getTerOut.rateAmountId"/><set field="timeEntry.vendorRateAmountId" from="getTerOut.vendorRateAmountId"/><set field="rateAmountId" from="ratePurposeEnumId == 'RaprVendor' ? getTerOut.vendorRateAmountId : getTerOut.rateAmountId"/><entity-find-one entity-name="mantle.humanres.rate.RateAmount" value-field="rateAmount" cache="true"><field-map field-name="rateAmountId"/></entity-find-one></else></if><if condition="rateAmount"><then><set field="hourlyAmount" from="rateAmount.rateAmount"/><set field="hourlyAmountTotal" from="hours * hourlyAmount"/><set field="currencyUomId" from="rateAmount.rateCurrencyUomId"/></then><else><set field="purposeDesc" from="ec.entity.find('enums').condition('enumId', ratePurposeEnumId).one()?.description"/><entity-find-one entity-name="mantle.party.PartyDetail" value-field="workerParty"><field-map field-name="partyId" from="timeEntry.partyId"/></entity-find-one><message error="true"><![CDATA[No hourly ${purposeDesc} rate amount found for time entry ${timeEntryId} for worker ${ec.resource.expand('PartyNameTemplate','',workerParty)}]]></message></else></if></then><else><set field="hourlyAmountTotal" from="hours * hourlyAmount"/></else></if></then><else><set field="hourlyAmount" from="0.0"/><set field="hourlyAmountTotal" from="0.0"/></else></if><if condition="pieceCount"><then><set field="pieceAmount" from="ratePurposeEnumId == 'RaprVendor' ? timeEntry.vendorPieceRate : timeEntry.clientPieceRate"/><if condition="pieceAmount == null"><then><set field="pieceRateAmountId" from="ratePurposeEnumId == 'RaprVendor' ? timeEntry.vendorPieceRateAmountId : timeEntry.pieceRateAmountId"/><if condition="pieceRateAmountId"><then><entity-find-one entity-name="mantle.humanres.rate.RateAmount" value-field="pieceRateAmount" cache="true"><field-map field-name="rateAmountId" from="pieceRateAmountId"/></entity-find-one></then><else><service-call name="mantle.work.TimeServices.get#TimeEntryRate" out-map="[rateAmountId:getTerOut.rateAmountId,rateAmount:getTerOut.rateAmount,vendorRateAmountId:getTerOut.vendorRateAmountId,vendorRateAmount:getTerOut.vendorRateAmount,pieceRateAmountId:getTerOut.pieceRateAmountId,pieceRateAmount:getTerOut.pieceRateAmount,vendorPieceRateAmountId:getTerOut.vendorPieceRateAmountId,vendorPieceRateAmount:getTerOut.vendorPieceRateAmount]" in-map="[timeEntryId:timeEntryId]"/><set field="timeEntry.pieceRateAmountId" from="getTerOut.pieceRateAmountId"/><set field="timeEntry.vendorPieceRateAmountId" from="getTerOut.vendorPieceRateAmountId"/><set field="pieceRateAmountId" from="ratePurposeEnumId == 'RaprVendor' ? getTerOut.vendorPieceRateAmountId : getTerOut.pieceRateAmountId"/><entity-find-one entity-name="mantle.humanres.rate.RateAmount" value-field="pieceRateAmount" cache="true"><field-map field-name="rateAmountId" from="pieceRateAmountId"/></entity-find-one></else></if><if condition="pieceRateAmount"><then><set field="pieceAmount" from="pieceRateAmount.rateAmount"/><set field="pieceAmountTotal" from="pieceCount * pieceAmount"/><set field="currencyUomId" from="rateAmount.rateCurrencyUomId"/></then><else><set field="purposeDesc" from="ec.entity.find('enums').condition('enumId', ratePurposeEnumId).one()?.description"/><message><![CDATA[No ${purposeDesc} piece rate amount found for time entry ${timeEntryId}]]></message></else></if></then><else><set field="pieceAmountTotal" from="pieceCount * pieceAmount"/></else></if></then><else><set field="pieceAmount" from="0.0"/><set field="pieceAmountTotal" from="0.0"/></else></if><check-errors/><if condition="pieceAmountTotal"><then><if condition="pieceRateAmount?.rateTypeEnumId == 'RatpPiecePlusHour'"><then><set field="amountTotal" from="(hourlyAmountTotal ?: 0.0) + pieceAmountTotal"/><set field="amount" from="amountTotal"/><set field="quantity" from="1.0"/></then><else><if condition="hourlyAmountTotal > pieceAmountTotal"><then><set field="amountTotal" from="hourlyAmountTotal"/><set field="amount" from="hourlyAmount"/><set field="quantity" from="hours"/></then><else><set field="amountTotal" from="pieceAmountTotal"/><set field="amount" from="pieceAmount"/><set field="quantity" from="pieceCount"/></else></if></else></if></then><else><set field="amountTotal" from="hourlyAmountTotal"/><set field="amount" from="hourlyAmount"/><set field="quantity" from="hours"/></else></if></actions></service>