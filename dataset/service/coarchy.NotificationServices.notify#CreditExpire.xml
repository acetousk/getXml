<!--Service Location coarchy.NotificationServices.notify#CreditExpire--><service verb="notify" noun="CreditExpire"><in-parameters><parameter name="currentTimestamp" default="ec.user.nowTimestamp" type="Timestamp" required="true"/><parameter name="thresholdLow" type="Integer" default="4"/><parameter name="thresholdHigh" type="Integer" default="7"/><parameter name="lookForwardDays" type="Integer" default="7"/></in-parameters><out-parameters><parameter name="financialAccountList" type="List"/><parameter name="emailsSentList" type="List"/><parameter name="activatedPartyIdList" type="List"/><parameter name="availableBalanceByOwner" type="Map"/><parameter name="creditsOrgMonthNeededByOwner" type="Map"/><parameter name="projectedExpiryDateByOwner" type="Map"/><parameter name="daysLeftByOwner" type="Map"/><parameter name="lastCreditPurchaseByOwner" type="Map"/></out-parameters><actions><set field="emailsSentList" from="[]"/><set field="baseLinkUrl" from="!'production'.equals(System.getProperty('instance_purpose')) ? 'http://localhost:8080' : 'https://coarchy.com'"/><if condition="lookForwardDays == 7"><set field="emailTemplateId" value="CREDITS_EXPIRING_7DAYS"/><set field="bodyParameters" from="[linkUrl:baseLinkUrl+'/settings/BuyPremium',baseLinkUrl:baseLinkUrl, currentYear:ec.user.nowTimestamp.format('yyyy'),                     title:'Your credits are expiring soon', periodDescription: '7 days']"/><else-if condition="lookForwardDays == 1"><set field="emailTemplateId" value="CREDITS_EXPIRING_1DAY"/><set field="bodyParameters" from="[linkUrl:baseLinkUrl+'/settings/BuyPremium',baseLinkUrl:baseLinkUrl, currentYear:ec.user.nowTimestamp.format('yyyy'),                         title:'Your credits are expiring soon', periodDescription: '1 day']"/></else-if><else><return error="true" message="No email template configured from custom period of ${lookForwardDays} days"/></else></if><entity-find entity-name="mantle.account.financial.FinancialAccount" list="financialAccountList" distinct="true"><econdition field-name="finAccountTypeId" value="OrganizationMonthCredit"/><econdition field-name="statusId" value="FaActive"/><date-filter/><select-field field-name="ownerPartyId,finAccountId,availableBalance"/></entity-find><set field="financialAccountList" from="financialAccountList.groupBy{it.ownerPartyId}.collect{it.value.max{it.availableBalance}}"/><set field="activatedPartyIdList" from="financialAccountList.ownerPartyId"/><set field="availableBalanceByOwner" from="[:]"/><set field="lastCreditPurchaseByOwner" from="[:]"/><set field="creditsOrgMonthNeededByOwner" from="[:]"/><set field="projectedExpiryDateByOwner" from="[:]"/><set field="daysLeftByOwner" from="[:]"/><iterate list="financialAccountList" entry="financialAccount"><set field="availableBalanceByOwner[financialAccount.ownerPartyId]" from="financialAccount.availableBalance"/><entity-find entity-name="mantle.account.financial.FinancialAccountTrans" list="finAccountTxList"><econdition field-name="finAccountId" from="financialAccount.finAccountId"/><econdition field-name="amount" operator="greater" from="0"/><econdition field-name="finAccountTransTypeEnumId" value="FattAdjustment"/><order-by field-name="-transactionDate"/></entity-find><set field="lastCreditPurchaseByOwner[financialAccount.ownerPartyId]" from="finAccountTxList?.getFirst()?.transactionDate"/></iterate><iterate list="activatedPartyIdList" entry="activatedPartyId"><entity-find entity-name="mantle.party.Party" list="partyOrgList"><econdition field-name="ownerPartyId" from="activatedPartyId"/><econdition field-name="partyTypeEnumId" value="PtyOrganization"/><econdition field-name="disabled" value="N" or-null="true"/></entity-find><set field="avgCreditsNeededPerDayMsList" from="[]"/><iterate list="partyOrgList" entry="partyOrg"><entity-find entity-name="mantle.party.PartyActivation" list="partyActivationList"><date-filter/><econdition field-name="partyId" from="partyOrg.partyId"/><order-by field-name="-fromDate"/></entity-find><if condition="!partyActivationList"><continue/></if><service-call name="coarchy.CoarchyServices.calculate#PartyActivationUsage" in-map="[organizationPartyId:partyOrg.partyId, periodFromDate:currentTimestamp,periodThruDate:currentTimestamp.plus(lookForwardDays),minActivationMinutesPerDay:5]" out-map="[activationPeriodCount:activationOut.activationPeriodCount,dayAmountList:activationOut.dayAmountList,dayCount:activationOut.dayCount,totalDays:activationOut.totalDays]" out-map-add-to-existing="false"/><set field="creditsNeededMs" type="BigDecimal" from="(activationOut.dayAmountList?:[0]).sum()"/><set field="avgCreditsNeededPerDayMs" type="BigDecimal" from="(creditsNeededMs/lookForwardDays)"/><script><![CDATA[avgCreditsNeededPerDayMsList.add(avgCreditsNeededPerDayMs)]]></script></iterate><if condition="!avgCreditsNeededPerDayMsList"><continue/></if><set field="avgCreditsNeededPerDayMs" from="avgCreditsNeededPerDayMsList.sum()"/><set field="creditsNeededOrgMonth" from="(avgCreditsNeededPerDayMs*lookForwardDays).div(30.0 * 24.0 * 60.0 * 60.0 * 1000.0)"/><set field="availableBalanceMs" from="availableBalanceByOwner[activatedPartyId] * 30.0 * 24.0 * 60.0 * 60.0 * 1000.0"/><set field="daysLeft" from="availableBalanceMs/(avgCreditsNeededPerDayMs==0?1.0:avgCreditsNeededPerDayMs)"/><set field="daysLeftFloor" type="Integer" from="Math.floor(daysLeft)"/><set field="projectedExpiryDate" from="currentTimestamp.plus(daysLeftFloor)"/><script><![CDATA[creditsOrgMonthNeededByOwner[activatedPartyId] = creditsNeededOrgMonth]]></script><script><![CDATA[projectedExpiryDateByOwner[activatedPartyId] = projectedExpiryDate]]></script><script><![CDATA[daysLeftByOwner[activatedPartyId] = daysLeft]]></script><if condition="daysLeftFloor>1"><set field="bodyParameters.periodDescription" value="${daysLeftFloor} days"/><else-if condition="daysLeftFloor==1"><set field="bodyParameters.periodDescription" value="1 day"/></else-if><else-if condition="daysLeftFloor < 1"><set field="bodyParameters.periodDescription" value="less than a day"/></else-if></if><if condition="(daysLeftFloor > thresholdHigh) || (daysLeftFloor < thresholdLow)"><log level="warn" message=" For ${activatedPartyId}, Not continuing since thresholds not met (min: ${thresholdLow}, max: ${thresholdHigh}, val:${daysLeftFloor})"/><continue/><else><log level="warn" message=" Sending credits expiry email to party ${activatedPartyId}, Email template: ${emailTemplateId}, conditions met (min: ${thresholdLow}, max: ${thresholdHigh}, val:${daysLeftFloor})"/><service-call name="coarchy.NotificationServices.send#CreditExpireNotificationEmail" in-map="[emailTemplateId:emailTemplateId, partyId:activatedPartyId, bodyParameters:bodyParameters, lastCreditPurchaseDate:lastCreditPurchaseByOwner[activatedPartyId]]" out-map="[sentEmail:context.sentEmail,emailTemplateId:context.emailTemplateId,emailMessageId:context.emailMessageId]"/><if condition="sentEmail"><script><![CDATA[emailsSentList.add(emailMessageId)]]></script></if></else></if></iterate></actions></service>