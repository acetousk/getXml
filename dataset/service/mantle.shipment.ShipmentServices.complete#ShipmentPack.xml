<!--Service Location mantle.shipment.ShipmentServices.complete#ShipmentPack--><service verb="complete" noun="ShipmentPack"><in-parameters><parameter name="shipmentId" required="true"/><parameter name="carrierAndShipmentMethod"/><parameter name="networkPrinterId"/><parameter name="makeDefaultPrinter" type="Boolean" default="false"/><parameter name="getLabels" type="Boolean" default="false"/><parameter name="getReturnLabels" type="Boolean" default="false"/></in-parameters><out-parameters/><actions><entity-find entity-name="mantle.shipment.ShipmentRouteSegment" list="srsList"><econdition field-name="shipmentId"/><order-by field-name="shipmentRouteSegmentSeqId"/></entity-find><set field="shipmentRouteSegmentSeqId" from="srsList ? srsList[0].shipmentRouteSegmentSeqId : null"/><if condition="!shipmentRouteSegmentSeqId"><return error="true" message="No route segment found for shipment ${shipmentId}"/></if><service-call name="mantle.shipment.ShipmentServices.update#ShipmentAndRouteSegment" in-map="context" transaction="force-new"/><entity-find-one entity-name="mantle.shipment.Shipment" value-field="shipment"/><if condition="shipment == null"><return error="true" message="Shipment ${shipmentId} not found"/></if><if condition="shipment.statusId in ['ShipInput', 'ShipScheduled', 'ShipPicked']"><service-call name="mantle.shipment.ShipmentServices.pack#Shipment" in-map="[shipmentId:shipmentId]" transaction="force-new"/></if><entity-find entity-name="mantle.shipment.ShipmentItemSource" list="sisInvoiceList"><econdition field-name="shipmentId"/><econdition field-name="invoiceId" operator="is-not-null"/><select-field field-name="invoiceId"/></entity-find><if condition="sisInvoiceList"><entity-find entity-name="mantle.account.invoice.Invoice" list="invoiceList"><econdition field-name="invoiceId" operator="in" from="sisInvoiceList*.invoiceId"/><econdition field-name="statusId" operator="not-equals" value="InvoiceCancelled"/><select-field field-name="invoiceTotal"/></entity-find><set field="invoiceTotal" from="invoiceList*.invoiceTotal.sum()"/><if condition="invoiceTotal"><entity-find entity-name="mantle.shipment.ShipmentOrderPayment" list="shipmentPaymentList" distinct="true"><econdition field-name="shipmentId"/><select-field field-name="paymentId,paymentInstrumentEnumId,statusId,amount"/></entity-find><set field="paymentTotal" from="0.0"/><iterate list="shipmentPaymentList" entry="shipmentPayment"><if condition="shipmentPayment.paymentInstrumentEnumId == 'PiCreditCard'"><then><if condition="shipmentPayment.statusId in ['PmntDelivered', 'PmntConfirmed']"><set field="paymentTotal" from="paymentTotal + shipmentPayment.amount"/></if></then><else><if condition="!(shipmentPayment.statusId in ['PmntCancelled', 'PmntVoid', 'PmntDeclined'])"><set field="paymentTotal" from="paymentTotal + shipmentPayment.amount"/></if></else></if></iterate><if condition="paymentTotal < invoiceTotal"><return type="warning" message="Captured credit card and other payments total ${paymentTotal} is less than shipment invoice total ${invoiceTotal} so not automatically getting labels"/></if></if></if><if condition="getLabels"><service-call name="mantle.shipment.CarrierServices.request#ShipmentLabels" in-map="[shipmentId:shipmentId, getReturnLabels:false]"/><set field="hasAllLabels" from="true"/><entity-find entity-name="mantle.shipment.ShipmentPackageRouteSeg" list="packageRouteSegList"><econdition field-name="shipmentId"/><econdition field-name="shipmentRouteSegmentSeqId"/></entity-find><iterate list="packageRouteSegList" entry="packageRouteSeg"><if condition="!packageRouteSeg.gatewayLabelId && packageRouteSeg.labelImage == null && !packageRouteSeg.labelUrl"><set field="hasAllLabels" from="false"/></if></iterate><if condition="hasAllLabels"><then><if condition="networkPrinterId"><service-call name="mantle.shipment.ShipmentServices.print#ShipmentLabels" in-map="[returnLabels:false] + context"/></if><if condition="getReturnLabels"><service-call name="mantle.shipment.CarrierServices.request#ShipmentLabels" in-map="[shipmentId:shipmentId, getReturnLabels:true]"/><if condition="networkPrinterId"><service-call name="mantle.shipment.ShipmentServices.print#ShipmentLabels" in-map="[returnLabels:true] + context"/></if></if></then><else><message type="danger"><![CDATA[Could not get labels, not printing or getting return labels]]></message></else></if></if></actions></service>