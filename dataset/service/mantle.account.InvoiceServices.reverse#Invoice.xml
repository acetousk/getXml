<!--Service Location mantle.account.InvoiceServices.reverse#Invoice--><service verb="reverse" noun="Invoice"><in-parameters><parameter name="invoiceId" required="true" entity-name="mantle.account.invoice.Invoice" field-name="invoiceId"/></in-parameters><out-parameters/><actions><entity-find-one entity-name="mantle.account.invoice.Invoice" value-field="invoice" for-update="true"/><if condition="!(invoice.statusId in ['InvoiceInProcess', 'InvoiceIncoming', 'InvoiceReceived'])"><return type="danger" message="Cannot reverse invoice ${invoiceId} in status ${invoice.status?.description}, must be In Process, Incoming, or Received"/></if><entity-find-count entity-name="mantle.account.payment.PaymentApplication" count-field="applCount"><econditions combine="or"><econdition field-name="invoiceId"/><econdition field-name="toInvoiceId" from="invoiceId"/></econditions><econdition field-name="amountApplied" operator="not-equals" from="0.0"/></entity-find-count><if condition="applCount"><return type="danger" message="Cannot reverse invoice ${invoiceId} because it is already applied"/></if><set field="targetStatusId" from="invoice.statusId == 'InvoiceInProcess' ? 'InvoiceIncoming' : 'InvoiceInProcess'"/><service-call name="update#mantle.account.invoice.Invoice" in-map="[invoiceId:invoiceId, fromPartyId:invoice.toPartyId, toPartyId:invoice.fromPartyId, statusId:targetStatusId]"/><entity-find entity-name="mantle.account.invoice.InvoiceItem" list="invoiceItemList" for-update="true"><econdition field-name="invoiceId"/></entity-find><iterate list="invoiceItemList" entry="invoiceItem"><service-call name="update#mantle.account.invoice.InvoiceItem" in-map="[invoiceId:invoiceId, invoiceItemSeqId:invoiceItem.invoiceItemSeqId, amount:-invoiceItem.amount]"/></iterate></actions></service>