<!--Service Location org.moqui.impl.EntitySyncServices.internalRun#EntitySync--><service verb="internalRun" noun="EntitySync"><in-parameters><parameter name="entitySync" type="EntityValue" required="true"/></in-parameters><out-parameters><parameter name="errorMessage"/><parameter name="exclusiveFromTime" type="Timestamp"/><parameter name="inclusiveThruTime" type="Timestamp"/><parameter name="recordsStored" type="Long"/></out-parameters><actions><set field="entitySyncId" from="entitySync.entitySyncId"/><set field="remoteInMap" from="[authUsername:entitySync.targetUsername, authPassword:entitySync.targetPassword]"/><service-call name="org.moqui.impl.EntitySyncServices.get#EntitySyncIncludeList" out-map="[entityIncludeList:context.entityIncludeList]" in-map="context"/><set field="getInMap" from="[entityIncludeList:entityIncludeList, lastSuccessfulSyncTime:entitySync.lastSuccessfulSyncTime,                     syncSplitMillis:entitySync.syncSplitMillis, recordThreshold:entitySync.recordThreshold,                     delayBufferMillis:entitySync.delayBufferMillis]"/><if condition="entitySync.forPull == 'Y'"><set field="inMap" from="remoteInMap + getInMap"/><set field="serviceName" value="org.moqui.impl.EntitySyncServices.get#EntitySyncData"/><script><![CDATA[Map outMap = ec.service.callJsonRpc(entitySync.targetServerUrl, serviceName, inMap)
                    if (outMap) context.putAll(outMap)]]></script><if condition="recordCount"><service-call name="org.moqui.impl.EntitySyncServices.put#EntitySyncData" out-map="[recordsStored:context.recordsStored]" in-map="[entityData:entityData]"/><else><set field="recordsStored" from="0"/></else></if><else><service-call name="org.moqui.impl.EntitySyncServices.get#EntitySyncData" out-map="[entityData:context.entityData,recordCount:context.recordCount,exclusiveFromTime:context.exclusiveFromTime,inclusiveThruTime:context.inclusiveThruTime]" in-map="getInMap"/><if condition="recordCount"><set field="inMap" from="remoteInMap + [entityData:entityData]"/><set field="serviceName" value="org.moqui.impl.EntitySyncServices.put#EntitySyncData"/><script><![CDATA[Map outMap = ec.service.callJsonRpc(entitySync.targetServerUrl, serviceName, inMap)
                            if (outMap) context.putAll(outMap)]]></script><else><set field="recordsStored" from="0"/></else></if></else></if><if condition="ec.message.hasError()"><set field="errorMessage" from="ec.message.getErrorsString()"/><script><![CDATA[ec.message.clearErrors()]]></script></if></actions></service>