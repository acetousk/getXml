<!--Service Location mantle.account.InvoiceServices.create#EntireOrderPartInvoice--><service verb="create" noun="EntireOrderPartInvoice"><in-parameters><parameter name="orderId" required="true"/><parameter name="orderPartSeqId" required="true"/><parameter name="statusId"><description><![CDATA[If specified after create set to this statusId (always created
                initially in InvoiceInProcess or InvoiceIncoming, so there must be a transition to specified status).]]></description></parameter><parameter name="invoiceDate" type="Timestamp" default="ec.user.nowTimestamp"/><parameter name="partialOrderItemList" type="List"><description><![CDATA[If specified used instead of all items in
                the OrderPart. Must be a list of OrderItem EntityValue objects in the OrderPart.]]></description><parameter name="orderItem" type="Map"><parameter name="orderId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.order.OrderItem" field-name="orderId"/><parameter name="orderItemSeqId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.order.OrderItem" field-name="orderItemSeqId"/><parameter name="orderPartSeqId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.order.OrderItem" field-name="orderPartSeqId"/><parameter name="parentItemSeqId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.order.OrderItem" field-name="parentItemSeqId"/><parameter name="itemTypeEnumId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.order.OrderItem" field-name="itemTypeEnumId"/><parameter name="productId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.order.OrderItem" field-name="productId"/><parameter name="productFeatureId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.order.OrderItem" field-name="productFeatureId"/><parameter name="otherPartyProductId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.order.OrderItem" field-name="otherPartyProductId"/><parameter name="productParameterSetId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.order.OrderItem" field-name="productParameterSetId"/><parameter name="itemDescription" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.order.OrderItem" field-name="itemDescription"/><parameter name="comments" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.order.OrderItem" field-name="comments"/><parameter name="quantity" type="java.math.BigDecimal" required="false" allow-html="none" entity-name="mantle.order.OrderItem" field-name="quantity"/><parameter name="quantityUomId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.order.OrderItem" field-name="quantityUomId"/><parameter name="quantityCancelled" type="java.math.BigDecimal" required="false" allow-html="none" entity-name="mantle.order.OrderItem" field-name="quantityCancelled"/><parameter name="selectedAmount" type="java.math.BigDecimal" required="false" allow-html="none" entity-name="mantle.order.OrderItem" field-name="selectedAmount"/><parameter name="priority" type="java.lang.Long" required="false" allow-html="none" entity-name="mantle.order.OrderItem" field-name="priority"/><parameter name="requiredByDate" type="java.sql.Timestamp" required="false" allow-html="none" entity-name="mantle.order.OrderItem" field-name="requiredByDate"/><parameter name="unitAmount" type="java.math.BigDecimal" required="false" allow-html="none" entity-name="mantle.order.OrderItem" field-name="unitAmount"/><parameter name="unitListPrice" type="java.math.BigDecimal" required="false" allow-html="none" entity-name="mantle.order.OrderItem" field-name="unitListPrice"/><parameter name="isModifiedPrice" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.order.OrderItem" field-name="isModifiedPrice"/><parameter name="standardCost" type="java.math.BigDecimal" required="false" allow-html="none" entity-name="mantle.order.OrderItem" field-name="standardCost"/><parameter name="externalItemSeqId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.order.OrderItem" field-name="externalItemSeqId"/><parameter name="fromAssetId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.order.OrderItem" field-name="fromAssetId"/><parameter name="productPriceId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.order.OrderItem" field-name="productPriceId"/><parameter name="productCategoryId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.order.OrderItem" field-name="productCategoryId"/><parameter name="isPromo" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.order.OrderItem" field-name="isPromo"/><parameter name="promoQuantity" type="java.math.BigDecimal" required="false" allow-html="none" entity-name="mantle.order.OrderItem" field-name="promoQuantity"/><parameter name="promoTimesUsed" type="java.math.BigDecimal" required="false" allow-html="none" entity-name="mantle.order.OrderItem" field-name="promoTimesUsed"/><parameter name="storePromotionId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.order.OrderItem" field-name="storePromotionId"/><parameter name="promoCodeId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.order.OrderItem" field-name="promoCodeId"/><parameter name="promoCodeText" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.order.OrderItem" field-name="promoCodeText"/><parameter name="subscriptionId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.order.OrderItem" field-name="subscriptionId"/><parameter name="finAccountId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.order.OrderItem" field-name="finAccountId"/><parameter name="finAccountTransId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.order.OrderItem" field-name="finAccountTransId"/><parameter name="overrideGlAccountId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.order.OrderItem" field-name="overrideGlAccountId"/><parameter name="salesOpportunityId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.order.OrderItem" field-name="salesOpportunityId"/><parameter name="sourceReferenceId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.order.OrderItem" field-name="sourceReferenceId"/><parameter name="sourcePercentage" type="java.math.BigDecimal" required="false" allow-html="none" entity-name="mantle.order.OrderItem" field-name="sourcePercentage"/><parameter name="amountAlreadyIncluded" type="java.math.BigDecimal" required="false" allow-html="none" entity-name="mantle.order.OrderItem" field-name="amountAlreadyIncluded"/><parameter name="exemptAmount" type="java.math.BigDecimal" required="false" allow-html="none" entity-name="mantle.order.OrderItem" field-name="exemptAmount"/><parameter name="customerReferenceId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.order.OrderItem" field-name="customerReferenceId"/><parameter name="taxAuthorityId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.order.OrderItem" field-name="taxAuthorityId"/><parameter name="lastUpdatedStamp" type="java.sql.Timestamp" required="false" allow-html="none" entity-name="mantle.order.OrderItem" field-name="lastUpdatedStamp"/></parameter></parameter></in-parameters><out-parameters><parameter name="invoiceId"/></out-parameters><actions><entity-find-one entity-name="mantle.order.OrderHeader" value-field="orderHeader"/><entity-find-one entity-name="mantle.order.OrderPart" value-field="orderPart"/><set field="toPartyId" from="orderPart.customerPartyId"/><entity-find entity-name="mantle.order.OrderPartParty" list="billToList"><econdition field-name="orderId"/><econdition field-name="orderPartSeqId"/><econdition field-name="roleTypeId" value="CustomerBillTo"/></entity-find><if condition="billToList"><set field="toPartyId" from="billToList[0].partyId"/></if><set field="description" value="Invoice for Order ${orderId} part ${orderPartSeqId}"/><service-call name="mantle.account.InvoiceServices.create#Invoice" out-map="[invoiceId:context.invoiceId]" in-map="[invoiceTypeEnumId:'InvoiceSales', fromPartyId:orderPart.vendorPartyId, toPartyId:toPartyId,                         invoiceDate:invoiceDate, currencyUomId:orderHeader.currencyUomId, description:description,                         otherPartyOrderId:orderPart.otherPartyOrderId, settlementTermId:orderPart.settlementTermId,                         productStoreId:orderHeader.productStoreId, systemMessageRemoteId:orderHeader.systemMessageRemoteId]"/><if condition="partialOrderItemList"><then><set field="orderItemList" from="partialOrderItemList"/></then><else><entity-find entity-name="mantle.order.OrderItem" list="orderItemList"><econdition field-name="orderId"/><econdition field-name="orderPartSeqId"/><order-by field-name="orderItemSeqId"/></entity-find></else></if><iterate list="orderItemList" entry="orderItem"><set field="oibBaseMap" from="[orderId:orderId, orderItemSeqId:orderItem.orderItemSeqId]"/><entity-find entity-name="mantle.order.OrderItemBilling" list="orderItemBillingList"><econdition-object field="oibBaseMap"/></entity-find><set field="quantityNotBilled" from="(orderItem.quantity != null ? orderItem.quantity : 1.0) * (orderItem.selectedAmount ?: 1.0)"/><iterate list="orderItemBillingList" entry="orderItemBilling"><set field="quantityNotBilled" from="quantityNotBilled - orderItemBilling.quantity"/></iterate><if condition="quantityNotBilled > 0"><service-call name="create#mantle.account.invoice.InvoiceItem" in-map="[invoiceId:invoiceId, invoiceItemSeqId:orderItem.orderItemSeqId,                                 parentItemSeqId:orderItem.parentItemSeqId, itemTypeEnumId:orderItem.itemTypeEnumId ?: 'ItemSales',                                 amount:orderItem.unitAmount, description:orderItem.itemDescription, quantity:quantityNotBilled,                                 quantityUomId:orderItem.quantityUomId, otherPartyProductId:orderItem.otherPartyProductId,                                 productId:orderItem.productId,                                 finAccountId:orderItem.finAccountId, finAccountTransId:orderItem.finAccountTransId]"/><set field="quantityNotShipSourced" from="quantityNotBilled"/><set field="curShipmentId" from="null"/><entity-find entity-name="mantle.shipment.ShipmentItemSource" list="shipmentItemSourceList"><econdition field-name="orderId"/><econdition field-name="orderItemSeqId" from="orderItem.orderItemSeqId"/></entity-find><iterate list="shipmentItemSourceList" entry="shipmentItemSource"><if condition="!shipmentItemSource.invoiceId && quantityNotShipSourced >= shipmentItemSource.quantity"><set field="shipmentItemSource.invoiceId" from="invoiceId"/><set field="shipmentItemSource.invoiceItemSeqId" from="orderItem.orderItemSeqId"/><entity-update value-field="shipmentItemSource"/><set field="quantityNotShipSourced" from="quantityNotShipSourced - shipmentItemSource.quantity"/><set field="curShipmentId" from="shipmentItemSource.shipmentId"/></if></iterate><service-call name="create#mantle.order.OrderItemBilling" in-map="oibBaseMap + [invoiceId:invoiceId, invoiceItemSeqId:orderItem.orderItemSeqId,                                 amount:orderItem.unitAmount, quantity:quantityNotBilled, shipmentId:curShipmentId]"/></if></iterate><set field="partPayments" from="orderPart.payments"/><iterate list="partPayments" entry="partPayment"><if condition="!partPayment.forInvoiceId"><set field="partPayment.forInvoiceId" from="invoiceId"/><entity-update value-field="partPayment"/></if></iterate><if condition="statusId"><service-call name="update#mantle.account.invoice.Invoice" in-map="[invoiceId:invoiceId, statusId:statusId]"/></if><service-call name="mantle.account.PaymentServices.apply#OrderPaymentsToInvoice" in-map="[orderId:orderId, orderPartSeqId:orderPartSeqId, invoiceId:invoiceId]"/></actions></service>