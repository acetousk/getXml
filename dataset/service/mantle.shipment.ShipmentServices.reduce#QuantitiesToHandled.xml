<!--Service Location mantle.shipment.ShipmentServices.reduce#QuantitiesToHandled--><service verb="reduce" noun="QuantitiesToHandled"><in-parameters><parameter name="shipmentId" required="true"/></in-parameters><out-parameters/><actions><entity-find entity-name="mantle.shipment.ShipmentItem" list="shipmentItemList"><econdition field-name="shipmentId"/></entity-find><iterate list="shipmentItemList" entry="shipmentItem"><set field="quantityHandled" from="0.0"/><entity-find entity-name="mantle.shipment.ShipmentItemSource" list="sisList"><econdition field-name="shipmentId"/><econdition field-name="productId" from="shipmentItem.productId"/></entity-find><iterate list="sisList" entry="sis"><set field="sisQtyHandled" from="sis.quantity - sis.quantityNotHandled"/><set field="quantityHandled" from="quantityHandled + sisQtyHandled"/></iterate><if condition="quantityHandled < 0.0"><log level="warn" message="In reduce#QuantitiesToHandled calculated quantity ${quantityHandled} less than zero for shipment ${shipmentId} product ${shipmentItem.productId}"/><set field="quantityHandled" from="0.0"/></if><if condition="shipmentItem.quantity != quantityHandled"><service-call name="mantle.shipment.ShipmentServices.update#ShipmentItem" in-map="[shipmentId:shipmentId, productId:shipmentItem.productId, quantity:quantityHandled]"/><entity-find entity-name="mantle.shipment.ShipmentPackageContent" list="packageContentList"><econdition field-name="shipmentId"/><econdition field-name="productId" from="shipmentItem.productId"/></entity-find><set field="quantityHandledRem" from="quantityHandled"/><iterate list="packageContentList" entry="packageContent"><if condition="quantityHandledRem < packageContent.quantity"><then><if condition="quantityHandledRem == 0.0"><then><entity-delete value-field="packageContent"/></then><else><set field="packageContent.quantity" from="quantityHandledRem"/><entity-update value-field="packageContent"/><set field="quantityHandledRem" from="0.0"/></else></if></then><else><set field="quantityHandledRem" from="quantityHandledRem - packageContent.quantity"/></else></if></iterate></if></iterate></actions></service>