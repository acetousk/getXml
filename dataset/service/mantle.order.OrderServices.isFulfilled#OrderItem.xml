<!--Service Location mantle.order.OrderServices.isFulfilled#OrderItem--><service verb="isFulfilled" noun="OrderItem"><in-parameters><parameter name="orderId" required="true" entity-name="mantle.order.OrderItem" field-name="orderId"/><parameter name="orderItemSeqId" required="true" entity-name="mantle.order.OrderItem" field-name="orderItemSeqId"/><parameter name="orderItem" type="EntityValue"/><parameter name="orderSubscriptionList" type="List"/><parameter name="orderWorkEffortList" type="List"/><parameter name="orderAssetIssuanceList" type="List"/><parameter name="orderAssetReceiptList" type="List"/></in-parameters><out-parameters><parameter name="isFulfilled" type="Boolean"/></out-parameters><actions><if condition="orderItem == null"><entity-find-one entity-name="mantle.order.OrderItem" value-field="orderItem"/></if><entity-find entity-name="moqui.basic.EnumGroupMember" list="productItemTypeEgms" cache="true"><econdition field-name="enumGroupEnumId" value="EngItemsProduct"/></entity-find><set field="productItemTypes" from="productItemTypeEgms*.enumId"/><set field="isFulfilled" from="true"/><if condition="orderItem.productId && productItemTypes.contains(orderItem.itemTypeEnumId)"><then><entity-find-one entity-name="mantle.product.Product" value-field="product" cache="true"><field-map field-name="productId" from="orderItem.productId"/></entity-find-one><if condition="product.productTypeEnumId in ['PtDigital', 'PtDigitalAsset']"><if condition="orderSubscriptionList == null"><entity-find entity-name="mantle.product.subscription.Subscription" list="orderSubscriptionList"><econdition field-name="orderId"/><econdition field-name="orderItemSeqId"/></entity-find></if><entity-find entity-name="mantle.product.subscription.ProductSubscriptionResource" list="productSubscriptionResourceList" cache="true"><econdition field-name="productId" from="product.productId"/></entity-find><iterate list="productSubscriptionResourceList" entry="productSubscriptionResource"><filter-map-list list="orderSubscriptionList" to-list="currentSubscriptionList"><field-map field-name="orderItemSeqId" from="orderItem.orderItemSeqId"/><field-map field-name="subscriptionResourceId" from="productSubscriptionResource.subscriptionResourceId"/></filter-map-list><if condition="!currentSubscriptionList"><set field="isFulfilled" from="false"/></if></iterate></if><if condition="isFulfilled && product.productTypeEnumId in ['PtAsset', 'PtDigitalAsset', 'PtAssetUse', 'PtPickAssembly']"><if condition="orderAssetIssuanceList == null"><then><entity-find entity-name="mantle.product.issuance.AssetIssuance" list="currentAssetIssuanceList"><econdition field-name="orderId"/><econdition field-name="orderItemSeqId"/></entity-find></then><else><filter-map-list list="orderAssetIssuanceList" to-list="currentAssetIssuanceList"><field-map field-name="orderItemSeqId"/></filter-map-list></else></if><if condition="orderAssetReceiptList == null"><then><entity-find entity-name="mantle.product.issuance.AssetIssuance" list="currentAssetIssuanceList"><econdition field-name="orderId"/><econdition field-name="orderItemSeqId"/></entity-find></then><else><filter-map-list list="orderAssetReceiptList" to-list="currentAssetReceiptList"><field-map field-name="orderItemSeqId"/></filter-map-list></else></if><set field="currentQuantityTotal" from="0" type="BigDecimal"/><iterate list="currentAssetIssuanceList" entry="currentAssetIssuance"><set field="currentQuantityTotal" from="currentQuantityTotal + currentAssetIssuance.quantity"/></iterate><iterate list="currentAssetReceiptList" entry="currentAssetReceipt"><set field="currentQuantityTotal" from="currentQuantityTotal + currentAssetReceipt.quantityAccepted"/></iterate><if condition="currentQuantityTotal < orderItem.quantity"><set field="isFulfilled" from="false"/></if></if><if condition="isFulfilled"><if condition="orderWorkEffortList == null"><then><entity-find entity-name="mantle.order.OrderItemWorkEffort" list="itemWorkEffortList"><econdition field-name="orderId"/><econdition field-name="orderItemSeqId"/><econdition field-name="requiredWork" value="Y"/></entity-find></then><else><filter-map-list list="orderWorkEffortList" to-list="itemWorkEffortList"><field-map field-name="orderItemSeqId"/></filter-map-list></else></if><if condition="itemWorkEffortList"><set field="workEffortIdList" from="itemWorkEffortList*.workEffortId"/><entity-find entity-name="mantle.work.effort.WorkEffort" list="workEffortList"><econdition field-name="workEffortId" operator="in" from="workEffortIdList"/><select-field field-name="workEffortId,statusId"/></entity-find><iterate list="workEffortList" entry="workEffort"><if condition="!(workEffort.statusId in ['WeComplete', 'WeClosed', 'WeCancelled'])"><set field="isFulfilled" from="false"/><break/></if></iterate></if></if></then><else/></if></actions></service>