<!--Service Location mantle.account.PaymentServices.create#InvoicePayment--><service verb="create" noun="InvoicePayment"><in-parameters><parameter name="invoiceId" required="true"/><parameter name="paymentTypeEnumId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.payment.Payment" field-name="paymentTypeEnumId"/><parameter name="fromPartyId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.payment.Payment" field-name="fromPartyId"/><parameter name="toPartyId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.payment.Payment" field-name="toPartyId"/><parameter name="paymentInstrumentEnumId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.payment.Payment" field-name="paymentInstrumentEnumId" default-value="PiCompanyCheck"/><parameter name="paymentMethodId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.payment.Payment" field-name="paymentMethodId"/><parameter name="toPaymentMethodId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.payment.Payment" field-name="toPaymentMethodId"/><parameter name="paymentGatewayConfigId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.payment.Payment" field-name="paymentGatewayConfigId"/><parameter name="orderId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.payment.Payment" field-name="orderId"/><parameter name="orderPartSeqId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.payment.Payment" field-name="orderPartSeqId"/><parameter name="orderItemSeqId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.payment.Payment" field-name="orderItemSeqId"/><parameter name="statusId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.payment.Payment" field-name="statusId" default="paymentStatusId"/><parameter name="effectiveDate" type="Timestamp" required="false" allow-html="none" entity-name="mantle.account.payment.Payment" field-name="effectiveDate"/><parameter name="settlementDate" type="java.sql.Timestamp" required="false" allow-html="none" entity-name="mantle.account.payment.Payment" field-name="settlementDate"/><parameter name="dueDate" type="java.sql.Timestamp" required="false" allow-html="none" entity-name="mantle.account.payment.Payment" field-name="dueDate"/><parameter name="paymentAuthCode" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.payment.Payment" field-name="paymentAuthCode"/><parameter name="paymentRefNum" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.payment.Payment" field-name="paymentRefNum"/><parameter name="comments" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.payment.Payment" field-name="comments"/><parameter name="memo" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.payment.Payment" field-name="memo"/><parameter name="distGroupEnumId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.payment.Payment" field-name="distGroupEnumId"/><parameter name="amount" type="BigDecimal" required="false" allow-html="none" entity-name="mantle.account.payment.Payment" field-name="amount"><description><![CDATA[Defaults to invoice unpaid total]]></description></parameter><parameter name="amountUomId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.payment.Payment" field-name="amountUomId"/><parameter name="appliedTotal" type="java.math.BigDecimal" required="false" allow-html="none" entity-name="mantle.account.payment.Payment" field-name="appliedTotal"/><parameter name="unappliedTotal" type="java.math.BigDecimal" required="false" allow-html="none" entity-name="mantle.account.payment.Payment" field-name="unappliedTotal"/><parameter name="forInvoiceId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.payment.Payment" field-name="forInvoiceId"/><parameter name="refundForPaymentId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.payment.Payment" field-name="refundForPaymentId"/><parameter name="finAccountId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.payment.Payment" field-name="finAccountId"/><parameter name="finAccountAuthId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.payment.Payment" field-name="finAccountAuthId"/><parameter name="finAccountTransId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.payment.Payment" field-name="finAccountTransId"/><parameter name="overrideOrgPartyId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.payment.Payment" field-name="overrideOrgPartyId"/><parameter name="partyRelationshipId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.payment.Payment" field-name="partyRelationshipId"/><parameter name="timePeriodId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.payment.Payment" field-name="timePeriodId"/><parameter name="originalCurrencyAmount" type="java.math.BigDecimal" required="false" allow-html="none" entity-name="mantle.account.payment.Payment" field-name="originalCurrencyAmount"/><parameter name="originalCurrencyUomId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.payment.Payment" field-name="originalCurrencyUomId"/><parameter name="presentFlag" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.payment.Payment" field-name="presentFlag"/><parameter name="swipedFlag" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.payment.Payment" field-name="swipedFlag"/><parameter name="processAttempt" type="java.lang.Long" required="false" allow-html="none" entity-name="mantle.account.payment.Payment" field-name="processAttempt"/><parameter name="needsNsfRetry" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.payment.Payment" field-name="needsNsfRetry"/><parameter name="visitId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.payment.Payment" field-name="visitId" default="ec.user.visitId"/><parameter name="lastUpdatedStamp" type="java.sql.Timestamp" required="false" allow-html="none" entity-name="mantle.account.payment.Payment" field-name="lastUpdatedStamp"/><parameter name="paymentStatusId" default-value="PmntDelivered"/><parameter name="paymentOverrideGlAccountId"/></in-parameters><out-parameters><parameter name="paymentId"/><parameter name="paymentApplicationId"/></out-parameters><actions><service-call name="mantle.account.PaymentServices.check#InvoiceStatusForPayment" in-map="[invoiceId:invoiceId]"/><entity-find-one entity-name="mantle.account.invoice.Invoice" value-field="invoice"/><if condition="paymentTypeEnumId == null"><entity-find-one entity-name="moqui.basic.Enumeration" value-field="invoiceTypeEnum" auto-field-map="[enumId:invoice.invoiceTypeEnumId]"/><set field="paymentTypeEnumId" from="(invoiceTypeEnum?.relatedEnumId) ?: 'PtInvoicePayment'"/></if><if condition="!amount"><service-call name="mantle.account.InvoiceServices.get#InvoiceTotal" in-map="[invoiceId:invoiceId]" out-map="[invoiceTotal:totalOut.invoiceTotal,appliedPaymentsTotal:totalOut.appliedPaymentsTotal,unpaidTotal:totalOut.unpaidTotal]"/><set field="amount" from="totalOut.unpaidTotal"/></if><if condition="!amountUomId"><set field="amountUomId" from="invoice.currencyUomId"/></if><if condition="amount == 0.0"><return message="Not creating payment for invoice ${invoiceId}, unpaid total is zero"/></if><entity-find entity-name="mantle.account.payment.Payment" list="paymentList"><econdition field-name="forInvoiceId" from="invoiceId"/><econdition field-name="statusId" operator="not-in" value="PmntCancelled,PmntVoid,PmntDeclined"/></entity-find><set field="forTotal" from="paymentList*.amount.sum()"/><if condition="forTotal >= invoice.invoiceTotal"><return message="Not creating payment for invoice ${invoiceId}, found payments ${paymentList*.paymentId} for this invoice"/></if><set field="initialStatusId" from="statusId == 'PmntProposed' ? statusId : 'PmntPromised'"/><service-call name="create#mantle.account.payment.Payment" out-map="[paymentId:context.paymentId,paymentTypeEnumId:context.paymentTypeEnumId,fromPartyId:context.fromPartyId,toPartyId:context.toPartyId,paymentInstrumentEnumId:context.paymentInstrumentEnumId,paymentMethodId:context.paymentMethodId,toPaymentMethodId:context.toPaymentMethodId,paymentGatewayConfigId:context.paymentGatewayConfigId,orderId:context.orderId,orderPartSeqId:context.orderPartSeqId,orderItemSeqId:context.orderItemSeqId,statusId:context.statusId,effectiveDate:context.effectiveDate,settlementDate:context.settlementDate,dueDate:context.dueDate,paymentAuthCode:context.paymentAuthCode,paymentRefNum:context.paymentRefNum,comments:context.comments,memo:context.memo,distGroupEnumId:context.distGroupEnumId,amount:context.amount,amountUomId:context.amountUomId,appliedTotal:context.appliedTotal,unappliedTotal:context.unappliedTotal,forInvoiceId:context.forInvoiceId,refundForPaymentId:context.refundForPaymentId,finAccountId:context.finAccountId,finAccountAuthId:context.finAccountAuthId,finAccountTransId:context.finAccountTransId,overrideGlAccountId:context.overrideGlAccountId,overrideOrgPartyId:context.overrideOrgPartyId,partyRelationshipId:context.partyRelationshipId,timePeriodId:context.timePeriodId,originalCurrencyAmount:context.originalCurrencyAmount,originalCurrencyUomId:context.originalCurrencyUomId,presentFlag:context.presentFlag,swipedFlag:context.swipedFlag,processAttempt:context.processAttempt,needsNsfRetry:context.needsNsfRetry,visitId:context.visitId,acctgTransResultEnumId:context.acctgTransResultEnumId,reconcileStatusId:context.reconcileStatusId,paymentMethodFileId:context.paymentMethodFileId,lastUpdatedStamp:context.lastUpdatedStamp]" in-map="context + [fromPartyId:invoice.toPartyId, toPartyId:invoice.fromPartyId, forInvoiceId:invoiceId,                         statusId:initialStatusId, overrideGlAccountId:paymentOverrideGlAccountId]"/><if condition="statusId == 'PmntConfirmed'"><service-call name="update#mantle.account.payment.Payment" in-map="[paymentId:paymentId, statusId:'PmntDelivered']"/></if><service-call name="update#mantle.account.payment.Payment" in-map="[paymentId:paymentId, statusId:statusId]"/><entity-find entity-name="mantle.account.payment.PaymentApplication" list="paymentAppList"><econdition field-name="paymentId"/></entity-find><set field="paymentApplicationId" from="paymentAppList ? paymentAppList[0].paymentApplicationId : null"/></actions></service>