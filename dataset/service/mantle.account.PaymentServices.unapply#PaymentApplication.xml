<!--Service Location mantle.account.PaymentServices.unapply#PaymentApplication--><service verb="unapply" noun="PaymentApplication"><in-parameters><parameter name="paymentApplicationId" required="true" entity-name="mantle.account.payment.PaymentApplication" field-name="paymentApplicationId"/></in-parameters><out-parameters/><actions><entity-find-one entity-name="mantle.account.payment.PaymentApplication" value-field="paymentApplication" for-update="true"/><if condition="paymentApplication.amountApplied != 0.0"><service-call name="update#mantle.account.payment.PaymentApplication" in-map="[paymentApplicationId:paymentApplicationId, amountApplied:0.0,                             amountOriginallyApplied:paymentApplication.amountApplied]"/><if condition="paymentApplication.invoiceId"><entity-find-one entity-name="mantle.account.invoice.Invoice" value-field="invoice"><field-map field-name="invoiceId" from="paymentApplication.invoiceId"/></entity-find-one><if condition="invoice.statusId == 'InvoicePmtRecvd'"><then><set field="invoice.statusId" value="InvoiceFinalized"/><entity-update value-field="invoice"/></then><else-if condition="invoice.statusId == 'InvoicePmtSent'"><set field="invoice.statusId" value="InvoiceApproved"/><entity-update value-field="invoice"/></else-if></if></if><if condition="paymentApplication.toInvoiceId"><entity-find-one entity-name="mantle.account.invoice.Invoice" value-field="toInvoice"><field-map field-name="invoiceId" from="paymentApplication.toInvoiceId"/></entity-find-one><if condition="toInvoice.statusId == 'InvoicePmtRecvd'"><then><set field="toInvoice.statusId" value="InvoiceFinalized"/><entity-update value-field="toInvoice"/></then><else-if condition="toInvoice.statusId == 'InvoicePmtSent'"><set field="toInvoice.statusId" value="InvoiceApproved"/><entity-update value-field="toInvoice"/></else-if></if></if></if></actions></service>