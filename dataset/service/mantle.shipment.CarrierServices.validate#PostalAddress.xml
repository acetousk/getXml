<!--Service Location mantle.shipment.CarrierServices.validate#PostalAddress--><service verb="validate" noun="PostalAddress"><in-parameters><parameter name="contactMechId" required="true" entity-name="mantle.party.contact.PostalAddress" field-name="contactMechId"/><parameter name="partyId"/><parameter name="facilityId"/><parameter name="shippingGatewayConfigId"><description><![CDATA[Defaults to ValidateAddressGatewayConfigId user/group preference]]></description></parameter><parameter name="orderId"><description><![CDATA[If specified update matching OrderPart.postalContactMechId]]></description></parameter><parameter name="shipmentId"><description><![CDATA[If specified update matching ShipmentRouteSegment origin and dest postal IDs]]></description></parameter></in-parameters><out-parameters><parameter name="contactMechId" entity-name="mantle.party.contact.PostalAddress" field-name="contactMechId"><description><![CDATA[Return original or if update#PartyPostalAddress is called then the new]]></description></parameter></out-parameters><actions><set field="origContactMechId" from="contactMechId"/><entity-find-one entity-name="mantle.party.contact.ContactMech" value-field="contactMech"/><entity-find-one entity-name="mantle.party.contact.PostalAddress" value-field="postalAddress"/><if condition="postalAddress == null"><return/></if><if condition="!postalAddress.shipGatewayAddressId"><if condition="partyId"><then><entity-find entity-name="mantle.party.contact.PartyContactMechInfo" list="replacesPcmiList"><date-filter/><econdition field-name="partyId"/><econdition field-name="replacesContactMechId" from="contactMechId"/><select-field field-name="contactMechId"/><order-by field-name="contactMechId"/></entity-find><if condition="replacesPcmiList"><set field="contactMechId" from="replacesPcmiList[0].contactMechId"/><return/></if></then><else-if condition="facilityId"><entity-find entity-name="mantle.facility.FacilityContactMechInfo" list="replacesFcmiList"><date-filter/><econdition field-name="facilityId"/><econdition field-name="replacesContactMechId" from="contactMechId"/><select-field field-name="contactMechId"/><order-by field-name="contactMechId"/></entity-find><if condition="replacesFcmiList"><set field="contactMechId" from="replacesFcmiList[0].contactMechId"/><return/></if></else-if></if></if><if condition="!shippingGatewayConfigId && partyId"><entity-find-one entity-name="mantle.party.Party" value-field="party"/><if condition="party?.ownerPartyId"><service-call name="mantle.party.PartyServices.get#PartySettingValue" out-map="[settingValue:ptySettingOut.settingValue]" in-map="[partyId:party.ownerPartyId, partySettingTypeId:'ValidateAddressGatewayConfigId']"/><set field="shippingGatewayConfigId" from="ptySettingOut?.settingValue"/></if></if><if condition="!shippingGatewayConfigId"><set field="shippingGatewayConfigId" from="ec.user.getPreference('ValidateAddressGatewayConfigId')"/></if><if condition="!shippingGatewayConfigId"><return/></if><entity-find-one entity-name="mantle.shipment.carrier.ShippingGatewayConfig" value-field="shippingGatewayConfig"/><if condition="shippingGatewayConfig == null"><log level="error" message="No ShippingGatewayConfig found with ID ${shippingGatewayConfigId}, not validating address"/><return/></if><set field="validateAddressServiceName" from="shippingGatewayConfig.validateAddressServiceName"/><if condition="!validateAddressServiceName"><log level="error" message="No ShippingGatewayConfig with ID ${shippingGatewayConfigId} has no validateAddressServiceName, not validating address"/><return/></if><service-call name="${validateAddressServiceName}" out-map="context" in-map="context"/><if condition="contactMechId != origContactMechId"><if condition="orderId"><entity-find entity-name="mantle.order.OrderPart" list="orderPartList"><econdition field-name="orderId"/></entity-find><iterate list="orderPartList" entry="orderPart"><if condition="orderPart.postalContactMechId == origContactMechId"><set field="orderPart.postalContactMechId" from="contactMechId"/><entity-update value-field="orderPart"/></if></iterate></if><if condition="shipmentId"><entity-find entity-name="mantle.shipment.ShipmentRouteSegment" list="routeSegmentList"><econdition field-name="shipmentId"/></entity-find><iterate list="routeSegmentList" entry="routeSegment"><if condition="routeSegment.originPostalContactMechId == origContactMechId"><set field="routeSegment.originPostalContactMechId" from="contactMechId"/></if><if condition="routeSegment.destPostalContactMechId == origContactMechId"><set field="routeSegment.destPostalContactMechId" from="contactMechId"/></if><entity-update value-field="routeSegment"/></iterate></if></if></actions></service>