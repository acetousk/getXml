<!--Service Location coarchy.ProductEvaluationServices.create#ProductEvaluation--><service verb="create" noun="ProductEvaluation"><in-parameters><parameter name="productId" required="true" entity-name="coarchy.product.ProductEvaluation" field-name="productId"/><parameter name="organizationId" required="true" entity-name="coarchy.product.ProductEvaluation" field-name="organizationId"/><parameter name="evaluationName" required="true" entity-name="coarchy.product.ProductEvaluation" field-name="evaluationName"/><parameter name="emailAddress" required="true"/><parameter name="processStoryIds" type="List" required="true"/></in-parameters><out-parameters/><actions><entity-find-one entity-name="mantle.product.Product" value-field="product"/><if condition="!product"><return error="true" message="Product ${productId} not found."/></if><service-call name="create#coarchy.product.ProductEvaluation" in-map="[productId:productId, organizationId:organizationId, statusId: 'PeRequirementsSelection', createdDate:ec.user.nowTimestamp, evaluationName:evaluationName]" out-map="[productEvaluationId:context.productEvaluationId,productId:context.productId,organizationId:context.organizationId,statusId:context.statusId,evaluationName:context.evaluationName,createdDate:context.createdDate,requirementsSetDate:context.requirementsSetDate,completedDate:context.completedDate,lastUpdatedStamp:context.lastUpdatedStamp]"/><iterate list="processStoryIds" entry="processStoryId"><service-call name="create#coarchy.product.ProductEvaluationStory" in-map="[productEvaluationId:productEvaluationId, processStoryId:processStoryId, organizationId:organizationId]"/></iterate><entity-find entity-name="coarchy.ValueStatement" list="valueStatementList"><econdition field-name="replacedByValueStatementId" operator="is-null"/><econdition field-name="disabled" value="N" or-null="true"/><econdition field-name="organizationId"/><order-by field-name="sequenceNum,value"/></entity-find><iterate list="valueStatementList" entry="valueStatement"><service-call name="create#coarchy.product.ProductEvaluationStatement" in-map="[productEvaluationId:productEvaluationId, statementId:valueStatement.valueStatementId, organizationId:organizationId]"/></iterate><set field="allProcessStoryIds" from="processStoryIds.clone()"/><iterate list="processStoryIds" entry="processStoryId"><service-call name="coarchy.ProductEvaluationServices.get#ProcessStoryDescendants" out-map="[descendantIdList:descOut.descendantIdList]" out-map-add-to-existing="false" in-map="[processStoryId:processStoryId]"/><script><![CDATA[allProcessStoryIds.addAll(descOut.descendantIdList)]]></script></iterate><entity-find entity-name="coarchy.ProcessStoryActivityDetail" list="processStoryActivityList"><date-filter/><econdition field-name="replacedByActivityId" operator="is-null"/><econdition field-name="processStoryId" operator="in" from="allProcessStoryIds"/><econditions combine="or"><econdition field-name="condition" operator="not-equals" value=""/><econdition field-name="action" operator="not-equals" value=""/></econditions><select-field field-name="processStoryId,activityId,condition,action"/></entity-find><iterate list="processStoryActivityList" entry="processStoryActivity"><service-call name="create#coarchy.product.ProductEvaluationActivity" in-map="[productEvaluationId:productEvaluationId, processStoryId:processStoryActivity.processStoryId, activityId:processStoryActivity.activityId, organizationId:organizationId]"/></iterate><service-call name="coarchy.ProductEvaluationServices.add#ProductEvaluationParty" in-map="[productEvaluationId:productEvaluationId, emailAddress:emailAddress, organizationId:organizationId]"/></actions></service>