<!--Service Location mantle.product.AssetServices.update#AssetAndReceipt--><service verb="update" noun="AssetAndReceipt"><in-parameters><parameter name="assetId" required="false" entity-name="mantle.product.asset.AssetDetail" field-name="assetId" type="java.lang.String" allow-html="none"/><parameter name="assetReceiptId" entity-name="mantle.product.asset.AssetDetail" field-name="assetReceiptId" type="java.lang.String" required="false" allow-html="none"><description><![CDATA[If not specified will look it up with assetId and shipmentId.]]></description></parameter><parameter name="shipmentId" entity-name="mantle.product.asset.AssetDetail" field-name="shipmentId" type="java.lang.String" required="false" allow-html="none"/><parameter name="workEffortId" entity-name="mantle.product.asset.AssetDetail" field-name="workEffortId" type="java.lang.String" required="false" allow-html="none"/><parameter name="productId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="productId"/><parameter name="orderId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.AssetDetail" field-name="orderId"/><parameter name="orderItemSeqId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.AssetDetail" field-name="orderItemSeqId"/><parameter name="shipmentItemSourceId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.receipt.AssetReceipt" field-name="shipmentItemSourceId"/><parameter name="shipmentPackageSeqId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.receipt.AssetReceipt" field-name="shipmentPackageSeqId"/><parameter name="invoiceId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.receipt.AssetReceipt" field-name="invoiceId"/><parameter name="invoiceItemSeqId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.receipt.AssetReceipt" field-name="invoiceItemSeqId"/><parameter name="returnId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.AssetDetail" field-name="returnId"/><parameter name="returnItemSeqId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.AssetDetail" field-name="returnItemSeqId"/><parameter name="receivedByUserId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.receipt.AssetReceipt" field-name="receivedByUserId"/><parameter name="receivedDate" type="java.sql.Timestamp" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="receivedDate"><description><![CDATA[If statusId == AstIncoming then no default, otherwise defaults to now.]]></description></parameter><parameter name="itemDescription" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.receipt.AssetReceipt" field-name="itemDescription"/><parameter name="quantityAccepted" type="java.math.BigDecimal" required="false" allow-html="none" entity-name="mantle.product.receipt.AssetReceipt" field-name="quantityAccepted"/><parameter name="quantityRejected" type="java.math.BigDecimal" required="false" allow-html="none" entity-name="mantle.product.receipt.AssetReceipt" field-name="quantityRejected"/><parameter name="rejectionReasonEnumId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.receipt.AssetReceipt" field-name="rejectionReasonEnumId"/><parameter name="acctgTransResultEnumId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.AssetDetail" field-name="acctgTransResultEnumId"/><parameter name="lastUpdatedStamp" type="java.sql.Timestamp" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="lastUpdatedStamp"/><parameter name="effectiveDate" type="java.sql.Timestamp" required="false" allow-html="none" entity-name="mantle.product.asset.AssetDetail" field-name="effectiveDate"/><parameter name="unitCost" type="java.math.BigDecimal" required="false" allow-html="none" entity-name="mantle.product.asset.AssetDetail" field-name="unitCost"/><parameter name="assetReservationId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.AssetDetail" field-name="assetReservationId"/><parameter name="otherAssetId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.AssetDetail" field-name="otherAssetId"/><parameter name="assetMaintenanceId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.AssetDetail" field-name="assetMaintenanceId"/><parameter name="assetIssuanceId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.AssetDetail" field-name="assetIssuanceId"/><parameter name="physicalInventoryId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.AssetDetail" field-name="physicalInventoryId"/><parameter name="physicalInventoryCountId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.AssetDetail" field-name="physicalInventoryCountId"/><parameter name="varianceReasonEnumId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.AssetDetail" field-name="varianceReasonEnumId"/><parameter name="description" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.AssetDetail" field-name="description"/><parameter name="parentAssetId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="parentAssetId"/><parameter name="assetTypeEnumId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="assetTypeEnumId"/><parameter name="classEnumId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="classEnumId"/><parameter name="statusId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="statusId"/><parameter name="ownerPartyId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="ownerPartyId"/><parameter name="assetPoolId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="assetPoolId"/><parameter name="hasQuantity" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="hasQuantity"/><parameter name="originalQuantity" type="java.math.BigDecimal" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="originalQuantity"/><parameter name="originalQuantityUomId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="originalQuantityUomId"/><parameter name="assetName" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="assetName"/><parameter name="comments" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="comments"/><parameter name="serialNumber" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="serialNumber"/><parameter name="softIdentifier" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="softIdentifier"/><parameter name="activationNumber" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="activationNumber"/><parameter name="activationValidThru" type="java.sql.Timestamp" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="activationValidThru"/><parameter name="acquiredDate" type="java.sql.Timestamp" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="acquiredDate"/><parameter name="manufacturedDate" type="java.sql.Timestamp" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="manufacturedDate"/><parameter name="expectedEndOfLife" type="java.sql.Date" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="expectedEndOfLife"/><parameter name="actualEndOfLife" type="java.sql.Date" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="actualEndOfLife"/><parameter name="capacity" type="java.math.BigDecimal" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="capacity"/><parameter name="capacityUomId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="capacityUomId"/><parameter name="facilityId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="facilityId"/><parameter name="locationSeqId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="locationSeqId"/><parameter name="containerId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="containerId"/><parameter name="shipmentBoxTypeId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="shipmentBoxTypeId"/><parameter name="lotId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="lotId"/><parameter name="geoPointId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="geoPointId"/><parameter name="originId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="originId"/><parameter name="originFacilityId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="originFacilityId"/><parameter name="acquireOrderId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="acquireOrderId"/><parameter name="acquireOrderItemSeqId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="acquireOrderItemSeqId"/><parameter name="acquireWorkEffortId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="acquireWorkEffortId"/><parameter name="acquireShipmentId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="acquireShipmentId"/><parameter name="acquireCost" type="java.math.BigDecimal" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="acquireCost"/><parameter name="acquireCostUomId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="acquireCostUomId"/><parameter name="salvageValue" type="java.math.BigDecimal" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="salvageValue"/><parameter name="depreciation" type="java.math.BigDecimal" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="depreciation"/><parameter name="depreciationTypeEnumId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="depreciationTypeEnumId"/><parameter name="yearBeginDepreciation" type="java.math.BigDecimal" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="yearBeginDepreciation"/><parameter name="taxDepreciation" type="java.math.BigDecimal" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="taxDepreciation"/><parameter name="taxDepreciationTypeEnumId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="taxDepreciationTypeEnumId"/><parameter name="lotNumber"><description><![CDATA[If specified and no there is no lotId create a Lot with this number and the
                expirationDate and mfgPartyId parameters.]]></description></parameter><parameter name="expirationDate" type="Date"><description><![CDATA[Used when creating a lot, defaults to expectedEndOfLife.
                If this is specified and no expectedEndOfLife is then set expectedEndOfLife to this (regardless of whether Lot is created).]]></description></parameter><parameter name="mfgPartyId"/></in-parameters><out-parameters><parameter name="assetDetailId"/></out-parameters><actions><if condition="quantityAccepted < 0.0"><return error="true" message="Quantity Accepted may not be negative"/></if><if condition="quantityRejected != null && quantityRejected < 0.0"><return error="true" message="Quantity Rejected may not be negative"/></if><entity-find-one entity-name="mantle.product.asset.Asset" value-field="asset"/><set field="oldStatusId" from="asset.statusId"/><set field="oldAtp" from="asset.availableToPromiseTotal"/><set field="oldQoh" from="asset.quantityOnHandTotal"/><set field="oldAcquireCost" from="asset.acquireCost"/><set field="oldReceivedDate" from="asset.receivedDate"/><if condition="!assetReceiptId && shipmentId"><then><entity-find entity-name="mantle.product.receipt.AssetReceipt" list="assetReceiptList"><econdition field-name="assetId"/><econdition field-name="shipmentId"/><order-by field-name="assetReceiptId"/></entity-find><set field="originalAssetReceipt" from="assetReceiptList?.first"/><set field="assetReceiptId" from="originalAssetReceipt?.assetReceiptId"/></then><else><entity-find-one entity-name="mantle.product.receipt.AssetReceipt" value-field="originalAssetReceipt"/></else></if><if condition="!assetReceiptId"><return error="true" message="Cannot update Asset and Receipt, could not find AssetReceipt record for assetId [${assetId}], shipmentId [${shipmentId}]"/></if><set field="quantityDiff" from="(quantityAccepted != null ? quantityAccepted : (originalAssetReceipt.quantityAccepted ?: 0.0)) - (originalAssetReceipt.quantityAccepted ?: 0.0)"/><set field="quantityRejectedDiff" from="(quantityRejected != null ? quantityRejected : (originalAssetReceipt.quantityRejected ?: 0.0)) - (originalAssetReceipt.quantityRejected ?: 0.0)"/><set field="newQuantityRemaining" from="(quantityDiff ?: 0) + (quantityRejectedDiff ?: 0)"/><if condition="newQuantityRemaining && shipmentId"><service-call name="mantle.shipment.ShipmentServices.ensure#ShipmentItemQuantityRemaining" in-map="[shipmentId:shipmentId, productId:asset.productId, newQuantityRemaining:newQuantityRemaining]"/></if><if condition="expectedEndOfLife == null"><set field="expectedEndOfLife" from="expirationDate"/></if><if condition="lotId"><then><entity-find-one entity-name="mantle.product.asset.Lot" value-field="lot"><field-map field-name="lotId"/></entity-find-one><if condition="manufacturedDate == null"><set field="manufacturedDate" from="lot.manufacturedDate"/></if><if condition="expectedEndOfLife == null"><set field="expectedEndOfLife" from="lot.expirationDate"/></if></then><else-if condition="lotNumber"><entity-find entity-name="mantle.product.asset.Lot" list="existingLots"><econdition field-name="lotNumber"/><econdition field-name="mfgPartyId"/></entity-find><if condition="existingLots"><then><set field="lotId" from="existingLots[0].lotId"/><if condition="expectedEndOfLife == null"><set field="expectedEndOfLife" from="existingLots[0].expirationDate"/></if></then><else><if condition="!mfgPartyId && shipmentId"><entity-find-one entity-name="mantle.shipment.Shipment" value-field="shipment"/><set field="mfgPartyId" from="shipment.fromPartyId"/></if><if condition="expirationDate == null"><set field="expirationDate" from="expectedEndOfLife"/></if><service-call name="create#mantle.product.asset.Lot" out-map="[lotId:context.lotId,mfgPartyId:context.mfgPartyId,lotNumber:context.lotNumber,quantity:context.quantity,manufacturedDate:context.manufacturedDate,expirationDate:context.expirationDate,lastUpdatedStamp:context.lastUpdatedStamp]" in-map="[lotNumber:lotNumber, mfgPartyId:mfgPartyId, manufacturedDate:manufacturedDate, expirationDate:expirationDate]"/></else></if></else-if></if><if condition="!receivedDate && statusId && statusId != 'AstIncoming'"><set field="receivedDate" from="ec.user.nowTimestamp"/></if><service-call name="update#mantle.product.receipt.AssetReceipt" in-map="context" out-map="[assetReceiptId:context.assetReceiptId,assetId:context.assetId,productId:context.productId,orderId:context.orderId,orderItemSeqId:context.orderItemSeqId,shipmentId:context.shipmentId,shipmentItemSourceId:context.shipmentItemSourceId,shipmentPackageSeqId:context.shipmentPackageSeqId,invoiceId:context.invoiceId,invoiceItemSeqId:context.invoiceItemSeqId,returnId:context.returnId,returnItemSeqId:context.returnItemSeqId,workEffortId:context.workEffortId,receivedByUserId:context.receivedByUserId,receivedDate:context.receivedDate,itemDescription:context.itemDescription,quantityAccepted:context.quantityAccepted,quantityRejected:context.quantityRejected,rejectionReasonEnumId:context.rejectionReasonEnumId,acctgTransResultEnumId:context.acctgTransResultEnumId,lastUpdatedStamp:context.lastUpdatedStamp]"/><entity-find-one entity-name="mantle.shipment.ShipmentItemSource" value-field="shipmentItemSource" for-update="true"><field-map field-name="shipmentItemSourceId" from="originalAssetReceipt.shipmentItemSourceId"/></entity-find-one><if condition="shipmentItemSource != null"><set field="shipmentItemSource.quantityNotHandled" from="shipmentItemSource.quantityNotHandled - quantityDiff - quantityRejectedDiff"/><if condition="shipmentItemSource.quantityNotHandled && shipmentItemSource.statusId == 'SisReceived'"><set field="shipmentItemSource.statusId" value="SisPending"/></if><if condition="!shipmentItemSource.quantityNotHandled && shipmentItemSource.statusId == 'SisPending'"><set field="shipmentItemSource.statusId" value="SisReceived"/></if><entity-update value-field="shipmentItemSource"/></if><service-call name="update#mantle.product.asset.Asset" in-map="context" out-map="[assetId:context.assetId,parentAssetId:context.parentAssetId,assetTypeEnumId:context.assetTypeEnumId,classEnumId:context.classEnumId,statusId:context.statusId,ownerPartyId:context.ownerPartyId,assetPoolId:context.assetPoolId,productId:context.productId,hasQuantity:context.hasQuantity,quantityOnHandTotal:context.quantityOnHandTotal,availableToPromiseTotal:context.availableToPromiseTotal,originalQuantity:context.originalQuantity,originalQuantityUomId:context.originalQuantityUomId,assetName:context.assetName,comments:context.comments,serialNumber:context.serialNumber,softIdentifier:context.softIdentifier,activationNumber:context.activationNumber,activationValidThru:context.activationValidThru,receivedDate:context.receivedDate,acquiredDate:context.acquiredDate,manufacturedDate:context.manufacturedDate,expectedEndOfLife:context.expectedEndOfLife,actualEndOfLife:context.actualEndOfLife,capacity:context.capacity,capacityUomId:context.capacityUomId,facilityId:context.facilityId,locationSeqId:context.locationSeqId,containerId:context.containerId,shipmentBoxTypeId:context.shipmentBoxTypeId,lotId:context.lotId,geoPointId:context.geoPointId,originId:context.originId,originFacilityId:context.originFacilityId,acquireOrderId:context.acquireOrderId,acquireOrderItemSeqId:context.acquireOrderItemSeqId,acquireWorkEffortId:context.acquireWorkEffortId,acquireShipmentId:context.acquireShipmentId,acquireCost:context.acquireCost,acquireCostUomId:context.acquireCostUomId,salvageValue:context.salvageValue,depreciation:context.depreciation,depreciationTypeEnumId:context.depreciationTypeEnumId,yearBeginDepreciation:context.yearBeginDepreciation,taxDepreciation:context.taxDepreciation,taxDepreciationTypeEnumId:context.taxDepreciationTypeEnumId,lastUpdatedStamp:context.lastUpdatedStamp]"/><if condition="oldAtp <= 0 && statusId == 'AstAvailable' && oldStatusId != 'AstAvailable'"><service-call name="create#mantle.product.asset.AssetDetail" out-map="[assetDetailId:context.assetDetailId,assetId:context.assetId,effectiveDate:context.effectiveDate,quantityOnHandDiff:context.quantityOnHandDiff,availableToPromiseDiff:context.availableToPromiseDiff,unitCost:context.unitCost,assetReservationId:context.assetReservationId,otherAssetId:context.otherAssetId,shipmentId:context.shipmentId,productId:context.productId,orderId:context.orderId,orderItemSeqId:context.orderItemSeqId,returnId:context.returnId,returnItemSeqId:context.returnItemSeqId,workEffortId:context.workEffortId,assetMaintenanceId:context.assetMaintenanceId,assetIssuanceId:context.assetIssuanceId,assetReceiptId:context.assetReceiptId,physicalInventoryId:context.physicalInventoryId,physicalInventoryCountId:context.physicalInventoryCountId,varianceReasonEnumId:context.varianceReasonEnumId,description:context.description,acctgTransResultEnumId:context.acctgTransResultEnumId,lastUpdatedStamp:context.lastUpdatedStamp]" in-map="[assetId:assetId, effectiveDate:receivedDate, quantityOnHandDiff:0,                             availableToPromiseDiff:oldQoh, shipmentId:shipmentId, productId:asset.productId,                             assetReceiptId:assetReceiptId]"/><service-call name="mantle.product.AssetServices.reserve#IncreasedAsset" in-map="[assetId:assetId]"/></if><if condition="quantityDiff != 0"><service-call name="mantle.product.AssetServices.change#AssetQuantity" in-map="context"/></if><if condition="(acquireCost != null && acquireCost != oldAcquireCost) ||                     (quantityAccepted != null && quantityAccepted != originalAssetReceipt.quantityAccepted) ||                     (receivedDate != null && oldReceivedDate != receivedDate)"><service-call name="mantle.ledger.AssetAutoPostServices.repost#Asset" in-map="[assetId:assetId]"/></if></actions></service>