<!--Service Location mantle.order.ReturnServices.find#ReturnableOrderItems--><service verb="find" noun="ReturnableOrderItems"><in-parameters><parameter name="returnId" required="true"/><parameter name="lookBackDays" type="Integer" default="30"/></in-parameters><out-parameters><parameter name="orderItemInfoList" type="List"><parameter name="orderItemInfo" type="Map"><parameter name="orderId"/><parameter name="orderItemSeqId"/><parameter name="itemTypeEnumId"/><parameter name="isProductItemType" type="Boolean"/><parameter name="productId"/><parameter name="invoiceQuantity" type="BigDecimal"/><parameter name="returnedQuantity" type="BigDecimal"/><parameter name="returnableQuantity" type="BigDecimal"/><parameter name="invoiceTotal" type="BigDecimal"/><parameter name="returnedTotal" type="BigDecimal"/><parameter name="returnableTotal" type="BigDecimal"/></parameter></parameter></out-parameters><actions><entity-find-one entity-name="mantle.order.return.ReturnHeader" value-field="returnHeader"/><script><![CDATA[Calendar lookBackCal = ec.user.nowCalendar
                lookBackCal.add(Calendar.DAY_OF_MONTH, -lookBackDays)
                lookBackTs = new java.sql.Timestamp(lookBackCal.getTimeInMillis())]]></script><entity-find entity-name="moqui.basic.EnumGroupMember" list="productItemTypeEgms" cache="true"><econdition field-name="enumGroupEnumId" value="EngItemsProduct"/></entity-find><set field="productItemTypes" from="productItemTypeEgms*.enumId"/><entity-find entity-name="mantle.order.return.ReturnableOrderItemView" list="returnableItems"><econdition field-name="customerPartyId" from="returnHeader.customerPartyId"/><econdition field-name="vendorPartyId" from="returnHeader.vendorPartyId"/><econdition field-name="placedDate" operator="greater-equals" from="lookBackTs"/><select-field field-name="orderId,orderItemSeqId,itemTypeEnumId,productId,quantity,invoiceQuantity,invoiceAmount"/><order-by field-name="orderId,orderItemSeqId"/></entity-find><set field="orderItemInfoList" from="[]"/><iterate list="returnableItems" entry="item"><if condition="item.invoiceQuantity == 0.0"><continue/></if><set field="isProductItemType" from="item.itemTypeEnumId in productItemTypes"/><entity-find-one entity-name="mantle.product.Product" value-field="product" cache="true"><field-map field-name="productId" from="item.productId"/></entity-find-one><set field="isShippable" from="isProductItemType && product != null ? product.productTypeEnumId in ['PtAsset', 'PtDigitalAsset', 'PtAssetUse', 'PtPickAssembly'] : false"/><set field="returnedQuantity" from="0.0"/><set field="returnedTotal" from="0.0"/><entity-find entity-name="mantle.order.return.ReturnItemQuantity" list="riqList"><econdition field-name="orderId" from="item.orderId"/><econdition field-name="orderItemSeqId" from="item.orderItemSeqId"/><econdition field-name="statusId" operator="not-equals" value="ReturnCancelled"/><select-field field-name="returnQuantity,responseAmount"/></entity-find><iterate list="riqList" entry="riq"><set field="retQuantity" from="riq.returnQuantity != null ? riq.returnQuantity : 1.0"/><set field="returnedQuantity" from="returnedQuantity + retQuantity"/><set field="returnedTotal" from="returnedTotal + (retQuantity * (riq.responseAmount ?: 0.0)).setScale(2, BigDecimal.ROUND_HALF_UP)"/></iterate><set field="invoiceQuantity" from="item.invoiceQuantity != null ? item.invoiceQuantity : 1.0"/><set field="returnableQuantity" from="invoiceQuantity - returnedQuantity"/><set field="invoiceTotal" from="(invoiceQuantity * (item.invoiceAmount ?: 0.0)).setScale(2, BigDecimal.ROUND_HALF_UP)"/><set field="returnableTotal" from="invoiceTotal - returnedTotal"/><if condition="returnableQuantity > 0.0 || (!isProductItemType && returnableTotal > 0.0)"><script><![CDATA[orderItemInfoList.add([orderId:item.orderId, orderItemSeqId:item.orderItemSeqId,
                            itemTypeEnumId:item.itemTypeEnumId, isProductItemType:isProductItemType, isShippable:isShippable,
                            productId:item.productId, invoiceQuantity:invoiceQuantity, invoiceTotal:invoiceTotal,
                            returnedQuantity:returnedQuantity, returnableQuantity:returnableQuantity,
                            returnedTotal:returnedTotal, returnableTotal:returnableTotal])]]></script></if></iterate></actions></service>