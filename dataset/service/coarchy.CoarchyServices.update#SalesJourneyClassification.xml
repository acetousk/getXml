<!--Service Location coarchy.CoarchyServices.update#SalesJourneyClassification--><service verb="update" noun="SalesJourneyClassification"><in-parameters><parameter name="currentTimestamp" default="ec.user.nowTimestamp" type="Timestamp" required="true"/></in-parameters><out-parameters><parameter name="newColdLeadPartyIdList" type="List"/><parameter name="newPreviouslyPayingCustomerPartyIdList" type="List"/></out-parameters><actions><set field="lastMonth" from="new Timestamp(ZonedDateTime.ofInstant(Instant.ofEpochMilli(                     (long) currentTimestamp.time), ZoneId.systemDefault()).minusMonths(1).toInstant().toEpochMilli())" type="Timestamp"/><set field="newColdLeadPartyIdList" from="[]"/><entity-find entity-name="mantle.party.PartyClassificationAppl" list="hotLeadList"><econdition field-name="partyClassificationId" value="HotLead"/><date-filter/><order-by field-name="-fromDate"/></entity-find><iterate list="hotLeadList" entry="partyClassification"><entity-find entity-name="moqui.security.UserAccount" list="userAccountList" limit="1"><econdition field-name="partyId" from="partyClassification.partyId"/><select-field field-name="userId"/><order-by field-name="-lastUpdatedStamp"/></entity-find><set field="userAccount" from="userAccountList?.getFirst()"/><if condition="!userAccount"><continue/></if><entity-find entity-name="moqui.security.UserLoginHistory" list="historyList" limit="1"><econdition field-name="userId" from="userAccount.userId"/><order-by field-name="-fromDate"/></entity-find><if condition="historyList.getFirst()?.fromDate != null && historyList.getFirst().fromDate.toInstant() < lastMonth.toInstant()"><set field="newColdLeadPartyIdList" from="newColdLeadPartyIdList + [partyClassification.partyId]"/><service-call name="mantle.party.PartyServices.set#PartyClassification" in-map="[                         partyId:partyClassification.partyId,partyClassificationId:'ColdLead']" out-map="[]"/></if></iterate><set field="newPreviouslyPayingCustomerPartyIdList" from="[]"/><entity-find entity-name="mantle.party.PartyClassificationAppl" list="payingCustomerList"><econdition field-name="partyClassificationId" value="PayingCustomer"/><date-filter/><order-by field-name="-fromDate"/></entity-find><iterate list="payingCustomerList" entry="partyClassification"><entity-find entity-name="mantle.account.financial.FinancialAccount" list="financialAccountList" distinct="true"><econdition field-name="ownerPartyId" from="partyClassification.partyId"/><econdition field-name="finAccountTypeId" value="OrganizationMonthCredit"/><econdition field-name="statusId" value="FaActive"/><date-filter/><select-field field-name="ownerPartyId,finAccountId,availableBalance"/></entity-find><if condition="financialAccountList.size() == 0"><continue/></if><if condition="financialAccountList.getFirst().availableBalance < .01"><set field="newPreviouslyPayingCustomerPartyIdList" from="newPreviouslyPayingCustomerPartyIdList + [partyClassification.partyId]"/><service-call name="mantle.party.PartyServices.set#PartyClassification" in-map="[                         partyId:partyClassification.partyId,partyClassificationId:'NonPayingCustomer']" out-map="[]"/><continue/></if><entity-find-count entity-name="mantle.party.PartyActivationAndParty" count-field="partyActivationAndPartyCount"><econdition field-name="ownerPartyId" from="partyClassification.partyId"/><date-filter/></entity-find-count><if condition="partyActivationAndPartyCount > 0"><continue/></if><entity-find entity-name="mantle.party.Party" list="partyList"><econdition field-name="ownerPartyId" from="partyClassification.partyId"/><econdition field-name="partyTypeEnumId" value="PtyOrganization"/></entity-find><set field="hasAnyFromDateLessThanLastMonth" from="false"/><iterate list="partyList" entry="party"><entity-find entity-name="mantle.party.PartyActivation" list="partyActivationList" limit="1"><econdition field-name="partyId" from="party.partyId"/><order-by field-name="-fromDate"/></entity-find><if condition="partyActivationList.size() == 0"><continue/></if><if condition="lastMonth.toInstant() < partyActivationList.getFirst().thruDate.toInstant()"><set field="hasAnyFromDateLessThanLastMonth" value="true"/><break/></if></iterate><if condition="!hasAnyFromDateLessThanLastMonth"><set field="newPreviouslyPayingCustomerPartyIdList" from="newPreviouslyPayingCustomerPartyIdList + [partyClassification.partyId]"/><service-call name="mantle.party.PartyServices.set#PartyClassification" in-map="[                         partyId:partyClassification.partyId,partyClassificationId:'PreviouslyPayingCustomer']" out-map="[]"/></if></iterate></actions></service>