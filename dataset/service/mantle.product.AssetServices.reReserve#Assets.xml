<!--Service Location mantle.product.AssetServices.reReserve#Assets--><service verb="reReserve" noun="Assets"><in-parameters><parameter name="facilityId"/><parameter name="productId"/><parameter name="orderId"/><parameter name="reserveOrderStatusIds" default-value="OrderPlaced,OrderHold,OrderProcessing,OrderApproved,OrderSent"/></in-parameters><out-parameters/><actions><set field="reserveOrderStatusIdSet" from="new HashSet(((String) reserveOrderStatusIds).split(',') as List)"/><entity-find entity-name="mantle.product.issuance.AssetAndReservation" list="resOrderItemList" distinct="true"><econdition field-name="facilityId" ignore-if-empty="true"/><econdition field-name="productId" ignore-if-empty="true"/><econdition field-name="orderId" ignore-if-empty="true"/><select-field field-name="orderId,orderItemSeqId"/></entity-find><log message="reReserve#Assets facilityId ${facilityId} productId ${productId} orderId ${orderId} OrderItems with reservations ${resOrderItemList.size()}"/><set field="orderItemInfoList" from="[]"/><iterate list="resOrderItemList" entry="resOrderItem"><entity-find-one entity-name="mantle.order.OrderItem" value-field="orderItem"><field-map field-name="orderId" from="resOrderItem.orderId"/><field-map field-name="orderItemSeqId" from="resOrderItem.orderItemSeqId"/></entity-find-one><if condition="orderItem == null"><log level="warn" message="In reReserve#Assets could not find OrderItem ${orderId}:${orderItemSeqId}"/><continue/></if><service-call name="mantle.product.AssetServices.remove#OrderItemReservations" in-map="[orderId:resOrderItem.orderId, orderItemSeqId:resOrderItem.orderItemSeqId]"/><set field="orderPart" from="orderItem.part"/><if condition="orderPart.statusId in reserveOrderStatusIdSet"><set field="orderHeader" from="orderItem.header"/><script><![CDATA[orderItemInfoList.add([orderId:orderItem.orderId, orderItemSeqId:orderItem.orderItemSeqId,
                            priority:orderPart.priority, placedDate:orderHeader.placedDate])]]></script></if></iterate><order-map-list list="orderItemInfoList"><order-by field-name="priority"/><order-by field-name="placedDate"/><order-by field-name="orderId"/><order-by field-name="orderItemSeqId"/></order-map-list><iterate list="orderItemInfoList" entry="orderItemInfo"><service-call name="mantle.product.AssetServices.reserve#AssetForOrderItem" in-map="[orderId:orderItemInfo.orderId, orderItemSeqId:orderItemInfo.orderItemSeqId, forceReserve:true]"/></iterate></actions></service>