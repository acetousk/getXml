<!--Service Location coarchy.NotificationServices.notify#ChurnedUsers--><service verb="notify" noun="ChurnedUsers"><in-parameters><parameter name="currentTimestamp" type="Timestamp" default="ec.user.nowTimestamp"/></in-parameters><out-parameters><parameter name="emailsSentList" type="List"/><parameter name="inactiveOwnerIdList" type="List"/><parameter name="lastActiveByOwnerId" type="Map"/></out-parameters><actions><set field="emailsSentList" from="[]"/><set field="baseLinkUrl" from="!'production'.equals(System.getProperty('instance_purpose')) ? 'http://localhost:8080' : 'https://coarchy.com'"/><entity-find entity-name="mantle.party.PartyActivation" list="inactivePartyActivationlist"><econdition field-name="fromDate" operator="less" from="currentTimestamp"/><econdition field-name="thruDate" operator="less-equals" from="currentTimestamp"/></entity-find><entity-find entity-name="mantle.party.Party" list="partyList"><econdition field-name="partyId" operator="in" from="inactivePartyActivationlist*.partyId"/></entity-find><set field="ownerIdSet" from="new TreeSet(partyList*.ownerPartyId)"/><set field="inactiveOwnerIdList" from="[]"/><set field="lastActiveByOwnerId" from="[:]"/><iterate list="ownerIdSet" entry="ownerId"><entity-find entity-name="mantle.party.Party" list="ownerOrgList"><econdition field-name="ownerPartyId" from="ownerId"/><econdition field-name="partyTypeEnumId" value="PtyOrganization"/><econdition field-name="disabled" value="N" or-null="true"/></entity-find><entity-find-count entity-name="mantle.party.PartyActivation" count-field="partyActivationList"><date-filter/><econdition field-name="partyId" operator="in" from="ownerOrgList*.partyId"/></entity-find-count><if condition="!partyActivationList"><entity-find entity-name="mantle.party.PartyActivation" list="partyActivationList" limit="1"><econdition field-name="partyId" operator="in" from="ownerOrgList*.partyId"/><order-by field-name="-thruDate"/></entity-find><set field="lastActiveDate" from="partyActivationList[0].thruDate"/><script><![CDATA[lastActiveByOwnerId[ownerId] = lastActiveDate]]></script><set field="nowDate" from="ZonedDateTime.ofInstant(Instant.ofEpochMilli(                         (long) currentTimestamp.time), ZoneId.systemDefault())"/><set field="lastActiveDate" from="ZonedDateTime.ofInstant(Instant.ofEpochMilli(                         (long) lastActiveDate.time), ZoneId.systemDefault())"/><set field="daysSinceLastActive" from="java.time.temporal.ChronoUnit.DAYS.between(                             lastActiveDate, nowDate)" type="BigDecimal"/><if condition="daysSinceLastActive > 20"><script><![CDATA[inactiveOwnerIdList.add(ownerId)]]></script><else><log level="warn" message="Not sending churn email to ${ownerId} since hasn't been 20 days since last active (val=${daysSinceLastActive})"/></else></if></if></iterate><set field="bodyParameters" from="[linkUrl:baseLinkUrl+'/settings/BuyPremium',baseLinkUrl:baseLinkUrl, currentYear:ec.user.nowTimestamp.format('yyyy'),                     title:'We\'ve missed you...']"/><iterate list="inactiveOwnerIdList" entry="inactiveOwnerId"><service-call name="coarchy.NotificationServices.send#MonthlyNotificationEmail" in-map="[emailTemplateId:'CHURN_RESUBSCRIBE', partyId:inactiveOwnerId, bodyParameters:bodyParameters, currentTimestamp:currentTimestamp]" out-map="[sentEmail:context.sentEmail,emailTemplateId:context.emailTemplateId,emailMessageId:context.emailMessageId]"/><if condition="sentEmail"><script><![CDATA[emailsSentList.add(emailMessageId)]]></script></if></iterate></actions></service>