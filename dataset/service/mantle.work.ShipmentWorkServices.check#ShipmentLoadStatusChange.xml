<!--Service Location mantle.work.ShipmentWorkServices.check#ShipmentLoadStatusChange--><service verb="check" noun="ShipmentLoadStatusChange"><in-parameters><parameter name="workEffortId" required="true"/><parameter name="statusId" required="true"/></in-parameters><out-parameters/><actions><if condition="!(statusId in ['WeComplete', 'WeClosed', 'WeCancelled'])"><return/></if><entity-find-one entity-name="mantle.work.effort.WorkEffort" value-field="workEffort"/><if condition="workEffort?.purposeEnumId != 'WepShipmentShip'"><return/></if><entity-find entity-name="mantle.shipment.Shipment" list="shipmentStatusList" distinct="true"><econdition field-name="shipWorkEffortId" from="workEffortId"/><select-field field-name="statusId"/></entity-find><if condition="shipmentStatusList.size() == 0"><return/></if><set field="shipmentStatusIdSet" from="new HashSet(shipmentStatusList*.statusId)"/><set field="badStatusIdList" from="[]"/><entity-find-one entity-name="moqui.basic.StatusItem" value-field="workEffortStatus"/><if condition="shipmentStatusIdSet.contains('ShipInput')"><script><![CDATA[badStatusIdList.add('ShipInput')]]></script></if><if condition="shipmentStatusIdSet.contains('ShipScheduled')"><script><![CDATA[badStatusIdList.add('ShipScheduled')]]></script></if><if condition="statusId in ['WeClosed', 'WeCancelled']"><if condition="shipmentStatusIdSet.contains('ShipPicked')"><script><![CDATA[badStatusIdList.add('ShipPicked')]]></script></if><if condition="shipmentStatusIdSet.contains('ShipPacked')"><script><![CDATA[badStatusIdList.add('ShipPacked')]]></script></if></if><if condition="statusId == 'WeCancelled'"><if condition="shipmentStatusIdSet.contains('ShipShipped')"><script><![CDATA[badStatusIdList.add('ShipShipped')]]></script></if><if condition="shipmentStatusIdSet.contains('ShipDelivered')"><script><![CDATA[badStatusIdList.add('ShipDelivered')]]></script></if><if condition="shipmentStatusIdSet.contains('ShipRejected')"><script><![CDATA[badStatusIdList.add('ShipRejected')]]></script></if></if><if condition="badStatusIdList"><set field="statusListSb" from="new StringBuilder()"/><iterate list="badStatusIdList" entry="badStatusId"><entity-find-one entity-name="moqui.basic.StatusItem" value-field="badStatus"><field-map field-name="statusId" from="badStatusId"/></entity-find-one><script><![CDATA[if (statusListSb) statusListSb.append(", "); statusListSb.append(badStatus?.description ?: badStatusId)]]></script></iterate><message error="true"><![CDATA[Status change to ${workEffortStatus?.description ?: statusId} not allowed, picklist ${workEffortId} has Shipments in statuses ${statusListSb.toString()}]]></message></if></actions></service>