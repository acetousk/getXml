<!--Service Location mantle.account.PaymentServices.create#RefundPayment--><service verb="create" noun="RefundPayment"><in-parameters><parameter name="paymentId" required="true"><description><![CDATA[The ID of the original Payment]]></description></parameter><parameter name="paymentTypeEnumId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.payment.Payment" field-name="paymentTypeEnumId" default-value="PtRefund"/><parameter name="paymentInstrumentEnumId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.payment.Payment" field-name="paymentInstrumentEnumId"/><parameter name="paymentMethodId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.payment.Payment" field-name="paymentMethodId"/><parameter name="toPaymentMethodId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.payment.Payment" field-name="toPaymentMethodId"/><parameter name="paymentGatewayConfigId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.payment.Payment" field-name="paymentGatewayConfigId"/><parameter name="orderId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.payment.Payment" field-name="orderId"/><parameter name="orderPartSeqId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.payment.Payment" field-name="orderPartSeqId"/><parameter name="orderItemSeqId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.payment.Payment" field-name="orderItemSeqId"/><parameter name="statusId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.payment.Payment" field-name="statusId" default-value="PmntPromised"/><parameter name="effectiveDate" type="Timestamp" required="false" allow-html="none" entity-name="mantle.account.payment.Payment" field-name="effectiveDate"><description><![CDATA[Only set if specified, set to now if statusId is PmntDelivered as must be set before delivered status]]></description></parameter><parameter name="settlementDate" type="java.sql.Timestamp" required="false" allow-html="none" entity-name="mantle.account.payment.Payment" field-name="settlementDate"/><parameter name="dueDate" type="java.sql.Timestamp" required="false" allow-html="none" entity-name="mantle.account.payment.Payment" field-name="dueDate"/><parameter name="paymentAuthCode" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.payment.Payment" field-name="paymentAuthCode"/><parameter name="paymentRefNum" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.payment.Payment" field-name="paymentRefNum"/><parameter name="comments" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.payment.Payment" field-name="comments"/><parameter name="memo" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.payment.Payment" field-name="memo"/><parameter name="distGroupEnumId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.payment.Payment" field-name="distGroupEnumId"/><parameter name="amount" type="BigDecimal" required="false" allow-html="none" entity-name="mantle.account.payment.Payment" field-name="amount"><description><![CDATA[Defaults to the unapplied amount of the original Payment, cannot be greater than unapplied amount]]></description></parameter><parameter name="amountUomId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.payment.Payment" field-name="amountUomId"/><parameter name="appliedTotal" type="java.math.BigDecimal" required="false" allow-html="none" entity-name="mantle.account.payment.Payment" field-name="appliedTotal"/><parameter name="unappliedTotal" type="java.math.BigDecimal" required="false" allow-html="none" entity-name="mantle.account.payment.Payment" field-name="unappliedTotal"/><parameter name="refundForPaymentId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.payment.Payment" field-name="refundForPaymentId"/><parameter name="finAccountId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.payment.Payment" field-name="finAccountId"/><parameter name="finAccountAuthId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.payment.Payment" field-name="finAccountAuthId"/><parameter name="finAccountTransId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.payment.Payment" field-name="finAccountTransId"/><parameter name="overrideGlAccountId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.payment.Payment" field-name="overrideGlAccountId"/><parameter name="overrideOrgPartyId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.payment.Payment" field-name="overrideOrgPartyId"/><parameter name="partyRelationshipId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.payment.Payment" field-name="partyRelationshipId"/><parameter name="timePeriodId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.payment.Payment" field-name="timePeriodId"/><parameter name="originalCurrencyAmount" type="java.math.BigDecimal" required="false" allow-html="none" entity-name="mantle.account.payment.Payment" field-name="originalCurrencyAmount"/><parameter name="originalCurrencyUomId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.payment.Payment" field-name="originalCurrencyUomId"/><parameter name="presentFlag" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.payment.Payment" field-name="presentFlag"/><parameter name="swipedFlag" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.payment.Payment" field-name="swipedFlag"/><parameter name="processAttempt" type="java.lang.Long" required="false" allow-html="none" entity-name="mantle.account.payment.Payment" field-name="processAttempt"/><parameter name="needsNsfRetry" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.payment.Payment" field-name="needsNsfRetry"/><parameter name="visitId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.payment.Payment" field-name="visitId"/><parameter name="lastUpdatedStamp" type="java.sql.Timestamp" required="false" allow-html="none" entity-name="mantle.account.payment.Payment" field-name="lastUpdatedStamp"/></in-parameters><out-parameters><parameter name="paymentId"><description><![CDATA[The ID of the refund Payment]]></description></parameter><parameter name="paymentApplicationId"><description><![CDATA[The ID of the application of the refund Payment to the original]]></description></parameter><parameter name="amount" type="BigDecimal"/></out-parameters><actions><set field="refundForPaymentId" from="paymentId"/><entity-find-one entity-name="mantle.account.payment.Payment" value-field="refundForPayment" for-update="true"><field-map field-name="paymentId" from="refundForPaymentId"/></entity-find-one><if condition="!(refundForPayment.statusId in ['PmntDelivered', 'PmntConfirmed'])"><return message="Payment must be in Delivered or Confirmed status"/></if><service-call name="mantle.account.PaymentServices.get#PaymentTotals" in-map="[paymentId:refundForPaymentId]" out-map="[paymentTotal:refundForTotalOut.paymentTotal,appliedTotal:refundForTotalOut.appliedTotal,unappliedTotal:refundForTotalOut.unappliedTotal]"/><if condition="!amount"><set field="amount" from="refundForTotalOut.unappliedTotal"/></if><if condition="!amount"><return message="Amount is zero, not creating refund payment"/></if><if condition="statusId in ['PmntDelivered', 'PmntConfirmed'] && effectiveDate == null"><set field="effectiveDate" from="ec.user.nowTimestamp"/></if><set field="fromPartyId" from="refundForPayment.toPartyId"/><set field="toPartyId" from="refundForPayment.fromPartyId"/><set field="orderId" from="orderId ?: refundForPayment.orderId"/><set field="orderPartSeqId" from="orderPartSeqId ?: refundForPayment.orderPartSeqId"/><set field="paymentInstrumentEnumId" from="paymentInstrumentEnumId ?: refundForPayment.paymentInstrumentEnumId"/><set field="paymentId" from="null"/><service-call name="mantle.account.PaymentServices.create#Payment" in-map="context" out-map="[paymentId:createOut.paymentId]"/><set field="paymentId" from="createOut.paymentId"/><if condition="statusId in ['PmntDelivered', 'PmntConfirmed']"><set field="amountToApply" from="amount"/><if condition="amountToApply > refundForTotalOut.unappliedTotal"><set field="amountToApply" from="refundForTotalOut.unappliedTotal"/></if><service-call name="mantle.account.PaymentServices.apply#PaymentToPayment" out-map="[paymentApplicationId:context.paymentApplicationId,amountApplied:context.amountApplied]" in-map="[paymentId:paymentId, toPaymentId:refundForPaymentId, amount:amountToApply]"/></if></actions></service>