<!--Service Location mantle.product.AssetServices.reserve#AssetsForOrder--><service verb="reserve" noun="AssetsForOrder"><in-parameters><parameter name="orderId" required="true"/><parameter name="forceReserve" type="Boolean" default="false"><description><![CDATA[Ignore validations on ProductStore.reservationAutoEnumId, presence of productStoreId or vendorPartyId in OrgInternal role]]></description></parameter></in-parameters><out-parameters/><actions><entity-find-one entity-name="mantle.order.OrderHeader" value-field="orderHeader"/><set field="productStore" from="orderHeader.'mantle.product.store.ProductStore'"/><if condition="!forceReserve"><if condition="productStore == null"><then><set field="orderParts" from="orderHeader.parts"/><iterate list="orderParts" entry="orderPart"><entity-find-one entity-name="mantle.party.PartyRole" value-field="orgPartyRole" cache="true"><field-map field-name="partyId" from="orderPart.vendorPartyId"/><field-map field-name="roleTypeId" value="OrgInternal"/></entity-find-one><if condition="orgPartyRole == null"><return/></if></iterate></then><else><if condition="productStore.reservationOrderEnumId == 'AsResOrdNoRes'"><return/></if></else></if></if><entity-find entity-name="mantle.order.OrderPart" list="orderPartList"><econdition field-name="orderId"/><order-by field-name="orderPartSeqId"/></entity-find><iterate list="orderPartList" entry="orderPart"><set field="reservationAutoEnumId" from="orderPart.reservationAutoEnumId ?: productStore?.reservationAutoEnumId ?: 'AsResAutoPlaced'"/><if condition="!forceReserve && reservationAutoEnumId == 'AsResAutoNone'"><continue/></if><if condition="!forceReserve && reservationAutoEnumId == 'AsResAutoApproved'"><then><set field="resStatusList" from="['OrderApproved', 'OrderSent']"/></then><else><set field="resStatusList" from="['OrderPlaced', 'OrderProcessing', 'OrderApproved', 'OrderSent', 'OrderHold']"/></else></if><if condition="!(orderHeader.statusId in resStatusList) || !(orderPart.statusId in resStatusList)"><continue/></if><entity-find entity-name="mantle.order.OrderItem" list="orderItemList"><econdition field-name="orderId"/><econdition field-name="orderPartSeqId" from="orderPart.orderPartSeqId"/><econdition field-name="productId" operator="is-not-null"/><order-by field-name="productId"/></entity-find><iterate list="orderItemList" entry="orderItem"><service-call name="mantle.product.AssetServices.reserve#AssetForOrderItem" in-map="[orderId:orderId, orderItemSeqId:orderItem.orderItemSeqId, productStore:productStore, forceReserve:forceReserve]"/></iterate></iterate></actions></service>