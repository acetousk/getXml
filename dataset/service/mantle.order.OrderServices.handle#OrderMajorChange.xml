<!--Service Location mantle.order.OrderServices.handle#OrderMajorChange--><service verb="handle" noun="OrderMajorChange"><in-parameters><parameter name="orderId" required="true"/><parameter name="orderPartSeqId" required="true"/><parameter name="orderHeader" type="EntityValue"/></in-parameters><out-parameters/><actions><set field="sharedFlagKey" from="'OrderMajorChange' + orderId + orderPartSeqId"/><if condition="ec.context.getSharedMap().get(sharedFlagKey)"><return/></if><if condition="orderHeader == null"><entity-find-one entity-name="mantle.order.OrderHeader" value-field="orderHeader" for-update="true"/></if><if condition="orderHeader.productStoreId"><entity-find-one entity-name="mantle.order.OrderPart" value-field="orderPart" for-update="true"/><set field="noRecalcStatuses" from="['OrderApproved', 'OrderSent', 'OrderCompleted', 'OrderRejected', 'OrderCancelled']"/><if condition="orderHeader.statusId in noRecalcStatuses"><return type="warning" message="Not updating promotions, shipping, or tax for order ${orderId} in status ${orderHeader.status?.description}"/></if><if condition="orderPart.statusId in noRecalcStatuses"><return type="warning" message="Not updating promotions, shipping, or tax for order part ${orderId}:${orderPartSeqId} in status ${orderPart.status?.description}"/></if><entity-find-count entity-name="mantle.order.OrderItemBillingDetail" count-field="partBillingCount"><econdition field-name="orderId"/><econdition field-name="orderPartSeqId"/></entity-find-count><if condition="partBillingCount"><return type="warning" message="Not updating promotions, shipping, or tax for order part ${orderId}:${orderPartSeqId} with ${partBillingCount} OrderItemBilling records"/></if><script><![CDATA[ec.context.getSharedMap().put(sharedFlagKey, true)]]></script><if condition="!'Y'.equals(orderPart.disablePromotions)"><entity-find entity-name="mantle.order.OrderItem" list="promoItemList"><econdition field-name="orderId"/><econdition field-name="orderPartSeqId"/><econdition field-name="isPromo" value="Y"/></entity-find><iterate list="promoItemList" entry="promoItem"><service-call name="mantle.order.OrderServices.delete#OrderItem" in-map="[orderId:promoItem.orderId, orderItemSeqId:promoItem.orderItemSeqId]"/></iterate><service-call name="mantle.product.PromotionServices.apply#OrderPromotions" in-map="[orderId:orderId, orderPartSeqId:orderPartSeqId, orderHeader:orderHeader]"/></if><set field="doShipCalc" from="true"/><if condition="'ShMthGround'.equals(orderPart.shipmentMethodEnumId)"><entity-find entity-name="mantle.order.OrderItem" list="shipPromoItemList" distinct="true"><econdition field-name="orderId"/><econdition field-name="orderPartSeqId"/><econdition field-name="isPromo" value="Y"/><econdition field-name="storePromotionId" operator="is-not-null"/><select-field field-name="storePromotionId"/></entity-find><iterate list="shipPromoItemList" entry="shipPromoItem"><entity-find-one entity-name="mantle.product.store.ProductStorePromotion" value-field="storePromotion" cache="true"><field-map field-name="storePromotionId" from="shipPromoItem.storePromotionId"/></entity-find-one><if condition="'Y'.equals(storePromotion?.freeGroundShipping)"><set field="doShipCalc" from="false"/><break/></if></iterate></if><if condition="!'Y'.equals(orderPart.disableShippingCalc)"><entity-find entity-name="mantle.order.OrderItem" list="shippingItemList"><econdition field-name="orderId"/><econdition field-name="orderPartSeqId"/><econdition field-name="itemTypeEnumId" value="ItemShipping"/></entity-find><iterate list="shippingItemList" entry="shippingItem"><service-call name="mantle.order.OrderServices.delete#OrderItem" in-map="[orderId:shippingItem.orderId, orderItemSeqId:shippingItem.orderItemSeqId]"/></iterate><if condition="doShipCalc"><service-call name="mantle.shipment.CarrierServices.calculate#OrderPartShipping" in-map="[orderId:orderId, orderPartSeqId:orderPartSeqId, createOrderItem:true]"/></if></if><if condition="!'Y'.equals(orderPart.disableTaxCalc)"><entity-find entity-name="mantle.order.OrderItem" list="taxItemList"><econdition field-name="orderId"/><econdition field-name="orderPartSeqId"/><econdition field-name="itemTypeEnumId" operator="in" value="ItemSalesTax,ItemVatTax"/></entity-find><iterate list="taxItemList" entry="taxItem"><service-call name="mantle.order.OrderServices.delete#OrderItem" in-map="[orderId:taxItem.orderId, orderItemSeqId:taxItem.orderItemSeqId]"/></iterate><service-call name="mantle.other.TaxServices.calculate#OrderSalesTax" in-map="[orderId:orderId, orderPartSeqId:orderPartSeqId]"/></if><script><![CDATA[ec.context.getSharedMap().remove(sharedFlagKey)]]></script><service-call name="mantle.order.OrderServices.increment#OrderRevision" in-map="context"/></if></actions></service>