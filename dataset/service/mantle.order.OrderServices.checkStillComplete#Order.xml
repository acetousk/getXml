<!--Service Location mantle.order.OrderServices.checkStillComplete#Order--><service verb="checkStillComplete" noun="Order"><in-parameters><parameter name="orderId"/></in-parameters><out-parameters><parameter name="oldStatusId"/><parameter name="statusChanged" type="Boolean"/></out-parameters><actions><entity-find-one entity-name="mantle.order.OrderHeader" value-field="orderHeader"/><if condition="orderHeader == null"><return error="true" message="Order ${orderId} not found"/></if><if condition="orderHeader.statusId != 'OrderCompleted'"><return/></if><set field="statusChanged" from="false"/><set field="allPartsComplete" from="true"/><entity-find entity-name="mantle.order.OrderPart" list="orderPartList"><econdition field-name="orderId"/></entity-find><iterate list="orderPartList" entry="orderPart"><if condition="orderPart.statusId != 'OrderCompleted'"><set field="allPartsComplete" from="false"/><continue/></if><service-call name="mantle.order.OrderServices.isFulfilled#OrderPart" out-map="[isFulfilled:isFulfilledOut.isFulfilled]" in-map="[orderId:orderId, orderPartSeqId:orderPart.orderPartSeqId]"/><if condition="!isFulfilledOut.isFulfilled"><service-call name="update#mantle.order.OrderPart" in-map="[orderId:orderId, orderPartSeqId:orderPart.orderPartSeqId, statusId:'OrderApproved']"/><set field="allPartsComplete" from="false"/></if></iterate><if condition="!allPartsComplete"><service-call name="update#mantle.order.OrderHeader" out-map="[orderId:context.orderId,orderName:context.orderName,entryDate:context.entryDate,placedDate:context.placedDate,approvedDate:context.approvedDate,completedDate:context.completedDate,statusId:context.statusId,processingStatusId:context.processingStatusId,orderRevision:context.orderRevision,currencyUomId:context.currencyUomId,billingAccountId:context.billingAccountId,productStoreId:context.productStoreId,salesChannelEnumId:context.salesChannelEnumId,terminalId:context.terminalId,displayId:context.displayId,externalId:context.externalId,externalRevision:context.externalRevision,originId:context.originId,originUrl:context.originUrl,syncStatusId:context.syncStatusId,systemMessageRemoteId:context.systemMessageRemoteId,visitId:context.visitId,enteredByPartyId:context.enteredByPartyId,parentOrderId:context.parentOrderId,recurCronExpression:context.recurCronExpression,lastOrderedDate:context.lastOrderedDate,recurAutoInvoice:context.recurAutoInvoice,remainingSubTotal:context.remainingSubTotal,grandTotal:context.grandTotal,lastUpdatedStamp:context.lastUpdatedStamp]" in-map="[orderId:orderId, statusId:'OrderApproved']"/></if></actions></service>