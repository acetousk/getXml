<!--Service Location mantle.product.PromotionServices.apply#NewCustomerDiscount--><service verb="apply" noun="NewCustomerDiscount"><in-parameters><parameter name="orderId" required="true"/><parameter name="orderPartSeqId" required="true"/><parameter name="storePromotionId" required="true"/><parameter name="promoCodeId"/><parameter name="useLimit" type="BigDecimal"/><parameter name="itemDescription"/><parameter name="discountPercent" type="BigDecimal" required="true"><description><![CDATA[Required. Discount percent for new customers as a plain number like 10 or 25.]]></description></parameter><parameter name="itemsWithPromo" type="Boolean" default="false"><description><![CDATA[If true apply to product item quantities that already have another promotion (defaults to false)]]></description></parameter><parameter name="includeNonConsumer" type="Boolean" default="false"><description><![CDATA[If true apply when customer has a customer classification other than Consumer (defaults to false)]]></description></parameter><parameter name="requireAccountForWeb" type="Boolean" default="true"><description><![CDATA[If true (default) for Web orders only apply if the customer has a User Account]]></description></parameter></in-parameters><out-parameters/><actions><entity-find-one entity-name="mantle.order.OrderHeader" value-field="orderHeader"/><entity-find-one entity-name="mantle.order.OrderPart" value-field="orderPart"/><set field="customerPartyId" from="orderPart?.customerPartyId"/><if condition="!customerPartyId"><return/></if><if condition="requireAccountForWeb && orderHeader?.salesChannelEnumId == 'ScWeb'"><entity-find entity-name="moqui.security.UserAccount" list="userAccounts"><econdition field-name="partyId" from="customerPartyId"/><select-field field-name="userId"/></entity-find><if condition="!userAccounts"><return/></if></if><if condition="!includeNonConsumer"><entity-find entity-name="mantle.party.PartyClassificationAndAppl" list="classApplList"><date-filter/><econdition field-name="partyId" from="customerPartyId"/><econdition field-name="classificationTypeEnumId" value="PcltCustomer"/></entity-find><iterate list="classApplList" entry="classAppl"><if condition="classAppl.partyClassificationId != 'CustConsumer'"><return/></if></iterate></if><if condition="orderPart.isNewCustomer != 'Y'"><set field="includeStatuses" from="['OrderPlaced', 'OrderProcessing', 'OrderApproved', 'OrderSent', 'OrderCompleted', 'OrderHold']"/><entity-find-count entity-name="mantle.order.OrderHeaderAndPart" count-field="ordersCount"><econdition field-name="customerPartyId"/><econdition field-name="orderId" operator="not-equals"/><econdition field-name="statusId" operator="in" from="includeStatuses"/><econdition field-name="partStatusId" operator="in" from="includeStatuses" or-null="true"/></entity-find-count><if condition="ordersCount"><return/></if></if><entity-find-one entity-name="mantle.product.store.ProductStorePromoCode" value-field="storePromoCode"/><set field="useLimitRemaining" from="useLimit ?: 1000.0"/><entity-find entity-name="mantle.order.OrderItem" list="prodItemList"><econdition field-name="orderId"/><econdition field-name="orderPartSeqId"/><econdition field-name="itemTypeEnumId" value="ItemProduct"/></entity-find><iterate list="prodItemList" entry="orderItem"><service-call name="mantle.order.OrderServices.get#OrderItemTotal" out-map-add-to-existing="false" in-map="[orderItem:orderItem, getChildrenTotals:true]" out-map="[combinedAmount:orderItemTotalOut.combinedAmount,combinedQuantity:orderItemTotalOut.combinedQuantity,itemTotal:orderItemTotalOut.itemTotal,childrenTotal:orderItemTotalOut.childrenTotal,itemPlusChildrenTotal:orderItemTotalOut.itemPlusChildrenTotal,childItemCount:orderItemTotalOut.childItemCount,hasPromo:orderItemTotalOut.hasPromo,promoQuantityUsed:orderItemTotalOut.promoQuantityUsed,childOrderItemList:orderItemTotalOut.childOrderItemList]"/><if condition="!orderItemTotalOut.combinedAmount"><continue/></if><if condition="itemsWithPromo"><then><set field="promoQuantity" from="orderItem.quantity"/></then><else><set field="promoQuantity" from="orderItem.quantity - orderItemTotalOut.promoQuantityUsed"/></else></if><if condition="promoQuantity > useLimitRemaining"><set field="promoQuantity" from="useLimitRemaining"/></if><if condition="promoQuantity <= 0.0"><continue/></if><set field="useLimitRemaining" from="useLimitRemaining - promoQuantity"/><set field="discountAmount" from="-(orderItemTotalOut.combinedAmount * (discountPercent/100.0)).setScale(2, BigDecimal.ROUND_HALF_UP)"/><service-call name="create#mantle.order.OrderItem" out-map="[orderId:createItemOut.orderId,orderItemSeqId:createItemOut.orderItemSeqId,orderPartSeqId:createItemOut.orderPartSeqId,parentItemSeqId:createItemOut.parentItemSeqId,itemTypeEnumId:createItemOut.itemTypeEnumId,productId:createItemOut.productId,productFeatureId:createItemOut.productFeatureId,otherPartyProductId:createItemOut.otherPartyProductId,productParameterSetId:createItemOut.productParameterSetId,itemDescription:createItemOut.itemDescription,comments:createItemOut.comments,quantity:createItemOut.quantity,quantityUomId:createItemOut.quantityUomId,quantityCancelled:createItemOut.quantityCancelled,selectedAmount:createItemOut.selectedAmount,priority:createItemOut.priority,requiredByDate:createItemOut.requiredByDate,unitAmount:createItemOut.unitAmount,unitListPrice:createItemOut.unitListPrice,isModifiedPrice:createItemOut.isModifiedPrice,standardCost:createItemOut.standardCost,externalItemSeqId:createItemOut.externalItemSeqId,fromAssetId:createItemOut.fromAssetId,productPriceId:createItemOut.productPriceId,productCategoryId:createItemOut.productCategoryId,isPromo:createItemOut.isPromo,promoQuantity:createItemOut.promoQuantity,promoTimesUsed:createItemOut.promoTimesUsed,storePromotionId:createItemOut.storePromotionId,promoCodeId:createItemOut.promoCodeId,promoCodeText:createItemOut.promoCodeText,subscriptionId:createItemOut.subscriptionId,finAccountId:createItemOut.finAccountId,finAccountTransId:createItemOut.finAccountTransId,overrideGlAccountId:createItemOut.overrideGlAccountId,salesOpportunityId:createItemOut.salesOpportunityId,sourceReferenceId:createItemOut.sourceReferenceId,sourcePercentage:createItemOut.sourcePercentage,amountAlreadyIncluded:createItemOut.amountAlreadyIncluded,exemptAmount:createItemOut.exemptAmount,customerReferenceId:createItemOut.customerReferenceId,taxAuthorityId:createItemOut.taxAuthorityId,lastUpdatedStamp:createItemOut.lastUpdatedStamp]" in-map="[orderId:orderId, orderPartSeqId:orderPartSeqId, parentItemSeqId:orderItem.orderItemSeqId,                                  itemTypeEnumId:'ItemDiscount', quantity:promoQuantity, unitAmount:discountAmount, productId:orderItem.productId,                                  sourcePercentage:discountPercent, storePromotionId:storePromotionId,                                  promoCodeId:promoCodeId, promoCodeText:storePromoCode?.promoCode,                                  isPromo:'Y', promoQuantity:promoQuantity, promoTimesUsed:promoQuantity,                                  itemDescription:ec.resource.expand(itemDescription, '')?:'New Customer Discount']"/></iterate></actions></service>