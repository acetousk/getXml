<!--Service Location mantle.order.OrderServices.autoApprove#Order--><service verb="autoApprove" noun="Order"><in-parameters><parameter name="orderId" required="true"/></in-parameters><out-parameters/><actions><entity-find-one entity-name="mantle.order.OrderHeader" value-field="orderHeader"/><if condition="orderHeader == null"><return error="true" message="Order ${orderId} not found"/></if><if condition="orderHeader.statusId != 'OrderPlaced'"><return/></if><entity-find entity-name="mantle.account.payment.Payment" list="paymentList"><econdition field-name="orderId"/><econdition field-name="statusId" operator="in" from="['PmntAuthorized', 'PmntDelivered', 'PmntConfirmed']"/></entity-find><set field="totalAuthorized" from="0.0"/><iterate list="paymentList" entry="payment"><set field="totalAuthorized" from="totalAuthorized + (payment.amount ?: 0.0)"/></iterate><if condition="totalAuthorized >= orderHeader.grandTotal"><service-call name="mantle.order.OrderInfoServices.check#OrderPreApprove" in-map="[orderId:orderId]" out-map="[approveWarnings:checkOut.approveWarnings]"/><entity-find entity-name="moqui.entity.EntityAuditLog" list="statusHistoryList"><econdition field-name="changedEntityName" value="mantle.order.OrderHeader"/><econdition field-name="changedFieldName" value="statusId"/><econdition field-name="pkPrimaryValue" from="orderId"/><econdition field-name="newValueText" value="OrderApproved"/><select-field field-name="auditHistorySeqId"/></entity-find><if condition="!checkOut.approveWarnings && !statusHistoryList"><then><service-call name="mantle.order.OrderServices.update#OrderStatus" in-map="[orderId:orderId, statusId:'OrderApproved', approvedDate:ec.user.nowTimestamp]"/></then><else><log message="Not auto-approving Order ${orderId} status history: ${statusHistoryList*.auditHistorySeqId}, warnings: ${checkOut.approveWarnings}"/></else></if></if></actions></service>