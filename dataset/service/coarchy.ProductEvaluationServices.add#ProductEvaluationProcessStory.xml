<!--Service Location coarchy.ProductEvaluationServices.add#ProductEvaluationProcessStory--><service verb="add" noun="ProductEvaluationProcessStory"><in-parameters><parameter name="productEvaluationId" required="true"/><parameter name="organizationId" required="true"/><parameter name="processStoryIds" type="List" required="true"/></in-parameters><out-parameters/><actions><entity-find-one entity-name="coarchy.product.ProductEvaluation" value-field="productEvaluation"/><if condition="productEvaluation.statusId != 'PeRequirementsSelection'"><return error="true" message="Cannot edit activities in this status."/></if><set field="newProcessStoryIds" from="new TreeSet()"/><iterate list="processStoryIds" entry="processStoryId"><entity-find-count entity-name="coarchy.product.ProductEvaluationStory" count-field="productEvaluationStoryCount"><econdition field-name="productEvaluationId"/><econdition field-name="processStoryId"/><econdition field-name="organizationId"/></entity-find-count><if condition="!productEvaluationStoryCount"><service-call name="create#coarchy.product.ProductEvaluationStory" in-map="[productEvaluationId:productEvaluationId, processStoryId:processStoryId, organizationId:organizationId]"/><service-call name="coarchy.ProductEvaluationServices.get#ProcessStoryDescendants" out-map="[descendantIdList:descOut.descendantIdList]" out-map-add-to-existing="false" in-map="[processStoryId:processStoryId]"/><script><![CDATA[newProcessStoryIds.add(processStoryId)]]></script><script><![CDATA[newProcessStoryIds.addAll(descOut.descendantIdList)]]></script></if></iterate><entity-find entity-name="coarchy.ProcessStoryActivityDetail" list="processStoryActivityList"><date-filter/><econdition field-name="replacedByActivityId" operator="is-null"/><econdition field-name="processStoryId" operator="in" from="newProcessStoryIds"/><econditions combine="or"><econdition field-name="condition" operator="not-equals" value=""/><econdition field-name="action" operator="not-equals" value=""/></econditions><select-field field-name="processStoryId,activityId,condition,action"/></entity-find><iterate list="processStoryActivityList" entry="processStoryActivity"><entity-find-count entity-name="coarchy.product.ProductEvaluationActivity" count-field="existingCount"><econdition field-name="productEvaluationId"/><econdition field-name="organizationId"/><econdition field-name="processStoryId" from="processStoryActivity.processStoryId"/><econdition field-name="activityId" from="processStoryActivity.activityId"/></entity-find-count><if condition="existingCount"><continue/></if><service-call name="create#coarchy.product.ProductEvaluationActivity" in-map="[productEvaluationId:productEvaluationId, processStoryId:processStoryActivity.processStoryId, activityId:processStoryActivity.activityId, organizationId:organizationId]"/></iterate></actions></service>