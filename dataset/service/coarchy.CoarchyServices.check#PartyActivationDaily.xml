<!--Service Location coarchy.CoarchyServices.check#PartyActivationDaily--><service verb="check" noun="PartyActivationDaily"><in-parameters><parameter name="finAccountTypeId" required="true" default-value="OrganizationMonthCredit"/><parameter name="currentTimestamp" default="ec.user.nowTimestamp" type="Timestamp" required="true"/></in-parameters><out-parameters><parameter name="organizationChangeList" type="List"/><parameter name="ownerChangeList" type="List"/><parameter name="periodFromDate" type="Timestamp"/><parameter name="periodThruDate" type="Timestamp"/><parameter name="activationThruDate" type="Timestamp"/></out-parameters><actions><set field="activationThruDate" from="new Timestamp(ZonedDateTime.ofInstant(Instant.ofEpochMilli(                 (long) currentTimestamp.time), ZoneId.systemDefault()).plusDays(1).toInstant().toEpochMilli())"/><set field="periodFromDate" from="new Timestamp(ZonedDateTime.ofInstant(Instant.ofEpochMilli(                 (long) currentTimestamp.time), ZoneId.systemDefault()).withDayOfMonth(1).toInstant().toEpochMilli())"/><set field="periodThruDate" from="new Timestamp(ZonedDateTime.ofInstant(Instant.ofEpochMilli(                 (long) currentTimestamp.time), ZoneId.systemDefault()).plusMonths(1).withDayOfMonth(1).toInstant().toEpochMilli())"/><entity-find entity-name="mantle.account.financial.FinancialAccount" list="financialAccountList" distinct="true"><econdition field-name="finAccountTypeId"/><econdition field-name="statusId" value="FaActive"/><date-filter valid-date="currentTimestamp"/><select-field field-name="ownerPartyId,finAccountId,availableBalance"/></entity-find><set field="financialAccountList" from="financialAccountList.groupBy{it.ownerPartyId}.collect{it.value.max{it.availableBalance}}"/><set field="organizationChangeList" from="[]"/><set field="ownerChangeList" from="[]"/><iterate list="financialAccountList" entry="financialAccount"><set field="totalCreditsUsed" from="0.0" type="BigDecimal"/><entity-find entity-name="mantle.party.Party" list="organizationList"><econdition field-name="partyTypeEnumId" value="PtyOrganization"/><econdition field-name="disabled" value="N" or-null="true"/><econdition field-name="ownerPartyId" from="financialAccount.ownerPartyId"/></entity-find><if condition="organizationList.size() == 0"><log level="warn" message="No organization found with financial account for ${financialAccount.ownerPartyId}"/><continue/></if><iterate list="organizationList" entry="organization"><service-call name="coarchy.CoarchyServices.calculate#PartyActivationUsage" in-map="[organizationPartyId:                         organization.partyId, periodFromDate:periodFromDate, periodThruDate:periodThruDate,                         activationThruDate:activationThruDate]" out-map="[activationPeriodCount:context.activationPeriodCount,dayAmountList:context.dayAmountList,dayCount:context.dayCount,totalDays:context.totalDays]"/><set field="organizationChangeList" from="organizationChangeList + [organizationId:organization.partyId,activationPeriodCount:activationPeriodCount,deactivated:'N']"/><set field="totalCreditsUsed" from="totalCreditsUsed + activationPeriodCount" type="BigDecimal"/></iterate><set field="ownerChangeList" from="ownerChangeList + [ownerPartyId:financialAccount.ownerPartyId,totalCreditsUsed:totalCreditsUsed,availableBalance:financialAccount.availableBalance]"/><if condition="totalCreditsUsed > 0.0 && totalCreditsUsed > financialAccount.availableBalance"><log message="${financialAccount.ownerPartyId} used ${totalCreditsUsed} / ${financialAccount.availableBalance} credits this month for organizations ${organizationList*.partyId}. Deactivating all of the organizations."/><iterate list="organizationList" entry="organization"><entity-find entity-name="mantle.party.PartyActivation" list="partyActivationList" limit="1" for-update="true"><econdition field-name="partyId" from="organization.partyId"/><date-filter valid-date="currentTimestamp"/><order-by field-name="-fromDate"/></entity-find><if condition="partyActivationList.size() == 0"><continue/></if><set field="organizationChangeList.find{it.organizationId == organization.partyId}.deactivated" value="Y"/><set field="partyActivationList.getFirst().thruDate" from="currentTimestamp"/><entity-update value-field="partyActivationList.getFirst()"/></iterate></if></iterate></actions></service>