<!--Service Location mantle.shipment.CarrierServices.get#GeneralPackageRequiresInsurance--><service verb="get" noun="GeneralPackageRequiresInsurance"><in-parameters><parameter name="quantityByProductId" type="Map"/><parameter name="insurancePackageThreshold" type="BigDecimal"><description><![CDATA[If not specified will attempt to look up from ProductStore]]></description></parameter><parameter name="currencyUomId"><description><![CDATA[Used for cost lookup, defaults to default of PriceServices.get#ProductPriceByType]]></description></parameter><parameter name="productStoreId"/><parameter name="vendorPartyId"/></in-parameters><out-parameters><parameter name="insuranceRequired" type="Boolean"><description><![CDATA[True if any Product in package has shippingInsuranceReqd = 'Y' or packageTotalCost >= insurancePackageThreshold]]></description></parameter><parameter name="packageTotalCost" type="BigDecimal"/><parameter name="contentDescription"/></out-parameters><actions><set field="insuranceRequired" from="false"/><set field="packageTotalCost" from="0.0"/><set field="contentDescription" value=""/><iterate list="quantityByProductId" key="productId" entry="quantity"><entity-find-one entity-name="mantle.product.Product" value-field="product" cache="true"><field-map field-name="productId"/></entity-find-one><if condition="product.shippingInsuranceReqd == 'Y'"><set field="insuranceRequired" from="true"/></if><service-call name="mantle.product.PriceServices.get#ProductPriceByType" out-map="[price:costOut.price,productPriceId:costOut.productPriceId,priceUomId:costOut.priceUomId]" in-map="[productId:productId, priceTypeEnumId:'PptAverage', priceUomId:currencyUomId,                             productStoreId:productStoreId, vendorPartyId:vendorPartyId]"/><if condition="costOut.price"><then><set field="packageTotalCost" from="packageTotalCost + ((costOut.price ?: 0.0) * (quantity ?: 0.0))"/></then><else-if condition="product.shippingInsuranceReqd == 'Y'"><log level="warn" message="Product ${productId} has shippingInsuranceReqd=Y but no ${currencyUomId} Cost (ProductPrice type PptAverage)"/></else-if></if><if condition="contentDescription"><set field="contentDescription" from="contentDescription + ', '"/></if><set field="contentDescription" from="contentDescription + ec.l10n.format(quantity, null) + 'x ' + product.productName"/></iterate><if condition="!insuranceRequired"><if condition="insurancePackageThreshold == null && productStoreId"><entity-find-one entity-name="mantle.product.store.ProductStore" value-field="productStore"/><set field="insurancePackageThreshold" from="productStore?.insurancePackageThreshold"/></if><if condition="insurancePackageThreshold != null && packageTotalCost >= insurancePackageThreshold"><set field="insuranceRequired" from="true"/></if></if></actions></service>