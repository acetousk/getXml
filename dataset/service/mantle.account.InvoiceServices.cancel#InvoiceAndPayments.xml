<!--Service Location mantle.account.InvoiceServices.cancel#InvoiceAndPayments--><service verb="cancel" noun="InvoiceAndPayments"><in-parameters><parameter name="invoiceId" required="true"/></in-parameters><out-parameters/><actions><set field="paymentIdSet" from="new TreeSet()"/><entity-find entity-name="mantle.account.payment.Payment" list="paymentList"><econdition field-name="forInvoiceId" from="invoiceId"/></entity-find><if condition="paymentList"><script><![CDATA[paymentIdSet.addAll(paymentList*.paymentId)]]></script></if><entity-find entity-name="mantle.account.payment.PaymentApplication" list="paymentApplicationList"><econdition field-name="invoiceId"/></entity-find><iterate list="paymentApplicationList" entry="paymentApplication"><if condition="paymentApplication.paymentId"><script><![CDATA[paymentIdSet.add(paymentApplication.paymentId)]]></script></if></iterate><service-call name="update#mantle.account.invoice.Invoice" in-map="[invoiceId:invoiceId, statusId:'InvoiceCancelled']"/><iterate list="paymentIdSet" entry="paymentId"><entity-find-one entity-name="mantle.account.payment.Payment" value-field="payment"/><set field="targetStatusId" from="payment.statusId in ['PmntProposed', 'PmntPromised'] ? 'PmntCancelled' : 'PmntVoid'"/><service-call name="update#mantle.account.payment.Payment" in-map="[paymentId:paymentId, statusId:targetStatusId]"/></iterate></actions></service>