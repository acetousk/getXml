<!--Service Location mantle.other.BudgetServices.store#BudgetItemDetailsSubPeriods--><service verb="store" noun="BudgetItemDetailsSubPeriods"><in-parameters><parameter name="budgetId" required="true"/><parameter name="glAccountId" required="true"/><parameter name="assetId"><description><![CDATA[Must pass assetId or facilityId]]></description></parameter><parameter name="facilityId"/><parameter name="amountMain" type="BigDecimal"/><parameter name="amountPer1" type="BigDecimal"/><parameter name="amountPer2" type="BigDecimal"/><parameter name="amountPer3" type="BigDecimal"/><parameter name="amountPer4" type="BigDecimal"/><parameter name="amountPer5" type="BigDecimal"/><parameter name="amountPer6" type="BigDecimal"/><parameter name="amountPer7" type="BigDecimal"/><parameter name="amountPer8" type="BigDecimal"/><parameter name="amountPer9" type="BigDecimal"/><parameter name="amountPer10" type="BigDecimal"/><parameter name="amountPer11" type="BigDecimal"/><parameter name="amountPer12" type="BigDecimal"/></in-parameters><out-parameters/><actions><if condition="!assetId && !facilityId"><return message="Not storing budget item details, no assetId or facilityId specified"/></if><entity-find-one entity-name="mantle.other.budget.Budget" value-field="budget"/><if condition="!budget.timePeriodId || !budget.subTimePeriodTypeId"><return error="true" message="Budget must have a Time Period and a Sub-Period Type"/></if><entity-find entity-name="mantle.other.budget.BudgetItem" list="budgetItemList"><econdition field-name="budgetId"/><econdition field-name="glAccountId"/></entity-find><set field="budgetItemSeqIds" from="budgetItemList*.budgetItemSeqId"/><entity-find entity-name="mantle.other.budget.BudgetItemDetail" list="budgetItemDetailList"><econdition field-name="budgetId"/><econdition field-name="budgetItemSeqId" operator="in" from="budgetItemSeqIds"/><econdition field-name="assetId" ignore-if-empty="true"/><econdition field-name="facilityId" ignore-if-empty="true"/></entity-find><service-call name="mantle.party.TimeServices.get#DescendantPeriods" out-map="[timePeriodList:subPeriodOut.timePeriodList]" in-map="[parentPeriodId:budget.timePeriodId, timePeriodTypeId:budget.subTimePeriodTypeId, createMissing:true]"/><set field="subTimePeriodList" from="subPeriodOut.timePeriodList"/><set field="subTimePeriodIds" from="new ArrayList(subTimePeriodList*.timePeriodId)"/><set field="subAmountTotal" from="0.0"/><iterate list="subTimePeriodIds" entry="subTimePeriodId"><set field="budgetItem" from="budgetItemList.find({ it.subTimePeriodId == subTimePeriodId })"/><set field="budgetItemSeqId" from="budgetItem?.budgetItemSeqId"/><set field="amount" from="context.get('amountPer' + (subTimePeriodId_index + 1))"/><if condition="budgetItemSeqId"><then><set field="budgetItemDetail" from="budgetItemDetailList.find({ it.budgetItemSeqId == budgetItemSeqId })"/><set field="budgetItemDetailId" from="budgetItemDetail?.budgetItemDetailId"/><if condition="amount != null"><then><set field="subAmountTotal" from="subAmountTotal + amount"/><if condition="budgetItemDetail != null"><then><set field="budgetItemDetail.amount" from="amount"/><entity-update value-field="budgetItemDetail"/></then><else><service-call name="create#mantle.other.budget.BudgetItemDetail" in-map="context"/></else></if></then><else-if condition="budgetItemDetailId"><service-call name="delete#mantle.other.budget.BudgetItemDetail" in-map="context"/></else-if></if></then><else-if condition="amount != null"><service-call name="create#mantle.other.budget.BudgetItem" out-map="[budgetId:budgetItemOut.budgetId,budgetItemSeqId:budgetItemOut.budgetItemSeqId,budgetItemTypeEnumId:budgetItemOut.budgetItemTypeEnumId,itemTypeEnumId:budgetItemOut.itemTypeEnumId,glAccountId:budgetItemOut.glAccountId,amount:budgetItemOut.amount,productId:budgetItemOut.productId,quantity:budgetItemOut.quantity,quantityUomId:budgetItemOut.quantityUomId,purpose:budgetItemOut.purpose,justification:budgetItemOut.justification,subTimePeriodId:budgetItemOut.subTimePeriodId,lastUpdatedStamp:budgetItemOut.lastUpdatedStamp]" out-map-add-to-existing="false" in-map="[budgetId:budgetId, glAccountId:glAccountId, subTimePeriodId:subTimePeriodId, amount:amount]"/><set field="budgetItemSeqId" from="budgetItemOut.budgetItemSeqId"/><set field="budgetItemDetailId" from="null"/><service-call name="create#mantle.other.budget.BudgetItemDetail" in-map="context"/></else-if></if></iterate><set field="subTimePeriodId" from="null"/><set field="budgetItems" from="budgetItemList.findAll({ it.subTimePeriodId == null })"/><while condition="budgetItems.size() > 1"><set field="delBudgetItem" from="budgetItems.remove(0)"/><entity-delete value-field="delBudgetItem"/></while><set field="budgetItem" from="budgetItems ? budgetItems.get(0) : null"/><set field="budgetItemSeqId" from="budgetItem?.budgetItemSeqId"/><set field="amount" from="amountMain ?: subAmountTotal ?: null"/><if condition="budgetItemSeqId"><then><set field="budgetItemDetail" from="budgetItemDetailList.find({ it.budgetItemSeqId == budgetItemSeqId })"/><set field="budgetItemDetailId" from="budgetItemDetail?.budgetItemDetailId"/><if condition="amount != null"><then><set field="subAmountTotal" from="subAmountTotal + amount"/><if condition="budgetItemDetail != null"><then><set field="budgetItemDetail.amount" from="amount"/><entity-update value-field="budgetItemDetail"/></then><else><service-call name="create#mantle.other.budget.BudgetItemDetail" in-map="context"/></else></if></then><else-if condition="budgetItemDetailId"><service-call name="delete#mantle.other.budget.BudgetItemDetail" in-map="context"/></else-if></if></then><else-if condition="amount != null"><service-call name="create#mantle.other.budget.BudgetItem" out-map="[budgetId:budgetItemOut.budgetId,budgetItemSeqId:budgetItemOut.budgetItemSeqId,budgetItemTypeEnumId:budgetItemOut.budgetItemTypeEnumId,itemTypeEnumId:budgetItemOut.itemTypeEnumId,glAccountId:budgetItemOut.glAccountId,amount:budgetItemOut.amount,productId:budgetItemOut.productId,quantity:budgetItemOut.quantity,quantityUomId:budgetItemOut.quantityUomId,purpose:budgetItemOut.purpose,justification:budgetItemOut.justification,subTimePeriodId:budgetItemOut.subTimePeriodId,lastUpdatedStamp:budgetItemOut.lastUpdatedStamp]" out-map-add-to-existing="false" in-map="[budgetId:budgetId, glAccountId:glAccountId, subTimePeriodId:subTimePeriodId]"/><set field="budgetItemSeqId" from="budgetItemOut.budgetItemSeqId"/><set field="budgetItemDetailId" from="null"/><service-call name="create#mantle.other.budget.BudgetItemDetail" in-map="context"/></else-if></if></actions></service>