<!--Service Location mantle.order.ReturnServices.receive#ReturnItem--><service verb="receive" noun="ReturnItem"><in-parameters><parameter name="returnId" required="true" entity-name="mantle.order.return.ReturnItem" field-name="returnId"/><parameter name="returnItemSeqId" required="true" entity-name="mantle.order.return.ReturnItem" field-name="returnItemSeqId"/><parameter name="receivedQuantity" type="BigDecimal" required="true" entity-name="mantle.order.return.ReturnItem" field-name="receivedQuantity"/></in-parameters><out-parameters><parameter name="oldStatusId"/><parameter name="statusChanged" type="Boolean"/></out-parameters><actions><if condition="receivedQuantity == 0.0"><return/></if><entity-find-one entity-name="mantle.order.return.ReturnItem" value-field="returnItem" for-update="true"/><if condition="returnItem.receivedQuantity"><set field="receivedQuantity" from="receivedQuantity + returnItem.receivedQuantity"/></if><set field="curReceivedRatio" from="returnItem.returnQuantity && returnItem.returnQuantity != receivedQuantity ?                     (receivedQuantity as BigDecimal).divide(returnItem.returnQuantity, 6, BigDecimal.ROUND_HALF_UP) : 1.0"/><set field="allReceived" from="returnItem.returnQuantity == receivedQuantity"/><set field="hasResponse" from="returnItem.responseDate != null"/><service-call name="update#mantle.order.return.ReturnItem" out-map="[returnId:context.returnId,returnItemSeqId:context.returnItemSeqId,parentItemSeqId:context.parentItemSeqId,returnReasonEnumId:context.returnReasonEnumId,returnResponseEnumId:context.returnResponseEnumId,responseImmediate:context.responseImmediate,itemTypeEnumId:context.itemTypeEnumId,productId:context.productId,replacementProductId:context.replacementProductId,description:context.description,orderId:context.orderId,orderItemSeqId:context.orderItemSeqId,statusId:context.statusId,inventoryStatusId:context.inventoryStatusId,returnQuantity:context.returnQuantity,receivedQuantity:context.receivedQuantity,returnPrice:context.returnPrice,responseAmount:context.responseAmount,externalId:context.externalId,responseDate:context.responseDate,replacementOrderId:context.replacementOrderId,finAccountTransId:context.finAccountTransId,refundPaymentId:context.refundPaymentId,lastUpdatedStamp:context.lastUpdatedStamp]" in-map="[returnId:returnId, returnItemSeqId:returnItemSeqId, receivedQuantity:receivedQuantity,                         returnQuantity:(hasResponse ? returnItem.returnQuantity : receivedQuantity),                         statusId:(allReceived || !hasResponse ? 'ReturnReceived' : returnItem.statusId)]"/><entity-find entity-name="mantle.order.return.ReturnItem" list="childItemList"><econdition field-name="returnId"/><econdition field-name="parentItemSeqId" from="returnItemSeqId"/></entity-find><iterate list="childItemList" entry="childItem"><set field="childReceivedQty" from="curReceivedRatio * (childItem.returnQuantity ?: 1.0)"/><set field="childHasResponse" from="childItem.responseDate != null"/><service-call name="update#mantle.order.return.ReturnItem" out-map="[returnId:context.returnId,returnItemSeqId:context.returnItemSeqId,parentItemSeqId:context.parentItemSeqId,returnReasonEnumId:context.returnReasonEnumId,returnResponseEnumId:context.returnResponseEnumId,responseImmediate:context.responseImmediate,itemTypeEnumId:context.itemTypeEnumId,productId:context.productId,replacementProductId:context.replacementProductId,description:context.description,orderId:context.orderId,orderItemSeqId:context.orderItemSeqId,statusId:context.statusId,inventoryStatusId:context.inventoryStatusId,returnQuantity:context.returnQuantity,receivedQuantity:context.receivedQuantity,returnPrice:context.returnPrice,responseAmount:context.responseAmount,externalId:context.externalId,responseDate:context.responseDate,replacementOrderId:context.replacementOrderId,finAccountTransId:context.finAccountTransId,refundPaymentId:context.refundPaymentId,lastUpdatedStamp:context.lastUpdatedStamp]" in-map="[returnId:returnId,                         returnItemSeqId:childItem.returnItemSeqId, receivedQuantity:childReceivedQty,                         returnQuantity:(childHasResponse ? childItem.returnQuantity : childReceivedQty),                         statusId:(allReceived || !childHasResponse ? 'ReturnReceived' : childItem.statusId)]"/></iterate><service-call name="mantle.order.ReturnServices.checkUpdate#ReturnHeaderStatus" in-map="[returnId:returnId,                     statusId:'ReturnReceived', itemStatusIds:['ReturnReceived', 'ReturnManResp', 'ReturnCompleted', 'ReturnCancelled']]"/><if condition="returnItem.returnResponseEnumId == 'RrspManual' && !returnItem.responseDate"><service-call name="update#mantle.order.return.ReturnItem" in-map="[returnId:returnId,                         returnItemSeqId:returnItemSeqId, statusId:'ReturnManResp']"/><service-call name="mantle.order.ReturnServices.checkUpdate#ReturnHeaderStatus" in-map="[returnId:returnId,                         statusId:'ReturnManResp', itemStatusIds:['ReturnReceived', 'ReturnManResp', 'ReturnCancelled']]"/></if><if condition="hasResponse"><service-call name="mantle.order.ReturnServices.complete#ReturnItem" in-map="[returnId:returnId, returnItemSeqId:returnItemSeqId]"/></if></actions></service>