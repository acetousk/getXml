<!--Service Location coarchy.ProductEvaluationServices.include#ProductEvaluationActivity--><service verb="include" noun="ProductEvaluationActivity"><in-parameters><parameter name="productEvaluationId" required="true" entity-name="coarchy.product.ProductEvaluationActivity" field-name="productEvaluationId"/><parameter name="processStoryId" required="true" entity-name="coarchy.product.ProductEvaluationActivity" field-name="processStoryId"/><parameter name="activityId" required="true" entity-name="coarchy.product.ProductEvaluationActivity" field-name="activityId"/></in-parameters><out-parameters/><actions><entity-find-one entity-name="coarchy.product.ProductEvaluation" value-field="productEvaluation"/><if condition="productEvaluation.statusId != 'PeRequirementsSelection'"><return error="true" message="Cannot edit activities in this status."/></if><entity-find entity-name="coarchy.product.ProductEvaluationActivity" list="allActivityList"><econdition field-name="productEvaluationId"/></entity-find><entity-find entity-name="coarchy.product.ProductEvaluationActivity" list="excludedActivityList"><econdition field-name="productEvaluationId"/><econdition field-name="processStoryId"/><econdition field-name="activityId"/><econdition field-name="excludeFlag" value="Y"/></entity-find><if condition="!excludedActivityList"><service-call name="store#coarchy.product.ProductEvaluationActivity" in-map="[productEvaluationId:productEvaluationId, processStoryId:processStoryId, activityId:activityId, excludeFlag:'N', organizationId:productEvaluation.organizationId]"/><entity-find entity-name="coarchy.product.ProductEvaluationActivity" list="excludedActivityList"><econdition field-name="productEvaluationId"/><econdition field-name="processStoryId"/><econdition field-name="activityId"/><econdition field-name="excludeFlag" value="Y"/></entity-find></if><iterate list="excludedActivityList" entry="excludedActivity"><service-call name="update#coarchy.product.ProductEvaluationActivity" in-map="[productEvaluationId:productEvaluationId, processStoryId:processStoryId, activityId:activityId, excludeFlag:'N']"/><entity-find-one entity-name="coarchy.ProcessStoryActivity" value-field="psActivity"><field-map field-name="activityId"/></entity-find-one><if condition="psActivity.processStoryId"><service-call name="coarchy.ProductEvaluationServices.get#ProcessStoryAnscestors" out-map="[anscestorIdList:anscOut.anscestorIdList]" out-map-add-to-existing="false" in-map="[processStoryId:psActivity.processStoryId]"/><entity-find entity-name="coarchy.ProcessStoryActivityDetail" list="activityList"><econdition field-name="activityId" operator="in" from="allActivityList*.activityId"/><econdition field-name="processStoryId" operator="in" from="anscOut.anscestorIdList"/><econditions combine="or"><econdition field-name="condition" operator="not-equals" value=""/><econdition field-name="action" operator="not-equals" value=""/></econditions><select-field field-name="processStoryId,activityId,condition,action"/></entity-find><iterate list="activityList" entry="activity"><service-call name="coarchy.ProductEvaluationServices.include#ProductEvaluationActivity" in-map="[productEvaluationId:productEvaluationId, processStoryId:activity.processStoryId, activityId:activity.activityId]"/></iterate></if></iterate></actions></service>