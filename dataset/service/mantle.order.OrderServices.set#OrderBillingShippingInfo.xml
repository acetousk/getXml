<!--Service Location mantle.order.OrderServices.set#OrderBillingShippingInfo--><service verb="set" noun="OrderBillingShippingInfo"><in-parameters><parameter name="orderId" required="true"/><parameter name="orderPartSeqId"/><parameter name="paymentId"/><parameter name="paymentInstrumentEnumId"/><parameter name="paymentMethodId"/><parameter name="toPaymentMethodId"/><parameter name="finAccountId"/><parameter name="shippingFacilityId"/><parameter name="shippingPostalContactMechId"/><parameter name="shippingTelecomContactMechId"/><parameter name="carrierAndShipmentMethod"/><parameter name="carrierPartyId"/><parameter name="shipmentMethodEnumId"/></in-parameters><out-parameters><parameter name="paymentId"/></out-parameters><actions><entity-find-one entity-name="mantle.order.OrderHeader" value-field="orderHeader" for-update="true"/><if condition="orderPartSeqId"><then><entity-find-one entity-name="mantle.order.OrderPart" value-field="orderPart" for-update="true"/></then><else><entity-find entity-name="mantle.order.OrderPart" list="orderPartList"><econdition field-name="orderId"/><order-by field-name="orderPartSeqId"/></entity-find><set field="orderPart" from="orderPartList.first"/><set field="orderPartSeqId" from="orderPart.orderPartSeqId"/></else></if><if condition="shippingPostalContactMechId && !shippingTelecomContactMechId"><entity-find-one entity-name="mantle.party.contact.PostalAddress" value-field="shippingPostalAddress"><field-map field-name="contactMechId" from="shippingPostalContactMechId"/></entity-find-one><set field="shippingTelecomContactMechId" from="shippingPostalAddress.telecomContactMechId"/></if><set field="canUpdateShippingInfo" from="true"/><entity-find entity-name="mantle.shipment.ShipmentItemSource" list="shipmentItemSourceList"><econdition field-name="orderId"/></entity-find><if condition="shipmentItemSourceList"><entity-find entity-name="mantle.order.OrderItem" list="partOrderItemList"><econdition field-name="orderId"/><econdition field-name="orderPartSeqId"/></entity-find><script><![CDATA[List orderItemSeqIdList = partOrderItemList.orderItemSeqId
                    partShipmentIdSet = new TreeSet()
                    for (Map sis in shipmentItemSourceList) if (sis.orderItemSeqId in orderItemSeqIdList) {
                        partShipmentIdSet.add(sis.shipmentId)
                    }]]></script><iterate list="partShipmentIdSet" entry="shipmentId"><entity-find-one entity-name="mantle.shipment.Shipment" value-field="shipment"/><if condition="shipment.statusId in ['ShipRejected', 'ShipCancelled']"><continue/></if><if condition="shipment.statusId in ['ShipPacked', 'ShipShipped', 'ShipDelivered']"><message type="danger" public="true"><![CDATA[Not updating shipping info, Shipment ${shipmentId} is ${shipment.status?.description}]]></message><set field="canUpdateShippingInfo" from="false"/></if></iterate></if><if condition="canUpdateShippingInfo"><if condition="partShipmentIdSet"><iterate list="partShipmentIdSet" entry="shipmentId"><entity-find entity-name="mantle.shipment.ShipmentRouteSegment" list="shipmentRouteSegments"><econdition field-name="shipmentId"/><order-by field-name="-shipmentRouteSegmentSeqId"/></entity-find><if condition="shipmentRouteSegments"><set field="shipmentRouteSegment" from="shipmentRouteSegments[0]"/><set field="shipmentRouteSegment.shipmentMethodEnumId" from="shipmentMethodEnumId" set-if-empty="false"/><set field="shipmentRouteSegment.destPostalContactMechId" from="shippingPostalContactMechId" set-if-empty="false"/><set field="shipmentRouteSegment.destTelecomContactMechId" from="shippingTelecomContactMechId" set-if-empty="false"/><entity-update value-field="shipmentRouteSegment"/></if></iterate></if><if condition="shippingFacilityId"><set field="orderPart.facilityId" from="shippingFacilityId"/></if><if condition="shippingPostalContactMechId"><set field="orderPart.postalContactMechId" from="shippingPostalContactMechId"/></if><if condition="shippingTelecomContactMechId"><set field="orderPart.telecomContactMechId" from="shippingTelecomContactMechId"/></if><if condition="carrierAndShipmentMethod"><set field="carrierPartyId" from="carrierAndShipmentMethod.split(':')[0]"/><set field="shipmentMethodEnumId" from="carrierAndShipmentMethod.split(':')[1]"/></if><if condition="carrierPartyId"><set field="orderPart.carrierPartyId" from="carrierPartyId"/></if><if condition="shipmentMethodEnumId"><set field="orderPart.shipmentMethodEnumId" from="shipmentMethodEnumId"/></if><entity-update value-field="orderPart"/></if><if condition="paymentId"><entity-find-one entity-name="mantle.account.payment.Payment" value-field="payment"/><if condition="payment != null && (payment.orderId != orderId || payment.orderPartSeqId != orderPartSeqId)"><set field="payment" from="null"/><set field="paymentId" from="null"/></if></if><if condition="payment == null"><entity-find entity-name="mantle.account.payment.Payment" list="paymentList"><econdition field-name="orderId"/><econdition field-name="orderPartSeqId"/><order-by field-name="paymentId"/></entity-find><set field="payment" from="paymentList.first"/></if><if condition="payment != null"><then><if condition="paymentMethodId"><set field="payment.paymentMethodId" from="paymentMethodId"/></if><if condition="toPaymentMethodId"><set field="payment.toPaymentMethodId" from="toPaymentMethodId"/></if><if condition="finAccountId"><set field="payment.finAccountId" from="finAccountId"/></if><entity-update value-field="payment"/><set field="paymentId" from="payment.paymentId"/></then><else-if condition="paymentMethodId || paymentInstrumentEnumId || finAccountId"><service-call name="mantle.order.OrderServices.add#OrderPartPayment" out-map="[paymentId:context.paymentId]" in-map="[orderId:orderId, orderPartSeqId:orderPartSeqId, paymentInstrumentEnumId:paymentInstrumentEnumId,                             paymentMethodId:paymentMethodId, toPaymentMethodId:toPaymentMethodId, finAccountId:finAccountId]"/></else-if></if></actions></service>