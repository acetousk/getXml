<!--Service Location coarchy.CoarchyServices.check#PartyActivation--><service verb="check" noun="PartyActivation"><in-parameters><parameter name="userPartyId" required="true"/><parameter name="finAccountTypeId" required="true" default-value="OrganizationMonthCredit"/><parameter name="currentTimestamp" default="ec.user.nowTimestamp" type="Timestamp" required="true"/></in-parameters><out-parameters><parameter name="organizationChangeList" type="List"/><parameter name="needsCredits" type="Boolean"/><parameter name="creditsNeeded" type="Integer"/><parameter name="totalCreditsUsed" type="BigDecimal"/><parameter name="periodFromDate" type="Timestamp"/><parameter name="periodThruDate" type="Timestamp"/><parameter name="activationThruDate" type="Timestamp"/></out-parameters><actions><set field="activationThruDate" from="new Timestamp(ZonedDateTime.ofInstant(Instant.ofEpochMilli(                 (long) currentTimestamp.time), ZoneId.systemDefault()).plusDays(1).toInstant().toEpochMilli())"/><set field="periodFromDate" from="new Timestamp(ZonedDateTime.ofInstant(Instant.ofEpochMilli(                 (long) currentTimestamp.time), ZoneId.systemDefault()).withDayOfMonth(1).toInstant().toEpochMilli())"/><set field="periodThruDate" from="new Timestamp(ZonedDateTime.ofInstant(Instant.ofEpochMilli(                 (long) currentTimestamp.time), ZoneId.systemDefault()).plusMonths(1).withDayOfMonth(1).toInstant().toEpochMilli())"/><entity-find-one entity-name="mantle.party.Party" value-field="userParty"><field-map field-name="partyId" from="userPartyId"/></entity-find-one><if condition="!userPartyId"><log level="warn" message="Party ${userPartyId} was not found"/><return type="warning" message="${ec.resource.expand('CoarchyGeneralError',null)}"/></if><entity-find entity-name="mantle.account.financial.FinancialAccount" list="financialAccountList" distinct="true"><econdition field-name="ownerPartyId" from="userPartyId"/><econdition field-name="finAccountTypeId"/><econdition field-name="statusId" value="FaActive"/><date-filter valid-date="currentTimestamp"/><select-field field-name="ownerPartyId,finAccountId,availableBalance"/></entity-find><if condition="financialAccountList.size() == 0"><set field="needsCredits" from="true"/><set field="creditsNeeded" from="1" type="Integer"/><return/></if><set field="financialAccount" from="financialAccountList.groupBy{it.ownerPartyId}.collect{it.value.max{it.availableBalance}}[0]"/><set field="organizationChangeList" from="[]"/><set field="totalCreditsUsed" from="0.0" type="BigDecimal"/><entity-find entity-name="mantle.party.Party" list="organizationList"><econdition field-name="partyTypeEnumId" value="PtyOrganization"/><econdition field-name="disabled" value="N" or-null="true"/><econdition field-name="ownerPartyId" from="userPartyId"/></entity-find><if condition="organizationList.size() == 0"><set field="needsCredits" from="true"/><set field="creditsNeeded" from="1" type="Integer"/><return/></if><iterate list="organizationList" entry="organization"><service-call name="coarchy.CoarchyServices.calculate#PartyActivationUsage" in-map="[                     organizationPartyId:organization.partyId, periodFromDate:periodFromDate, periodThruDate:periodThruDate,                     activationThruDate:activationThruDate]" out-map="[activationPeriodCount:context.activationPeriodCount,dayAmountList:context.dayAmountList,dayCount:context.dayCount,totalDays:context.totalDays]"/><set field="organizationChangeList" from="organizationChangeList + [organizationId:organization.partyId,activationPeriodCount:activationPeriodCount]"/><set field="totalCreditsUsed" from="totalCreditsUsed + activationPeriodCount" type="BigDecimal"/></iterate><set field="creditsNeeded" from="0.0" type="BigDecimal"/><set field="needsCredits" from="false"/><if condition="totalCreditsUsed >= financialAccount.availableBalance"><set field="needsCredits" from="true"/><set field="creditsNeededMax" from="(totalCreditsUsed-financialAccount.availableBalance).setScale(0, BigDecimal.ROUND_UP)" type="Integer"/><set field="creditsNeeded" from="creditsNeededMax>1.0?creditsNeededMax:1"/></if></actions></service>