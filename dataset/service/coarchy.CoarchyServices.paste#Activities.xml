<!--Service Location coarchy.CoarchyServices.paste#Activities--><service verb="paste" noun="Activities"><in-parameters><parameter name="processStoryId" required="true"/><parameter name="clipboardEntryId" required="true"/><parameter name="organizationId" required="true"/><parameter name="pageIndex"/><parameter name="downPageIndex"/><parameter name="sequenceNum"/><parameter name="insertType"/></in-parameters><out-parameters><parameter name="pageIndex"/></out-parameters><actions><entity-find entity-name="coarchy.ClipboardEntry" list="entryList" limit="1"><econdition field-name="partyId" from="ec.user.userAccount?.partyId"/><econdition field-name="clipboardEntryId"/></entity-find><if condition="entryList.size() == 0"><return error="true" message="${ec.resource.expand('CoarchyProcessClipboardEmpty', null)}"/></if><entity-find-count entity-name="mantle.party.PartyRelationship" count-field="partyRelationshipCount"><date-filter/><econdition field-name="relationshipTypeEnumId" value="PrtMember"/><econdition field-name="toRoleTypeId" value="OrgInternal"/><econdition field-name="fromPartyId" from="ec.user.userAccount.partyId"/><econdition field-name="toPartyId" from="organizationId"/></entity-find-count><if condition="partyRelationshipCount == 0"><return error="true" message="${ec.resource.expand('CoarchyOrgUnauthorizedUser', null)}"/></if><set field="entry" from="entryList.getFirst()"/><set field="moveTypeEnumId" from="entry.moveTypeEnumId"/><set field="clipboardEntryId" from="entry.clipboardEntryId"/><entity-find entity-name="coarchy.ClipboardActivity" list="activityList"><econdition field-name="clipboardEntryId"/><order-by field-name="activitySeqId"/></entity-find><entity-find-count entity-name="coarchy.ProcessStoryActivity" count-field="processActivityCount"><date-filter/><econdition field-name="processStoryId"/></entity-find-count><if condition="processActivityCount"><then><if condition="((pageIndex == null) || (downPageIndex == null) || (sequenceNum == null) || (insertType == null))"><log level="warn" message="Missing required parameters [pageIndex: ${pageIndex}, downPageIndex: ${downPageIndex}, sequenceNum: ${sequenceNum}, insertType: ${insertType}]"/><return error="true" message="${ec.resource.expand('CoarchyProcessClipboardPasteError', null)}"/></if></then><else><set field="pageIndex" from="0"/><set field="downPageIndex" from="0"/><set field="sequenceNum" from="0"/><set field="insertType" value="first"/></else></if><set field="insertSequenceNum" from="sequenceNum"/><if condition="insertType=='below'"><set field="pageIndex" from="downPageIndex"/><entity-find entity-name="coarchy.ProcessStoryActivityDetail" list="processStoryActivityMaxList" limit="1"><date-filter/><econdition field-name="processStoryId"/><econdition field-name="sequenceNum" operator="greater" from="sequenceNum.toInteger()"/><select-field field-name="processStoryActivityId,sequenceNum"/><order-by field-name="sequenceNum"/></entity-find><set field="insertSequenceNum" from="processStoryActivityMaxList?.getFirst()?.sequenceNum!=null?                     processStoryActivityMaxList?.getFirst()?.sequenceNum:sequenceNum.toInteger()+1"/></if><entity-find entity-name="coarchy.ProcessStoryActivityDetail" list="processStoryActivityList"><date-filter/><econdition field-name="processStoryId"/><econdition field-name="sequenceNum" operator="greater-equals" from="insertSequenceNum.toInteger()"/><select-field field-name="processStoryActivityId,sequenceNum,activityId"/><order-by field-name="-sequenceNum"/></entity-find><iterate list="processStoryActivityList" entry="processStoryActivity"><service-call name="update#coarchy.ProcessStoryActivity" in-map="[                     processStoryActivityId:processStoryActivity.processStoryActivityId,                     sequenceNum:processStoryActivity.sequenceNum.toInteger()+activityList.size()]"/></iterate><set field="actorIdMap" from="[:]"/><entity-find entity-name="coarchy.ClipboardActor" list="actorList" distinct="true"><econdition field-name="clipboardEntryId"/><select-field field-name="actorSeqId,activitySeqId,name,description"/><order-by field-name="actorSeqId"/></entity-find><iterate list="actorList" entry="actor"><entity-find entity-name="coarchy.Actor" list="insideActorList" distinct="true" limit="1"><econdition field-name="name" from="actor.name"/><select-field field-name="actorId,name"/><order-by field-name="name"/></entity-find><if condition="!insideActorList"><then><service-call name="create#coarchy.Actor" in-map="[name:actor.name,                             description:actor.description,organizationId:organizationId]" out-map="[actorId:actorContext.actorId,name:actorContext.name,description:actorContext.description,organizationId:actorContext.organizationId,lastUpdatedStamp:actorContext.lastUpdatedStamp]"/><script><![CDATA[actorIdMap.put(actor.actorSeqId,actorContext?.actorId)]]></script></then><else><script><![CDATA[actorIdMap.put(actor.actorSeqId,insideActorList.getFirst().actorId)]]></script></else></if></iterate><set field="valueStatementIdMap" from="[:]"/><entity-find entity-name="coarchy.ClipboardActivityStatement" list="activityStatementList" distinct="true"><econdition field-name="clipboardEntryId"/><select-field field-name="statementSeqId,activitySeqId,value,typeEnumId"/><order-by field-name="statementSeqId"/></entity-find><iterate list="activityStatementList" entry="activityStatement"><entity-find entity-name="coarchy.ValueStatement" list="insideStatementList" distinct="true" limit="1"><econdition field-name="disabled" value="N" or-null="true"/><econdition field-name="replacedByValueStatementId" operator="is-null"/><econdition field-name="value" from="activityStatement.value"/><econdition field-name="typeEnumId" from="activityStatement.typeEnumId"/><select-field field-name="valueStatementId,value,typeEnumId"/><order-by field-name="value"/></entity-find><if condition="!insideStatementList"><then><service-call name="create#coarchy.ValueStatement" in-map="[value:activityStatement.value,                             typeEnumId:activityStatement.typeEnumId,organizationId:organizationId]" out-map="[valueStatementId:valueStatementContext.valueStatementId,value:valueStatementContext.value,sequenceNum:valueStatementContext.sequenceNum,typeEnumId:valueStatementContext.typeEnumId,disabled:valueStatementContext.disabled,replacedByValueStatementId:valueStatementContext.replacedByValueStatementId,organizationId:valueStatementContext.organizationId,lastUpdatedStamp:valueStatementContext.lastUpdatedStamp]"/><script><![CDATA[valueStatementIdMap.put(activityStatement.statementSeqId,valueStatementContext?.valueStatementId)]]></script></then><else><script><![CDATA[valueStatementIdMap.put(activityStatement.statementSeqId,insideStatementList.getFirst().valueStatementId)]]></script></else></if></iterate><iterate list="activityList" entry="activity"><set field="actorSeqIdList" from="actorList.findAll{ it.activitySeqId == activity.activitySeqId }*.actorSeqId"/><set field="actorIdList" from="actorSeqIdList.collect{ actorIdMap[it] }"/><set field="statementSeqIdList" from="activityStatementList.findAll{ it.activitySeqId == activity.activitySeqId }*.statementSeqId"/><set field="statementIdList" from="statementSeqIdList.collect{ valueStatementIdMap[it] }"/><service-call name="coarchy.CoarchyServices.create#Activity" in-map="[processStoryId:processStoryId,organizationId:organizationId,condition:activity.condition,action:activity.action,actorIdList:actorIdList,statementIdList:statementIdList, sequenceNum:insertSequenceNum.toInteger()+activity_index,implementationId:activity.implementationId,ignoreNoAction:true]"/></iterate></actions></service>