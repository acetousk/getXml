<!--Service Location coarchy.ProductEvaluationServices.add#ProductEvaluationResponse--><service verb="add" noun="ProductEvaluationResponse"><in-parameters><parameter name="productEvaluationId" required="true" entity-name="coarchy.product.ProductEvaluationResponse" field-name="productEvaluationId"/><parameter name="organizationId" required="true" entity-name="coarchy.product.ProductEvaluationResponse" field-name="organizationId"/><parameter name="activityId" entity-name="coarchy.product.ProductEvaluationResponse" field-name="activityId"/><parameter name="statementId" entity-name="coarchy.product.ProductEvaluationResponse" field-name="statementId"/><parameter name="implementationStatusEnumId" required="true" entity-name="coarchy.product.ProductEvaluationResponse" field-name="implementationStatusEnumId"/><parameter name="rating" type="Integer" entity-name="coarchy.product.ProductEvaluationResponse" field-name="rating"/><parameter name="comments" entity-name="coarchy.product.ProductEvaluationResponse" field-name="comments"/><parameter name="isVendor" type="Boolean"/></in-parameters><out-parameters/><actions><entity-find-one entity-name="coarchy.product.ProductEvaluation" value-field="productEvaluation"/><if condition="productEvaluation.statusId != 'PeAwaitingVendorResponse'"><return error="true" message="Cannot add response in this status."/></if><entity-find-count entity-name="mantle.party.PartyRelationship" count-field="partyRelationshipCount"><date-filter/><econdition field-name="relationshipTypeEnumId" value="PrtMember"/><econdition field-name="toRoleTypeId" value="OrgInternal"/><econdition field-name="fromPartyId" from="ec.user.userAccount.partyId"/><econdition field-name="toPartyId" from="productEvaluation.organizationId"/></entity-find-count><entity-find-count entity-name="mantle.party.PartyRelationship" count-field="vendorRelationshipCount"><date-filter/><econdition field-name="relationshipTypeEnumId" value="PrtVendorRepresentative"/><econdition field-name="toRoleTypeId" value="VendorRepresentative"/><econdition field-name="fromPartyId" from="ec.user.userAccount.partyId"/><econdition field-name="toPartyId" from="productEvaluation.organizationId"/></entity-find-count><if condition="!partyRelationshipCount && ! vendorRelationshipCount"><return error="true" message="You are not allowed to perform this action."/></if><set field="isResponseInternal" from="(isVendor && vendorRelationshipCount>0)?false:(partyRelationshipCount>0)"/><set field="lastEditedByUserId" from="ec.user.userId"/><entity-find entity-name="coarchy.product.ProductEvaluationResponse" list="productEvalResponseList"><econdition field-name="productEvaluationId"/><econdition field-name="evaluationByEnumId" value="EbInternal" ignore="!isResponseInternal"/><econdition field-name="evaluationByEnumId" value="EbVendor" ignore="isResponseInternal"/><econdition field-name="activityId" ignore="!activityId"/><econdition field-name="statementId" ignore="!statementId"/></entity-find><if condition="!productEvalResponseList"><service-call name="create#coarchy.product.ProductEvaluationResponse" in-map="[productEvaluationId:productEvaluationId, activityId:activityId, statementId:statementId, implementationStatusEnumId:implementationStatusEnumId, rating:rating, comments:comments, lastEditedByUserId: lastEditedByUserId, evaluationByEnumId: isResponseInternal?'EbInternal':'EbVendor',organizationId:organizationId]"/><else><set field="productEvalResponse" from="productEvalResponseList[0]"/><service-call name="update#coarchy.product.ProductEvaluationResponse" in-map="[productEvaluationResponseId:productEvalResponse.productEvaluationResponseId, implementationStatusEnumId:implementationStatusEnumId, rating:rating, comments:comments, lastEditedByUserId: lastEditedByUserId]"/></else></if></actions></service>