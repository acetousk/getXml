<!--Service Location mantle.product.AssetServices.change#AssetQuantity--><service verb="change" noun="AssetQuantity"><in-parameters><parameter name="assetId" type="java.lang.String" required="true" allow-html="none" entity-name="mantle.product.asset.AssetDetail" field-name="assetId"/><parameter name="effectiveDate" type="Timestamp" required="false" allow-html="none" entity-name="mantle.product.asset.AssetDetail" field-name="effectiveDate" default="ec.user.nowTimestamp"/><parameter name="unitCost" type="java.math.BigDecimal" required="false" allow-html="none" entity-name="mantle.product.asset.AssetDetail" field-name="unitCost"/><parameter name="assetReservationId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.AssetDetail" field-name="assetReservationId"/><parameter name="otherAssetId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.AssetDetail" field-name="otherAssetId"/><parameter name="shipmentId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.AssetDetail" field-name="shipmentId"/><parameter name="productId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.AssetDetail" field-name="productId"/><parameter name="orderId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.AssetDetail" field-name="orderId"/><parameter name="orderItemSeqId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.AssetDetail" field-name="orderItemSeqId"/><parameter name="returnId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.AssetDetail" field-name="returnId"/><parameter name="returnItemSeqId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.AssetDetail" field-name="returnItemSeqId"/><parameter name="workEffortId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.AssetDetail" field-name="workEffortId"/><parameter name="assetMaintenanceId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.AssetDetail" field-name="assetMaintenanceId"/><parameter name="assetIssuanceId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.AssetDetail" field-name="assetIssuanceId"/><parameter name="assetReceiptId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.AssetDetail" field-name="assetReceiptId"/><parameter name="physicalInventoryId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.AssetDetail" field-name="physicalInventoryId"/><parameter name="physicalInventoryCountId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.AssetDetail" field-name="physicalInventoryCountId"/><parameter name="varianceReasonEnumId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.AssetDetail" field-name="varianceReasonEnumId"/><parameter name="description" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.AssetDetail" field-name="description"/><parameter name="acctgTransResultEnumId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.AssetDetail" field-name="acctgTransResultEnumId"/><parameter name="lastUpdatedStamp" type="java.sql.Timestamp" required="false" allow-html="none" entity-name="mantle.product.asset.AssetDetail" field-name="lastUpdatedStamp"/><parameter name="quantityDiff" type="BigDecimal" required="true"/></in-parameters><out-parameters/><actions><if condition="quantityDiff == 0.0"><return type="warning" message="Not changing quantity for Asset ${assetId}, quantityDiff is zero"/></if><entity-find-one entity-name="mantle.product.asset.Asset" value-field="asset" for-update="true"><field-map field-name="assetId"/></entity-find-one><service-call name="create#mantle.product.asset.AssetDetail" in-map="context +                     [quantityOnHandDiff:quantityDiff, availableToPromiseDiff:quantityDiff]"/><if condition="asset.serialNumber && quantityDiff == -1.0 && (asset.quantityOnHandTotal == 1.0 || asset.hasQuantity == 'N')"><set field="ownerPartyId" from="null"/><if condition="orderId && orderItemSeqId"><entity-find-one entity-name="mantle.order.OrderItem" value-field="orderItem"/><set field="orderPart" from="orderItem?.part"/><set field="ownerPartyId" from="orderPart?.customerPartyId"/></if><if condition="!ownerPartyId && shipmentId"><entity-find-one entity-name="mantle.shipment.Shipment" value-field="shipment"/><set field="ownerPartyId" from="shipment?.toPartyId"/></if><service-call name="update#mantle.product.asset.Asset" in-map="[assetId:asset.assetId, statusId:'AstDelivered', ownerPartyId:(ownerPartyId ?: asset.ownerPartyId)]"/></if><if condition="quantityDiff > 0.0 && asset.productId"><service-call name="mantle.product.AssetServices.reserve#IncreasedAsset" in-map="[assetId:assetId]"/></if><if condition="quantityDiff < 0.0 && asset.productId"><entity-find-one entity-name="mantle.product.asset.Asset" value-field="asset" for-update="true"><field-map field-name="assetId"/></entity-find-one><if condition="asset.availableToPromiseTotal < 0.0"><set field="negativeAvailable" from="-asset.availableToPromiseTotal"/><set field="reduceQuantityRemaining" from="-quantityDiff"/><if condition="reduceQuantityRemaining > negativeAvailable"><set field="reduceQuantityRemaining" from="negativeAvailable"/></if><entity-find entity-name="mantle.product.issuance.AssetReservation" list="existingResList"><econdition field-name="assetId"/><order-by field-name="-reservedDate"/></entity-find><iterate list="existingResList" entry="res"><if condition="reduceQuantityRemaining == 0.0"><break/></if><set field="quantityToReduce" from="reduceQuantityRemaining > res.quantityNotIssued ? res.quantityNotIssued : reduceQuantityRemaining"/><service-call name="mantle.product.AssetServices.reduce#AssetReservation" out-map="[quantityDeducted:reduceArOut.quantityDeducted]" out-map-add-to-existing="false" in-map="[assetReservationId:res.assetReservationId, quantityToDeduct:quantityToReduce, reserveIncreasedAsset:false]"/><service-call name="mantle.product.AssetServices.reserve#AssetForOrderItem" in-map="[orderId:res.orderId, orderItemSeqId:res.orderItemSeqId, skipAssetIds:[assetId]]"/><set field="reduceQuantityRemaining" from="reduceQuantityRemaining - reduceArOut.quantityDeducted"/></iterate></if></if></actions></service>