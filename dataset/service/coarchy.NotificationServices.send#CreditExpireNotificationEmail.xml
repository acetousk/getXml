<!--Service Location coarchy.NotificationServices.send#CreditExpireNotificationEmail--><service verb="send" noun="CreditExpireNotificationEmail"><in-parameters><parameter name="emailTemplateId" required="true"/><parameter name="partyId" required="true"/><parameter name="bodyParameters" required="true" type="Map"/><parameter name="preferredContactMechId"/><parameter name="toAddresses"/><parameter name="emailTypeEnumId" required="true" default-value="CONT_EMAIL_TEMPLATE"/><parameter name="lastCreditPurchaseDate" type="Timestamp"/></in-parameters><out-parameters><parameter name="sentEmail"/><parameter name="emailTemplateId"/><parameter name="emailMessageId"/></out-parameters><actions><entity-find entity-name="moqui.security.UserAccount" list="userAccountList" limit="2"><econdition field-name="partyId"/><econdition field-name="disabled" operator="not-equals" value="Y"/></entity-find><if condition="userAccountList.size() > 1"><log level="warn" message="Multiple user accounts found for party ${partyId}"/></if><set field="userAccount" from="userAccountList?.getFirst()"/><if condition="!toAddresses"><set field="toAddresses" from="userAccount.emailAddress"/></if><entity-find entity-name="moqui.basic.email.EmailMessage" list="emailMessageList"><econdition field-name="emailTemplateId"/><econdition field-name="toUserId" from="userAccount.userId"/><order-by field-name="-sentDate"/></entity-find><if condition="emailMessageList"><set field="emailLastSentDate" from="emailMessageList?.getFirst()?.sentDate"/><if condition="lastCreditPurchaseDate && (lastCreditPurchaseDate.time > emailLastSentDate.time)"><then><log level="warn" message="Re-sending email template ${emailTemplateId} since credit purchase was performed after last sent date"/></then><else><return message="Email template ${emailTemplateId} already sent to user ${userAccount.userId} on ${emailLastSentDate}"/></else></if></if><if condition="!preferredContactMechId"><entity-find entity-name="mantle.party.contact.PartyContactMech" list="partyContactMechList" limit="1"><econdition field-name="partyId"/><econdition field-name="contactMechPurposeId" value="EmailPrimary"/><date-filter/><order-by field-name="-fromDate"/></entity-find><set field="preferredContactMechId" from="partyContactMechList?.getFirst()?.contactMechId"/></if><service-call name="org.moqui.impl.EmailServices.send#EmailTemplate" in-map="[emailTemplateId:emailTemplateId,toAddresses:toAddresses,bodyParameters:bodyParameters, toUserId:userAccount.userId]" out-map="[messageId:context.messageId,emailMessageId:context.emailMessageId]"/><if condition="emailMessageId"><set field="sentEmail" from="true"/></if><service-call name="mantle.party.CommunicationServices.create#Message" in-map="[communicationEventTypeId:'Email',contactMechTypeEnumId:'CmtEmailAddress',statusId:'CeSent',                     toContactMechId:preferredContactMechId,toPartyId:partyId,fromPartyId:'coarchy',emailMessageId:emailMessageId]" out-map="[communicationEventId:communicationEventOut.communicationEventId,fromPartyId:communicationEventOut.fromPartyId,communicationEventTypeId:communicationEventOut.communicationEventTypeId,statusId:communicationEventOut.statusId,entryDate:communicationEventOut.entryDate]"/></actions></service>