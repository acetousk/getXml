<!--Service Location mantle.shipment.ShipmentServices.update#ShipmentItem--><service verb="update" noun="ShipmentItem"><in-parameters><parameter name="shipmentId" required="false" entity-name="mantle.shipment.ShipmentItemSource" field-name="shipmentId" type="java.lang.String" allow-html="none"/><parameter name="productId" required="false" entity-name="mantle.shipment.ShipmentItemSource" field-name="productId" type="java.lang.String" allow-html="none"/><parameter name="quantity" type="BigDecimal" required="true" allow-html="none" entity-name="mantle.shipment.ShipmentItemSource" field-name="quantity"/><parameter name="lastUpdatedStamp" type="java.sql.Timestamp" required="false" allow-html="none" entity-name="mantle.shipment.ShipmentItemSource" field-name="lastUpdatedStamp"/><parameter name="shipmentItemSourceId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.shipment.ShipmentItemSource" field-name="shipmentItemSourceId"/><parameter name="binLocationNumber" type="java.lang.Long" required="false" allow-html="none" entity-name="mantle.shipment.ShipmentItemSource" field-name="binLocationNumber"/><parameter name="orderId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.shipment.ShipmentItemSource" field-name="orderId"/><parameter name="orderItemSeqId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.shipment.ShipmentItemSource" field-name="orderItemSeqId"/><parameter name="returnId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.shipment.ShipmentItemSource" field-name="returnId"/><parameter name="returnItemSeqId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.shipment.ShipmentItemSource" field-name="returnItemSeqId"/><parameter name="statusId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.shipment.ShipmentItemSource" field-name="statusId"/><parameter name="quantityNotHandled" type="java.math.BigDecimal" required="false" allow-html="none" entity-name="mantle.shipment.ShipmentItemSource" field-name="quantityNotHandled"/><parameter name="quantityPicked" type="java.math.BigDecimal" required="false" allow-html="none" entity-name="mantle.shipment.ShipmentItemSource" field-name="quantityPicked"/><parameter name="invoiceId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.shipment.ShipmentItemSource" field-name="invoiceId"/><parameter name="invoiceItemSeqId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.shipment.ShipmentItemSource" field-name="invoiceItemSeqId"/></in-parameters><out-parameters><parameter name="shipmentItemSourceId"/></out-parameters><actions><if condition="quantity < 0.0"><return error="true" message="Quantity cannot be less than zero for shipment ${shipmentId} product ${productId} (${quantity})"/></if><entity-find entity-name="mantle.product.issuance.AssetIssuanceSummary" list="issuanceSummaryList"><econdition field-name="shipmentId"/><econdition field-name="productId"/><select-field field-name="quantity"/></entity-find><if condition="issuanceSummaryList && (issuanceSummaryList[0].quantity ?: 0.0) > quantity"><return error="true" message="Quantity cannot be reduced below packed/issued quantity ${issuanceSummaryList[0].quantity}"/></if><entity-find entity-name="mantle.product.receipt.AssetReceiptSummary" list="receiptSummaryList"><econdition field-name="shipmentId"/><econdition field-name="productId"/><select-field field-name="quantityAccepted,quantityRejected"/></entity-find><if condition="receiptSummaryList"><set field="receiptTotal" from="(receiptSummaryList[0].quantityAccepted ?: 0.0) + (receiptSummaryList[0].quantityRejected ?: 0.0)"/><if condition="receiptTotal > quantity"><return error="true" message="Quantity cannot be reduced below received quantity ${receiptTotal}"/></if></if><entity-find-one entity-name="mantle.shipment.Shipment" value-field="shipment"/><service-call name="org.moqui.impl.BasicServices.find#EnumerationByParent" out-map="[enumerationList:shipmentTypeOut.enumerationList,enumIdSet:shipmentTypeOut.enumIdSet]" in-map="[parentEnumId:'ShpTpOutgoing']"/><set field="isOutgoing" from="shipment.shipmentTypeEnumId in shipmentTypeOut.enumIdSet"/><entity-find-one entity-name="mantle.shipment.ShipmentItem" value-field="shipmentItem"/><set field="quantityChange" from="quantity - (shipmentItem.quantity ?: 0.0)"/><entity-set value-field="shipmentItem"/><entity-update value-field="shipmentItem"/><if condition="shipmentItemSourceId"><then><entity-find-one entity-name="mantle.shipment.ShipmentItemSource" value-field="sis"/><entity-set value-field="sis"/><set field="sis.quantity" from="(sis.quantity ?: 0.0) + quantityChange"/><set field="sis.quantityNotHandled" from="(sis.quantityNotHandled ?: 0.0) + quantityChange"/><entity-update value-field="sis"/></then><else><entity-find entity-name="mantle.shipment.ShipmentItemSource" list="sisList"><econdition field-name="shipmentId"/><econdition field-name="productId"/></entity-find><set field="sisQuantity" from="0.0"/><filter-map-list list="sisList" to-list="noOrderSisList"><field-map field-name="orderId" from="null"/></filter-map-list><set field="orderSisList" from="[]"/><iterate list="sisList" entry="sis"><script><![CDATA[if (sis.orderId) orderSisList.add(sis)]]></script></iterate><iterate list="sisList" entry="sis"><set field="sisQuantity" from="sisQuantity + (sis.quantity ?: 0.0)"/></iterate><set field="quantityChange" from="quantity - sisQuantity"/><if condition="quantityChange > 0.0"><set field="increaseRemaining" from="quantityChange"/><iterate list="orderSisList" entry="sis"><entity-find entity-name="mantle.shipment.ShipmentItemSource" list="itemSisList"><econdition field-name="orderId" from="sis.orderId"/><econdition field-name="orderItemSeqId" from="sis.orderItemSeqId"/><select-field field-name="quantity"/></entity-find><set field="itemShipmentQuantity" from="0.0"/><iterate list="itemSisList" entry="itemSis"><set field="itemShipmentQuantity" from="itemShipmentQuantity + itemSis.quantity"/></iterate><entity-find-one entity-name="mantle.order.OrderItem" value-field="orderItem"><field-map field-name="orderId" from="sis.orderId"/><field-map field-name="orderItemSeqId" from="sis.orderItemSeqId"/></entity-find-one><set field="itemQuantityRemaining" from="orderItem.quantity - itemShipmentQuantity"/><set field="currentChange" from="increaseRemaining > itemQuantityRemaining ?                                 itemQuantityRemaining : increaseRemaining"/><if condition="currentChange"><set field="sis.quantity" from="(sis.quantity ?: 0.0) + currentChange"/><set field="sis.quantityNotHandled" from="(sis.quantityNotHandled ?: 0.0) + currentChange"/><entity-update value-field="sis"/><set field="increaseRemaining" from="increaseRemaining - currentChange"/><if condition="increaseRemaining == 0.0"><break/></if></if></iterate><if condition="orderSisList && increaseRemaining && isOutgoing"><return error="true" message="For outgoing shipments cannot increase quantity above what is on related order items (${increaseRemaining} too many)"/></if><if condition="increaseRemaining && noOrderSisList"><then><set field="sis" from="noOrderSisList[0]"/><set field="sis.quantity" from="(sis.quantity ?: 0.0) + increaseRemaining"/><set field="sis.quantityNotHandled" from="(sis.quantityNotHandled ?: 0.0) + increaseRemaining"/><entity-update value-field="sis"/></then><else-if condition="increaseRemaining"><service-call name="create#mantle.shipment.ShipmentItemSource" in-map="context + [quantity:increaseRemaining, quantityNotHandled:increaseRemaining, statusId:'SisPending']"/></else-if></if></if><if condition="quantityChange < 0.0"><set field="reduceRemaining" from="-quantityChange"/><iterate list="noOrderSisList" entry="sis"><set field="currentChange" from="reduceRemaining > (sis.quantityNotHandled ?: 0.0) ?                                 (sis.quantityNotHandled ?: 0.0) : reduceRemaining"/><if condition="currentChange"><set field="sis.quantity" from="(sis.quantity ?: 0.0) - currentChange"/><set field="sis.quantityNotHandled" from="(sis.quantityNotHandled ?: 0.0) - currentChange"/><if condition="sis.quantity > 0.0 && sis.quantityNotHandled == 0.0"><set field="sis.statusId" from="isOutgoing ? 'SisPacked' : 'SisReceived'"/></if><entity-update value-field="sis"/><set field="reduceRemaining" from="reduceRemaining - currentChange"/><if condition="reduceRemaining == 0.0"><break/></if></if></iterate><iterate list="orderSisList" entry="sis"><set field="currentChange" from="reduceRemaining > (sis.quantityNotHandled ?: 0.0) ?                                 (sis.quantityNotHandled ?: 0.0) : reduceRemaining"/><if condition="currentChange"><set field="sis.quantity" from="(sis.quantity ?: 0.0) - currentChange"/><set field="sis.quantityNotHandled" from="(sis.quantityNotHandled ?: 0.0) - currentChange"/><if condition="sis.quantity > 0.0 && sis.quantityNotHandled == 0.0"><set field="sis.statusId" from="isOutgoing ? 'SisPacked' : 'SisReceived'"/></if><entity-update value-field="sis"/><set field="reduceRemaining" from="reduceRemaining - currentChange"/><if condition="reduceRemaining == 0.0"><break/></if></if></iterate></if></else></if><if condition="shipment.assemblyWorkEffortId"><entity-find-one entity-name="mantle.product.Product" value-field="product" cache="true"/><if condition="product.productTypeEnumId == 'PtPickAssembly'"><service-call name="mantle.work.ManufacturingServices.set#ProducedProductQuantity" in-map="[workEffortId:shipment.assemblyWorkEffortId, productId:productId, estimatedQuantity:quantity]"/></if></if></actions></service>