<!--Service Location org.moqui.impl.EntitySyncServices.get#EntitySyncIncludeList--><service verb="get" noun="EntitySyncIncludeList"><in-parameters><parameter name="entitySyncId" required="true"/></in-parameters><out-parameters><parameter name="entityIncludeList" type="List"><parameter name="entryMap" type="Map"><parameter name="entityName"/><parameter name="includeFilterList" type="List"><description><![CDATA[List of Maps to be ORed together]]></description><parameter name="filterMap" type="Map"/></parameter><parameter name="dependents" type="Boolean"/></parameter></parameter></out-parameters><actions><entity-find entity-name="moqui.entity.sync.EntitySyncArtifactDetail" list="esadList"><econdition field-name="artifactTypeEnumId" value="AT_ENTITY"/><econdition field-name="entitySyncId"/></entity-find><set field="includeMap" from="new HashMap()"/><set field="excludeMap" from="new HashMap()"/><set field="alwaysMap" from="new HashMap()"/><set field="withDependentsSet" from="new HashSet()"/><set field="allEntitySet" from="ec.entity.getAllNonViewEntityNames()"/><iterate list="esadList" entry="esad"><set field="nameSet" from="new HashSet()"/><if condition="esad.nameIsPattern == 'Y'"><iterate list="allEntitySet" entry="entityName"><if condition="entityName.matches(esad.artifactName)"><script><![CDATA[nameSet.add(entityName)]]></script></if></iterate><else><script><![CDATA[nameSet.add(esad.artifactName)]]></script></else></if><iterate list="nameSet" entry="entityName"><set field="curMap" from="esad.applEnumId == 'EsaaExclude' ? excludeMap : (esad.applEnumId == 'EsaaAlways' ? alwaysMap : includeMap)"/><set field="curMapList" from="curMap.get(entityName) ?: []"/><if condition="esad.filterMap"><script><![CDATA[curMapList.add(ec.resource.expression(esad.filterMap, null))]]></script></if><script><![CDATA[curMap.put(entityName, curMapList)]]></script><script><![CDATA[if (esad.dependents == 'Y') withDependentsSet.add(entityName)]]></script></iterate></iterate><iterate list="excludeMap" entry="curMapList" key="entityName"><script><![CDATA[includeMap.remove(entityName)]]></script></iterate><iterate list="alwaysMap" entry="curMapList" key="entityName"><script><![CDATA[if (includeMap.containsKey(entityName)) {
                        List incMapList = includeMap.get(entityName)
                        incMapList.addAll(curMapList)
                    } else {
                        includeMap.put(entityName, curMapList)
                    }]]></script></iterate><set field="entityIncludeList" from="[]"/><iterate list="includeMap" entry="incMapList" key="entityName"><script><![CDATA[entityIncludeList.add([entityName:entityName, includeFilterList:incMapList,
                                               dependents:(withDependentsSet.contains(entityName) ? 'Y' : 'N')])]]></script></iterate></actions></service>