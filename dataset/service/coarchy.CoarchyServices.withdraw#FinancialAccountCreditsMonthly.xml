<!--Service Location coarchy.CoarchyServices.withdraw#FinancialAccountCreditsMonthly--><service verb="withdraw" noun="FinancialAccountCreditsMonthly"><in-parameters><parameter name="finAccountTypeId" required="true" default-value="OrganizationMonthCredit"/><parameter name="serviceStartTime" type="Timestamp" default="ec.user.nowTimestamp" required="true"/></in-parameters><out-parameters/><actions><set field="periodThruDate" from="serviceStartTime"/><set field="periodFromDate" from="new Timestamp(ZonedDateTime.ofInstant(Instant.ofEpochMilli(                 (long) periodThruDate.time), ZoneId.systemDefault()).minusMonths(1).toInstant().toEpochMilli())"/><entity-find entity-name="mantle.account.financial.FinancialAccount" list="financialAccountList" distinct="true"><econdition field-name="finAccountTypeId"/><econdition field-name="statusId" value="FaActive"/><date-filter/><select-field field-name="ownerPartyId,finAccountId,availableBalance"/></entity-find><set field="financialAccountList" from="financialAccountList.groupBy{it.ownerPartyId}.collect{it.value.max{it.availableBalance}}"/><iterate list="financialAccountList" entry="financialAccount"><set field="totalCreditsUsed" from="0.0" type="BigDecimal"/><entity-find entity-name="mantle.party.Party" list="organizationList"><econdition field-name="partyTypeEnumId" value="PtyOrganization"/><econdition field-name="disabled" value="N" or-null="true"/><econdition field-name="ownerPartyId" from="financialAccount.ownerPartyId"/></entity-find><if condition="organizationList.size() == 0"><log level="warn" message="No organization found with financial account for ${financialAccount.ownerPartyId}"/><continue/></if><iterate list="organizationList" entry="organization"><service-call name="coarchy.CoarchyServices.calculate#PartyActivationUsage" in-map="[organizationPartyId:                         organization.partyId, periodFromDate:periodFromDate, periodThruDate:periodThruDate]" out-map="[activationPeriodCount:context.activationPeriodCount,dayAmountList:context.dayAmountList,dayCount:context.dayCount,totalDays:context.totalDays]"/><set field="totalCreditsUsed" from="totalCreditsUsed + activationPeriodCount" type="BigDecimal"/><log level="info" message="withdraw dayAmountList ${dayAmountList}"/><log level="info" message="withdraw ${activationPeriodCount} for ${dayCount} / ${totalDays} days from financialAccount ${financialAccount} for organization ${organization.partyId} owned by ${financialAccount.ownerPartyId}"/></iterate><if condition="totalCreditsUsed > 0.0"><service-call name="mantle.account.FinancialAccountServices.withdraw#FinancialAccount" in-map="[                         finAccountId:financialAccount.finAccountId,amount:totalCreditsUsed,decimalDigits:4]" out-map="[amount:context.amount,preBalance:context.preBalance,postBalance:context.postBalance,finAccountTransId:context.finAccountTransId,responseCode:context.responseCode,responseMessage:context.responseMessage]"/></if></iterate></actions></service>