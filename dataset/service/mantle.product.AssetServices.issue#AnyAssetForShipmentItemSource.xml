<!--Service Location mantle.product.AssetServices.issue#AnyAssetForShipmentItemSource--><service verb="issue" noun="AnyAssetForShipmentItemSource"><in-parameters><parameter name="shipmentItemSourceId" required="true"/><parameter name="quantity" type="BigDecimal" required="true"/><parameter name="issuedDate" type="Timestamp" default="ec.user.nowTimestamp"/><parameter name="forceIssueOther" type="Boolean" default="false"/><parameter name="workEffortId"/><parameter name="workEffortOnly" type="Boolean" default="false"><description><![CDATA[Issue only to WorkEffort, not to Order, Shipment, or Invoice]]></description></parameter></in-parameters><out-parameters><parameter name="quantityRemaining" type="BigDecimal"/></out-parameters><actions><set field="quantityRemaining" from="quantity"/><entity-find-one entity-name="mantle.shipment.ShipmentItemSource" value-field="shipmentItemSource"/><if condition="shipmentItemSource == null"><return error="true" message="Could not find ShipmentItemSource with ID ${shipmentItemSourceId}"/></if><set field="shipmentId" from="shipmentItemSource.shipmentId"/><set field="shipment" from="shipmentItemSource.shipment"/><entity-find entity-name="mantle.shipment.ShipmentRouteSegment" list="shipmentRouteSegmentList"><econdition field-name="shipmentId"/><order-by field-name="-shipmentRouteSegmentSeqId"/></entity-find><set field="facilityId" from="shipmentRouteSegmentList?.first?.originFacilityId"/><if condition="!facilityId"><return type="warning" message="No origin Facility found for Shipment ${shipmentId}, ShipmentItemSource ${shipmentItemSourceId}, not trying to issue other inventory"/></if><entity-find-one entity-name="mantle.facility.Facility" value-field="facility" cache="true"/><set field="productId" from="shipmentItemSource.productId"/><set field="productStoreId" from="shipment.productStoreId"/><set field="vendorPartyId" from="shipment.fromPartyId"/><set field="customerPartyId" from="shipment.toPartyId"/><if condition="productStoreId && !vendorPartyId"><entity-find-one entity-name="mantle.product.store.ProductStore" value-field="productStore"/><set field="vendorPartyId" from="productStore?.organizationPartyId"/></if><set field="ownerPartyIdSet" from="new HashSet()"/><if condition="vendorPartyId"><script><![CDATA[ownerPartyIdSet.add(vendorPartyId)]]></script><entity-find entity-name="mantle.party.PartyRelationship" list="parentRelList" cache="true"><date-filter/><econdition field-name="relationshipTypeEnumId" value="PrtOrgRollup"/><econdition field-name="fromPartyId" from="vendorPartyId"/><econdition field-name="toPartyId" operator="is-not-null"/></entity-find><script><![CDATA[if (parentRelList) ownerPartyIdSet.addAll(parentRelList*.toPartyId)]]></script></if><service-call name="mantle.product.AssetServices.get#AssetPools" out-map="[assetPoolIdSet:poolsOut.assetPoolIdSet]" in-map="[productStoreId:productStoreId, vendorPartyId:vendorPartyId, customerPartyId:customerPartyId]"/><set field="assetPoolIdSet" from="poolsOut.assetPoolIdSet"/><if condition="workEffortOnly"><then><set field="baseMap" from="[workEffortId:workEffortId]"/></then><else><set field="baseMap" from="[shipmentId:shipmentId, shipmentItemSourceId:shipmentItemSourceId,                         orderId:shipmentItemSource.orderId, orderItemSeqId:shipmentItemSource.orderItemSeqId,                         invoiceId:shipmentItemSource.invoiceId, invoiceItemSeqId:shipmentItemSource.invoiceItemSeqId]"/></else></if><entity-find entity-name="mantle.product.asset.Asset" list="assetList"><econdition field-name="productId"/><econdition field-name="facilityId"/><econdition field-name="ownerPartyId" operator="in" from="ownerPartyIdSet" ignore="facility?.assetAllowOtherOwner == 'Y' || !ownerPartyIdSet"/><econdition field-name="assetPoolId" operator="in" from="assetPoolIdSet" ignore="!assetPoolIdSet" or-null="true"/><econdition field-name="assetPoolId" operator="is-null" ignore="assetPoolIdSet"/><econdition field-name="statusId" value="AstAvailable"/><econdition field-name="availableToPromiseTotal" operator="greater" from="0.0"/><order-by field-name="receivedDate,assetId"/></entity-find><iterate list="assetList" entry="asset"><set field="curQuantity" from="asset.availableToPromiseTotal > quantityRemaining ? quantityRemaining : asset.availableToPromiseTotal"/><if condition="curQuantity"><service-call name="mantle.product.AssetServices.issue#Asset" in-map="baseMap + [quantity:curQuantity, issuedDate:issuedDate, assetId:asset.assetId]"/><set field="quantityRemaining" from="quantityRemaining - curQuantity"/><if condition="quantityRemaining == 0.0"><break/></if></if></iterate><if condition="quantityRemaining && forceIssueOther"><entity-find entity-name="mantle.product.asset.Asset" list="assetList"><econdition field-name="productId"/><econdition field-name="facilityId"/><econdition field-name="ownerPartyId" operator="in" from="ownerPartyIdSet" ignore="facility?.assetAllowOtherOwner == 'Y' || !ownerPartyIdSet"/><econdition field-name="assetPoolId" operator="in" from="assetPoolIdSet" ignore="!assetPoolIdSet" or-null="true"/><econdition field-name="assetPoolId" operator="is-null" ignore="assetPoolIdSet"/><econdition field-name="statusId" value="AstAvailable"/><econdition field-name="quantityOnHandTotal" operator="greater" from="0.0"/><order-by field-name="receivedDate,assetId"/></entity-find><iterate list="assetList" entry="asset"><set field="curQuantity" from="asset.quantityOnHandTotal > quantityRemaining ? quantityRemaining : asset.quantityOnHandTotal"/><if condition="curQuantity"><service-call name="mantle.product.AssetServices.displace#AssetReservations" in-map="[assetId:asset.assetId, quantity:curQuantity]"/><service-call name="mantle.product.AssetServices.issue#Asset" in-map="baseMap + [quantity:curQuantity, issuedDate:issuedDate, assetId:asset.assetId]"/><set field="quantityRemaining" from="quantityRemaining - curQuantity"/><if condition="quantityRemaining == 0.0"><break/></if></if></iterate><if condition="quantityRemaining && facility?.assetAllowIssueOverQoh == 'Y'"><entity-find entity-name="mantle.product.asset.Asset" list="recentAssetList" limit="1"><econdition field-name="productId"/><econdition field-name="facilityId"/><econdition field-name="ownerPartyId" operator="in" from="ownerPartyIdSet" ignore="facility?.assetAllowOtherOwner == 'Y' || !ownerPartyIdSet"/><econdition field-name="assetPoolId" operator="in" from="assetPoolIdSet" ignore="!assetPoolIdSet" or-null="true"/><econdition field-name="assetPoolId" operator="is-null" ignore="assetPoolIdSet"/><econdition field-name="statusId" value="AstAvailable"/><order-by field-name="-receivedDate,-assetId"/></entity-find><if condition="recentAssetList"><then><service-call name="mantle.product.AssetServices.issue#Asset" in-map="baseMap + [quantity:quantityRemaining, issuedDate:issuedDate, assetId:recentAssetList[0].assetId]"/><set field="quantityRemaining" from="0.0"/></then><else><service-call name="mantle.product.AssetServices.create#ProductAssetAdHoc" out-map="[assetId:createAssetOut.assetId]" in-map="[productId:productId, facilityId:facilityId, ownerPartyId:vendorPartyId,                                     createdDate:nowTimestamp]"/><service-call name="mantle.product.AssetServices.issue#Asset" in-map="baseMap + [quantity:quantityRemaining, issuedDate:issuedDate, assetId:createAssetOut.assetId]"/><set field="quantityRemaining" from="0.0"/></else></if></if></if></actions></service>