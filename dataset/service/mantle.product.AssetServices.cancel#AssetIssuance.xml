<!--Service Location mantle.product.AssetServices.cancel#AssetIssuance--><service verb="cancel" noun="AssetIssuance"><in-parameters><parameter name="assetIssuanceId" required="true" entity-name="mantle.product.issuance.AssetIssuance" field-name="assetIssuanceId"/><parameter name="quantityToCancel" type="BigDecimal"><description><![CDATA[Defaults to AssetIssuance.quantity]]></description></parameter><parameter name="reserveAsset" type="Boolean" default="true"/><parameter name="orderId" entity-name="mantle.product.issuance.AssetIssuance" field-name="orderId"><description><![CDATA[For reservation after cancel issuance if AssetReservation no longer exists, defaults to AssetIssuance.orderId]]></description></parameter><parameter name="orderItemSeqId" entity-name="mantle.product.issuance.AssetIssuance" field-name="orderItemSeqId"><description><![CDATA[For reservation after cancel issuance if AssetReservation no longer exists, defaults to AssetIssuance.orderItemSeqId]]></description></parameter></in-parameters><out-parameters><parameter name="assetReservationId" entity-name="mantle.product.issuance.AssetIssuance" field-name="assetReservationId"/></out-parameters><actions><entity-find-one entity-name="mantle.product.issuance.AssetIssuance" value-field="assetIssuance" for-update="true"/><entity-find-one entity-name="mantle.product.asset.Asset" value-field="asset" for-update="true"><field-map field-name="assetId" from="assetIssuance.assetId"/></entity-find-one><if condition="quantityToCancel == null"><set field="quantityToCancel" from="assetIssuance.quantity"/></if><if condition="!quantityToCancel"><return message="No quantity to cancel for issuance ${assetIssuanceId} of asset ${assetIssuance.assetId}"/></if><if condition="quantityToCancel > assetIssuance.quantity"><return error="true" message="Quantity to cancel ${quantityToCancel} is greater than quantity ${assetIssuance.quantity} for asset issuance ${assetIssuanceId}"/></if><if condition="assetIssuance.invoiceId"><return error="true" message="Cannot cancel issuance ${assetIssuanceId}, already on invoice ${assetIssuance.invoiceId}"/></if><set field="quantityCancelled" from="(assetIssuance.quantityCancelled ?: 0.0) + quantityToCancel"/><set field="quantityRemaining" from="assetIssuance.quantity - quantityToCancel"/><service-call name="update#mantle.product.issuance.AssetIssuance" in-map="[assetIssuanceId:assetIssuanceId,                     quantity:quantityRemaining, quantityCancelled:quantityCancelled]"/><set field="cancelDate" from="ec.user.nowTimestamp"/><if condition="assetIssuance.assetReservationId"><entity-find-one entity-name="mantle.product.issuance.AssetReservation" value-field="oldReservation"><field-map field-name="assetReservationId" from="assetIssuance.assetReservationId"/></entity-find-one></if><service-call name="create#mantle.product.asset.AssetDetail" in-map="[assetId:assetIssuance.assetId,                         effectiveDate:cancelDate, quantityOnHandDiff:quantityToCancel,                         availableToPromiseDiff:(oldReservation != null ? 0.0 : quantityToCancel),                         productId:assetIssuance.productId, assetIssuanceId:assetIssuanceId,                         shipmentId:assetIssuance.shipmentId, workEffortId:assetIssuance.workEffortId,                         assetMaintenanceId:assetIssuance.assetMaintenanceId]"/><if condition="oldReservation != null"><then><set field="oldReservation.quantityNotIssued" from="(oldReservation.quantityNotIssued ?: 0.0) + quantityToCancel"/><entity-update value-field="oldReservation"/></then><else><if condition="reserveAsset && (orderId || assetIssuance.orderId)"><service-call name="mantle.product.AssetServices.reserve#AssetForOrderItem" in-map="[orderId:(orderId ?: assetIssuance.orderId), orderItemSeqId:(orderItemSeqId ?: assetIssuance.orderItemSeqId),                                 assetId:assetIssuance.assetId]"/></if></else></if><if condition="asset.serialNumber && quantityToCancel == 1.0"><set field="oldOwnerPartyId" from="asset.ownerPartyId"/><entity-find entity-name="moqui.entity.EntityAuditLog" list="ownerAuditLogList" limit="1"><econdition field-name="changedEntityName" value="mantle.product.asset.Asset"/><econdition field-name="changedFieldName" value="ownerPartyId"/><econdition field-name="pkPrimaryValue" from="asset.assetId"/><econdition field-name="newValueText" from="asset.ownerPartyId"/><econdition field-name="oldValueText" operator="is-not-null"/><order-by field-name="-changedDate"/></entity-find><if condition="ownerAuditLogList"><then><set field="oldOwnerPartyId" from="ownerAuditLogList[0].oldValueText"/></then><else><message type="warning"><![CDATA[No prior Owner Party for Asset ${asset.assetId} while canceling issuance ${assetIssuanceId}, leaving current owner]]></message></else></if><set field="oldStatusId" from="asset.statusId"/><entity-find entity-name="moqui.entity.EntityAuditLog" list="statusAuditLogList" limit="1"><econdition field-name="changedEntityName" value="mantle.product.asset.Asset"/><econdition field-name="changedFieldName" value="statusId"/><econdition field-name="pkPrimaryValue" from="asset.assetId"/><econdition field-name="newValueText" from="asset.statusId"/><econdition field-name="oldValueText" operator="is-not-null"/><order-by field-name="-changedDate"/></entity-find><if condition="statusAuditLogList"><then><set field="oldStatusId" from="statusAuditLogList[0].oldValueText"/></then><else><message type="warning"><![CDATA[No prior Status for Asset ${asset.assetId} while canceling issuance ${assetIssuanceId}, leaving current status]]></message></else></if><if condition="ownerAuditLogList || statusAuditLogList"><service-call name="update#mantle.product.asset.Asset" in-map="[assetId:asset.assetId, statusId:oldStatusId, ownerPartyId:oldOwnerPartyId]"/></if></if></actions></service>