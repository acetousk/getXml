<!--Service Location coarchy.CoarchyServices.create#Activity--><service verb="create" noun="Activity"><in-parameters><parameter name="processStoryId" required="true"/><parameter name="organizationId" required="true" entity-name="coarchy.Activity" field-name="organizationId"/><parameter name="condition" entity-name="coarchy.Activity" field-name="condition"/><parameter name="actorIdList" type="List"/><parameter name="statementIdList" type="List" default="[]"/><parameter name="action" entity-name="coarchy.Activity" field-name="action"/><parameter name="sequenceNum"/><parameter name="implementationId" entity-name="coarchy.Activity" field-name="implementationId"/><parameter name="ignoreNoAction" type="Boolean" default="false"/></in-parameters><out-parameters><parameter name="activityId" entity-name="coarchy.Activity" field-name="activityId"/><parameter name="processStoryActivityId"/><parameter name="sequenceNum"/></out-parameters><actions><if condition="!ignoreNoAction && !action.trim()"><return type="warning" message="${ec.resource.expand('CoarchyProcessActivityActionRequired',null)}"/></if><set field="condition" from="condition?.trim()"/><set field="action" from="action?.trim()"/><if condition="condition?.length() > 0 || actorIdList.size() > 0"><then><if condition="Character.isUpperCase(action.charAt(0))"><set field="action" from="action[0].toLowerCase() + action.substring(1)"/></if></then><else-if condition="Character.isLowerCase(action.charAt(0))"><set field="action" from="action[0].toUpperCase() + action.substring(1)"/></else-if></if><service-call name="create#coarchy.Activity" in-map="[condition:condition, action:action, organizationId:organizationId, implementationId:implementationId]" out-map="[activityId:newActivity.activityId,condition:newActivity.condition,action:newActivity.action,replacedByActivityId:newActivity.replacedByActivityId,implementationId:newActivity.implementationId,organizationId:newActivity.organizationId,lastUpdatedStamp:newActivity.lastUpdatedStamp]"/><set field="activityId" from="newActivity.activityId"/><set field="newSequenceNum" from="sequenceNum"/><if condition="!sequenceNum"><entity-find entity-name="coarchy.ProcessStoryActivity" limit="1" list="processStoryActivityList"><date-filter/><econdition field-name="processStoryId"/><order-by field-name="-sequenceNum"/></entity-find><set field="highestProcessStoryActivity" from="processStoryActivityList?.getFirst()"/><set field="newSequenceNum" from="highestProcessStoryActivity?.sequenceNum != null ? highestProcessStoryActivity?.sequenceNum + 1 : 0"/></if><service-call name="create#coarchy.ProcessStoryActivity" in-map="[processStoryId:processStoryId,activityId:newActivity.activityId, sequenceNum:newSequenceNum, fromDate:ec.user.nowTimestamp, organizationId:organizationId]" out-map="[processStoryActivityId:newStoryActivity.processStoryActivityId,processStoryId:newStoryActivity.processStoryId,activityId:newStoryActivity.activityId,sequenceNum:newStoryActivity.sequenceNum,detailProcessStoryId:newStoryActivity.detailProcessStoryId,fromDate:newStoryActivity.fromDate,thruDate:newStoryActivity.thruDate,organizationId:newStoryActivity.organizationId,lastUpdatedStamp:newStoryActivity.lastUpdatedStamp]"/><set field="processStoryActivityId" from="newStoryActivity.processStoryActivityId"/><set field="sequenceNum" from="newStoryActivity.sequenceNum"/><if condition="actorIdList?.size() != 0 && actorIdList instanceof String"><then><service-call name="store#coarchy.ActivityActor" in-map="[activityId:newActivity.activityId, actorId:actorIdList, organizationId:organizationId]"/></then><else><iterate list="actorIdList" entry="actorId"><service-call name="store#coarchy.ActivityActor" in-map="[activityId:newActivity.activityId, actorId:actorId, organizationId:organizationId]"/></iterate></else></if><iterate list="statementIdList" entry="statementId"><service-call name="store#coarchy.ValueStatementActivity" in-map="[activityId:newActivity.activityId, valueStatementId:statementId, organizationId:organizationId]"/></iterate></actions></service>