<!--Service Location mantle.shipment.ShipmentServices.receive#ShipmentProduct--><service verb="receive" noun="ShipmentProduct"><in-parameters><parameter name="shipmentId" required="true"/><parameter name="parentAssetId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="parentAssetId"/><parameter name="assetTypeEnumId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="assetTypeEnumId"/><parameter name="classEnumId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="classEnumId"/><parameter name="statusId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="statusId"/><parameter name="ownerPartyId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="ownerPartyId"/><parameter name="assetPoolId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="assetPoolId"/><parameter name="productId" type="java.lang.String" required="true" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="productId"/><parameter name="hasQuantity" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="hasQuantity"/><parameter name="quantityOnHandTotal" type="java.math.BigDecimal" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="quantityOnHandTotal"/><parameter name="availableToPromiseTotal" type="java.math.BigDecimal" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="availableToPromiseTotal"/><parameter name="originalQuantity" type="java.math.BigDecimal" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="originalQuantity"/><parameter name="originalQuantityUomId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="originalQuantityUomId"/><parameter name="assetName" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="assetName"/><parameter name="comments" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="comments"/><parameter name="serialNumber" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="serialNumber"/><parameter name="softIdentifier" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="softIdentifier"/><parameter name="activationNumber" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="activationNumber"/><parameter name="activationValidThru" type="java.sql.Timestamp" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="activationValidThru"/><parameter name="receivedDate" type="java.sql.Timestamp" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="receivedDate"/><parameter name="acquiredDate" type="java.sql.Timestamp" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="acquiredDate"/><parameter name="manufacturedDate" type="java.sql.Timestamp" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="manufacturedDate"/><parameter name="expectedEndOfLife" type="java.sql.Date" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="expectedEndOfLife"/><parameter name="actualEndOfLife" type="java.sql.Date" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="actualEndOfLife"/><parameter name="capacity" type="java.math.BigDecimal" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="capacity"/><parameter name="capacityUomId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="capacityUomId"/><parameter name="facilityId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="facilityId"><description><![CDATA[If not specified uses ShipmentRouteSegment.destinationFacilityId.]]></description></parameter><parameter name="locationSeqId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="locationSeqId"/><parameter name="containerId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="containerId"/><parameter name="shipmentBoxTypeId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="shipmentBoxTypeId"/><parameter name="lotId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="lotId"/><parameter name="geoPointId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="geoPointId"/><parameter name="originId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="originId"/><parameter name="originFacilityId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="originFacilityId"/><parameter name="acquireOrderId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="acquireOrderId"/><parameter name="acquireOrderItemSeqId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="acquireOrderItemSeqId"/><parameter name="acquireWorkEffortId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="acquireWorkEffortId"/><parameter name="acquireShipmentId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="acquireShipmentId"/><parameter name="acquireCost" type="java.math.BigDecimal" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="acquireCost"/><parameter name="acquireCostUomId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="acquireCostUomId"/><parameter name="salvageValue" type="java.math.BigDecimal" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="salvageValue"/><parameter name="depreciation" type="java.math.BigDecimal" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="depreciation"/><parameter name="depreciationTypeEnumId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="depreciationTypeEnumId"/><parameter name="yearBeginDepreciation" type="java.math.BigDecimal" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="yearBeginDepreciation"/><parameter name="taxDepreciation" type="java.math.BigDecimal" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="taxDepreciation"/><parameter name="taxDepreciationTypeEnumId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="taxDepreciationTypeEnumId"/><parameter name="lastUpdatedStamp" type="java.sql.Timestamp" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="lastUpdatedStamp"/><parameter name="quantityAccepted" type="BigDecimal" required="true"/><parameter name="quantityRejected" type="BigDecimal" default="0.0"/><parameter name="rejectionReasonEnumId"/><parameter name="lotNumber"/><parameter name="expirationDate" type="Date"/><parameter name="mfgPartyId"><description><![CDATA[Defaults to Shipment.fromPartyId (if lotNumber and no lotId)]]></description></parameter></in-parameters><out-parameters><parameter name="assetIdList" type="List"><parameter name="assetId"/></parameter></out-parameters><actions><if condition="quantityAccepted < 0.0"><return error="true" message="Quantity Accepted may not be negative"/></if><if condition="quantityRejected != null && quantityRejected < 0.0"><return error="true" message="Quantity Rejected may not be negative"/></if><if condition="!facilityId"><entity-find entity-name="mantle.shipment.ShipmentRouteSegment" list="shipmentRouteSegmentList"><econdition field-name="shipmentId"/><order-by field-name="-shipmentRouteSegmentSeqId"/></entity-find><set field="facilityId" from="shipmentRouteSegmentList?.first?.destinationFacilityId"/></if><if condition="!facilityId"><return error="true" message="Cannot receive Product ${productId} on Shipment ${shipmentId}, no facilityId specified."/></if><if condition="!lotId && lotNumber && !mfgPartyId"><entity-find-one entity-name="mantle.shipment.Shipment" value-field="shipment"/><set field="mfgPartyId" from="shipment.fromPartyId"/></if><entity-find entity-name="mantle.shipment.ShipmentItemSource" list="shipmentItemSourceList" cache="false"><econdition field-name="shipmentId"/><econdition field-name="productId"/></entity-find><set field="assetIdList" from="[]"/><set field="quantityAcceptedRemaining" from="quantityAccepted"/><set field="quantityRejectedRemaining" from="quantityRejected"/><iterate list="shipmentItemSourceList" entry="shipmentItemSource"><set field="updateQuantityNotHandled" from="shipmentItemSource.quantityNotHandled > 0.0"/><set field="quantityNotHandled" from="shipmentItemSource.quantity"/><entity-find entity-name="mantle.product.receipt.AssetReceipt" list="assetReceiptList"><econdition field-name="shipmentItemSourceId" from="shipmentItemSource.shipmentItemSourceId"/></entity-find><iterate list="assetReceiptList" entry="assetReceipt"><set field="quantityNotHandled" from="quantityNotHandled - (assetReceipt.quantityAccepted ?: 0.0) - (assetReceipt.quantityRejected ?: 0.0)"/></iterate><set field="quantityToAccept" from="quantityNotHandled > quantityAcceptedRemaining ? quantityAcceptedRemaining : quantityNotHandled"/><set field="quantityAcceptedRemaining" from="quantityAcceptedRemaining > quantityNotHandled ? quantityAcceptedRemaining - quantityNotHandled : 0.0"/><set field="quantityNotHandled" from="quantityNotHandled - quantityToAccept"/><set field="quantityToReject" from="quantityNotHandled > quantityRejectedRemaining ? quantityRejectedRemaining : quantityNotHandled"/><set field="quantityRejectedRemaining" from="quantityRejectedRemaining > quantityNotHandled ? quantityRejectedRemaining - quantityNotHandled : 0.0"/><set field="quantityNotHandled" from="quantityNotHandled - quantityToReject"/><service-call name="mantle.product.AssetServices.receive#Asset" out-map="[assetId:receiveAssetOut.assetId,assetReceiptId:receiveAssetOut.assetReceiptId,assetDetailId:receiveAssetOut.assetDetailId]" in-map="context + [shipmentItemSourceId:shipmentItemSource.shipmentItemSourceId, shipmentPackageSeqId:null,                             orderId:shipmentItemSource.orderId, orderItemSeqId:shipmentItemSource.orderItemSeqId,                             returnId:shipmentItemSource.returnId, returnItemSeqId:shipmentItemSource.returnItemSeqId,                             quantity:quantityToAccept, quantityRejected:quantityToReject]"/><script><![CDATA[assetIdList.add(receiveAssetOut.assetId)]]></script><if condition="quantityNotHandled <= 0"><set field="shipmentItemSource.statusId" value="SisReceived"/></if><if condition="updateQuantityNotHandled"><set field="shipmentItemSource.quantityNotHandled" from="quantityNotHandled"/></if><entity-update value-field="shipmentItemSource"/><if condition="shipmentItemSource.orderId && shipmentItemSource.orderItemSeqId"><entity-find-one entity-name="mantle.order.OrderItem" value-field="orderItem"><field-map field-name="orderId" from="shipmentItemSource.orderId"/><field-map field-name="orderItemSeqId" from="shipmentItemSource.orderItemSeqId"/></entity-find-one><service-call name="mantle.order.OrderServices.checkComplete#OrderPart" in-map="[orderId:orderItem.orderId, orderPartSeqId:orderItem.orderPartSeqId]"/></if></iterate><if condition="quantityAcceptedRemaining > 0 || quantityRejectedRemaining > 0"><service-call name="mantle.product.AssetServices.receive#Asset" out-map="[assetId:receiveAssetOut.assetId,assetReceiptId:receiveAssetOut.assetReceiptId,assetDetailId:receiveAssetOut.assetDetailId]" in-map="context + [productId:productId, quantity:quantityAcceptedRemaining, shipmentId:shipmentId,                             facilityId:facilityId, quantityRejected:quantityRejectedRemaining, rejectionReasonEnumId:rejectionReasonEnumId]"/><script><![CDATA[assetIdList.add(receiveAssetOut.assetId)]]></script></if></actions></service>