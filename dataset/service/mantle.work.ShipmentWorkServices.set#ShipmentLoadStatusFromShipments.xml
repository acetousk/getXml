<!--Service Location mantle.work.ShipmentWorkServices.set#ShipmentLoadStatusFromShipments--><service verb="set" noun="ShipmentLoadStatusFromShipments"><in-parameters><parameter name="workEffortId" required="true"/></in-parameters><out-parameters/><actions><entity-find-one entity-name="mantle.work.effort.WorkEffort" value-field="workEffort" for-update="true"/><if condition="workEffort?.purposeEnumId != 'WepShipmentShip'"><return/></if><set field="weStatusId" from="workEffort.statusId"/><entity-find entity-name="mantle.shipment.Shipment" list="shipmentStatusList" distinct="true"><econdition field-name="shipWorkEffortId" from="workEffortId"/><select-field field-name="statusId"/></entity-find><if condition="shipmentStatusList.size() == 0"><return/></if><set field="shipmentStatusIdSet" from="new HashSet(shipmentStatusList*.statusId)"/><if condition="shipmentStatusIdSet.contains('ShipCancelled') && shipmentStatusIdSet.size() == 1"><if condition="weStatusId != 'WeCancelled' && weStatusId != 'WeClosed'"><service-call name="update#mantle.work.effort.WorkEffort" in-map="[workEffortId:workEffortId, statusId:'WeCancelled']"/></if><return/></if><set field="allShipmentStatusIds" from="['ShipInput', 'ShipScheduled', 'ShipPicked', 'ShipPacked',                 'ShipShipped', 'ShipDelivered', 'ShipRejected', 'ShipCancelled']"/><set field="targetStatusId" from="null"/><set field="weClosedStatusIds" from="['ShipShipped', 'ShipDelivered', 'ShipRejected', 'ShipCancelled']"/><if condition="!targetStatusId && !shipmentStatusIdSet.disjoint(weClosedStatusIds) &&                     shipmentStatusIdSet.disjoint(allShipmentStatusIds - weClosedStatusIds)"><set field="targetStatusId" value="WeClosed"/></if><set field="weCompleteStatusIds" from="['ShipPicked', 'ShipPacked', 'ShipShipped', 'ShipDelivered', 'ShipRejected', 'ShipCancelled']"/><if condition="!targetStatusId && !shipmentStatusIdSet.disjoint(weCompleteStatusIds) &&                     shipmentStatusIdSet.disjoint(allShipmentStatusIds - weCompleteStatusIds)"><set field="targetStatusId" value="WeComplete"/></if><set field="weInProgressStatusIds" from="['ShipPicked', 'ShipPacked', 'ShipShipped', 'ShipDelivered', 'ShipRejected']"/><if condition="!targetStatusId && !shipmentStatusIdSet.disjoint(weInProgressStatusIds)"><set field="targetStatusId" value="WeInProgress"/></if><if condition="targetStatusId"><then><if condition="targetStatusId != weStatusId"><entity-find entity-name="moqui.basic.StatusFlowTransition" list="transitionList"><econdition field-name="statusId" from="weStatusId"/><econdition field-name="toStatusId" from="targetStatusId"/></entity-find><if condition="transitionList"><then><service-call name="update#mantle.work.effort.WorkEffort" in-map="[workEffortId:workEffortId, statusId:targetStatusId]"/></then><else><message type="danger"><![CDATA[Could not change status for picklist ${workEffortId}, transition not valid from ${weStatusId} to ${targetStatusId}]]></message></else></if></if></then><else><if condition="weStatusId in ['WeComplete', 'WeClosed', 'WeCancelled']"><service-call name="update#mantle.work.effort.WorkEffort" in-map="[workEffortId:workEffortId, statusId:'WeInProgress']"/></if></else></if></actions></service>