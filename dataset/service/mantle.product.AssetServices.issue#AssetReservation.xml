<!--Service Location mantle.product.AssetServices.issue#AssetReservation--><service verb="issue" noun="AssetReservation"><in-parameters><parameter name="assetReservation" type="EntityValue" required="true"/><parameter name="shipmentId"/><parameter name="shipmentItemSourceId"/><parameter name="workEffortId"/><parameter name="quantity" type="BigDecimal" required="true" entity-name="mantle.product.issuance.AssetReservation" field-name="quantity"/><parameter name="issuedDate" type="Timestamp" default="ec.user.nowTimestamp"/></in-parameters><out-parameters/><actions><if condition="quantity == 0.0"><return type="warning" message="Not issuing zero quantity against AssetReservation ${assetReservation?.assetReservationId}"/></if><if condition="quantity > assetReservation.quantityNotIssued"><return error="true" message="For reservation ${assetReservation.assetReservationId} tried to issue quantity ${quantity} which is greater than quantity not issued ${assetReservation.quantityNotIssued} for the reservation"/></if><set field="asset" from="assetReservation.asset"/><entity-find-one entity-name="mantle.facility.Facility" value-field="facility" cache="true"><field-map field-name="facilityId" from="asset?.facilityId"/></entity-find-one><if condition="facility?.assetAllowIssueOverQoh != 'Y'"><if condition="quantity > asset.quantityOnHandTotal"><return error="true" message="For reservation ${assetReservation.assetReservationId} tried to issue quantity ${quantity} which is greater than quantity on hand ${asset.quantityOnHandTotal} for asset ${asset.assetId}"/></if></if><if condition="shipmentItemSourceId"><entity-find-one entity-name="mantle.shipment.ShipmentItemSource" value-field="shipmentItemSource"/><if condition="!shipmentId"><set field="shipmentId" from="shipmentItemSource.shipmentId"/></if></if><entity-find entity-name="mantle.product.issuance.AssetIssuance" list="existingIssuanceList"><econdition field-name="shipmentId" ignore-if-empty="true"/><econdition field-name="shipmentItemSourceId" ignore-if-empty="true"/><econdition field-name="workEffortId" ignore-if-empty="true"/><econdition field-name="assetReservationId" from="assetReservation.assetReservationId"/><econdition field-name="assetId" from="assetReservation.assetId"/><econdition field-name="orderId" from="assetReservation.orderId" ignore-if-empty="true"/><econdition field-name="orderItemSeqId" from="assetReservation.orderItemSeqId" ignore-if-empty="true"/></entity-find><if condition="existingIssuanceList"><then><set field="existingIssuance" from="existingIssuanceList[0]"/><set field="assetIssuanceId" from="existingIssuance.assetIssuanceId"/><service-call name="update#mantle.product.issuance.AssetIssuance" in-map="[assetIssuanceId:assetIssuanceId, quantity:(existingIssuance.quantity + quantity),                             invoiceId:(existingIssuance.invoiceId ?: shipmentItemSource?.invoiceId),                             invoiceItemSeqId:(existingIssuance.invoiceItemSeqId ?: shipmentItemSource?.invoiceItemSeqId)]"/></then><else><service-call name="create#mantle.product.issuance.AssetIssuance" out-map="[assetIssuanceId:context.assetIssuanceId,assetId:context.assetId,assetReservationId:context.assetReservationId,orderId:context.orderId,orderItemSeqId:context.orderItemSeqId,shipmentId:context.shipmentId,shipmentItemSourceId:context.shipmentItemSourceId,productId:context.productId,invoiceId:context.invoiceId,invoiceItemSeqId:context.invoiceItemSeqId,returnId:context.returnId,returnItemSeqId:context.returnItemSeqId,workEffortId:context.workEffortId,facilityId:context.facilityId,assetMaintenanceId:context.assetMaintenanceId,issuedByUserId:context.issuedByUserId,issuedDate:context.issuedDate,quantity:context.quantity,quantityCancelled:context.quantityCancelled,acctgTransResultEnumId:context.acctgTransResultEnumId,lastUpdatedStamp:context.lastUpdatedStamp]" in-map="[assetId:assetReservation.assetId, assetReservationId:assetReservation.assetReservationId,                             orderId:assetReservation.orderId, orderItemSeqId:assetReservation.orderItemSeqId,                             invoiceId:shipmentItemSource?.invoiceId, invoiceItemSeqId:shipmentItemSource?.invoiceItemSeqId,                             shipmentId:shipmentId, shipmentItemSourceId:shipmentItemSourceId,                             workEffortId:workEffortId, productId:assetReservation.productId,                             issuedDate:issuedDate, issuedByUserId:ec.user.userId, quantity:quantity]"/></else></if><service-call name="create#mantle.product.asset.AssetDetail" in-map="[assetId:assetReservation.assetId,                     effectiveDate:issuedDate, quantityOnHandDiff:-quantity,                     assetReservationId:assetReservation.assetReservationId, shipmentId:shipmentId, workEffortId:workEffortId,                     productId:assetReservation.productId, assetIssuanceId:assetIssuanceId,                     orderId:assetReservation.orderId, orderItemSeqId:assetReservation.orderItemSeqId]"/><set field="assetReservation.quantityNotIssued" from="assetReservation.quantityNotIssued - quantity"/><if condition="assetReservation.quantityNotIssued == 0.0"><then><entity-delete value-field="assetReservation"/></then><else><entity-update value-field="assetReservation"/></else></if><if condition="asset.serialNumber && quantity == 1.0 && (asset.quantityOnHandTotal == 1.0 || asset.hasQuantity == 'N')"><set field="ownerPartyId" from="asset.ownerPartyId"/><if condition="assetReservation.orderId && assetReservation.orderItemSeqId"><set field="orderItem" from="assetReservation.orderItem"/><set field="orderPart" from="orderItem?.part"/><if condition="orderPart?.customerPartyId"><set field="ownerPartyId" from="orderPart.customerPartyId"/></if></if><service-call name="update#mantle.product.asset.Asset" in-map="[assetId:asset.assetId, statusId:'AstDelivered', ownerPartyId:ownerPartyId]"/></if></actions></service>