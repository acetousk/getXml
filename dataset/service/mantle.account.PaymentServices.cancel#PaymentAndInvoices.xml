<!--Service Location mantle.account.PaymentServices.cancel#PaymentAndInvoices--><service verb="cancel" noun="PaymentAndInvoices"><in-parameters><parameter name="paymentId" required="true"/></in-parameters><out-parameters/><actions><entity-find-one entity-name="mantle.account.payment.Payment" value-field="payment"/><if condition="!(payment.statusId in ['PmntProposed', 'PmntPromised', 'PmntAuthorized', 'PmntDelivered'])"><return error="true" message="Payment ${paymentId} must be in Proposed or Promised status to be cancelled, or Authorized or Delivered status to be voided"/></if><set field="invoiceIdSet" from="new TreeSet()"/><if condition="payment.forInvoiceId"><script><![CDATA[invoiceIdSet.add(payment.forInvoiceId)]]></script></if><entity-find entity-name="mantle.account.payment.PaymentApplication" list="paymentApplicationList"><econdition field-name="paymentId"/></entity-find><iterate list="paymentApplicationList" entry="paymentApplication"><if condition="paymentApplication.invoiceId"><script><![CDATA[invoiceIdSet.add(paymentApplication.invoiceId)]]></script></if></iterate><set field="targetStatusId" from="payment.statusId in ['PmntProposed', 'PmntPromised'] ? 'PmntCancelled' : 'PmntVoid'"/><service-call name="update#mantle.account.payment.Payment" in-map="[paymentId:paymentId, statusId:targetStatusId]"/><iterate list="invoiceIdSet" entry="invoiceId"><service-call name="update#mantle.account.invoice.Invoice" in-map="[invoiceId:invoiceId, statusId:'InvoiceCancelled']"/></iterate></actions></service>