<!--Service Location mantle.account.FinancialAccountServices.withdraw#FinancialAccount--><service verb="withdraw" noun="FinancialAccount"><in-parameters><parameter name="finAccountId" type="java.lang.String" required="true" allow-html="none" entity-name="mantle.account.financial.FinancialAccountTrans" field-name="finAccountId"/><parameter name="finAccountAuthId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.financial.FinancialAccountTrans" field-name="finAccountAuthId"/><parameter name="fromPartyId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.financial.FinancialAccountTrans" field-name="fromPartyId"/><parameter name="toPartyId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.financial.FinancialAccountTrans" field-name="toPartyId"/><parameter name="glReconciliationId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.financial.FinancialAccountTrans" field-name="glReconciliationId"/><parameter name="reasonEnumId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.financial.FinancialAccountTrans" field-name="reasonEnumId" default-value="FatrDisbursement"/><parameter name="transactionDate" type="Timestamp" required="false" allow-html="none" entity-name="mantle.account.financial.FinancialAccountTrans" field-name="transactionDate" default="ec.user.nowTimestamp"/><parameter name="entryDate" type="Timestamp" required="false" allow-html="none" entity-name="mantle.account.financial.FinancialAccountTrans" field-name="entryDate" default="ec.user.nowTimestamp"/><parameter name="amount" type="BigDecimal" required="true" allow-html="none" entity-name="mantle.account.financial.FinancialAccountTrans" field-name="amount"/><parameter name="postBalance" type="java.math.BigDecimal" required="false" allow-html="none" entity-name="mantle.account.financial.FinancialAccountTrans" field-name="postBalance"/><parameter name="paymentId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.financial.FinancialAccountTrans" field-name="paymentId"/><parameter name="invoiceId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.financial.FinancialAccountTrans" field-name="invoiceId"/><parameter name="invoiceItemSeqId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.financial.FinancialAccountTrans" field-name="invoiceItemSeqId"/><parameter name="orderId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.financial.FinancialAccountTrans" field-name="orderId"/><parameter name="orderItemSeqId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.financial.FinancialAccountTrans" field-name="orderItemSeqId"/><parameter name="otherFinAccountTransId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.financial.FinancialAccountTrans" field-name="otherFinAccountTransId"/><parameter name="performedByUserId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.financial.FinancialAccountTrans" field-name="performedByUserId"/><parameter name="acctgTransResultEnumId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.financial.FinancialAccountTrans" field-name="acctgTransResultEnumId"/><parameter name="reversedByTransId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.financial.FinancialAccountTrans" field-name="reversedByTransId"/><parameter name="reverseOfTransId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.financial.FinancialAccountTrans" field-name="reverseOfTransId"/><parameter name="comments" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.financial.FinancialAccountTrans" field-name="comments"/><parameter name="externalId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.financial.FinancialAccountTrans" field-name="externalId"/><parameter name="lastUpdatedStamp" type="java.sql.Timestamp" required="false" allow-html="none" entity-name="mantle.account.financial.FinancialAccountTrans" field-name="lastUpdatedStamp"/></in-parameters><out-parameters><parameter name="amount" type="BigDecimal"/><parameter name="preBalance" type="BigDecimal"/><parameter name="postBalance" type="BigDecimal"/><parameter name="finAccountTransId"/><parameter name="responseCode"><description><![CDATA[May be 'success' or 'nsf']]></description></parameter><parameter name="responseMessage"/></out-parameters><actions><if condition="amount < 0.0"><return error="true" message="Cannot withdraw negative amount ${amount}, do a deposit instead"/></if><set field="amount" from="amount.setScale(2, BigDecimal.ROUND_HALF_UP)"/><set field="performedByUserId" from="ec.user.userId"/><entity-find-one entity-name="mantle.account.financial.FinancialAccount" value-field="financialAccount" for-update="true"/><set field="preBalance" from="financialAccount.actualBalance ?: 0.0"/><set field="balancePlusCredit" from="preBalance + (financialAccount.negativeBalanceLimit ?: 0)"/><if condition="balancePlusCredit < amount"><set field="responseCode" value="nsf"/><set field="responseMessage" value="Insufficient funds: ${ec.l10n.format(balancePlusCredit, '0.00')} can be withdrawn, withdraw amount ${ec.l10n.format(amount, '0.00')}"/><return/></if><if condition="!fromPartyId"><set field="fromPartyId" from="financialAccount.ownerPartyId"/></if><if condition="!toPartyId"><set field="toPartyId" from="financialAccount.organizationPartyId"/></if><set field="amount" from="-amount"/><set field="postBalance" from="preBalance + amount"/><set field="finAccountTransTypeEnumId" value="FattWithdraw"/><service-call name="create#mantle.account.financial.FinancialAccountTrans" in-map="context" out-map="[finAccountTransId:context.finAccountTransId,finAccountTransTypeEnumId:context.finAccountTransTypeEnumId,finAccountId:context.finAccountId,finAccountAuthId:context.finAccountAuthId,fromPartyId:context.fromPartyId,toPartyId:context.toPartyId,glReconciliationId:context.glReconciliationId,reasonEnumId:context.reasonEnumId,transactionDate:context.transactionDate,entryDate:context.entryDate,amount:context.amount,postBalance:context.postBalance,paymentId:context.paymentId,invoiceId:context.invoiceId,invoiceItemSeqId:context.invoiceItemSeqId,orderId:context.orderId,orderItemSeqId:context.orderItemSeqId,otherFinAccountTransId:context.otherFinAccountTransId,performedByUserId:context.performedByUserId,acctgTransResultEnumId:context.acctgTransResultEnumId,reversedByTransId:context.reversedByTransId,reverseOfTransId:context.reverseOfTransId,comments:context.comments,externalId:context.externalId,lastUpdatedStamp:context.lastUpdatedStamp]"/><service-call name="update#mantle.account.financial.FinancialAccount" in-map="[finAccountId:finAccountId, actualBalance:postBalance]"/><if condition="finAccountAuthId"><service-call name="update#mantle.account.financial.FinancialAccountAuth" in-map="[finAccountAuthId:finAccountAuthId, expireDate:ec.user.nowTimestamp]"/></if><service-call name="mantle.account.FinancialAccountServices.calculate#FinancialAccountTotals" in-map="[finAccountId:finAccountId]" out-map="[currencyUomId:totalsOut.currencyUomId,actualBalance:totalsOut.actualBalance,authBalance:totalsOut.authBalance,availableBalance:totalsOut.availableBalance]"/><set field="postBalance" from="totalsOut.actualBalance"/><set field="differAmount" from="postBalance - preBalance"/><if condition="differAmount != amount"><return error="true" message="Error withdrawing from financial account ${ec.resource.expand('FinancialAccountNameTemplate','',financialAccount)}, pre balance ${preBalance} and post balance ${postBalance} differ by ${differAmount} and not by transaction amount ${amount}"/></if><set field="responseCode" value="success"/><set field="responseMessage" value="Withdrew ${ec.l10n.format(amount, '0.00')} from account ${ec.resource.expand('FinancialAccountNameTemplate','',financialAccount)}"/></actions></service>