<!--Service Location mantle.shipment.CarrierServices.get#ShipmentGatewayDetails--><service verb="get" noun="ShipmentGatewayDetails"><in-parameters><parameter name="shipmentId" required="true"/><parameter name="shipmentRouteSegmentSeqId"><description><![CDATA[Defaults to the first route segment]]></description></parameter></in-parameters><out-parameters><parameter name="shipmentRouteSegmentSeqId"/><parameter name="routeSegment" type="EntityValue"/><parameter name="shippingGatewayConfigId"/><parameter name="shippingGatewayConfig" type="EntityValue"/></out-parameters><actions><entity-find-one entity-name="mantle.shipment.Shipment" value-field="shipment"/><if condition="shipmentRouteSegmentSeqId"><then><entity-find-one entity-name="mantle.shipment.ShipmentRouteSegment" value-field="routeSegment"/></then><else><entity-find entity-name="mantle.shipment.ShipmentRouteSegment" list="routeSegmentList"><econdition field-name="shipmentId"/><order-by field-name="shipmentRouteSegmentSeqId"/></entity-find><set field="routeSegment" from="routeSegmentList[0]"/><set field="shipmentRouteSegmentSeqId" from="routeSegment.shipmentRouteSegmentSeqId"/></else></if><if condition="shipment.productStoreId && routeSegment.carrierPartyId"><entity-find-one entity-name="mantle.product.store.ProductStoreShippingGateway" value-field="storeGateway"><field-map field-name="productStoreId" from="shipment.productStoreId"/><field-map field-name="carrierPartyId" from="routeSegment.carrierPartyId"/></entity-find-one><set field="shippingGatewayConfigId" from="storeGateway?.shippingGatewayConfigId"/></if><if condition="!shippingGatewayConfigId"><set field="shippingGatewayConfigId" from="routeSegment.shippingGatewayConfigId"/></if><if condition="!shippingGatewayConfigId"><entity-find-one entity-name="mantle.shipment.Shipment" value-field="shipment"/><if condition="shipment?.fromPartyId"><service-call name="mantle.party.PartyServices.get#PartySettingValue" out-map="[settingValue:ptySettingOut.settingValue]" in-map="[partyId:shipment.fromPartyId, partySettingTypeId:'DefaultShipmentGatewayConfigId']"/><set field="shippingGatewayConfigId" from="ptySettingOut?.settingValue"/></if></if><if condition="!shippingGatewayConfigId"><set field="shippingGatewayConfigId" from="ec.user.getPreference('DefaultShipmentGatewayConfigId')"/></if><if condition="!shippingGatewayConfigId"><return error="true" message="No shipping gateway set on shipment and no default preference set"/></if><entity-find-one entity-name="mantle.shipment.carrier.ShippingGatewayConfig" value-field="shippingGatewayConfig"/><if condition="shippingGatewayConfig == null"><log level="error" message="No ShippingGatewayConfig found with ID ${shippingGatewayConfigId}"/><return/></if><if condition="routeSegment.shippingGatewayConfigId != shippingGatewayConfigId"><set field="routeSegment.shippingGatewayConfigId" from="shippingGatewayConfigId"/><entity-update value-field="routeSegment"/></if></actions></service>