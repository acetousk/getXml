<!--Service Location mantle.account.PaymentMethodServices.cancel#PaymentMethodFile--><service verb="cancel" noun="PaymentMethodFile"><in-parameters><parameter name="paymentMethodFileId" required="true" entity-name="mantle.account.method.PaymentMethodFile" field-name="paymentMethodFileId"/><parameter name="outgoingStatusId" default-value="PmntAuthorized"/><parameter name="incomingStatusId" default-value="PmntAuthorized"/></in-parameters><out-parameters/><actions><entity-find-one entity-name="mantle.account.method.PaymentMethodFile" value-field="paymentMethodFile"/><if condition="paymentMethodFile.isCancelled == 'Y'"><return type="danger" message="File ${paymentMethodFileId} already cancelled"/></if><set field="fileTypeEnum" from="paymentMethodFile.fileTypeEnum"/><set field="paymentMethodFileType" from="paymentMethodFile.paymentMethodFileType"/><if condition="paymentMethodFileType?.systemMessageTypeId && paymentMethodFileType?.systemMessageRemoteId"><entity-find entity-name="moqui.service.message.SystemMessage" list="systemMessageList"><econdition field-name="paymentMethodFileId"/><econdition field-name="systemMessageTypeId" from="paymentMethodFileType.systemMessageTypeId"/><econdition field-name="systemMessageRemoteId" from="paymentMethodFileType.systemMessageRemoteId"/><econdition field-name="statusId" operator="not-in" value="SmsgRejected,SmsgCancelled"/><select-field field-name="systemMessageId,statusId"/><order-by field-name="systemMessageId"/></entity-find><set field="sysMesStatusIdList" from="systemMessageList*.statusId"/><if condition="sysMesStatusIdList.contains('SmsgSending') || sysMesStatusIdList.contains('SmsgSent') || sysMesStatusIdList.contains('SmsgConfirmed')"><return type="danger" message="File ${paymentMethodFileId} already sent in SystemMessage ${systemMessageList*.systemMessageId}"/></if><iterate list="systemMessageList" entry="systemMessage"><service-call name="org.moqui.impl.SystemMessageServices.cancel#SystemMessage" in-map="[systemMessageId:systemMessage.systemMessageId]"/></iterate></if><entity-find entity-name="mantle.account.payment.Payment" list="paymentList" for-update="true"><econdition field-name="paymentMethodFileId"/><order-by field-name="paymentId"/></entity-find><iterate list="paymentList" entry="payment"><set field="payment.paymentMethodFileId" from="null"/><if condition="payment.statusId == 'PmntDelivered' && fileTypeEnum?.optionIndicator == 'Y'"><if condition="payment.paymentMethodId == paymentMethodFile.paymentMethodId"><then><set field="payment.statusId" from="outgoingStatusId"/></then><else><set field="payment.statusId" from="incomingStatusId"/></else></if></if><entity-update value-field="payment"/></iterate><set field="paymentMethodFile.entryCount" from="0"/><set field="paymentMethodFile.debitAmountTotal" from="0.0"/><set field="paymentMethodFile.creditAmountTotal" from="0.0"/><set field="paymentMethodFile.isCancelled" value="Y"/><entity-update value-field="paymentMethodFile"/></actions></service>