<!--Service Location mantle.ledger.AssetAutoPostServices.post#PhysicalInventoryVariance--><service verb="post" noun="PhysicalInventoryVariance"><in-parameters><parameter name="assetDetailId" required="true"/></in-parameters><out-parameters><parameter name="acctgTransId"/></out-parameters><actions><entity-find-one entity-name="mantle.product.asset.AssetDetail" value-field="assetDetail" for-update="true"/><if condition="!assetDetail.physicalInventoryId"><return/></if><if condition="!assetDetail.quantityOnHandDiff"><return/></if><set field="assetId" from="assetDetail.assetId"/><set field="physicalInventoryId" from="assetDetail.physicalInventoryId"/><entity-find-one entity-name="mantle.product.asset.Asset" value-field="asset" for-update="true"/><entity-find-one entity-name="mantle.product.asset.PhysicalInventory" value-field="physicalInventory"/><if condition="asset.acquireCost == null"><log level="trace" message="Not posting posting Physical Inventory [${assetDetail.physicalInventoryId}] variance for Asset Detail [${assetDetailId}], Asset has no acquireCost"/><set field="assetDetail.acctgTransResultEnumId" value="AtrNoAcquireCost"/><entity-update value-field="assetDetail"/><return/></if><entity-find entity-name="mantle.ledger.transaction.AcctgTrans" list="existingTransList"><econdition field-name="assetId" from="assetDetail.assetId"/><econdition field-name="physicalInventoryId" from="assetDetail.physicalInventoryId"/><econdition field-name="acctgTransTypeEnumId" operator="in" from="['AttInventoryVariance', 'AttAssetVariance']"/><econdition field-name="reversedByAcctgTransId" from="null"/><econdition field-name="reverseOfAcctgTransId" from="null"/></entity-find><if condition="existingTransList"><return message="Physical Inventory change in asset detail ${assetDetailId}, physical inventory ${assetDetail.physicalInventoryId} has already been posted in accounting transaction ${existingTransList*.acctgTransId}"/></if><set field="transactionDate" from="physicalInventory.physicalInventoryDate ?: assetDetail.effectiveDate"/><set field="organizationPartyId" from="asset.ownerPartyId"/><if condition="!organizationPartyId"><log level="trace" message="Not posting Physical Inventory ${assetDetail.physicalInventoryId} variance for Asset Detail ${assetDetailId}, Asset ${assetId} has no Owner Party"/><set field="assetDetail.acctgTransResultEnumId" value="AtrNoAcctgPreference"/><entity-update value-field="assetDetail"/><return/></if><set field="isFound" from="assetDetail.quantityOnHandDiff > 0"/><set field="quantity" from="assetDetail.quantityOnHandDiff > 0 ? assetDetail.quantityOnHandDiff : -assetDetail.quantityOnHandDiff"/><set field="amount" from="quantity * asset.acquireCost"/><service-call name="mantle.ledger.LedgerServices.find#PartyAcctgPreference" out-map="[partyAcctgPreference:papOut.partyAcctgPreference]" in-map="[organizationPartyId:organizationPartyId]"/><set field="partyAcctgPreference" from="papOut.partyAcctgPreference"/><if condition="!partyAcctgPreference"><log level="trace" message="Not posting Physical Inventory ${assetDetail.physicalInventoryId} variance for Asset Detail ${assetDetailId}, could not find PartyAcctgPreference for Owner Party ${organizationPartyId}"/><set field="assetDetail.acctgTransResultEnumId" value="AtrNoAcctgPreference"/><entity-update value-field="assetDetail"/><return/></if><service-call name="mantle.ledger.AssetAutoPostServices.get#AssetTypeGlAccount" out-map="[assetTypeGlAccount:context.assetTypeGlAccount]" in-map="[organizationPartyId:organizationPartyId, assetTypeEnumId:asset.assetTypeEnumId,                         classEnumId:asset.classEnumId, assetId:asset.assetId]"/><if condition="asset.assetTypeEnumId == 'AstTpInventory'"><then><set field="acctgTransTypeEnumId" value="AttInventoryVariance"/><set field="varianceGlAccountTypeEnumId" from="isFound ? 'GatInvFound' : 'GatInvShrinkage'"/><set field="assetGlAccountTypeEnumId" value="GatInventory"/></then><else><set field="acctgTransTypeEnumId" value="AttAssetVariance"/><set field="varianceGlAccountTypeEnumId" from="isFound ? 'GatFaFound' : 'GatFaShrinkage'"/><set field="assetGlAccountTypeEnumId" value="GatFixedAsset"/></else></if><set field="varianceGlAccountId" from="isFound ? assetTypeGlAccount?.foundGlAccountId : assetTypeGlAccount?.shrinkageGlAccountId"/><if condition="!varianceGlAccountId"><service-call name="mantle.ledger.LedgerServices.get#DefaultGlAccountByType" out-map="[glAccountId:creditGlAccountOut.glAccountId]" in-map="[glAccountTypeEnumId:varianceGlAccountTypeEnumId, acctgTransTypeEnumId:acctgTransTypeEnumId,                             organizationPartyId:organizationPartyId, otherPartyId:null]"/><set field="varianceGlAccountId" from="creditGlAccountOut.glAccountId"/></if><if condition="varianceGlAccountId"><entity-find-one entity-name="mantle.ledger.account.GlAccount" value-field="varianceGlAccount" cache="true"><field-map field-name="glAccountId" from="varianceGlAccountId"/></entity-find-one><set field="varianceGlAccountTypeEnumId" from="varianceGlAccount?.glAccountTypeEnumId"/></if><set field="assetGlAccountId" from="assetTypeGlAccount?.assetGlAccountId"/><if condition="!assetGlAccountId"><service-call name="mantle.ledger.LedgerServices.get#DefaultGlAccountByType" out-map="[glAccountId:assetGlAccountOut.glAccountId]" in-map="[glAccountTypeEnumId:assetGlAccountTypeEnumId, acctgTransTypeEnumId:acctgTransTypeEnumId,                             organizationPartyId:organizationPartyId, otherPartyId:null]"/><set field="assetGlAccountId" from="assetGlAccountOut.glAccountId"/></if><if condition="assetGlAccountId"><entity-find-one entity-name="mantle.ledger.account.GlAccount" value-field="assetGlAccount" cache="true"><field-map field-name="glAccountId" from="assetGlAccountId"/></entity-find-one><set field="assetGlAccountTypeEnumId" from="assetGlAccount?.glAccountTypeEnumId"/></if><set field="useErrorJournal" from="false"/><service-call name="mantle.ledger.LedgerServices.create#AcctgTrans" out-map="[acctgTransId:context.acctgTransId]" in-map="[acctgTransTypeEnumId:acctgTransTypeEnumId, organizationPartyId:organizationPartyId,                         otherPartyId:null, amountUomId:asset.acquireCostUomId, physicalInventoryId:physicalInventoryId,                         assetId:asset.assetId, transactionDate:transactionDate]"/><if condition="!varianceGlAccountId"><set field="useErrorJournal" from="true"/></if><service-call name="mantle.ledger.LedgerServices.create#AcctgTransEntry" in-map="[acctgTransId:acctgTransId, debitCreditFlag:(isFound ? 'C' : 'D'), glAccountTypeEnumId:varianceGlAccountTypeEnumId,                         glAccountId:varianceGlAccountId, amount:amount, productId:asset.productId, assetId:asset.assetId]"/><if condition="!assetGlAccountId"><set field="useErrorJournal" from="true"/></if><service-call name="mantle.ledger.LedgerServices.create#AcctgTransEntry" in-map="[acctgTransId:acctgTransId, debitCreditFlag:(isFound ? 'D' : 'C'), glAccountTypeEnumId:assetGlAccountTypeEnumId,                         glAccountId:assetGlAccountId, amount:amount, productId:asset.productId, assetId:asset.assetId]"/><if condition="useErrorJournal"><then><if condition="partyAcctgPreference?.errorGlJournalId"><service-call name="update#mantle.ledger.transaction.AcctgTrans" in-map="[acctgTransId:acctgTransId, glJournalId:partyAcctgPreference.errorGlJournalId]"/></if></then><else><service-call name="mantle.ledger.LedgerServices.post#AcctgTrans" in-map="[acctgTransId:acctgTransId]"/></else></if><set field="assetDetail.acctgTransResultEnumId" value="AtrSuccess"/><entity-update value-field="assetDetail"/></actions></service>