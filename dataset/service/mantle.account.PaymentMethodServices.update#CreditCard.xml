<!--Service Location mantle.account.PaymentMethodServices.update#CreditCard--><service verb="update" noun="CreditCard"><in-parameters><parameter name="paymentMethodId" required="true" entity-name="mantle.account.method.CreditCard" field-name="paymentMethodId"/><parameter name="paymentMethodTypeEnumId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.method.PaymentMethod" field-name="paymentMethodTypeEnumId"/><parameter name="purposeEnumId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.method.PaymentMethod" field-name="purposeEnumId"/><parameter name="description" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.method.PaymentMethod" field-name="description"/><parameter name="fromDate" type="java.sql.Timestamp" required="false" allow-html="none" entity-name="mantle.account.method.PaymentMethod" field-name="fromDate"/><parameter name="thruDate" type="java.sql.Timestamp" required="false" allow-html="none" entity-name="mantle.account.method.PaymentMethod" field-name="thruDate"/><parameter name="thruDateSetAuto" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.method.PaymentMethod" field-name="thruDateSetAuto"/><parameter name="openedDate" type="java.sql.Timestamp" required="false" allow-html="none" entity-name="mantle.account.method.PaymentMethod" field-name="openedDate"/><parameter name="titleOnAccount" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.method.PaymentMethod" field-name="titleOnAccount"/><parameter name="firstNameOnAccount" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.method.PaymentMethod" field-name="firstNameOnAccount"/><parameter name="middleNameOnAccount" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.method.PaymentMethod" field-name="middleNameOnAccount"/><parameter name="lastNameOnAccount" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.method.PaymentMethod" field-name="lastNameOnAccount"/><parameter name="suffixOnAccount" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.method.PaymentMethod" field-name="suffixOnAccount"/><parameter name="companyNameOnAccount" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.method.PaymentMethod" field-name="companyNameOnAccount"/><parameter name="ledgerBalance" type="java.math.BigDecimal" required="false" allow-html="none" entity-name="mantle.account.method.PaymentMethod" field-name="ledgerBalance"/><parameter name="availableBalance" type="java.math.BigDecimal" required="false" allow-html="none" entity-name="mantle.account.method.PaymentMethod" field-name="availableBalance"/><parameter name="balanceDate" type="java.sql.Timestamp" required="false" allow-html="none" entity-name="mantle.account.method.PaymentMethod" field-name="balanceDate"/><parameter name="loanPaymentAmount" type="java.math.BigDecimal" required="false" allow-html="none" entity-name="mantle.account.method.PaymentMethod" field-name="loanPaymentAmount"/><parameter name="loanPaymentPeriodUomId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.method.PaymentMethod" field-name="loanPaymentPeriodUomId"/><parameter name="currencyUomId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.method.PaymentMethod" field-name="currencyUomId"/><parameter name="postalContactMechId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.method.PaymentMethod" field-name="postalContactMechId"/><parameter name="telecomContactMechId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.method.PaymentMethod" field-name="telecomContactMechId"/><parameter name="emailContactMechId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.method.PaymentMethod" field-name="emailContactMechId"/><parameter name="gatewayCimId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.method.PaymentMethod" field-name="gatewayCimId"/><parameter name="paymentGatewayConfigId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.method.PaymentMethod" field-name="paymentGatewayConfigId"/><parameter name="imageUrl" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.method.PaymentMethod" field-name="imageUrl"/><parameter name="trustLevelEnumId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.method.PaymentMethod" field-name="trustLevelEnumId"/><parameter name="paymentFraudEvidenceId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.method.PaymentMethod" field-name="paymentFraudEvidenceId"/><parameter name="glAccountId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.method.PaymentMethod" field-name="glAccountId"/><parameter name="finAccountId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.method.PaymentMethod" field-name="finAccountId"/><parameter name="originalPaymentMethodId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.method.PaymentMethod" field-name="originalPaymentMethodId"/><parameter name="lastUpdatedStamp" type="java.sql.Timestamp" required="false" allow-html="none" entity-name="mantle.account.method.CreditCard" field-name="lastUpdatedStamp"/><parameter name="creditCardTypeEnumId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.method.CreditCard" field-name="creditCardTypeEnumId"/><parameter name="cardNumber" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.method.CreditCard" field-name="cardNumber"/><parameter name="cardNumberLookupHash" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.method.CreditCard" field-name="cardNumberLookupHash"/><parameter name="validFromDate" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.method.CreditCard" field-name="validFromDate"/><parameter name="expireDate" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.method.CreditCard" field-name="expireDate"/><parameter name="issueNumber" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.method.CreditCard" field-name="issueNumber"/><parameter name="cardSecurityCode" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.account.method.CreditCard" field-name="cardSecurityCode"/><parameter name="consecutiveFailedAuths" type="java.lang.Long" required="false" allow-html="none" entity-name="mantle.account.method.CreditCard" field-name="consecutiveFailedAuths"/><parameter name="lastFailedAuthDate" type="java.sql.Timestamp" required="false" allow-html="none" entity-name="mantle.account.method.CreditCard" field-name="lastFailedAuthDate"/><parameter name="consecutiveFailedNsf" type="java.lang.Long" required="false" allow-html="none" entity-name="mantle.account.method.CreditCard" field-name="consecutiveFailedNsf"/><parameter name="lastFailedNsfDate" type="java.sql.Timestamp" required="false" allow-html="none" entity-name="mantle.account.method.CreditCard" field-name="lastFailedNsfDate"/><parameter name="validateSecurityCode"><description><![CDATA[Not persisted, just passed through so available to SECA rules for validation by gateway, etc]]></description></parameter></in-parameters><out-parameters><parameter name="paymentMethodId" required="true" entity-name="mantle.account.method.CreditCard" field-name="paymentMethodId"/></out-parameters><actions><entity-find-one entity-name="mantle.account.method.CreditCard" value-field="origCreditCard"/><if condition="!cardNumber"><set field="cardNumber" from="origCreditCard.cardNumber"/></if><set field="newCreditCard" from="origCreditCard.cloneValue()"/><entity-set value-field="newCreditCard" include="nonpk"/><entity-find-one entity-name="mantle.account.method.PaymentMethod" value-field="origPaymentMethod"/><set field="newPaymentMethod" from="origPaymentMethod.cloneValue()"/><entity-set value-field="newPaymentMethod" include="nonpk"/><if condition="newCreditCard == origCreditCard && newPaymentMethod == origPaymentMethod"><log message="No fields were different for Credit Card with ID ${paymentMethodId}, not updating"/><return/></if><entity-find-one entity-name="mantle.party.PartyRole" value-field="ownerOrgRole"><field-map field-name="partyId" from="origPaymentMethod.ownerPartyId"/><field-map field-name="roleTypeId" value="OrgInternal"/></entity-find-one><if condition="ownerOrgRole != null"><then><entity-update value-field="newPaymentMethod"/><entity-update value-field="newCreditCard"/></then><else><set field="origPaymentMethod.thruDate" from="ec.user.nowTimestamp"/><entity-update value-field="origPaymentMethod"/><set field="newPaymentMethod.paymentMethodId" from="null"/><entity-sequenced-id-primary value-field="newPaymentMethod"/><set field="newPaymentMethod.fromDate" from="ec.user.nowTimestamp"/><set field="newPaymentMethod.originalPaymentMethodId" from="origPaymentMethod.originalPaymentMethodId ?: origPaymentMethod.paymentMethodId"/><if condition="!newPaymentMethod.description"><entity-find-one entity-name="moqui.basic.Enumeration" value-field="creditCardTypeEnum"><field-map field-name="enumId" from="newCreditCard.creditCardTypeEnumId"/></entity-find-one><set field="cardNumberDisplay" from="cardNumber ? '*'.padRight(cardNumber.length() - 4, '*') + cardNumber.substring(cardNumber.length() - 4, cardNumber.length()) : ''"/><set field="newPaymentMethod.description" from="(creditCardTypeEnum?.description ?: 'Credit Card') + ' ' + cardNumberDisplay"/></if><entity-create value-field="newPaymentMethod"/><set field="newCreditCard.paymentMethodId" from="newPaymentMethod.paymentMethodId"/><entity-create value-field="newCreditCard"/><set field="paymentMethodId" from="newPaymentMethod.paymentMethodId"/></else></if></actions></service>