<!--Service Location mantle.shipment.CarrierServices.calculate#OrderPartShipping--><service verb="calculate" noun="OrderPartShipping"><in-parameters><parameter name="orderId" required="true"/><parameter name="orderPartSeqId" required="true"/><parameter name="shippingGatewayConfigId"><description><![CDATA[Optional if OrderHeader.productStoreId is populated
                and a corresponding ProductStoreShippingGateway record exists.]]></description></parameter><parameter name="createOrderItem" type="Boolean" default="true"/><parameter name="shipmentMethodEnumId"><description><![CDATA[Overrides the OrderPart.shipmentMethodEnumId if specified.]]></description></parameter><parameter name="carrierPartyId"><description><![CDATA[Overrides the OrderPart.carrierPartyId if specified.]]></description></parameter><parameter name="postalContactMechId"><description><![CDATA[Overrides the OrderPart.postalContactMechId if specified.]]></description></parameter></in-parameters><out-parameters><parameter name="shippingTotal" required="true"/><parameter name="orderItemSeqId"/></out-parameters><actions><entity-find-one entity-name="mantle.order.OrderHeader" value-field="orderHeader"/><entity-find-one entity-name="mantle.order.OrderPart" value-field="orderPart"/><set field="productStoreId" from="orderHeader.productStoreId"/><set field="carrierPartyId" from="carrierPartyId ?: orderPart.carrierPartyId"/><set field="shipmentMethodEnumId" from="shipmentMethodEnumId ?: orderPart.shipmentMethodEnumId"/><entity-find-one entity-name="mantle.product.store.ProductStore" value-field="productStore" cache="true"/><if condition="!shippingGatewayConfigId"><if condition="!carrierPartyId"><return/></if><if condition="!productStoreId"><return/></if><entity-find-one entity-name="mantle.product.store.ProductStoreShippingGateway" value-field="productStoreShippingGateway"><field-map field-name="productStoreId"/><field-map field-name="carrierPartyId"/></entity-find-one><set field="shippingGatewayConfigId" from="productStoreShippingGateway?.shippingGatewayConfigId"/></if><entity-find-one entity-name="mantle.shipment.carrier.ShippingGatewayConfig" value-field="shippingGatewayConfig" cache="true"/><if condition="shippingGatewayConfig == null"><return/></if><set field="getOrderRateServiceName" from="shippingGatewayConfig.getOrderRateServiceName"/><if condition="!getOrderRateServiceName"><return error="true" message="Could not get order shipping rate, no order rate service on gateway ${shippingGatewayConfig.shippingGatewayConfigId}"/></if><if condition="createOrderItem"><entity-delete-by-condition entity-name="mantle.order.OrderItem"><econdition field-name="orderId"/><econdition field-name="orderPartSeqId"/><econdition field-name="itemTypeEnumId" value="ItemShipping"/></entity-delete-by-condition></if><set field="getAutoPackageInfoName" from="shippingGatewayConfig.getAutoPackageInfoName"/><if condition="getAutoPackageInfoName"><entity-find entity-name="mantle.order.OrderItem" list="itemInfoList"><econdition field-name="orderId"/><econdition field-name="orderPartSeqId"/><econdition field-name="productId" operator="is-not-null"/></entity-find><service-call name="${getAutoPackageInfoName}" out-map="context" in-map="context"/></if><service-call name="${getOrderRateServiceName}" in-map="context" out-map="context"/><if condition="productStore?.markupOrderShipLabels == 'Y' || ec.user.getPreference('AllStoresMarkupLabelOrder') == 'true'"><service-call name="mantle.shipment.CarrierServices.get#ShipLabelMarkup" out-map="[markupAmount:markupOut.markupAmount,markupPercent:markupOut.markupPercent,markupMultiplier:markupOut.markupMultiplier,markedUpAmount:markupOut.markedUpAmount]" out-map-add-to-existing="false" in-map="[productStoreId:productStore.productStoreId, carrierPartyId:carrierPartyId,                                         shipmentMethodEnumId:shipmentMethodEnumId]"/><set field="markupAmount" from="markupOut?.markupAmount ?: 0.0"/><set field="markupMultiplier" from="markupOut?.markupMultiplier ?: 0.0"/><if condition="(markupMultiplier != 0.0 || markupAmount != 0.0)"><if condition="shippingTotal"><set field="shippingTotal" from="shippingTotal + markupAmount +                             (markupMultiplier as BigDecimal).multiply(shippingTotal).setScale(2, BigDecimal.ROUND_HALF_UP)"/></if><if condition="createOrderItem"><entity-find entity-name="mantle.order.OrderItem" list="shippingItemList"><econdition field-name="orderId"/><econdition field-name="orderPartSeqId"/><econdition field-name="itemTypeEnumId" value="ItemShipping"/></entity-find><iterate list="shippingItemList" entry="shippingItem"><if condition="shippingItem.unitAmount"><set field="shippingItem.standardCost" from="shippingItem.unitAmount"/><set field="shippingItem.unitAmount" from="shippingItem.unitAmount + markupAmount +                                     (markupMultiplier as BigDecimal).multiply(shippingItem.unitAmount).setScale(2, BigDecimal.ROUND_HALF_UP)"/><entity-update value-field="shippingItem"/></if></iterate></if></if></if></actions></service>