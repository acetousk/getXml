<!--Service Location mantle.product.ProductServices.find#VariantProduct--><service verb="find" noun="VariantProduct"><in-parameters><parameter name="baseProductId" required="true" default="productId"/><parameter name="productId"/><parameter name="productFeatureIdSet" type="Set" required="true"><parameter name="productFeatureId"/></parameter><parameter name="productTypeEnumId"/><parameter name="assetTypeEnumId"/><parameter name="assetClassEnumId"/><parameter name="createIfMissing" type="Boolean" default="false"/></in-parameters><out-parameters><parameter name="productId"/></out-parameters><actions><if condition="productFeatureIdSet.size() == 0"><return/></if><set field="productFeatureIdList" from="new ArrayList(productFeatureIdSet)"/><set field="firstProductFeatureId" from="productFeatureIdList[0]"/><script><![CDATA[productFeatureIdList.remove(0)]]></script><entity-find entity-name="ProductAssocAndToFeatureAppl" list="paatafaList"><date-filter/><econdition field-name="productId" from="baseProductId"/><econdition field-name="productAssocTypeEnumId" value="PatVariant"/><econdition field-name="applTypeEnumId" operator="in" value="PfatDistinguishing,PfatStandard"/><econdition field-name="productFeatureId" from="firstProductFeatureId"/></entity-find><set field="productId" from="null"/><iterate list="paatafaList" entry="paatafa"><set field="hasAllFeatures" from="true"/><iterate list="productFeatureIdList" entry="productFeatureId"><entity-find-count entity-name="mantle.product.feature.ProductFeatureAppl" count-field="pfaCount"><date-filter/><econdition field-name="productId" from="paatafa.toProductId"/><econdition field-name="applTypeEnumId" operator="in" value="PfatDistinguishing,PfatStandard"/><econdition field-name="productFeatureId"/></entity-find-count><if condition="pfaCount == 0"><set field="hasAllFeatures" from="false"/><break/></if></iterate><if condition="hasAllFeatures"><set field="productId" from="paatafa.toProductId"/><break/></if></iterate><if condition="!productId && createIfMissing"><entity-find-one entity-name="mantle.product.Product" value-field="product"><field-map field-name="productId" from="baseProductId"/></entity-find-one><entity-find entity-name="mantle.product.feature.ProductFeature" list="featureList"><econdition field-name="productFeatureId" operator="in" from="productFeatureIdSet"/></entity-find><service-call name="mantle.product.ProductServices.create#VariantProduct" out-map="[productId:context.productId]" in-map="[product:product, productTypeEnumId:productTypeEnumId, assetClassEnumId:assetClassEnumId,                             assetTypeEnumId:assetTypeEnumId, featureList:featureList]"/></if></actions></service>