<!--Service Location mantle.ledger.LedgerReportServices.get#AccountLedgerInfo--><service verb="get" noun="AccountLedgerInfo"><in-parameters><parameter name="glAccountIdList" type="List" required="true"/><parameter name="timePeriodId" required="true"/><parameter name="organizationPartyId"/><parameter name="showReverses" type="Boolean" default="false"/></in-parameters><out-parameters><parameter name="timePeriod" type="Map"/><parameter name="fromTimestamp" type="Timestamp"/><parameter name="thruTimestamp" type="Timestamp"/><parameter name="organizationPartyId"/><parameter name="orgDetail" type="Map"/><parameter name="currencyUomId"/><parameter name="glAccountOrgTimePeriodList" type="List"><parameter name="glAccountOrgTimePeriod" type="Map"/></parameter><parameter name="entryInfoList" type="List"><parameter name="entryInfo" type="Map"/></parameter></out-parameters><actions><service-call name="mantle.party.TimeServices.get#TimePeriodInfo" in-map="[timePeriodId:timePeriodId]" out-map="[timePeriod:context.timePeriod,fromTimestamp:context.fromTimestamp,thruTimestamp:context.thruTimestamp,thruTimestampExclusive:context.thruTimestampExclusive,thruTimestampLate:context.thruTimestampLate]"/><set field="organizationPartyId" from="organizationPartyId ?: timePeriod.partyId"/><entity-find-one entity-name="mantle.party.PartyDetail" value-field="orgDetail"><field-map field-name="partyId" from="organizationPartyId"/></entity-find-one><service-call name="mantle.ledger.LedgerServices.find#PartyAcctgPreference" out-map="[partyAcctgPreference:context.partyAcctgPreference]" in-map="[organizationPartyId:organizationPartyId]"/><set field="currencyUomId" from="partyAcctgPreference?.baseCurrencyUomId ?: 'USD'"/><entity-find entity-name="mantle.ledger.account.GlAccountOrgTimePeriod" list="glAccountOrgTimePeriodList"><econdition field-name="glAccountId" operator="in" from="glAccountIdList"/><econdition field-name="timePeriodId"/><econdition field-name="organizationPartyId"/><order-by field-name="glAccountId"/></entity-find><set field="entryInfoList" from="[]"/><iterate list="glAccountOrgTimePeriodList" entry="glAccountOrgTimePeriod"><set field="glAccountId" from="glAccountOrgTimePeriod.glAccountId"/><entity-find-one entity-name="mantle.ledger.account.GlAccount" value-field="glAccount" cache="true"><field-map field-name="glAccountId"/></entity-find-one><set field="isDebitAccount" from="glAccount.isDebit.equals('Y')"/><set field="glAccountCodeMask" from="partyAcctgPreference?.glAccountCodeMask ?: ec.user.getPreference('GlAccountCodeMask')"/><set field="accountCodeFormatter" from="masker(glAccountCodeMask, '0')"/><set field="accountCode" from="accountCodeFormatter != null ? accountCodeFormatter.valueToString(glAccount.accountCode) : glAccount.accountCode"/><entity-find entity-name="mantle.ledger.transaction.AcctgTransAndEntrySummary" list="acctgTransEntryList"><econdition field-name="glAccountId"/><econdition field-name="organizationPartyId"/><econdition field-name="transactionDate" operator="greater-equals" from="fromTimestamp"/><econdition field-name="transactionDate" operator="less-equals" from="thruTimestamp"/><econdition field-name="isPosted" value="Y"/><select-field field-name="acctgTransId,glJournalId,transactionDate,acctgTransTypeEnumId,description,txDescription,txVoucherRef"/><select-field field-name="reversedByAcctgTransId,reverseOfAcctgTransId"/><select-field field-name="invoiceId,paymentId,assetId,productId,acctgTransEntrySeqId"/><select-field field-name="otherPartyId,pseudoId,organizationName,firstName,lastName "/><select-field field-name="paymentRefNum,referenceNumber,otherPartyOrderId,amount,debitCreditFlag"/><order-by field-name="transactionDate,acctgTransId,acctgTransEntrySeqId"/></entity-find><set field="balance" from="glAccountOrgTimePeriod.beginningBalance ?: 0.0"/><script><![CDATA[entryInfoList.add([transactionDate:fromTimestamp, description:glAccount.accountName, accountCode:accountCode, balance:balance])]]></script><set field="totalsRow" from="[description:(' Totals (' + acctgTransEntryList.size() + ' transactions)'), accountCode:accountCode]"/><iterate list="acctgTransEntryList" entry="acctgTransEntry"><if condition="!showReverses"><if condition="acctgTransEntry.reversedByAcctgTransId"><then><if condition="acctgTransEntryList.find({ acctgTransEntry.reversedByAcctgTransId.equals(it.acctgTransId) }) != null"><continue/></if></then><else-if condition="acctgTransEntry.reverseOfAcctgTransId"><if condition="acctgTransEntryList.find({ acctgTransEntry.reverseOfAcctgTransId.equals(it.acctgTransId) }) != null"><continue/></if></else-if></if></if><set field="rowMap" from="acctgTransEntry.getMap()"/><set field="rowMap.debit" from="rowMap.debitCreditFlag == 'D' ? rowMap.amount : null"/><set field="rowMap.credit" from="rowMap.debitCreditFlag == 'C' ? rowMap.amount : null"/><if condition="isDebitAccount"><then><set field="balance" from="balance + (rowMap.debitCreditFlag == 'D' ? rowMap.amount : -rowMap.amount)"/></then><else><set field="balance" from="balance + (rowMap.debitCreditFlag == 'C' ? rowMap.amount : -rowMap.amount)"/></else></if><set field="rowMap.balance" from="balance"/><if condition="rowMap.paymentId && !rowMap.invoiceId"><entity-find entity-name="mantle.account.payment.PaymentApplication" list="pmtAppList"><econdition field-name="paymentId" from="rowMap.paymentId"/><econdition field-name="amountApplied" operator="not-equals" from="0.0"/><order-by field-name="appliedDate"/></entity-find><set field="rowMap.invoiceId" from="pmtAppList ? pmtAppList[0].invoiceId : null"/></if><script><![CDATA[entryInfoList.add(rowMap)
                        addToBigDecimalInMap('debit', rowMap.debit, totalsRow)
                        addToBigDecimalInMap('credit', rowMap.credit, totalsRow)]]></script></iterate><script><![CDATA[entryInfoList.add(totalsRow)
                    entryInfoList.add([transactionDate:thruTimestamp, description:glAccount.accountName, accountCode:accountCode, balance:balance])
                    if (glAccountOrgTimePeriod_has_next) entryInfoList.add([:])]]></script></iterate></actions></service>