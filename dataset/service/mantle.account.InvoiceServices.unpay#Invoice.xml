<!--Service Location mantle.account.InvoiceServices.unpay#Invoice--><service verb="unpay" noun="Invoice"><in-parameters><parameter name="invoiceId" required="true" entity-name="mantle.account.invoice.Invoice" field-name="invoiceId"/><parameter name="statusId" entity-name="mantle.account.invoice.Invoice" field-name="statusId"/></in-parameters><out-parameters/><actions><entity-find-one entity-name="mantle.account.invoice.Invoice" value-field="invoice" for-update="true"/><if condition="!statusId"><if condition="invoice.statusId == 'InvoicePmtRecvd'"><set field="statusId" value="InvoiceFinalized"/></if><if condition="invoice.statusId == 'InvoicePmtSent'"><set field="statusId" value="InvoiceApproved"/></if></if><if condition="statusId && invoice.statusId != statusId"><service-call name="update#mantle.account.invoice.Invoice" in-map="[invoiceId:invoiceId, statusId:statusId]"/></if><entity-find entity-name="mantle.account.payment.PaymentApplication" list="paymentApplicationList"><econdition field-name="invoiceId"/></entity-find><iterate list="paymentApplicationList" entry="paymentApplication"><if condition="paymentApplication.amountApplied != 0"><service-call name="mantle.account.PaymentServices.unapply#PaymentApplication" in-map="[paymentApplicationId:paymentApplication.paymentApplicationId]"/></if></iterate></actions></service>