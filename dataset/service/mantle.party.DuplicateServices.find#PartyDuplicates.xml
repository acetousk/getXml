<!--Service Location mantle.party.DuplicateServices.find#PartyDuplicates--><service verb="find" noun="PartyDuplicates"><in-parameters><parameter name="partyId" required="true"/></in-parameters><out-parameters><parameter name="matchingInfoByPartyId" type="Map"><description><![CDATA[Key is partyId, value is List of records that match the
                other party including PartyIdentification, email, telecom number, and postal address.]]></description></parameter></out-parameters><actions><entity-find-one entity-name="mantle.party.PartyDetail" value-field="partyDetail"/><set field="firstName" from="partyDetail.firstName"/><set field="organizationName" from="partyDetail.organizationName"/><set field="matchingInfoByPartyId" from="[:]"/><entity-find entity-name="mantle.party.PartyIdentification" list="partyIdentificationList"><econdition field-name="partyId"/><select-field field-name="idValue,partyIdTypeEnumId"/></entity-find><entity-find entity-name="mantle.party.PartyIdentification" list="allDupIdList"><econdition field-name="partyId" operator="not-equals"/><econdition field-name="idValue" operator="in" from="partyIdentificationList*.idValue"/></entity-find><iterate list="allDupIdList" entry="dupId"><set field="partyIdent" from="partyIdentificationList.find({ it.idValue == dupId.idValue && it.partyIdTypeEnumId == dupId.partyIdTypeEnumId })"/><script><![CDATA[if (partyIdent != null) addToListInMap(dupId.partyId, dupId, matchingInfoByPartyId)]]></script></iterate><entity-find entity-name="mantle.party.contact.PartyContactMechInfo" list="partyContactMechInfoList"><date-filter/><econdition field-name="partyId"/><econdition field-name="contactMechTypeEnumId" value="CmtEmailAddress"/><select-field field-name="infoString"/></entity-find><entity-find entity-name="mantle.party.contact.ContactMech" list="allDupEmailList"><econdition field-name="contactMechTypeEnumId" value="CmtEmailAddress"/><econdition field-name="infoString" operator="in" from="partyContactMechInfoList*.infoString"/><select-field field-name="contactMechId,contactMechTypeEnumId,infoString"/></entity-find><iterate list="allDupEmailList" entry="dupEmail"><entity-find entity-name="mantle.party.contact.PartyContactMech" list="dupPcmList"><date-filter/><econdition field-name="partyId" operator="not-equals"/><econdition field-name="contactMechId" from="dupEmail.contactMechId"/></entity-find><if condition="!dupPcmList"><continue/></if><set field="dupPcm" from="dupPcmList[0]"/><script><![CDATA[Map dupEmailInfo = dupEmail.getMap()
                    dupEmailInfo.put("partyId", dupPcm.partyId)
                    addToListInMap(dupPcm.partyId, dupEmailInfo, matchingInfoByPartyId)]]></script></iterate><entity-find-one entity-name="mantle.party.Person" value-field="person"><field-map field-name="partyId"/></entity-find-one><if condition="person != null && person.birthDate != null"><entity-find entity-name="mantle.party.Person" list="bdPersonList"><econdition field-name="partyId" operator="not-equals"/><econdition field-name="birthDate" from="person.birthDate"/><econdition field-name="firstName" from="person.firstName" ignore-case="true"/><econdition field-name="lastName" from="person.lastName" ignore-case="true"/></entity-find></if><iterate list="bdPersonList" entry="bdPerson"><script><![CDATA[addToListInMap(bdPerson.partyId, [partyId:bdPerson.partyId, birthDate:bdPerson.birthDate], matchingInfoByPartyId)]]></script></iterate><entity-find entity-name="mantle.party.contact.PartyContactMechTelecomNumber" list="partyTelecomNumberList"><date-filter/><econdition field-name="partyId"/><select-field field-name="areaCode,contactNumber"/></entity-find><set field="dupTelecomIdsFound" from="new HashSet()"/><iterate list="partyTelecomNumberList" entry="ptn"><if condition="!ptn.contactNumber"><continue/></if><service-call name="mantle.party.DuplicateServices.find#TelecomNumbers" in-map="[partyId:partyId, areaCode:ptn.areaCode, contactNumber:ptn.contactNumber,                             matchingInfoByPartyId:matchingInfoByPartyId, dupTelecomIdsFound:dupTelecomIdsFound]"/></iterate><entity-find entity-name="mantle.party.contact.PartyContactMechPostalAddressOnly" list="partyPostalAddressList"><date-filter/><econdition field-name="partyId"/><select-field field-name="address1,unitNumber,postalCode,postalCodeExt,countryGeoId"/></entity-find><set field="dupAddressIdsFound" from="new HashSet()"/><iterate list="partyPostalAddressList" entry="ppa"><if condition="!ppa.address1 || !ppa.postalCode"><continue/></if><service-call name="mantle.party.DuplicateServices.find#PostalAddresses" in-map="[partyId:partyId, address1:ppa.address1, unitNumber:ppa.unitNumber, postalCode:ppa.postalCode,                             postalCodeExt:ppa.postalCodeExt, countryGeoId:ppa.countryGeoId,                             matchingInfoByPartyId:matchingInfoByPartyId, dupAddressIdsFound:dupAddressIdsFound]"/></iterate><set field="matchPartyIdSet" from="new HashSet(matchingInfoByPartyId.keySet())"/><iterate list="matchPartyIdSet" entry="matchPartyId"><entity-find-one entity-name="mantle.party.Party" value-field="matchParty"><field-map field-name="partyId" from="matchPartyId"/></entity-find-one><if condition="'Y'.equals(matchParty.disabled)"><script><![CDATA[matchingInfoByPartyId.remove(matchPartyId)]]></script></if></iterate><set field="dupPartyIds" from="new HashSet(matchingInfoByPartyId.keySet())"/><script><![CDATA[dupPartyIds.add(partyId)]]></script><iterate list="dupPartyIds" entry="dupPartyId"><entity-find-one entity-name="mantle.party.Party" value-field="dupParty"><field-map field-name="partyId" from="dupPartyId"/></entity-find-one><set field="dupParty.hasDuplicates" from="matchingInfoByPartyId ? 'Y' : 'N'"/><set field="dupParty.lastDupCheckDate" from="new Timestamp(System.currentTimeMillis())"/><entity-update value-field="dupParty"/></iterate></actions></service>