<!--Service Location mantle.order.OrderServices.cancel#OrderPart--><service verb="cancel" noun="OrderPart"><in-parameters><parameter name="orderId" required="true" entity-name="mantle.order.OrderPart" field-name="orderId"/><parameter name="orderPartSeqId" required="true" entity-name="mantle.order.OrderPart" field-name="orderPartSeqId"/></in-parameters><out-parameters/><actions><entity-find-one entity-name="mantle.order.OrderPart" value-field="orderPart" for-update="true"/><if condition="orderPart == null"><return error="true" message="Order Part ${orderId}:${orderPartSeqId} not found"/></if><if condition="orderPart.statusId == 'OrderCompleted'"><return error="true" message="Cannot cancel Order Part ${orderId}:${orderPartSeqId}, already Completed"/></if><if condition="orderPart.statusId in ['OrderRejected', 'OrderCancelled']"><return message="Order Part ${orderId}:${orderPartSeqId} already Cancelled"/></if><set field="hasIssuedQuantity" from="false"/><entity-find entity-name="mantle.order.OrderItem" list="orderItemList"><econdition field-name="orderId"/><econdition field-name="orderPartSeqId"/></entity-find><iterate list="orderItemList" entry="orderItem"><service-call name="mantle.order.OrderServices.cancel#OrderItem" out-map="[hasIssuedQuantity:itemOut.hasIssuedQuantity,quantityCancelled:itemOut.quantityCancelled]" out-map-add-to-existing="false" in-map="[orderId:orderId, orderItemSeqId:orderItem.orderItemSeqId, orderItem:orderItem, checkCancelPart:false]"/><if condition="itemOut.hasIssuedQuantity"><set field="hasIssuedQuantity" from="true"/></if></iterate><set field="targetStatusId" from="hasIssuedQuantity ? 'OrderCompleted' : 'OrderCancelled'"/><service-call name="update#mantle.order.OrderPart" out-map="[orderId:context.orderId,orderPartSeqId:context.orderPartSeqId,parentPartSeqId:context.parentPartSeqId,partName:context.partName,statusId:context.statusId,vendorPartyId:context.vendorPartyId,customerPartyId:context.customerPartyId,otherPartyOrderId:context.otherPartyOrderId,otherPartyOrderDate:context.otherPartyOrderDate,facilityId:context.facilityId,carrierPartyId:context.carrierPartyId,shipmentMethodEnumId:context.shipmentMethodEnumId,tradeTermEnumId:context.tradeTermEnumId,settlementTermId:context.settlementTermId,postalContactMechId:context.postalContactMechId,telecomContactMechId:context.telecomContactMechId,trackingNumber:context.trackingNumber,shippingInstructions:context.shippingInstructions,maySplit:context.maySplit,signatureRequiredEnumId:context.signatureRequiredEnumId,giftMessage:context.giftMessage,isGift:context.isGift,isNewCustomer:context.isNewCustomer,partTotal:context.partTotal,priority:context.priority,shipAfterDate:context.shipAfterDate,shipBeforeDate:context.shipBeforeDate,estimatedShipDate:context.estimatedShipDate,estimatedDeliveryDate:context.estimatedDeliveryDate,estimatedPickUpDate:context.estimatedPickUpDate,validFromDate:context.validFromDate,validThruDate:context.validThruDate,autoCancelDate:context.autoCancelDate,dontCancelSetDate:context.dontCancelSetDate,dontCancelSetUserId:context.dontCancelSetUserId,disablePromotions:context.disablePromotions,disableShippingCalc:context.disableShippingCalc,disableTaxCalc:context.disableTaxCalc,reservationAutoEnumId:context.reservationAutoEnumId,checkoutId:context.checkoutId,checkoutUrl:context.checkoutUrl,lastUpdatedStamp:context.lastUpdatedStamp]" in-map="[orderId:orderId, orderPartSeqId:orderPartSeqId, statusId:targetStatusId]"/><service-call name="mantle.order.OrderServices.checkCancelComplete#Order" in-map="[orderId:orderId]"/></actions></service>