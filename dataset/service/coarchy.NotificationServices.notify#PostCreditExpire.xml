<!--Service Location coarchy.NotificationServices.notify#PostCreditExpire--><service verb="notify" noun="PostCreditExpire"><in-parameters><parameter name="organizationChangeList" type="List"/></in-parameters><out-parameters><parameter name="emailsSentList" type="List"/></out-parameters><actions><set field="emailsSentList" from="[]"/><set field="baseLinkUrl" from="!'production'.equals(System.getProperty('instance_purpose')) ? 'http://localhost:8080' : 'https://coarchy.com'"/><set field="deactivatedOrgList" from="organizationChangeList.findAll{it.deactivated=='Y'}"/><if condition="deactivatedOrgList?.size()"><set field="deactivatedOrgIds" from="deactivatedOrgList*.organizationId"/><entity-find entity-name="mantle.party.Party" list="partyList"><econdition field-name="partyId" operator="in" from="deactivatedOrgIds"/></entity-find><set field="ownerIdSet" from="new TreeSet(partyList*.ownerPartyId)"/><iterate list="ownerIdSet" entry="ownerId"><entity-find entity-name="mantle.account.financial.FinancialAccount" list="financialAccountList" distinct="true"><econdition field-name="ownerPartyId" from="ownerId"/><econdition field-name="finAccountTypeId" value="OrganizationMonthCredit"/><econdition field-name="statusId" value="FaActive"/><date-filter/><select-field field-name="ownerPartyId,finAccountId,availableBalance"/></entity-find><set field="financialAccountList" from="financialAccountList.groupBy{it.ownerPartyId}.collect{it.value.max{it.availableBalance}}"/><set field="financialAccount" from="financialAccountList?.first()"/><if condition="financialAccount"><entity-find entity-name="mantle.account.financial.FinancialAccountTrans" list="finAccountTxList"><econdition field-name="finAccountId" from="financialAccount.finAccountId"/><econdition field-name="amount" operator="greater" from="0"/><econdition field-name="finAccountTransTypeEnumId" value="FattAdjustment"/><order-by field-name="-transactionDate"/></entity-find><set field="lastCreditPurchaseDate" from="finAccountTxList?.getFirst()?.transactionDate"/></if><set field="bodyParameters" from="[linkUrl:baseLinkUrl+'/settings/BuyPremium',baseLinkUrl:baseLinkUrl, currentYear:ec.user.nowTimestamp.format('yyyy'),                     title:'Your credits have expired']"/><service-call name="coarchy.NotificationServices.send#CreditExpireNotificationEmail" in-map="[emailTemplateId:'CREDITS_EXPIRED', partyId:ownerId, bodyParameters:bodyParameters, lastCreditPurchaseDate:lastCreditPurchaseDate]" out-map="[sentEmail:context.sentEmail,emailTemplateId:context.emailTemplateId,emailMessageId:context.emailMessageId]"/><if condition="sentEmail"><script><![CDATA[emailsSentList.add(emailMessageId)]]></script></if></iterate></if></actions></service>