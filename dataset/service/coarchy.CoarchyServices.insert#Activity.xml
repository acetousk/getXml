<!--Service Location coarchy.CoarchyServices.insert#Activity--><service verb="insert" noun="Activity"><in-parameters><parameter name="pageIndex"/><parameter name="downPageIndex"/><parameter name="processStoryId"/><parameter name="sequenceNum"/><parameter name="implementationId" entity-name="coarchy.Activity" field-name="implementationId"/><parameter name="condition" entity-name="coarchy.Activity" field-name="condition"/><parameter name="actorIdList" type="List"/><parameter name="action" type="String" entity-name="coarchy.Activity" field-name="action"/><parameter name="insertType"/><parameter name="organizationId" entity-name="coarchy.Activity" field-name="organizationId"/><parameter name="sequenceNumDiff" default="1" type="Integer"/></in-parameters><out-parameters><parameter name="pageIndex"/><parameter name="pageSize"/><parameter name="orderByField"/></out-parameters><actions><if condition="!action?.trim()"><return type="danger" error="true" message="${ec.resource.expand('CoarchyProcessActivityActionRequired',null)}"/></if><set field="insertSequenceNum" from="sequenceNum"/><if condition="insertType=='below'"><set field="pageIndex" from="downPageIndex"/><entity-find entity-name="coarchy.ProcessStoryActivityDetail" list="processStoryActivityMaxList" limit="1"><date-filter/><econdition field-name="replacedByActivityId" operator="is-null"/><econdition field-name="sequenceNum" operator="greater" from="sequenceNum.toInteger()"/><select-field field-name="processStoryActivityId,sequenceNum"/><order-by field-name="sequenceNum"/></entity-find><set field="insertSequenceNum" from="processStoryActivityMaxList?.getFirst()?.sequenceNum"/></if><entity-find entity-name="coarchy.ProcessStoryActivityDetail" list="processStoryActivityList"><date-filter/><econdition field-name="replacedByActivityId" operator="is-null"/><econdition field-name="sequenceNum" operator="greater-equals" from="insertSequenceNum.toInteger()"/><select-field field-name="processStoryActivityId,sequenceNum"/><order-by field-name="-sequenceNum"/></entity-find><iterate list="processStoryActivityList" entry="processStoryActivity"><service-call name="update#coarchy.ProcessStoryActivity" in-map="[processStoryActivityId:processStoryActivity.processStoryActivityId,sequenceNum:processStoryActivity.sequenceNum.toInteger()+sequenceNumDiff]"/></iterate><service-call name="coarchy.CoarchyServices.create#Activity" in-map="[processStoryId:processStoryId,organizationId:organizationId,condition:condition,actorIdList:actorIdList,action:action,sequenceNum:insertSequenceNum,implementationId:implementationId]"/></actions></service>