<!--Service Location org.moqui.impl.EntitySyncServices.run#EntitySync--><service verb="run" noun="EntitySync"><in-parameters><parameter name="entitySyncId" required="true" entity-name="moqui.entity.sync.EntitySync" field-name="entitySyncId"/></in-parameters><out-parameters/><actions><set field="startDate" from="new Timestamp(System.currentTimeMillis())"/><entity-find-one entity-name="moqui.entity.sync.EntitySync" value-field="entitySync" for-update="true"/><if condition="entitySync.statusId == 'EsRunning' &&                     entitySync.lastStartDate.getTime() > (System.currentTimeMillis() - (24*60*60*1000))"><return/></if><if condition="entitySync.lastSuccessfulSyncTime &&                     entitySync.lastSuccessfulSyncTime.getTime() > (System.currentTimeMillis() - (entitySync.delayBufferMillis ?: 300000))"><return/></if><set field="entitySync.lastStartDate" from="startDate"/><set field="entitySync.statusId" value="EsRunning"/><entity-update value-field="entitySync"/><service-call name="org.moqui.impl.EntitySyncServices.internalRun#EntitySync" out-map="[errorMessage:context.errorMessage,exclusiveFromTime:context.exclusiveFromTime,inclusiveThruTime:context.inclusiveThruTime,recordsStored:context.recordsStored]" in-map="context"/><if condition="errorMessage"><set field="entitySync.statusId" value="EsOtherError"/><else><set field="entitySync.statusId" value="EsComplete"/><set field="entitySync.lastSuccessfulSyncTime" from="inclusiveThruTime"/></else></if><entity-update value-field="entitySync"/><set field="finishLong" from="System.currentTimeMillis()"/><set field="runningTimeMillis" from="finishLong - startDate.getTime()"/><service-call name="create#moqui.entity.sync.EntitySyncHistory" in-map="[entitySyncId:entitySyncId, statusId:entitySync.statusId, startDate:startDate,                         finishDate:new Timestamp(finishLong), exclusiveFromTime:exclusiveFromTime,                         inclusiveThruTime:inclusiveThruTime, recordsStored:recordsStored,                         runningTimeMillis:runningTimeMillis, errorMessage:errorMessage]"/><log level="info" message="EntitySync [${entitySyncId}] finished: startDate=${startDate}, lastSuccessfulSyncTime=${entitySync.lastSuccessfulSyncTime}, recordsStored=${recordsStored}, errorMessage=${errorMessage}"/><if condition="entitySync.lastSuccessfulSyncTime &&                     entitySync.lastSuccessfulSyncTime.getTime() < (System.currentTimeMillis() - (entitySync.delayBufferMillis ?: 300000))"><service-call name="org.moqui.impl.EntitySyncServices.run#EntitySync" in-map="[entitySyncId:entitySyncId]" async="true"/></if></actions></service>