<!--Service Location mantle.shippo.ShippoServices.request#ShipmentRateInfoInternal--><service verb="request" noun="ShipmentRateInfoInternal"><in-parameters><parameter name="apiToken" required="true"/><parameter name="requestMapList" type="List" required="true"/><parameter name="requestPackageIdList" type="List"/><parameter name="carrierMethodByServiceLevel" type="Map" required="true"/></in-parameters><out-parameters><parameter name="shippingRateInfoList" type="List"/><parameter name="rateInfoByServiceLevelByPackage" type="Map"/></out-parameters><actions><set field="restClientFutureList" from="[]"/><iterate list="requestMapList" entry="requestMap"><log level="info" message="Shippo bulk rates request:\n${requestMap}"/><script><![CDATA[org.moqui.util.RestClient restClient = ec.service.rest().method(org.moqui.util.RestClient.POST)
                            .addHeader("Authorization", "ShippoToken ${apiToken}")
                            .addHeader("Shippo-API-Version", "2018-02-08")
                            .addHeader("Content-Type", "application/json").jsonObject(requestMap)
                            .retry(1.0F,2)
                    restClient.uri().protocol("https").host("api.goshippo.com").port(443).path("shipments").build()

                    restClientFutureList.add(restClient.callFuture())]]></script></iterate><set field="rateInfoByServiceLevel" from="[:]"/><set field="rateInfoByServiceLevelByPackage" from="[:]"/><set field="curFutureIndex" from="0"/><iterate list="restClientFutureList" entry="restClientFuture"><script><![CDATA[org.moqui.util.RestClient.RestResponse restResponse = restClientFuture.get()
                    if (restResponse.statusCode < 200 || restResponse.statusCode >= 300) {
                        // based on code in Shippo Java client will return error message in plain text body
                        String errMsg = restResponse.text()
                        ec.logger.error("Shippo error response (${restResponse.statusCode}): ${errMsg}")
                        ec.message.addMessage("Shippo API error")
                        ec.message.addMessage(errMsg)
                        return
                    }
                    responseMap = restResponse.jsonObject()]]></script><if condition="responseMap.messages"><iterate list="responseMap.messages" entry="messageObj"><message><![CDATA[(${messageObj.source}:${messageObj.code}) ${messageObj.text}]]></message></iterate></if><if condition="responseMap.status != 'SUCCESS'"><message><![CDATA[Shippo label status ${responseMap.status} for package]]></message></if><set field="curRateInfoByServiceLevel" from="[:]"/><iterate list="responseMap.rates" entry="rateMap"><set field="serviceLevelToken" from="rateMap?.servicelevel?.token"/><if condition="!serviceLevelToken"><continue/></if><set field="carrierMethod" from="carrierMethodByServiceLevel.get(serviceLevelToken)"/><if condition="carrierMethod != null"><set field="rateInfo" from="curRateInfoByServiceLevel.get(serviceLevelToken)"/><set field="rateAmount" from="rateMap.amount as BigDecimal"/><if condition="rateInfo == null || rateAmount < rateInfo.shippingTotal"><script><![CDATA[curRateInfoByServiceLevel.put(serviceLevelToken, [carrierPartyId:carrierMethod.carrierPartyId,
                                    shipmentMethodEnumId:carrierMethod.shipmentMethodEnumId, shippingTotal:rateAmount,
                                    currency:rateMap.currency, days:rateMap.estimated_days, durationTerms:rateMap.duration_terms,
                                    serviceName:rateMap.servicelevel.name, carrierImageUrl:rateMap.provider_image_75,
                                    shippoObjectId:rateMap.object_id])]]></script></if></if></iterate><set field="shipmentPackageSeqId" from="requestPackageIdList?.get(curFutureIndex)"/><script><![CDATA[if (shipmentPackageSeqId) rateInfoByServiceLevelByPackage.put(shipmentPackageSeqId, curRateInfoByServiceLevel)]]></script><set field="curFutureIndex" from="curFutureIndex + 1"/><iterate list="curRateInfoByServiceLevel" entry="curRateInfo" key="serviceLevelToken"><set field="rateInfo" from="rateInfoByServiceLevel.get(serviceLevelToken)"/><if condition="rateInfo != null"><then><set field="newRateInfo" from="new HashMap(rateInfo)"/><set field="newRateInfo.shippingTotal" from="(newRateInfo.shippingTotal ?: 0.0) + (curRateInfo.shippingTotal ?: 0.0)"/><script><![CDATA[newRateInfo.remove(shippoObjectId)]]></script><script><![CDATA[rateInfoByServiceLevel.put(serviceLevelToken, newRateInfo)]]></script></then><else><script><![CDATA[rateInfoByServiceLevel.put(serviceLevelToken, curRateInfo)]]></script></else></if></iterate></iterate><set field="shippingRateInfoList" from="new ArrayList(rateInfoByServiceLevel.values())"/></actions></service>