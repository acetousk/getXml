<!--Service Location stripe.StripeServices.consume#StripeWebhookEvent--><service verb="consume" noun="StripeWebhookEvent"><in-parameters><parameter name="systemMessageId" required="true"/></in-parameters><out-parameters><parameter name="partyId"/><parameter name="paymentId"/><parameter name="paymentMethodId"/><parameter name="postalContactMechId"/><parameter name="telecomContactMechId"/><parameter name="emailContactMechId"/></out-parameters><actions><entity-find-one entity-name="moqui.service.message.SystemMessage" value-field="systemMessage" auto-field-map="[systemMessageId:systemMessageId]" for-update="true"/><entity-find entity-name="mantle.account.method.PaymentGatewayConfig" list="paymentGatewayConfigList" limit="1"><econdition field-name="systemMessageRemoteId" from="systemMessage.systemMessageRemoteId"/><order-by field-name="-lastUpdatedStamp"/></entity-find><set field="paymentGatewayConfig" from="paymentGatewayConfigList.getFirst()"/><set field="paymentGatewayConfigId" from="paymentGatewayConfig.paymentGatewayConfigId"/><if condition="paymentGatewayConfig.paymentGatewayTypeEnumId != 'PgtStripe'"><log level="warn" message="PaymentGatewayConfig ${paymentGatewayConfigId} is not a PgtStripe gateway"/></if><set field="messageObject" from="ec.elastic.jsonToObject(systemMessage.messageText)"/><if condition="messageObject.object == 'event' && messageObject.data.object.object == 'checkout.session'"><entity-find entity-name="mantle.order.OrderPart" list="orderPartList" limit="2" for-update="true"><econdition field-name="checkoutId" from="messageObject.data.object.id"/><order-by field-name="-lastUpdatedStamp,orderPartSeqId"/></entity-find><if condition="orderPartList.size() == 0"><return error="true" type="danger" message="No order part found for checkoutId ${messageObject.data.object.id}."/></if><if condition="orderPartList.size() >= 2"><log level="warn" message="Multiple order parts found for checkoutId ${messageObject.data.object.id}."/></if><set field="orderPart" from="orderPartList.getFirst()"/><if condition="messageObject.type == 'checkout.session.completed'"><service-call name="stripe.StripeServices.consume#CheckoutSessionCompleted" in-map="context" out-map="[]"/></if><if condition="messageObject.type == 'checkout.session.expired'"><service-call name="stripe.StripeServices.consume#CheckoutSessionExpired" in-map="context" out-map="[]"/></if></if></actions></service>