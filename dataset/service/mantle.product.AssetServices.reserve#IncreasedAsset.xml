<!--Service Location mantle.product.AssetServices.reserve#IncreasedAsset--><service verb="reserve" noun="IncreasedAsset"><in-parameters><parameter name="assetId" required="true"/></in-parameters><out-parameters><parameter name="quantityMoved" type="BigDecimal"/></out-parameters><actions><set field="quantityMoved" from="0.0"/><entity-find-one entity-name="mantle.product.asset.Asset" value-field="asset" for-update="true"/><if condition="asset.statusId != 'AstAvailable'"><return/></if><if condition="asset.availableToPromiseTotal <= 0.0"><return/></if><if condition="!asset.productId"><return/></if><entity-find-one entity-name="mantle.facility.Facility" value-field="inventoryFacility"><field-map field-name="facilityId" from="asset.facilityId"/></entity-find-one><set field="assetAllowOtherOwner" from="inventoryFacility?.assetAllowOtherOwner"/><set field="ownerPartyIdSet" from="new HashSet()"/><script><![CDATA[if (asset.ownerPartyId) ownerPartyIdSet.add(asset.ownerPartyId)]]></script><if condition="asset.ownerPartyId && assetAllowOtherOwner != 'Y'"><entity-find entity-name="mantle.party.PartyRelationship" list="childRelList" cache="true"><date-filter/><econdition field-name="relationshipTypeEnumId" value="PrtOrgRollup"/><econdition field-name="toPartyId" from="asset.ownerPartyId"/><econdition field-name="fromPartyId" operator="is-not-null"/></entity-find><script><![CDATA[if (childRelList) ownerPartyIdSet.addAll(childRelList*.fromPartyId)]]></script></if><set field="availableRemaining" from="asset.availableToPromiseTotal"/><entity-find entity-name="mantle.product.issuance.AssetAndReservation" list="resList"><econdition field-name="productId" from="asset.productId"/><econdition field-name="facilityId" from="asset.facilityId"/><econdition field-name="ownerPartyId" from="asset.ownerPartyId" ignore="assetAllowOtherOwner == 'Y' || !ownerPartyIdSet"/><econdition field-name="quantityNotAvailable" operator="greater" from="0.0"/><order-by field-name="priority"/><order-by field-name="reservedDate"/></entity-find><iterate list="resList" entry="res"><set field="quantityToMove" from="availableRemaining < res.quantityNotAvailable ?                         availableRemaining : res.quantityNotAvailable"/><if condition="quantityToMove == 0.0"><break/></if><if condition="quantityToMove > res.quantityNotIssued"><set field="quantityToMove" from="res.quantityNotIssued"/></if><if condition="quantityToMove > 0.0"><service-call name="mantle.product.AssetServices.move#AssetReservation" out-map="[quantityMoved:moveArOut.quantityMoved]" out-map-add-to-existing="false" in-map="[assetId:assetId, assetReservationId:res.assetReservationId, quantity:quantityToMove]"/><set field="availableRemaining" from="availableRemaining - (moveArOut.quantityMoved ?: 0.0)"/><set field="quantityMoved" from="quantityMoved + (moveArOut.quantityMoved ?: 0.0)"/></if></iterate></actions></service>