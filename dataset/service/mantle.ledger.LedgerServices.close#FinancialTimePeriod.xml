<!--Service Location mantle.ledger.LedgerServices.close#FinancialTimePeriod--><service verb="close" noun="FinancialTimePeriod"><in-parameters><parameter name="timePeriodId" required="true"/><parameter name="closePrevious" type="Boolean" default="false"/><parameter name="closeChildren" type="Boolean" default="false"/></in-parameters><out-parameters/><actions><entity-find-one entity-name="mantle.party.time.TimePeriod" value-field="timePeriod" for-update="true"/><service-call name="mantle.party.TimeServices.get#TimePeriodInfo" in-map="[timePeriod:timePeriod]" out-map="[timePeriod:periodInfo.timePeriod,fromTimestamp:periodInfo.fromTimestamp,thruTimestamp:periodInfo.thruTimestamp,thruTimestampExclusive:periodInfo.thruTimestampExclusive,thruTimestampLate:periodInfo.thruTimestampLate]"/><set field="fromTimestamp" from="periodInfo.fromTimestamp"/><set field="thruTimestamp" from="periodInfo.thruTimestamp"/><log message="Closing period ${timePeriodId} ${timePeriod.periodName}"/><if condition="timePeriod.isClosed == 'Y'"><message error="true"><![CDATA[Not closing period ${ec.resource.expand('TimePeriodNameTemplate','',timePeriod)}, already closed.]]></message></if><if condition="ec.user.nowTimestamp.before(timePeriod.thruDate)"><message error="true"><![CDATA[Not closing period ${ec.resource.expand('TimePeriodNameTemplate','',timePeriod)}, period has not ended (ends on ${timePeriod.thruDate}).]]></message></if><set field="previousTimePeriod" from="timePeriod.previous"/><if condition="previousTimePeriod && previousTimePeriod.isClosed != 'Y'"><if condition="closePrevious"><then><service-call name="mantle.ledger.LedgerServices.close#FinancialTimePeriod" in-map="[timePeriodId:previousTimePeriod.timePeriodId, closePrevious:closePrevious, closeChildren:closeChildren]"/></then><else><message error="true"><![CDATA[Not closing period ${ec.resource.expand('TimePeriodNameTemplate','',timePeriod)}, previous period ${ec.resource.expand('TimePeriodNameTemplate','',previousTimePeriod)} not closed.]]></message></else></if></if><entity-find entity-name="mantle.party.time.TimePeriod" list="childTimePeriodList"><econdition field-name="parentPeriodId" from="timePeriodId"/><order-by field-name="fromDate"/></entity-find><iterate list="childTimePeriodList" entry="childTimePeriod"><if condition="childTimePeriod.isClosed != 'Y'"><if condition="closeChildren"><then><service-call name="mantle.ledger.LedgerServices.close#FinancialTimePeriod" in-map="[timePeriodId:childTimePeriod.timePeriodId, closePrevious:closePrevious, closeChildren:closeChildren]"/></then><else><message error="true"><![CDATA[Not closing period ${ec.resource.expand('TimePeriodNameTemplate','',timePeriod)}, child period ${ec.resource.expand('TimePeriodNameTemplate','',childTimePeriod)} not closed.]]></message></else></if></if></iterate><entity-find-count entity-name="mantle.ledger.transaction.AcctgTrans" count-field="unpostedTransCount"><econdition field-name="isPosted" operator="not-equals" value="Y" or-null="true"/><econdition field-name="transactionDate" operator="greater-equals" from="fromTimestamp"/><econdition field-name="transactionDate" operator="less-equals" from="thruTimestamp"/></entity-find-count><if condition="unpostedTransCount > 0"><message error="true"><![CDATA[Not closing period ${ec.resource.expand('TimePeriodNameTemplate','',timePeriod)}, found ${unpostedTransCount} unposted transactions in period.]]></message></if><check-errors/><set field="timePeriod.isClosed" value="Y"/><entity-update value-field="timePeriod"/><service-call name="mantle.ledger.LedgerServices.recalculate#GlAccountOrgTimePeriodAmounts" in-map="[timePeriodId:timePeriodId]"/><message><![CDATA[Closed period ${timePeriod.periodName} and verified summary totals]]></message></actions></service>