<!--Service Location mantle.ledger.InvoiceAutoPostServices.repost#InvoiceAdjustment--><service verb="repost" noun="InvoiceAdjustment"><in-parameters><parameter name="invoiceId" required="true"/><parameter name="invoiceItemSeqId" required="true"/></in-parameters><out-parameters/><actions><entity-find-one entity-name="mantle.account.invoice.Invoice" value-field="invoice" for-update="true"/><if condition="invoice == null"><return error="true" message="Could not find Invoice with ID ${invoiceId}"/></if><if condition="invoice.statusId in ['InvoiceInProcess', 'InvoiceIncoming', 'InvoiceReceived', 'InvoiceCancelled']"><return error="true" message="Invoice ${invoiceId} cannot be posted in status ${invoice.statusId}"/></if><entity-find-one entity-name="mantle.account.invoice.InvoiceItem" value-field="invoiceItem"/><if condition="invoiceItem == null"><return error="true" message="Could not find Invoice Item with ID ${invoiceId}:${invoiceItemSeqId}"/></if><if condition="invoiceItem.isAdjustment != 'Y'"><return error="true" message="Invoice Item with ID ${invoiceId}:${invoiceItemSeqId} is not an Adjustment item, cannot post separately to GL"/></if><entity-find entity-name="mantle.ledger.transaction.AcctgTransAndEntry" list="existingTransList"><econdition field-name="invoiceId"/><econdition field-name="invoiceItemSeqId"/><econdition field-name="acctgTransTypeEnumId" value="AttInvoiceAdjust"/><econdition field-name="reversedByAcctgTransId" from="null"/><econdition field-name="reverseOfAcctgTransId" from="null"/></entity-find><if condition="existingTransList"><then><set field="acctgTransIdSet" from="new TreeSet(existingTransList*.acctgTransId)"/><iterate list="acctgTransIdSet" entry="acctgTransId"><service-call name="mantle.ledger.LedgerServices.unpost#AcctgTrans" in-map="[acctgTransId:acctgTransId]"/><service-call name="mantle.ledger.LedgerServices.delete#AcctgTrans" in-map="[acctgTransId:acctgTransId]"/></iterate></then><else><log level="warn" message="In repost#InvoiceAdjustment ${invoiceId}:${invoiceItemSeqId} no existing AcctgTrans records found"/></else></if><service-call name="mantle.ledger.InvoiceAutoPostServices.post#InvoiceAdjustment" in-map="[invoiceId:invoiceId, invoiceItemSeqId:invoiceItemSeqId]"/></actions></service>