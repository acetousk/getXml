<!--Service Location mantle.party.ContactServices.update#PartyTelecomNumber--><service verb="update" noun="PartyTelecomNumber"><in-parameters><parameter name="countryCode" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.party.contact.TelecomNumber" field-name="countryCode"/><parameter name="areaCode" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.party.contact.TelecomNumber" field-name="areaCode"/><parameter name="contactNumber" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.party.contact.TelecomNumber" field-name="contactNumber"/><parameter name="askForName" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.party.contact.TelecomNumber" field-name="askForName"/><parameter name="lastUpdatedStamp" type="java.sql.Timestamp" required="false" allow-html="none" entity-name="mantle.party.contact.PartyContactMech" field-name="lastUpdatedStamp"/><parameter name="thruDate" type="java.sql.Timestamp" required="false" allow-html="none" entity-name="mantle.party.contact.PartyContactMech" field-name="thruDate"/><parameter name="extension" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.party.contact.PartyContactMech" field-name="extension"/><parameter name="comments" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.party.contact.PartyContactMech" field-name="comments"/><parameter name="allowSolicitation" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.party.contact.PartyContactMech" field-name="allowSolicitation"/><parameter name="usedSince" type="java.sql.Date" required="false" allow-html="none" entity-name="mantle.party.contact.PartyContactMech" field-name="usedSince"/><parameter name="usedUntil" type="java.sql.Date" required="false" allow-html="none" entity-name="mantle.party.contact.PartyContactMech" field-name="usedUntil"/><parameter name="verifyCode" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.party.contact.PartyContactMech" field-name="verifyCode"/><parameter name="verifyCodeDate" type="java.sql.Timestamp" required="false" allow-html="none" entity-name="mantle.party.contact.PartyContactMech" field-name="verifyCodeDate"/><parameter name="verifyCodeAttempts" type="java.lang.Long" required="false" allow-html="none" entity-name="mantle.party.contact.PartyContactMech" field-name="verifyCodeAttempts"/><parameter name="partyId" required="true"/><parameter name="contactMechId" required="true"/><parameter name="contactMechPurposeId"/></in-parameters><out-parameters><parameter name="contactMechId" required="true"/><parameter name="trustLevelEnumId"/></out-parameters><actions><service-call name="mantle.party.ContactServices.clean#TelecomNumber" in-map="context" out-map="[countryCode:context.countryCode,areaCode:context.areaCode,contactNumber:context.contactNumber,extension:context.extension,isValid:context.isValid]"/><set field="trustLevelEnumId" from="isValid != null && !isValid ? 'CmtlInvalid' : 'CmtlNew'"/><entity-find-one entity-name="mantle.party.contact.TelecomNumber" value-field="origTelecomNumber"/><script><![CDATA[newTelecomNumber = origTelecomNumber.cloneValue()]]></script><entity-set value-field="newTelecomNumber" include="nonpk"/><if condition="contactMechPurposeId"><entity-find entity-name="mantle.party.contact.PartyContactMech" list="origPcmList"><econdition field-name="partyId"/><econdition field-name="contactMechId"/></entity-find><if condition="!origPcmList"><entity-find entity-name="mantle.account.method.PaymentMethod" list="payMethList"><econdition field-name="ownerPartyId" from="partyId"/><econdition field-name="telecomContactMechId" from="contactMechId"/></entity-find><if condition="!payMethList"><return error="true" message="Telecom Number with ID ${contactMechId} is not associated with party ${partyId}, not updating."/></if></if><filter-map-list list="origPcmList"><date-filter/></filter-map-list><filter-map-list list="origPcmList"><field-map field-name="contactMechPurposeId"/></filter-map-list></if><if condition="newTelecomNumber == origTelecomNumber"><set field="updatedPcm" from="false"/><iterate list="origPcmList" entry="origPcm"><set field="newPcm" from="origPcm.cloneValue()"/><entity-set value-field="newPcm" include="nonpk"/><if condition="newPcm != origPcm"><entity-update value-field="newPcm"/><set field="updatedPcm" from="true"/></if></iterate><if condition="!updatedPcm"><log message="No fields were different for Phone Number ${contactMechId}, not updating."/></if><return/></if><entity-find-one entity-name="mantle.party.contact.ContactMech" value-field="newContactMech"/><set field="newContactMech.replacesContactMechId" from="newContactMech.contactMechId"/><set field="newContactMech.contactMechId" from="null"/><set field="newContactMech.gatewayCimId" from="null"/><set field="newContactMech.trustLevelEnumId" from="trustLevelEnumId"/><set field="newContactMech.validateMessage" from="null"/><set field="newContactMech.paymentFraudEvidenceId" from="null"/><entity-sequenced-id-primary value-field="newContactMech"/><entity-create value-field="newContactMech"/><set field="newTelecomNumber.contactMechId" from="newContactMech.contactMechId"/><entity-create value-field="newTelecomNumber"/><if condition="contactMechPurposeId"><iterate list="origPcmList" entry="origPcm"><set field="origPcm.thruDate" from="ec.user.nowTimestamp"/><entity-update value-field="origPcm"/><entity-make-value entity-name="mantle.party.contact.PartyContactMech" value-field="newPcm" map="[partyId:partyId, contactMechId:newContactMech.contactMechId, fromDate:ec.user.nowTimestamp]"/><set field="newPcm.contactMechPurposeId" from="origPcm.contactMechPurposeId"/><set field="newPcm.extension" from="extension ?: origPcm.extension"/><set field="newPcm.comments" from="comments ?: origPcm.comments"/><set field="newPcm.allowSolicitation" from="allowSolicitation ?: origPcm.allowSolicitation"/><entity-create value-field="newPcm"/></iterate></if><set field="contactMechId" from="newContactMech.contactMechId"/></actions></service>