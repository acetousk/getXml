<!--Service Location mantle.shipment.ShipmentServices.add#ItemToPackage--><service verb="add" noun="ItemToPackage"><in-parameters><parameter name="shipmentId" required="true"/><parameter name="productId" required="true"/><parameter name="shipmentPackageSeqId"><description><![CDATA[If not specified will be put in a new package]]></description></parameter><parameter name="quantity" type="BigDecimal"/></in-parameters><out-parameters><parameter name="shipmentPackageSeqId"/></out-parameters><actions><entity-find-one entity-name="mantle.shipment.ShipmentItem" value-field="shipmentItem"><field-map field-name="shipmentId"/><field-map field-name="productId"/></entity-find-one><entity-find entity-name="mantle.shipment.ShipmentPackageContent" list="packageContentList"><econdition field-name="shipmentId"/><econdition field-name="productId"/></entity-find><set field="packageContentTotal" from="(packageContentList*.quantity).sum() ?: 0.0"/><set field="quantityNotInPackage" from="((BigDecimal) shipmentItem.quantity ?: 0.0) - packageContentTotal"/><if condition="!quantity || quantity > quantityNotInPackage"><set field="quantity" from="quantityNotInPackage"/></if><if condition="!quantity"><return message="No quantity to add to package, not adding"/></if><set field="existingPackage" from="shipmentPackageSeqId != null && !shipmentPackageSeqId.isEmpty()"/><if condition="!existingPackage"><service-call name="mantle.shipment.ShipmentServices.create#ShipmentPackage" in-map="[shipmentId:shipmentId]" out-map="[shipmentPackageSeqId:context.shipmentPackageSeqId]"/></if><entity-find-one entity-name="mantle.shipment.ShipmentPackageContent" value-field="packageContent"><field-map field-name="shipmentId"/><field-map field-name="productId"/><field-map field-name="shipmentPackageSeqId"/></entity-find-one><if condition="packageContent != null"><then><service-call name="update#mantle.shipment.ShipmentPackageContent" in-map="[shipmentId:shipmentId,                         shipmentPackageSeqId:shipmentPackageSeqId, productId:productId, quantity:(packageContent.quantity + quantity)]"/></then><else><service-call name="create#mantle.shipment.ShipmentPackageContent" in-map="context"/></else></if><if condition="existingPackage"><entity-find-one entity-name="mantle.shipment.ShipmentPackage" value-field="shipmentPackage"/><if condition="shipmentPackage.weight"><set field="shipmentPackage.weight" from="null"/><entity-update value-field="shipmentPackage"/></if></if></actions></service>