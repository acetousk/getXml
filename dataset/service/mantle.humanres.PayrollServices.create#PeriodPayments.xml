<!--Service Location mantle.humanres.PayrollServices.create#PeriodPayments--><service verb="create" noun="PeriodPayments"><in-parameters><parameter name="timePeriodId" required="true"/><parameter name="effectiveDate" type="Timestamp" required="true"/><parameter name="statusId" default-value="PmntAuthorized"/><parameter name="paymentInstrumentEnumId" default-value="PiCompanyCheck"/><parameter name="paymentMethodId"/></in-parameters><out-parameters/><actions><if condition="!paymentMethodId"><entity-find-one entity-name="mantle.party.time.TimePeriod" value-field="timePeriod"/><entity-find entity-name="mantle.account.method.PaymentMethod" list="paymentMethodList"><date-filter/><econdition field-name="ownerPartyId" from="timePeriod.partyId"/><econdition field-name="purposeEnumId" value="PmpPayroll"/><order-by field-name="-fromDate"/></entity-find><if condition="!paymentMethodList"><entity-find entity-name="mantle.account.method.PaymentMethod" list="paymentMethodList"><date-filter/><econdition field-name="ownerPartyId" from="timePeriod.partyId"/><econdition field-name="purposeEnumId" value="PmpGeneral"/><order-by field-name="-fromDate"/></entity-find></if><if condition="paymentMethodList"><set field="paymentMethodId" from="paymentMethodList[0].paymentMethodId"/></if></if><entity-find entity-name="mantle.account.invoice.Invoice" list="invoiceList" for-update="true"><econdition field-name="timePeriodId"/><econdition field-name="invoiceTypeEnumId" value="InvoicePayroll"/><econdition field-name="statusId" value="InvoiceApproved"/></entity-find><iterate list="invoiceList" entry="invoice"><set field="toPaymentMethodId" from="null"/><set field="toUseInstrumentEnumId" from="paymentInstrumentEnumId"/><if condition="paymentInstrumentEnumId == 'PiAch'"><entity-find entity-name="mantle.account.method.PaymentMethod" list="toPaymentMethodList"><date-filter/><econdition field-name="ownerPartyId" from="invoice.fromPartyId"/><econdition field-name="purposeEnumId" value="PmpPayroll"/><econdition field-name="paymentMethodTypeEnumId" value="PmtBankAccount"/><order-by field-name="-fromDate"/></entity-find><if condition="toPaymentMethodList"><set field="toPaymentMethodId" from="toPaymentMethodList[0].paymentMethodId"/></if><if condition="!toPaymentMethodId"><set field="toUseInstrumentEnumId" value="PiCompanyCheck"/></if></if><set field="distGroupEnumId" from="null"/><if condition="invoice.partyRelationshipId"><entity-find-one entity-name="mantle.humanres.employment.Employee" value-field="invEmployee"><field-map field-name="partyId" from="invoice.fromPartyId"/></entity-find-one><if condition="invEmployee?.distGroupEnumId"><set field="distGroupEnumId" from="invEmployee.distGroupEnumId"/></if></if><service-call name="mantle.account.PaymentServices.create#InvoicePayment" out-map="[paymentId:paymentOut.paymentId,paymentApplicationId:paymentOut.paymentApplicationId]" in-map="context + [invoiceId:invoice.invoiceId, partyRelationshipId:invoice.partyRelationshipId,                         paymentInstrumentEnumId:toUseInstrumentEnumId]"/></iterate></actions></service>