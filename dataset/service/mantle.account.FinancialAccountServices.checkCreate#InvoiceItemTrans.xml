<!--Service Location mantle.account.FinancialAccountServices.checkCreate#InvoiceItemTrans--><service verb="checkCreate" noun="InvoiceItemTrans"><in-parameters><parameter name="invoiceId" required="true"/><parameter name="invoiceItemSeqId" required="true"/></in-parameters><out-parameters><parameter name="finAccountTransId"/></out-parameters><actions><entity-find-one entity-name="mantle.account.invoice.InvoiceItem" value-field="invoiceItem" for-update="true"/><set field="finAccountId" from="invoiceItem.finAccountId"/><if condition="!finAccountId"><return/></if><set field="amount" from="(invoiceItem.quantity != null ? invoiceItem.quantity : 1.0) * (invoiceItem.amount ?: 0.0)"/><if condition="!amount"><return/></if><if condition="invoiceItem.finAccountTransId"><set field="finAccountTransId" from="invoiceItem.finAccountTransId"/><return/></if><entity-find-one entity-name="mantle.account.invoice.Invoice" value-field="invoice"/><entity-find-one entity-name="mantle.account.financial.FinancialAccount" value-field="financialAccount"/><set field="organizationPartyId" from="financialAccount.organizationPartyId"/><set field="ownerPartyId" from="financialAccount.ownerPartyId"/><set field="fromPartyId" from="invoice.fromPartyId"/><set field="toPartyId" from="invoice.toPartyId"/><if condition="organizationPartyId != fromPartyId && organizationPartyId != toPartyId"><message error="true"><![CDATA[Financial Account organization ${organizationPartyId} is not a party to invoice ${invoiceId}]]></message></if><if condition="ownerPartyId != fromPartyId && ownerPartyId != toPartyId"><message error="true"><![CDATA[Financial Account owner ${ownerPartyId} is not a party to invoice ${invoiceId}]]></message></if><check-errors/><set field="isDeposit" from="organizationPartyId == fromPartyId"/><if condition="amount < 0.0"><set field="isDeposit" from="!isDeposit"/><set field="amount" from="-amount"/></if><if condition="isDeposit"><then><service-call name="mantle.account.FinancialAccountServices.deposit#FinancialAccount" out-map="[amount:txOut.amount,preBalance:txOut.preBalance,postBalance:txOut.postBalance,finAccountTransId:txOut.finAccountTransId]" in-map="[finAccountId:finAccountId, amount:amount, transactionDate:invoice.invoiceDate, invoiceId:invoiceId]"/></then><else><service-call name="mantle.account.FinancialAccountServices.withdraw#FinancialAccount" out-map="[amount:txOut.amount,preBalance:txOut.preBalance,postBalance:txOut.postBalance,finAccountTransId:txOut.finAccountTransId,responseCode:txOut.responseCode,responseMessage:txOut.responseMessage]" in-map="[finAccountId:finAccountId, amount:amount, transactionDate:invoice.invoiceDate, invoiceId:invoiceId]"/></else></if><set field="finAccountTransId" from="txOut.finAccountTransId"/><set field="invoiceItem.finAccountTransId" from="finAccountTransId"/><entity-update value-field="invoiceItem"/></actions></service>