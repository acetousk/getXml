<!--Service Location mantle.shipment.CarrierServices.get#ShipLabelMarkup--><service verb="get" noun="ShipLabelMarkup"><in-parameters><parameter name="productStoreId" required="true"/><parameter name="carrierPartyId" required="true"/><parameter name="shipmentMethodEnumId" required="true"/><parameter name="baseAmount" type="BigDecimal"><description><![CDATA[If specified will use to calculate markedUpAmount]]></description></parameter></in-parameters><out-parameters><parameter name="markupAmount" type="BigDecimal"/><parameter name="markupPercent" type="BigDecimal"/><parameter name="markupMultiplier" type="BigDecimal"/><parameter name="markedUpAmount" type="BigDecimal"/></out-parameters><actions><entity-find entity-name="mantle.product.store.ProductStoreSetting" list="labelMarkupSettingList" cache="true"><econdition field-name="productStoreId"/><econdition field-name="settingTypeEnumId" value="PsstShipLabelMarkup"/><date-filter/><order-by field-name="-fromDate"/></entity-find><set field="labelMarkupValue" from="labelMarkupSettingList ? labelMarkupSettingList[0]?.settingValue : null"/><if condition="labelMarkupValue && !labelMarkupValue.isBigDecimal()"><log level="error" message="Shipping Label Markup not a valid number ${labelMarkupValue} for store ${shipment.productStoreId}"/></if><set field="labelMarkupPercent" from="labelMarkupValue && labelMarkupValue.isBigDecimal() ?                         new BigDecimal(labelMarkupValue) : null"/><entity-find-one entity-name="mantle.product.store.ProductStoreShipOption" value-field="productStoreShipOption" cache="true"><field-map field-name="productStoreId"/><field-map field-name="carrierPartyId"/><field-map field-name="shipmentMethodEnumId"/></entity-find-one><if condition="productStoreShipOption?.markupPercent != null || productStoreShipOption?.markupAmount != null"><then><set field="markupPercent" from="productStoreShipOption.markupPercent ?: 0.0"/><set field="markupAmount" from="productStoreShipOption.markupAmount ?: 0.0"/></then><else><set field="markupPercent" from="labelMarkupPercent ?: 0.0"/><set field="markupAmount" from="0.0"/></else></if><set field="markupMultiplier" from="markupPercent ? markupPercent.divide(100.0, 4, BigDecimal.ROUND_HALF_UP) : 0.0"/><if condition="baseAmount != null"><set field="markedUpAmount" from="baseAmount + markupAmount +                     (markupMultiplier as BigDecimal).multiply(baseAmount).setScale(2, BigDecimal.ROUND_HALF_UP)"/></if></actions></service>