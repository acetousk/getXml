<!--Service Location mantle.shipment.ShipmentServices.update#ShipmentPackageContent--><service verb="update" noun="ShipmentPackageContent"><in-parameters><parameter name="shipmentId" required="true" entity-name="mantle.shipment.ShipmentPackageContent" field-name="shipmentId"/><parameter name="productId" required="true" entity-name="mantle.shipment.ShipmentPackageContent" field-name="productId"/><parameter name="shipmentPackageSeqId" required="true" entity-name="mantle.shipment.ShipmentPackageContent" field-name="shipmentPackageSeqId"/><parameter name="quantity" type="BigDecimal" entity-name="mantle.shipment.ShipmentPackageContent" field-name="quantity"/></in-parameters><out-parameters/><actions><set field="quantityUpdated" from="false"/><if condition="!quantity"><then><service-call name="delete#mantle.shipment.ShipmentPackageContent" in-map="context"/><set field="quantityUpdated" from="true"/></then><else><entity-find-one entity-name="mantle.shipment.ShipmentItem" value-field="shipmentItem"><field-map field-name="shipmentId"/><field-map field-name="productId"/></entity-find-one><entity-find entity-name="mantle.shipment.ShipmentPackageContent" list="packageContentList"><econdition field-name="shipmentId"/><econdition field-name="productId"/><econdition field-name="shipmentPackageSeqId" operator="not-equals"/></entity-find><set field="packageContentTotal" from="(packageContentList*.quantity).sum() ?: 0.0"/><set field="quantityNotInPackage" from="((BigDecimal) shipmentItem.quantity ?: 0.0) - packageContentTotal"/><if condition="quantity > quantityNotInPackage"><set field="quantity" from="quantityNotInPackage"/></if><entity-find-one entity-name="mantle.shipment.ShipmentPackageContent" value-field="shipmentPackageContent"/><if condition="shipmentPackageContent.quantity != quantity"><service-call name="update#mantle.shipment.ShipmentPackageContent" in-map="context"/><set field="quantityUpdated" from="true"/></if></else></if><if condition="quantityUpdated"><entity-find-one entity-name="mantle.shipment.ShipmentPackage" value-field="shipmentPackage"/><if condition="shipmentPackage.weight"><set field="shipmentPackage.weight" from="null"/><entity-update value-field="shipmentPackage"/></if></if></actions></service>