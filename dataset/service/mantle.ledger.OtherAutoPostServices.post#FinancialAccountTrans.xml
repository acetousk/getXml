<!--Service Location mantle.ledger.OtherAutoPostServices.post#FinancialAccountTrans--><service verb="post" noun="FinancialAccountTrans"><in-parameters><parameter name="finAccountTransId" required="true" entity-name="mantle.account.financial.FinancialAccountTrans" field-name="finAccountTransId"/></in-parameters><out-parameters><parameter name="acctgTransId"/></out-parameters><actions><entity-find-one entity-name="mantle.account.financial.FinancialAccountTrans" value-field="financialAccountTrans" for-update="true"/><entity-find-related-one value-field="financialAccountTrans" relationship-name="mantle.account.financial.FinancialAccount" to-value-field="financialAccount"/><if condition="!financialAccount"><return error="true" message="Not posting, could not find Financial Account with ID [${financialAccountTrans.finAccountId}] for financial account transaction with ID [${finAccountTransId}]"/></if><if condition="!financialAccount.organizationPartyId"><log level="trace" message="Not posting, Financial Account ${ec.resource.expand('FinancialAccountNameTemplate','',financialAccount)} has no organization Party; for financial account transaction with ID [${finAccountTransId}]"/><set field="financialAccountTrans.acctgTransResultEnumId" value="AtrNoAcctgPreference"/><entity-update value-field="financialAccountTrans"/><return/></if><service-call name="mantle.ledger.LedgerServices.find#PartyAcctgPreference" out-map="[partyAcctgPreference:context.partyAcctgPreference]" in-map="[organizationPartyId:financialAccount.organizationPartyId]"/><if condition="!financialAccountTrans.reasonEnumId"><set field="defaultReasonByType" from="['FattDeposit':'FatrReplenish', 'FattWithdraw':'FatrDisbursement', 'FattAdjustment':'FatrErrorAdjust']"/><set field="financialAccountTrans.reasonEnumId" from="defaultReasonByType.get(financialAccountTrans.finAccountTransTypeEnumId)"/></if><set field="transTypeMap" from="[FattDeposit:'AttFinancialDeposit', FattWithdraw:'AttFinancialWithdrawal',                     FattAdjustment:'AttFinancialAdjustment']"/><set field="acctgTransTypeEnumId" from="transTypeMap.get(financialAccountTrans.finAccountTransTypeEnumId)"/><set field="useErrorJournal" from="false"/><service-call name="mantle.ledger.OtherAutoPostServices.get#FinancialAccountGlAccount" out-map="[glAccountId:accountOut.glAccountId,glAccountTypeEnumId:accountOut.glAccountTypeEnumId]" in-map="[acctgTransTypeEnumId:acctgTransTypeEnumId, organizationPartyId:financialAccount.organizationPartyId,                         finAccountTypeId:financialAccount.finAccountTypeId]"/><if condition="!accountOut.glAccountId"><set field="useErrorJournal" from="true"/></if><service-call name="mantle.ledger.OtherAutoPostServices.get#FinancialAccountTransGlAccount" out-map="[glAccountId:transOut.glAccountId,glAccountTypeEnumId:transOut.glAccountTypeEnumId]" in-map="[acctgTransTypeEnumId:acctgTransTypeEnumId, organizationPartyId:financialAccount.organizationPartyId,                         reasonEnumId:financialAccountTrans.reasonEnumId, finAccountTransTypeEnumId:financialAccountTrans.finAccountTransTypeEnumId]"/><if condition="!transOut.glAccountId"><set field="useErrorJournal" from="true"/></if><service-call name="mantle.ledger.LedgerServices.create#AcctgTrans" out-map="[acctgTransId:context.acctgTransId]" in-map="[acctgTransTypeEnumId:acctgTransTypeEnumId, organizationPartyId:financialAccount.organizationPartyId,                         otherPartyId:financialAccount.ownerPartyId, amountUomId:financialAccount.currencyUomId,                         transactionDate:financialAccountTrans.transactionDate]"/><entity-find-one entity-name="mantle.ledger.transaction.AcctgTrans" value-field="acctgTrans"/><set field="isWithdraw" from="financialAccountTrans.amount < 0"/><set field="amount" from="isWithdraw ? -financialAccountTrans.amount : financialAccountTrans.amount"/><set field="transMap" from="[acctgTransId:acctgTrans.acctgTransId, acctgTrans:acctgTrans,                     glAccountTypeEnumId:transOut.glAccountTypeEnumId, glAccountId:transOut.glAccountId,                     amount:amount]"/><set field="accountMap" from="[acctgTransId:acctgTrans.acctgTransId, acctgTrans:acctgTrans,                     glAccountTypeEnumId:accountOut.glAccountTypeEnumId, glAccountId:accountOut.glAccountId,                     amount:amount]"/><if condition="isWithdraw"><then><service-call name="mantle.ledger.LedgerServices.create#AcctgTransEntry" in-map="transMap + [debitCreditFlag:'C']"/><service-call name="mantle.ledger.LedgerServices.create#AcctgTransEntry" in-map="accountMap + [debitCreditFlag:'D']"/></then><else><service-call name="mantle.ledger.LedgerServices.create#AcctgTransEntry" in-map="transMap + [debitCreditFlag:'D']"/><service-call name="mantle.ledger.LedgerServices.create#AcctgTransEntry" in-map="accountMap + [debitCreditFlag:'C']"/></else></if><if condition="useErrorJournal"><then><if condition="partyAcctgPreference?.errorGlJournalId"><service-call name="update#mantle.ledger.transaction.AcctgTrans" in-map="[acctgTransId:acctgTrans.acctgTransId, glJournalId:partyAcctgPreference.errorGlJournalId]"/></if></then><else><service-call name="mantle.ledger.LedgerServices.post#AcctgTrans" in-map="[acctgTransId:acctgTrans.acctgTransId]"/></else></if><set field="financialAccountTrans.acctgTransResultEnumId" value="AtrSuccess"/><entity-update value-field="financialAccountTrans"/></actions></service>