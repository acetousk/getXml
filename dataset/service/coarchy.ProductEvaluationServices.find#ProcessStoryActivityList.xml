<!--Service Location coarchy.ProductEvaluationServices.find#ProcessStoryActivityList--><service verb="find" noun="ProcessStoryActivityList"><in-parameters><parameter name="productEvaluationId" required="true"/><parameter name="processStoryId" required="true"/><parameter name="showSubstories" required="true"/><parameter name="organizationId" required="true"/><parameter name="onlyIncluded" type="Boolean" default="false"/></in-parameters><out-parameters><parameter name="processStoryActivityList"/></out-parameters><actions><entity-find entity-name="coarchy.product.ProductEvaluationActivity" list="productEvaluationActivityList"><econdition field-name="productEvaluationId" operator="in"/><econdition field-name="excludeFlag" value="N" or-null="true"/></entity-find><set field="includedActivityIds" from="productEvaluationActivityList*.activityId"/><entity-find entity-name="coarchy.ProcessStoryActivityDetail" list="setupProcessStoryActivityList"><econdition field-name="processStoryId"/><econditions combine="or"><date-filter ignore="onlyIncluded"/><econdition field-name="activityId" from="includedActivityIds" operator="in"/></econditions><select-field field-name="activityId,condition,action,detailProcessStoryId,processStoryId"/><order-by field-name="sequenceNum"/></entity-find><set field="processStoryActivityList" from="[]"/><iterate list="setupProcessStoryActivityList" entry="processStoryActivity"><entity-find entity-name="coarchy.ActivityActorDetail" list="activityActorList"><econdition field-name="activityId" from="processStoryActivity.activityId"/><order-by field-name="name"/></entity-find><set field="detailProcessStoryName" from="null"/><set field="detail" from="null"/><set field="detailProcessStoryId" from="processStoryActivity.detailProcessStoryId"/><set field="detailProcessStoryActivityList" from="[]"/><if condition="processStoryActivity.detailProcessStoryId && showSubstories!='N'"><service-call name="coarchy.ProductEvaluationServices.find#ProcessStoryActivityList" out-map="[processStoryActivityList:detail.processStoryActivityList]" in-map="[productEvaluationId:productEvaluationId,processStoryId:processStoryActivity.detailProcessStoryId,showSubstories:showSubstories,                             organizationId:organizationId, onlyIncluded:onlyIncluded]"/><entity-find-one entity-name="coarchy.ProcessStory" value-field="detailProcessStory" auto-field-map="[processStoryId:processStoryActivity.detailProcessStoryId]"/><set field="detailProcessStoryName" from="detailProcessStory.name"/><entity-find entity-name="coarchy.ProcessStoryActivityDetail" list="setupDetailProcessStoryActivityList"><econdition field-name="processStoryId" from="processStoryActivity.detailProcessStoryId"/><econditions combine="or"><date-filter ignore="onlyIncluded"/><econdition field-name="activityId" from="includedActivityIds" operator="in"/></econditions><select-field field-name="activityId,condition,action"/><order-by field-name="sequenceNum"/></entity-find><iterate list="setupDetailProcessStoryActivityList" entry="detailProcessStoryActivity"><entity-find entity-name="coarchy.ActivityActorDetail" list="detailActivityActorList"><econdition field-name="activityId" from="detailProcessStoryActivity.activityId"/><order-by field-name="name"/></entity-find><script><![CDATA[detailProcessStoryActivityList.add([sequenceNum:detailProcessStoryActivity.sequenceNum,condition:detailProcessStoryActivity.condition,actorNames:detailActivityActorList*.name,action:detailProcessStoryActivity.action])]]></script></iterate></if><script><![CDATA[processStoryActivityList.add([processStoryId:processStoryActivity.processStoryId,activityId:processStoryActivity.activityId,
                    sequenceNum:processStoryActivity.sequenceNum,condition:processStoryActivity.condition,
                    actorNames:activityActorList*.name,action:processStoryActivity.action,detailProcessStoryId:detailProcessStoryId,
                    detailProcessStoryName:detailProcessStoryName,detailProcessStoryActivityList:detail?.processStoryActivityList?.clone()])]]></script></iterate></actions></service>