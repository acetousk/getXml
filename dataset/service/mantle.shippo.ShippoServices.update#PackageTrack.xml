<!--Service Location mantle.shippo.ShippoServices.update#PackageTrack--><service verb="update" noun="PackageTrack"><in-parameters><parameter name="transaction"><description><![CDATA[For labels outside Shippo or in Shippo test messages this may be null]]></description></parameter><parameter name="carrier"><description><![CDATA[Should always be populated, Shippo's carrier ID]]></description></parameter><parameter name="tracking_number"/><parameter name="eta" type="Timestamp"><description><![CDATA[By docs should be in ISO format, ie 2016-07-23T00:00:00Z]]></description></parameter><parameter name="original_eta" type="Timestamp"><description><![CDATA[By docs should be in ISO format, ie 2016-07-23T00:00:00Z]]></description></parameter><parameter name="tracking_status" type="Map"><parameter name="status"><description><![CDATA[May be: UNKNOWN, TRANSIT, DELIVERED, RETURNED, FAILURE]]></description></parameter><parameter name="substatus"><description><![CDATA[For complete list see https://goshippo.com/docs/tracking#event-definitions]]></description></parameter><parameter name="status_date" type="Timestamp"/><parameter name="status_details"><description><![CDATA[Message with more details about status]]></description></parameter></parameter></in-parameters><out-parameters/><actions><log message="Got Shippo tracking_update webhook call with: ${context}"/><if condition="!tracking_number"><log level="error" message="Got tracking_update call from Shippo with no tracking_number parameter"/></if><if condition="!tracking_number && !transaction"><return/></if><if condition="!tracking_status"><log level="error" message="Got tracking_update call from Shippo with no tracking_status map"/><return/></if><if condition="!tracking_status.status"><log level="error" message="Got tracking_update call from Shippo with no tracking_status.status field"/><return/></if><set field="shippoStatusMap" from="[UNKNOWN:'ShTsUnknown', DELIVERED:'ShTsDelivered', TRANSIT:'ShTsTransit', FAILURE:'ShTsFailure', RETURNED:'ShTsReturned']"/><if condition="transaction"><entity-find entity-name="mantle.shipment.ShipmentPackageRouteSeg" list="sprsList"><econdition field-name="gatewayLabelId" from="transaction"/></entity-find></if><if condition="tracking_number && !sprsList"><entity-find entity-name="mantle.shipment.ShipmentPackageRouteSeg" list="sprsList"><econdition field-name="trackingCode" from="tracking_number"/></entity-find></if><iterate list="sprsList" entry="sprs"><set field="originalEta" from="sprs.trackingOrigEta ?: original_eta ?: eta"/><service-call name="update#mantle.shipment.ShipmentPackageRouteSeg" in-map="[shipmentId:sprs.shipmentId,                         shipmentPackageSeqId:sprs.shipmentPackageSeqId, shipmentRouteSegmentSeqId:sprs.shipmentRouteSegmentSeqId,                         gatewayMessage:(tracking_status.status_details ?: sprs.gatewayMessage),                         trackingStatusEnumId:shippoStatusMap.get(tracking_status.status), trackingSubStatus:tracking_status.substatus,                         trackingStatusDate:(tracking_status.status_date ?: ec.user.nowTimestamp),                         trackingEta:eta, trackingOrigEta:originalEta]"/></iterate><if condition="!sprsList"><if condition="transaction"><entity-find entity-name="mantle.shipment.ShipmentPackageRouteSeg" list="sprsList"><econdition field-name="returnGatewayLabelId" from="transaction"/></entity-find></if><if condition="tracking_number && !sprsList"><entity-find entity-name="mantle.shipment.ShipmentPackageRouteSeg" list="sprsList"><econdition field-name="returnTrackingCode" from="tracking_number"/></entity-find></if><iterate list="sprsList" entry="sprs"><service-call name="update#mantle.shipment.ShipmentPackageRouteSeg" in-map="[shipmentId:sprs.shipmentId,                             shipmentPackageSeqId:sprs.shipmentPackageSeqId, shipmentRouteSegmentSeqId:sprs.shipmentRouteSegmentSeqId,                             returnGatewayMessage:(tracking_status.status_details ?: sprs.gatewayMessage),                             returnTrackingStatusEnumId:shippoStatusMap.get(tracking_status.status),                             returnTrackingSubStatus:tracking_status.substatus,                             returnTrackingStatusDate:(tracking_status.status_date ?: ec.user.nowTimestamp)]"/></iterate></if><if condition="!sprsList"><log level="warn" message="No SPRS records found for Shippo tracking_update with transaction ${transaction} and tracking_number ${tracking_number}"/></if></actions></service>