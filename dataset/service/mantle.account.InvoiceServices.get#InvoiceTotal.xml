<!--Service Location mantle.account.InvoiceServices.get#InvoiceTotal--><service verb="get" noun="InvoiceTotal"><in-parameters><parameter name="invoiceId" required="true"/></in-parameters><out-parameters><parameter name="invoiceTotal" type="BigDecimal"/><parameter name="appliedPaymentsTotal" type="BigDecimal"/><parameter name="unpaidTotal" type="BigDecimal"/></out-parameters><actions><entity-find entity-name="mantle.account.invoice.InvoiceItem" list="invoiceItemList"><econdition field-name="invoiceId"/></entity-find><set field="invoiceTotal" from="0.0"/><iterate list="invoiceItemList" entry="invoiceItem"><set field="invoiceTotal" from="invoiceTotal + ((invoiceItem.quantity != null ? invoiceItem.quantity : 1.0) * (invoiceItem.amount ?: 0.0)).setScale(2, BigDecimal.ROUND_HALF_UP)"/></iterate><set field="invoiceTotal" from="(invoiceTotal as BigDecimal).setScale(2, BigDecimal.ROUND_HALF_UP)"/><entity-find entity-name="mantle.account.payment.PaymentApplication" list="paymentApplicationList"><econditions combine="or"><econdition field-name="invoiceId"/><econdition field-name="toInvoiceId" from="invoiceId"/></econditions></entity-find><set field="appliedPaymentsTotal" from="0.0"/><iterate list="paymentApplicationList" entry="paymentApplication"><set field="appliedPaymentsTotal" from="appliedPaymentsTotal + (paymentApplication.amountApplied ?: 0.0)"/></iterate><set field="unpaidTotal" from="invoiceTotal - appliedPaymentsTotal"/></actions></service>