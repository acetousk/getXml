<!--Service Location mantle.work.ManufacturingServices.unissue#Component--><service verb="unissue" noun="Component"><in-parameters><parameter name="workEffortId" required="true"/><parameter name="componentProductId" required="true"/><parameter name="componentQuantity" type="BigDecimal" required="true"><description><![CDATA[Unissues up to this quantity for each component]]></description></parameter><parameter name="unissueDate" type="Timestamp" default="ec.user.nowTimestamp"/></in-parameters><out-parameters/><actions><entity-find entity-name="mantle.product.issuance.AssetIssuance" list="issuanceList"><econdition field-name="workEffortId"/><econdition field-name="productId" from="componentProductId"/><order-by field-name="assetIssuanceId"/></entity-find><set field="quantityRemaining" from="componentQuantity"/><iterate list="issuanceList" entry="issuance"><if condition="quantityRemaining == 0.0"><break/></if><if condition="assemblySisList"><then><set field="curSisQtyRemaining" from="(issuance.quantity ?: 0.0) > quantityRemaining ? quantityRemaining : issuance.quantity"/><iterate list="assemblySisList" entry="assemblySis"><if condition="curSisQtyRemaining == 0.0"><break/></if><set field="quantityToReduce" from="(assemblySis.quantity ?: 0.0) > quantityRemaining ? quantityRemaining : assemblySis.quantity"/><set field="curSisQtyRemaining" from="curSisQtyRemaining > quantityToReduce ? (curSisQtyRemaining - quantityToReduce) : 0.0"/><set field="quantityRemaining" from="quantityRemaining > quantityToReduce ? (quantityRemaining - quantityToReduce) : 0.0"/><service-call name="mantle.product.AssetServices.cancel#AssetIssuance" in-map="[assetIssuanceId:issuance.assetIssuanceId, cancelDate:unissueDate, quantityToCancel:quantityToReduce,                                     orderId:assemblySis.orderId, orderItemSeqId:assemblySis.orderItemSeqId]"/></iterate></then><else><set field="quantityToReduce" from="(issuance.quantity ?: 0.0) > quantityRemaining ? quantityRemaining : issuance.quantity"/><set field="quantityRemaining" from="quantityRemaining > quantityToReduce ? (quantityRemaining - quantityToReduce) : 0.0"/><service-call name="mantle.product.AssetServices.cancel#AssetIssuance" in-map="[assetIssuanceId:issuance.assetIssuanceId, cancelDate:unissueDate, quantityToCancel:quantityToReduce]"/></else></if></iterate></actions></service>