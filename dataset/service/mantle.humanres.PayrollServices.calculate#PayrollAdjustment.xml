<!--Service Location mantle.humanres.PayrollServices.calculate#PayrollAdjustment--><service verb="calculate" noun="PayrollAdjustment"><in-parameters><parameter name="partyRelationshipId" required="true"/><parameter name="employment" type="Map"/><parameter name="employee" type="Map"/><parameter name="emplPosition" type="Map"/><parameter name="currencyUomId"/><parameter name="adjCalcServiceId"><description><![CDATA[Only populated if called from a PayrollAdjCalcService]]></description></parameter><parameter name="description"><description><![CDATA[If configured for service will be set, may expand in context (up to service to decide)]]></description></parameter><parameter name="payrollPhaseEnumId"/><parameter name="timePeriod" type="Map"/><parameter name="timeEntryList" type="List"/><parameter name="timeEntryRiskClassInfoList" type="List"/><parameter name="timePeriodTypeId" required="true"/><parameter name="payTimestamp" type="Timestamp"/><parameter name="payAmount" type="BigDecimal" required="true"/><parameter name="taxablePayAmount" type="BigDecimal" required="true"/><parameter name="socialTaxablePayAmount" type="BigDecimal" required="true"/><parameter name="medicalTaxablePayAmount" type="BigDecimal" required="true"/><parameter name="taxableYtdIncome" type="BigDecimal" required="true"/><parameter name="socialTaxableYtdIncome" type="BigDecimal" required="true"/><parameter name="medicalTaxableYtdIncome" type="BigDecimal" required="true"/><parameter name="priorAdjustmentList" type="List"><parameter name="adjustmentOut" type="Map"/></parameter><parameter name="homePostalAddress" type="Map"/><parameter name="payrollAdjustmentId" required="true" entity-name="mantle.humanres.employment.PayrollAdjustment" field-name="payrollAdjustmentId"/><parameter name="payrollAdjustment" type="Map"/></in-parameters><out-parameters><parameter name="adjustmentApplies" type="Boolean" required="true"/><parameter name="isEmployerPaid"><description><![CDATA[Y for employer paid, otherwise employee paid (adjust pay)]]></description></parameter><parameter name="payrollAdjustmentId"/><parameter name="adjCalcServiceId"/><parameter name="itemTypeEnumId" required="true"/><parameter name="overrideGlAccountId"/><parameter name="description" required="true"/><parameter name="quantity" type="BigDecimal" required="true"/><parameter name="quantityUomId"/><parameter name="amount" type="BigDecimal" required="true"/><parameter name="adjustmentBasisAmount" type="BigDecimal"><description><![CDATA[What the amount and/or quantity was
                calculated from. Depending on the adjustment, this can be dollars, hours, etc.]]></description></parameter><parameter name="stdDeductionAmount" type="BigDecimal"/><parameter name="allowanceDeductionAmount" type="BigDecimal"/><parameter name="allowanceExemptionAmount" type="BigDecimal"/><parameter name="taxAuthorityId"/><parameter name="payeePartyId"/><parameter name="payeeDueDays" type="Long"/><parameter name="payeeReference"/><parameter name="garnishDisposablePercent" type="BigDecimal"/><parameter name="garnishPriority" type="Long"/><parameter name="deductFromDisposable"/></out-parameters><actions><set field="adjustmentApplies" from="false"/><set field="quantity" from="1.0"/><set field="amount" from="0.0"/><set field="stdDeductionAmount" from="0.0"/><set field="allowanceDeductionAmount" from="0.0"/><set field="allowanceExemptionAmount" from="0.0"/><if condition="payrollAdjustment == null"><entity-find-one entity-name="mantle.humanres.employment.PayrollAdjustment" value-field="payrollAdjustment" cache="true"/></if><set field="isEmployerPaid" from="payrollAdjustment.isEmployerPaid"/><set field="itemTypeEnumId" from="payrollAdjustment.itemTypeEnumId"/><set field="description" from="payrollAdjustment.description"/><set field="taxAuthorityId" from="payrollAdjustment.taxAuthorityId"/><set field="payeePartyId" from="payrollAdjustment.payeePartyId"/><set field="payeeDueDays" from="payrollAdjustment.payeeDueDays"/><set field="payeeReference" from="payrollAdjustment.payeeReference"/><set field="garnishDisposablePercent" from="payrollAdjustment.garnishDisposablePercent"/><set field="garnishMinWageApplies" from="payrollAdjustment.garnishMinWageApplies"/><set field="garnishPriority" from="payrollAdjustment.garnishPriority"/><set field="deductFromDisposable" from="payrollAdjustment.deductFromDisposable"/><if condition="employment == null"><entity-find-one entity-name="mantle.humanres.employment.EmploymentAndRelationship" value-field="employment"/></if><if condition="emplPosition == null"><entity-find-one entity-name="mantle.humanres.position.EmplPosition" value-field="emplPosition"><field-map field-name="emplPositionId" from="employment.emplPositionId"/></entity-find-one></if><entity-find-one entity-name="mantle.humanres.employment.PayrollAdjustmentExempt" value-field="paExempt" cache="true"><field-map field-name="payrollAdjustmentId"/><field-map field-name="taxExemptEnumId" from="emplPosition.taxExemptEnumId"/></entity-find-one><if condition="paExempt != null"><return/></if><set field="rateBasisEnumId" from="payrollAdjustment.rateBasisEnumId"/><if condition="rateBasisEnumId == 'PrbsIncome'"><then><set field="adjustmentBasisAmount" from="taxablePayAmount"/><set field="adjustmentYtdAmount" from="taxableYtdIncome"/></then><else-if condition="rateBasisEnumId == 'PrbsSocial'"><set field="adjustmentBasisAmount" from="socialTaxablePayAmount"/><set field="adjustmentYtdAmount" from="socialTaxableYtdIncome"/></else-if><else-if condition="rateBasisEnumId == 'PrbsMedical'"><set field="adjustmentBasisAmount" from="medicalTaxablePayAmount"/><set field="adjustmentYtdAmount" from="medicalTaxableYtdIncome"/></else-if><else-if condition="rateBasisEnumId == 'PrbsStraightGross'"><if condition="payrollAdjustment.riskClassEnumId"><then><set field="adjustmentBasisAmount" from="0.0"/><iterate list="timeEntryRiskClassInfoList" entry="timeEntryRiskClassInfo"><if condition="timeEntryRiskClassInfo.riskClassEnumId == payrollAdjustment.riskClassEnumId"/></iterate></then><else><set field="adjustmentBasisAmount" from="0.0"/><iterate list="timeEntryList" entry="timeEntry"/></else></if></else-if><else-if condition="rateBasisEnumId == 'PrbsHours'"><if condition="payrollAdjustment.riskClassEnumId"><then><set field="adjustmentBasisAmount" from="0.0"/><set field="riskClassMatch" from="false"/><iterate list="timeEntryRiskClassInfoList" entry="timeEntryRiskClassInfo"><if condition="timeEntryRiskClassInfo.riskClassEnumId == payrollAdjustment.riskClassEnumId"><set field="timeEntry" from="timeEntryRiskClassInfo.timeEntry"/><set field="riskClassMatch" from="true"/><set field="adjustmentBasisAmount" from="adjustmentBasisAmount + timeEntry.hours"/></if></iterate><if condition="!riskClassMatch"><return/></if></then><else><set field="adjustmentBasisAmount" from="0.0"/><iterate list="timeEntryList" entry="timeEntry"><set field="adjustmentBasisAmount" from="adjustmentBasisAmount + timeEntry.hours"/></iterate></else></if></else-if><else><if condition="payrollAdjustment.riskClassEnumId"><then><set field="adjustmentBasisAmount" from="0.0"/><set field="adjustmentYtdAmount" from="0.0"/><iterate list="timeEntryRiskClassInfoList" entry="timeEntryRiskClassInfo"><if condition="timeEntryRiskClassInfo.riskClassEnumId == payrollAdjustment.riskClassEnumId"/></iterate></then><else><set field="adjustmentBasisAmount" from="payAmount"/><set field="adjustmentYtdAmount" from="payAmount"/></else></if></else></if><if condition="!adjustmentBasisAmount"><return/></if><entity-find entity-name="mantle.humanres.employment.PayrollAdjustmentFedStts" list="fedSttsList" cache="true"><econdition field-name="payrollAdjustmentId"/></entity-find><if condition="fedSttsList && employee.taxFederalStatusEnumId"><filter-map-list list="fedSttsList" to-list="filteredFedSttsList"><field-map field-name="taxFederalStatusEnumId" from="employee.taxFederalStatusEnumId"/></filter-map-list><if condition="!filteredFedSttsList"><return/></if></if><entity-find entity-name="mantle.humanres.employment.PayrollAdjustmentStateStts" list="stateSttsList" cache="true"><econdition field-name="payrollAdjustmentId"/></entity-find><if condition="stateSttsList && employee.taxStateStatusEnumId"><filter-map-list list="stateSttsList" to-list="filteredStateSttsList"><field-map field-name="taxStateStatusEnumId" from="employee.taxStateStatusEnumId"/></filter-map-list><if condition="!filteredStateSttsList"><return/></if></if><if condition="payrollAdjustment.isTax == 'Y' || payrollAdjustment.isSocialTax == 'Y' || payrollAdjustment.isMedicalTax == 'Y'"><entity-find-one entity-name="mantle.other.tax.TaxAuthority" value-field="taxAuthority" cache="true"><field-map field-name="taxAuthorityId" from="payrollAdjustment.taxAuthorityId"/></entity-find-one><if condition="taxAuthority.taxAuthorityTypeEnumId == 'TatFederal'"><then><if condition="homePostalAddress.countryGeoId != taxAuthority.taxAuthGeoId"><return/></if><set field="taxAllowances" from="employee.taxFederalAllowances != null ? employee.taxFederalAllowances : employment.taxFederalAllowances"/></then><else-if condition="taxAuthority.taxAuthorityTypeEnumId == 'TatState'"><if condition="homePostalAddress.stateProvinceGeoId != taxAuthority.taxAuthGeoId"><return/></if><set field="taxAllowances" from="employee.taxStateAllowances != null ? employee.taxStateAllowances : employment.taxStateAllowances"/></else-if><else><set field="taxAllowances" from="0.0"/></else></if><if condition="payrollAdjustment.applyStdDeduction == 'Y'"><entity-find entity-name="mantle.humanres.employment.PayrollStdDeduction" list="stdDeductionList"><date-filter valid-date="payTimestamp"/><econdition field-name="taxAuthorityId" from="payrollAdjustment.taxAuthorityId"/><econdition field-name="timePeriodTypeId"/><econdition field-name="taxFederalStatusEnumId" from="employee.taxFederalStatusEnumId" ignore="taxAuthority.taxAuthorityTypeEnumId != 'TatFederal'"/><econdition field-name="taxStateStatusEnumId" from="employee.taxStateStatusEnumId" ignore="taxAuthority.taxAuthorityTypeEnumId != 'TatState'"/><econdition field-name="minAllowances" operator="less-equals" from="taxAllowances" or-null="true"/><econdition field-name="maxAllowances" operator="greater-equals" from="taxAllowances" or-null="true"/></entity-find><if condition="stdDeductionList"><set field="stdDeduction" from="stdDeductionList[0]"/><set field="stdDeductionAmount" from="stdDeduction.amount"/><set field="adjustmentBasisAmount" from="adjustmentBasisAmount - stdDeductionAmount"/></if></if><if condition="payrollAdjustment.applyAllowanceDeduction == 'Y' && taxAllowances"><entity-find entity-name="mantle.humanres.employment.PayrollAllowance" list="allowanceList"><date-filter valid-date="payTimestamp"/><econdition field-name="taxAuthorityId" from="payrollAdjustment.taxAuthorityId"/><econdition field-name="timePeriodTypeId"/><econdition field-name="amountTypeEnumId" value="PaatDeduction"/></entity-find><if condition="allowanceList"><set field="allowance" from="allowanceList[0]"/><set field="allowanceDeductionAmount" from="allowance.amount * taxAllowances"/><set field="adjustmentBasisAmount" from="adjustmentBasisAmount - allowanceDeductionAmount"/><if condition="adjustmentBasisAmount < 0"><set field="adjustmentBasisAmount" from="0"/></if></if></if></if><entity-find entity-name="mantle.humanres.employment.PayrollAdjustmentDetail" list="payrollAdjustmentDetailList"><econdition field-name="payrollAdjustmentId"/><econdition field-name="ytdMin" operator="less-equals" from="adjustmentYtdAmount" or-null="true"/><econdition field-name="ytdMax" operator="greater" from="adjustmentYtdAmount" or-null="true"/><econdition field-name="periodMin" operator="less-equals" from="adjustmentBasisAmount" or-null="true"/><econdition field-name="periodMax" operator="greater" from="adjustmentBasisAmount" or-null="true"/><order-by field-name="-rate,-flatAmount"/></entity-find><if condition="!currencyUomId"><service-call name="mantle.ledger.LedgerServices.find#PartyAcctgPreference" out-map="[partyAcctgPreference:context.partyAcctgPreference]" in-map="[organizationPartyId:organizationPartyId]"/><set field="currencyUomId" from="partyAcctgPreference?.baseCurrencyUomId"/></if><if condition="payrollAdjustmentDetailList"><set field="adjustmentDetail" from="payrollAdjustmentDetailList[0]"/><set field="rateBasis" from="adjustmentBasisAmount"/><if condition="adjustmentDetail.rateAfterYtdMin == 'Y'"><set field="rateBasis" from="rateBasis - adjustmentDetail.ytdMin"/></if><if condition="adjustmentDetail.rateAfterPeriodMin == 'Y'"><set field="rateBasis" from="rateBasis - adjustmentDetail.periodMin"/></if><set field="amount" from="(adjustmentDetail.flatAmount ?: 0) + ((adjustmentDetail.rate ?: 0) * rateBasis)" type="BigDecimal"/><set field="amount" from="ec.l10n.roundCurrency(amount, currencyUomId)"/><if condition="amount != 0"><set field="adjustmentApplies" from="true"/></if></if><if condition="payrollAdjustment.applyAllowanceExemption == 'Y' && taxAllowances"><entity-find entity-name="mantle.humanres.employment.PayrollAllowance" list="allowanceExmList"><date-filter valid-date="payTimestamp"/><econdition field-name="taxAuthorityId" from="payrollAdjustment.taxAuthorityId"/><econdition field-name="timePeriodTypeId"/><econdition field-name="amountTypeEnumId" value="PaatExemption"/></entity-find><if condition="allowanceExmList"><set field="allowance" from="allowanceExmList[0]"/><set field="allowanceExemptionAmount" from="allowance.amount * taxAllowances"/><set field="amount" from="amount + allowanceExemptionAmount"/><if condition="amount > 0"><set field="amount" from="0.0"/></if></if></if></actions></service>