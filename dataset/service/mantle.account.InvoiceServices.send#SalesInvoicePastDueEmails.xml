<!--Service Location mantle.account.InvoiceServices.send#SalesInvoicePastDueEmails--><service verb="send" noun="SalesInvoicePastDueEmails"><in-parameters><parameter name="daysPastDue" type="Long" default="7"/><parameter name="daysPastInvoice" type="Long" default="40"/><parameter name="daysLastEmail" type="Long" default="2"/><parameter name="organizationPartyIdList" type="List"><parameter name="organizationPartyId"/></parameter><parameter name="alsoPrimaryEmails" type="Boolean" default="false"/></in-parameters><out-parameters/><actions><set field="nowZdt" from="java.time.ZonedDateTime.ofInstant(java.time.Instant.now(), java.time.ZoneId.systemDefault())"/><set field="dueLookBack" from="java.sql.Timestamp.from(nowZdt.minusDays(daysPastDue).toInstant())"/><set field="invoiceLookBack" from="java.sql.Timestamp.from(nowZdt.minusDays(daysPastInvoice).toInstant())"/><if condition="!organizationPartyIdList"><entity-find entity-name="mantle.party.PartyRole" list="orgPartyRoleList"><econdition field-name="roleTypeId" value="OrgInternal"/></entity-find><set field="organizationPartyIdList" from="orgPartyRoleList*.partyId"/></if><if condition="!organizationPartyIdList"><return message="No internal organizations specified or found, not sending Sales Invoice past due emails"/></if><iterate list="organizationPartyIdList" entry="organizationPartyId"><entity-find entity-name="mantle.account.invoice.Invoice" list="invoiceToPtyList" distinct="true"><econdition field-name="fromPartyId" from="organizationPartyId"/><econdition field-name="toPartyId" operator="is-not-null"/><econdition field-name="unpaidTotal" operator="greater" from="0.0"/><econdition field-name="statusId" operator="not-in" value="InvoiceInProcess,InvoiceWriteOff,InvoiceCancelled"/><econditions combine="or"><econdition field-name="dueDate" operator="less" from="dueLookBack"/><econdition field-name="invoiceDate" operator="less" from="invoiceLookBack"/></econditions><select-field field-name="toPartyId"/><order-by field-name="toPartyId"/></entity-find><log message="In send#SalesInvoicePastDueEmails for org ${organizationPartyId} found ${invoiceToPtyList.size()} customers with past due invoices"/><iterate list="invoiceToPtyList" entry="invoiceToPty"><service-call name="mantle.account.InvoiceServices.send#CustomerPastDueEmail" in-map="[fromPartyId:organizationPartyId, toPartyId:invoiceToPty.toPartyId, alsoPrimaryEmails:alsoPrimaryEmails,                                 daysPastDue:daysPastDue, daysPastInvoice:daysPastInvoice, daysLastEmail:daysLastEmail]"/></iterate></iterate></actions></service>