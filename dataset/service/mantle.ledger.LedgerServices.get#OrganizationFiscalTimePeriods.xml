<!--Service Location mantle.ledger.LedgerServices.get#OrganizationFiscalTimePeriods--><service verb="get" noun="OrganizationFiscalTimePeriods"><in-parameters><parameter name="organizationPartyId" required="true"/><parameter name="filterDate" type="Timestamp"/><parameter name="timePeriodTypeId"/><parameter name="term"/></in-parameters><out-parameters><parameter name="timePeriodList" type="List"/></out-parameters><actions><set field="filterSqlDate" from="filterDate != null ? new java.sql.Date(filterDate.time) : null"/><entity-find entity-name="mantle.party.time.TimePeriodAndType" list="timePeriodList"><econdition field-name="fromDate" operator="less-equals" from="filterSqlDate" ignore-if-empty="true"/><econdition field-name="thruDate" operator="greater-equals" from="filterSqlDate" ignore-if-empty="true"/><econdition field-name="periodPurposeEnumId" value="Fiscal" ignore="timePeriodTypeId"/><econdition field-name="partyId" from="organizationPartyId"/><econdition field-name="timePeriodTypeId" ignore-if-empty="true"/><econdition field-name="periodName" operator="like" value="%${term}%" ignore-case="true" ignore="!term"/></entity-find><if condition="!timePeriodList"><entity-find entity-name="mantle.party.PartyRelationship" list="partyRelationshipList" cache="true"><date-filter/><econdition field-name="fromPartyId" from="organizationPartyId"/><econdition field-name="relationshipTypeEnumId" value="PrtOrgRollup"/><econdition field-name="fromRoleTypeId" value="OrgInternal"/><econdition field-name="toRoleTypeId" value="OrgInternal"/></entity-find><if condition="partyRelationshipList"><service-call name="mantle.ledger.LedgerServices.get#OrganizationFiscalTimePeriods" out-map="[timePeriodList:parentPeriodsOut.timePeriodList]" in-map="[organizationPartyId:partyRelationshipList[0].toPartyId, filterDate:filterDate, timePeriodTypeId:timePeriodTypeId, term:term]"/><set field="parentOrgPeriodList" from="parentPeriodsOut.timePeriodList"/><set field="timePeriodList" from="[]"/><set field="timePeriodTypeIdList" from="['FiscalYear', 'FiscalQuarter', 'FiscalMonth', 'FiscalBiWeek', 'FiscalWeek']"/><set field="parentPeriodId" from="null"/><iterate list="timePeriodTypeIdList" entry="timePeriodTypeId"><filter-map-list list="parentOrgPeriodList" to-list="matchPeriodList"><field-map field-name="timePeriodTypeId"/></filter-map-list><if condition="matchPeriodList"><set field="parentOrgPeriod" from="matchPeriodList[0]"/><service-call name="mantle.party.TimeServices.getOrCreate#TimePeriod" out-map="[timePeriodId:createTpOut.timePeriodId,timePeriod:createTpOut.timePeriod]" in-map="[partyId:organizationPartyId, timePeriodTypeId:parentOrgPeriod.timePeriodTypeId,                                         fromDate:parentOrgPeriod.fromDate, parentPeriodId:parentPeriodId]"/><if condition="!createTpOut.timePeriodId"><return error="true" message="Get or create TimePeriod returned null value for partyId ${partyId}, timePeriodTypeId ${parentOrgPeriod.timePeriodTypeId}, fromDate ${parentOrgPeriod.fromDate}"/></if><entity-find-one entity-name="mantle.party.time.TimePeriod" value-field="timePeriod"><field-map field-name="timePeriodId" from="createTpOut.timePeriodId"/></entity-find-one><set field="parentPeriodId" from="createTpOut.timePeriodId"/><if condition="!timePeriodTypeId || timePeriodTypeId == timePeriod.timePeriodTypeId"><script><![CDATA[timePeriodList.add(timePeriod)]]></script></if></if></iterate></if></if><if condition="!timePeriodList"><service-call name="mantle.ledger.LedgerServices.check#NextFiscalTimePeriods" in-map="[organizationPartyId:organizationPartyId, basisDate:filterSqlDate]"/><entity-find entity-name="mantle.party.time.TimePeriodAndType" list="timePeriodList"><econdition field-name="fromDate" operator="less-equals" from="filterSqlDate" ignore-if-empty="true"/><econdition field-name="thruDate" operator="greater-equals" from="filterSqlDate" ignore-if-empty="true"/><econdition field-name="periodPurposeEnumId" value="Fiscal" ignore="timePeriodTypeId"/><econdition field-name="partyId" from="organizationPartyId"/><econdition field-name="timePeriodTypeId" ignore-if-empty="true"/></entity-find></if></actions></service>