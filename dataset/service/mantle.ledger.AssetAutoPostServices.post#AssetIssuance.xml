<!--Service Location mantle.ledger.AssetAutoPostServices.post#AssetIssuance--><service verb="post" noun="AssetIssuance"><in-parameters><parameter name="assetIssuanceId" required="true" entity-name="mantle.product.issuance.AssetIssuance" field-name="assetIssuanceId"/></in-parameters><out-parameters><parameter name="acctgTransId"/></out-parameters><actions><entity-find-one entity-name="mantle.product.issuance.AssetIssuance" value-field="assetIssuance" for-update="true"/><if condition="assetIssuance == null"><return error="true" message="Not posting inventory transaction, could not find Asset Issuance with ID ${assetIssuanceId}"/></if><if condition="!assetIssuance.quantity"><return message="No quantity issued, not posting inventory transaction to GL for issuance ${assetIssuanceId}"/></if><set field="asset" from="assetIssuance.'mantle.product.asset.Asset'"/><set field="organizationPartyId" from="asset.ownerPartyId"/><service-call name="mantle.ledger.LedgerServices.find#PartyAcctgPreference" out-map="[partyAcctgPreference:papOut.partyAcctgPreference]" in-map="[organizationPartyId:organizationPartyId]"/><set field="partyAcctgPreference" from="papOut.partyAcctgPreference"/><if condition="!partyAcctgPreference"><log level="trace" message="Not posting Asset Issuance ${assetIssuanceId}, could not find PartyAcctgPreference for Owner Party ${organizationPartyId}"/><set field="assetIssuance.acctgTransResultEnumId" value="AtrNoAcctgPreference"/><entity-update value-field="assetIssuance"/><return/></if><if condition="asset.acquireCost == null || asset.acquireCost == 0.0"><set field="assetIssuance.acctgTransResultEnumId" value="AtrNoAcquireCost"/><entity-update value-field="assetIssuance"/><return message="Not posting Asset Issuance ${assetIssuanceId}, Asset ${asset.assetId} has no Acquire Cost"/></if><entity-find entity-name="mantle.ledger.transaction.AcctgTrans" list="existingTransList"><econdition field-name="assetIssuanceId"/><econdition field-name="acctgTransTypeEnumId" operator="in" from="['AttInventoryIssuance', 'AttAssetIssuance']"/><econdition field-name="reversedByAcctgTransId" from="null"/><econdition field-name="reverseOfAcctgTransId" from="null"/></entity-find><if condition="existingTransList"><return message="Asset Issuance ${assetIssuanceId} has already been posted in accounting transaction ${existingTransList*.acctgTransId}"/></if><service-call name="mantle.ledger.AssetAutoPostServices.get#AssetTypeGlAccount" out-map="[assetTypeGlAccount:context.assetTypeGlAccount]" in-map="[organizationPartyId:organizationPartyId, assetTypeEnumId:asset.assetTypeEnumId,                         classEnumId:asset.classEnumId, assetId:asset.assetId]"/><if condition="assetIssuance.workEffortId"><entity-find-one entity-name="mantle.work.effort.WorkEffort" value-field="workEffort"><field-map field-name="workEffortId" from="assetIssuance.workEffortId"/></entity-find-one></if><if condition="asset.assetTypeEnumId == 'AstTpInventory'"><then><set field="acctgTransTypeEnumId" from="assetTypeGlAccount?.issuanceTransTypeEnumId ?: 'AttInventoryIssuance'"/><set field="issuanceGlAccountTypeEnumId" from="workEffort?.ownerPartyId == asset.ownerPartyId ? 'GatWipInventory' : 'GatCogs'"/><set field="assetGlAccountTypeEnumId" value="GatInventory"/></then><else><set field="acctgTransTypeEnumId" from="assetTypeGlAccount?.issuanceTransTypeEnumId ?: 'AttAssetIssuance'"/><set field="issuanceGlAccountTypeEnumId" value="GatUnissuedFixedAsset"/><set field="assetGlAccountTypeEnumId" value="GatFixedAsset"/></else></if><set field="assetGlAccountId" from="assetTypeGlAccount?.assetGlAccountId"/><if condition="!assetGlAccountId"><service-call name="mantle.ledger.LedgerServices.get#DefaultGlAccountByType" out-map="[glAccountId:assetGlAccountOut.glAccountId]" in-map="[glAccountTypeEnumId:assetGlAccountTypeEnumId, acctgTransTypeEnumId:acctgTransTypeEnumId,                             organizationPartyId:organizationPartyId, otherPartyId:null]"/><set field="assetGlAccountId" from="assetGlAccountOut.glAccountId"/></if><if condition="assetGlAccountId"><entity-find-one entity-name="mantle.ledger.account.GlAccount" value-field="assetGlAccount" cache="true"><field-map field-name="glAccountId" from="assetGlAccountId"/></entity-find-one><set field="assetGlAccountTypeEnumId" from="assetGlAccount?.glAccountTypeEnumId"/></if><set field="issuanceGlAccountId" from="workEffort?.ownerPartyId == asset.ownerPartyId ?                     assetTypeGlAccount?.wipAssetGlAccountId : assetTypeGlAccount?.issuanceGlAccountId"/><if condition="assetIssuance.shipmentId && assetTypeGlAccount?.transferGlAccountId"><entity-find-one entity-name="mantle.shipment.Shipment" value-field="shipment"><field-map field-name="shipmentId" from="assetIssuance.shipmentId"/></entity-find-one><if condition="shipment?.shipmentTypeEnumId == 'ShpTpTransfer'"><set field="issuanceGlAccountId" from="assetTypeGlAccount.transferGlAccountId"/></if></if><if condition="!issuanceGlAccountId"><service-call name="mantle.ledger.LedgerServices.get#DefaultGlAccountByType" out-map="[glAccountId:issuanceGlAccountOut.glAccountId]" in-map="[glAccountTypeEnumId:issuanceGlAccountTypeEnumId, acctgTransTypeEnumId:acctgTransTypeEnumId,                             organizationPartyId:organizationPartyId, otherPartyId:null]"/><set field="issuanceGlAccountId" from="issuanceGlAccountOut.glAccountId"/></if><if condition="issuanceGlAccountId"><entity-find-one entity-name="mantle.ledger.account.GlAccount" value-field="issuanceGlAccount" cache="true"><field-map field-name="glAccountId" from="issuanceGlAccountId"/></entity-find-one><set field="issuanceGlAccountTypeEnumId" from="issuanceGlAccount?.glAccountTypeEnumId"/></if><set field="amount" from="assetIssuance.quantity * asset.acquireCost"/><service-call name="mantle.ledger.LedgerServices.create#AcctgTrans" out-map="[acctgTransId:context.acctgTransId]" in-map="[acctgTransTypeEnumId:acctgTransTypeEnumId, organizationPartyId:organizationPartyId,                         otherPartyId:null, amountUomId:asset.acquireCostUomId, assetIssuanceId:assetIssuanceId,                         assetId:asset.assetId, shipmentId:assetIssuance.shipmentId, transactionDate:assetIssuance.issuedDate]"/><set field="useErrorJournal" from="false"/><if condition="!assetGlAccountId"><set field="useErrorJournal" from="true"/></if><service-call name="mantle.ledger.LedgerServices.create#AcctgTransEntry" in-map="[acctgTransId:acctgTransId, debitCreditFlag:'C', glAccountTypeEnumId:assetGlAccountTypeEnumId,                         glAccountId:assetGlAccountId, amount:amount, productId:asset.productId, assetId:asset.assetId]"/><if condition="!issuanceGlAccountId"><set field="useErrorJournal" from="true"/></if><service-call name="mantle.ledger.LedgerServices.create#AcctgTransEntry" in-map="[acctgTransId:acctgTransId, debitCreditFlag:'D', glAccountTypeEnumId:issuanceGlAccountTypeEnumId,                         glAccountId:issuanceGlAccountId, amount:amount, productId:asset.productId, assetId:asset.assetId]"/><if condition="useErrorJournal"><then><if condition="partyAcctgPreference?.errorGlJournalId"><service-call name="update#mantle.ledger.transaction.AcctgTrans" in-map="[acctgTransId:acctgTransId, glJournalId:partyAcctgPreference.errorGlJournalId]"/></if></then><else><service-call name="mantle.ledger.LedgerServices.post#AcctgTrans" in-map="[acctgTransId:acctgTransId]"/></else></if><set field="assetIssuance.acctgTransResultEnumId" value="AtrSuccess"/><entity-update value-field="assetIssuance"/></actions></service>