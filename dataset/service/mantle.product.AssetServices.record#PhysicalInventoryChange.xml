<!--Service Location mantle.product.AssetServices.record#PhysicalInventoryChange--><service verb="record" noun="PhysicalInventoryChange"><in-parameters><parameter name="parentAssetId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="parentAssetId"/><parameter name="assetTypeEnumId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="assetTypeEnumId"/><parameter name="statusId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="statusId"/><parameter name="ownerPartyId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="ownerPartyId"/><parameter name="assetPoolId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="assetPoolId"/><parameter name="productId" type="java.lang.String" required="true" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="productId"/><parameter name="originalQuantity" type="java.math.BigDecimal" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="originalQuantity"/><parameter name="originalQuantityUomId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="originalQuantityUomId"/><parameter name="assetName" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="assetName"/><parameter name="comments" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="comments"/><parameter name="serialNumber" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="serialNumber"/><parameter name="softIdentifier" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="softIdentifier"/><parameter name="activationNumber" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="activationNumber"/><parameter name="activationValidThru" type="java.sql.Timestamp" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="activationValidThru"/><parameter name="manufacturedDate" type="java.sql.Timestamp" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="manufacturedDate"/><parameter name="expectedEndOfLife" type="java.sql.Date" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="expectedEndOfLife"/><parameter name="actualEndOfLife" type="java.sql.Date" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="actualEndOfLife"/><parameter name="capacity" type="java.math.BigDecimal" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="capacity"/><parameter name="capacityUomId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="capacityUomId"/><parameter name="facilityId" type="java.lang.String" required="true" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="facilityId"/><parameter name="locationSeqId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="locationSeqId"/><parameter name="containerId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="containerId"/><parameter name="shipmentBoxTypeId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="shipmentBoxTypeId"/><parameter name="lotId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="lotId"/><parameter name="geoPointId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="geoPointId"/><parameter name="originId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="originId"/><parameter name="originFacilityId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="originFacilityId"/><parameter name="acquireOrderId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="acquireOrderId"/><parameter name="acquireOrderItemSeqId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="acquireOrderItemSeqId"/><parameter name="acquireWorkEffortId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="acquireWorkEffortId"/><parameter name="acquireShipmentId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="acquireShipmentId"/><parameter name="acquireCost" type="java.math.BigDecimal" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="acquireCost"/><parameter name="acquireCostUomId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="acquireCostUomId"/><parameter name="salvageValue" type="java.math.BigDecimal" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="salvageValue"/><parameter name="depreciation" type="java.math.BigDecimal" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="depreciation"/><parameter name="depreciationTypeEnumId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="depreciationTypeEnumId"/><parameter name="yearBeginDepreciation" type="java.math.BigDecimal" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="yearBeginDepreciation"/><parameter name="taxDepreciation" type="java.math.BigDecimal" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="taxDepreciation"/><parameter name="taxDepreciationTypeEnumId" type="java.lang.String" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="taxDepreciationTypeEnumId"/><parameter name="lastUpdatedStamp" type="java.sql.Timestamp" required="false" allow-html="none" entity-name="mantle.product.asset.Asset" field-name="lastUpdatedStamp"/><parameter name="physicalInventoryId"/><parameter name="physicalInventoryCountId"/><parameter name="quantityChange" type="BigDecimal" required="true"/><parameter name="partyId" default="ec.user.userAccount?.partyId"/><parameter name="physicalInventoryDate" type="Timestamp" default="ec.user.nowTimestamp"/><parameter name="varianceReasonEnumId"/><parameter name="assetList" type="EntityList"><description><![CDATA[Optional, meant to be used when called by other physical inventory services.]]></description><parameter name="asset" type="EntityValue"/></parameter><parameter name="strictLocation" type="Boolean" default="false"><description><![CDATA[If true filter by null locationSeqId (No Location), otherwise for null locationSeqId do not filter (Any Location)]]></description></parameter><parameter name="strictLot" type="Boolean" default="false"><description><![CDATA[If true filter by null lotId (No Lot), otherwise for null lotId do not filter (Any Lot)]]></description></parameter><parameter name="strictAll" type="Boolean" default="false"><description><![CDATA[If true filter by null locationSeqId, lotId, ownerPartyId, assetPoolId, and statusId (No/None); otherwise for null do not filter (Any)]]></description></parameter></in-parameters><out-parameters><parameter name="physicalInventoryId"/><parameter name="quantityRemaining" type="BigDecimal"><description><![CDATA[Always zero (0) if quantityChange is
                greater than zero. If quantityChange is less than zero and could not find enough quantity on hand this
                is the quantity that could not be removed.]]></description></parameter><parameter name="assetIdList" type="List"><parameter name="assetId"/></parameter></out-parameters><actions><set field="effectiveDate" from="physicalInventoryDate"/><if condition="!physicalInventoryId"><service-call name="create#mantle.product.asset.PhysicalInventory" in-map="context + [statusId:'PIComplete']" out-map="[physicalInventoryId:context.physicalInventoryId,physicalInventoryDate:context.physicalInventoryDate,statusId:context.statusId,facilityId:context.facilityId,partyId:context.partyId,comments:context.comments,lastUpdatedStamp:context.lastUpdatedStamp]"/></if><if condition="!ownerPartyId"><entity-find-one entity-name="mantle.facility.Facility" value-field="facility"/><set field="ownerPartyId" from="facility.ownerPartyId"/></if><set field="assetIdList" from="[]"/><if condition="!assetList"><entity-find entity-name="mantle.product.asset.Asset" list="assetList"><econdition field-name="productId"/><econdition field-name="facilityId"/><econdition field-name="locationSeqId" from="locationSeqId ?: null" ignore="!locationSeqId && !strictLocation && !strictAll"/><econdition field-name="lotId" from="lotId ?: null" ignore="!lotId && !strictLot && !strictAll"/><econdition field-name="ownerPartyId" from="ownerPartyId ?: null" ignore="!ownerPartyId && !strictAll"/><econdition field-name="assetPoolId" from="assetPoolId ?: null" ignore="!assetPoolId && !strictAll"/><econdition field-name="statusId" from="statusId ?: null" ignore="!statusId && !strictAll"/><econdition field-name="receivedDate" operator="less-equals" from="physicalInventoryDate" or-null="true"/><order-by field-name="receivedDate"/><order-by field-name="-assetId"/></entity-find></if><if condition="quantityChange > 0.0"><then><if condition="assetList"><then><set field="quantityRemaining" from="quantityChange"/><iterate list="assetList" entry="asset"><set field="quantityDiff" from="quantityRemaining"/><if condition="quantityDiff != 0"><service-call name="mantle.product.AssetServices.change#AssetQuantity" in-map="context + [assetId:asset.assetId]"/></if><set field="quantityRemaining" from="quantityRemaining - quantityDiff"/><script><![CDATA[assetIdList.add(asset.assetId)]]></script><if condition="quantityRemaining == 0"><break/></if></iterate></then><else><set field="quantityRemaining" from="0.0"/><service-call name="mantle.product.AssetServices.create#ProductAssetAdHoc" out-map="[assetId:context.assetId]" in-map="context + [createdDate:physicalInventoryDate]"/><service-call name="create#mantle.product.asset.AssetDetail" out-map="[assetDetailId:context.assetDetailId,assetId:context.assetId,effectiveDate:context.effectiveDate,quantityOnHandDiff:context.quantityOnHandDiff,availableToPromiseDiff:context.availableToPromiseDiff,unitCost:context.unitCost,assetReservationId:context.assetReservationId,otherAssetId:context.otherAssetId,shipmentId:context.shipmentId,productId:context.productId,orderId:context.orderId,orderItemSeqId:context.orderItemSeqId,returnId:context.returnId,returnItemSeqId:context.returnItemSeqId,workEffortId:context.workEffortId,assetMaintenanceId:context.assetMaintenanceId,assetIssuanceId:context.assetIssuanceId,assetReceiptId:context.assetReceiptId,physicalInventoryId:context.physicalInventoryId,physicalInventoryCountId:context.physicalInventoryCountId,varianceReasonEnumId:context.varianceReasonEnumId,description:context.description,acctgTransResultEnumId:context.acctgTransResultEnumId,lastUpdatedStamp:context.lastUpdatedStamp]" in-map="[assetId:assetId, effectiveDate:physicalInventoryDate, quantityOnHandDiff:quantityChange,                                 availableToPromiseDiff:quantityChange, productId:productId,                                 physicalInventoryId:physicalInventoryId, physicalInventoryCountId:physicalInventoryCountId,                                 varianceReasonEnumId:varianceReasonEnumId]"/><service-call name="mantle.product.AssetServices.reserve#IncreasedAsset" in-map="[assetId:assetId]"/><script><![CDATA[assetIdList.add(assetId)]]></script></else></if></then><else-if condition="quantityChange < 0.0"><set field="quantityRemaining" from="-quantityChange"/><set field="lockedAssetList" from="[]"/><set field="lockedAssetQoh" from="[:]"/><iterate list="assetList" entry="asset"><entity-find entity-name="mantle.product.asset.AssetDetailSummary" list="detailSummaryList"><econdition field-name="assetId" from="asset.assetId"/><econdition field-name="effectiveDate" operator="less-equals" from="physicalInventoryDate"/><select-field field-name="quantityOnHandTotal"/></entity-find><set field="quantityOnHandTotal" from="detailSummaryList.size() > 0 ? (detailSummaryList.get(0).quantityOnHandTotal ?: 0.0) : 0.0"/><set field="quantityDiff" from="quantityRemaining > quantityOnHandTotal ? quantityOnHandTotal : quantityRemaining"/><if condition="quantityDiff != 0.0"><entity-find-one entity-name="mantle.product.asset.Asset" value-field="lockedAsset" for-update="true"><field-map field-name="assetId" from="asset.assetId"/></entity-find-one><set field="quantityDiff" from="quantityRemaining > quantityOnHandTotal ? quantityOnHandTotal : quantityRemaining"/><if condition="quantityDiff != 0.0"><script><![CDATA[lockedAssetList.add(lockedAsset)
                                lockedAssetQoh.put(lockedAsset.assetId, quantityOnHandTotal)]]></script><set field="quantityRemaining" from="quantityRemaining - quantityDiff"/></if></if><if condition="quantityRemaining == 0.0"><break/></if></iterate><set field="quantityRemaining" from="-quantityChange"/><iterate list="lockedAssetList" entry="asset"><set field="quantityOnHandTotal" from="lockedAssetQoh.get(asset.assetId)"/><set field="quantityDiff" from="quantityRemaining > quantityOnHandTotal ? quantityOnHandTotal : quantityRemaining"/><if condition="quantityDiff != 0.0"><service-call name="mantle.product.AssetServices.change#AssetQuantity" in-map="context +                                 [assetId:asset.assetId, quantityDiff:-quantityDiff]"/><set field="quantityRemaining" from="quantityRemaining - quantityDiff"/><script><![CDATA[assetIdList.add(asset.assetId)]]></script></if><if condition="quantityRemaining == 0.0"><break/></if></iterate></else-if></if><if condition="quantityRemaining != 0"><message type="warning"><![CDATA[Could not reduce quantity by ${quantityRemaining}, insufficient quantity on hand.]]></message></if></actions></service>