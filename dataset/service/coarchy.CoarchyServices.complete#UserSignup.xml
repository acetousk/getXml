<!--Service Location coarchy.CoarchyServices.complete#UserSignup--><service verb="complete" noun="UserSignup"><in-parameters><parameter name="username" required="true" default="ec.web?.sessionAttributes?.moquiPreAuthcUsername ?: username"/><parameter name="firstName" required="true"/><parameter name="lastName" required="true"/><parameter name="oldPassword" required="true"/><parameter name="newPassword" required="true"/></in-parameters><out-parameters><parameter name="updateSuccessful"/><parameter name="loginSuccess"/><parameter name="passwordIssues"/></out-parameters><actions><entity-find-one entity-name="moqui.security.UserAccount" value-field="userAccount"><field-map field-name="username" from="username"/><select-field field-name="userId,partyId,currentPassword,passwordSetDate"/></entity-find-one><if condition="!userAccount"><return error="true" message="${ec.resource.expand('CoarchyAuthUserNotFound','')}"/></if><if condition="userAccount.currentPassword && userAccount.passwordSetDate"><return error="true" message="${ec.resource.expand('CoarchyAuthPasswordAlreadySet','')}"/></if><service-call name="org.moqui.impl.UserServices.update#Password" in-map="[username:username,                 oldPassword:oldPassword,newPassword:newPassword,newPasswordVerify:newPassword]" out-map="[username:context.username,passwordIssues:context.passwordIssues,updateSuccessful:context.updateSuccessful]"/><if condition="updateSuccessful"><entity-find-one entity-name="moqui.security.UserAccount" value-field="userAccount"><field-map field-name="username"/><select-field field-name="userId,partyId"/></entity-find-one><service-call name="update#moqui.security.UserAccount" in-map="[userId:userAccount.userId,userFullName:(firstName?firstName+' ':'')+lastName?:'']"/><service-call name="mantle.party.PartyServices.update#Account" in-map="[userId:userAccount.userId,firstName:firstName,lastName:lastName]"/><set field="loginSuccess" from="ec.user.internalLoginUser(username)"/><entity-find-count entity-name="mantle.party.PartyRelationship" count-field="vendorRelCount"><date-filter/><econdition field-name="relationshipTypeEnumId" value="PrtVendorRepresentative"/><econdition field-name="toRoleTypeId" value="VendorRepresentative"/><econdition field-name="fromPartyId" from="userAccount.partyId"/></entity-find-count><entity-find-count entity-name="mantle.party.PartyRelationship" count-field="memberRelCount"><date-filter/><econdition field-name="relationshipTypeEnumId" value="PrtMember"/><econdition field-name="toRoleTypeId" value="OrgInternal"/><econdition field-name="fromPartyId" from="userAccount.partyId"/></entity-find-count><set field="treatAsVendor" from="(vendorRelCount > 0) && !memberRelCount"/><if condition="!treatAsVendor"><service-call name="mantle.party.PartyServices.set#PartyClassification" in-map="[partyId:userAccount.partyId,partyClassificationId:'HotLead']" out-map="[]"/></if><set field="emailTemplateId" from="treatAsVendor?'ONBOARDING_VENDOR_WELCOME':'ONBOARDING_WELCOME'"/><set field="emailTitle" from="treatAsVendor?'Welcome to Coarchy, connect with customers, sell more!':'Welcome to Coarchy, Build a better future!'"/><set field="baseLinkUrl" from="!'production'.equals(System.getProperty('instance_purpose')) ? 'http://localhost:8080' : 'https://coarchy.com'"/><service-call name="coarchy.CoarchyServices.send#ContactListEmail" in-map="[                         contactListId:'CoarchyOnboarding',emailTemplateId:emailTemplateId,                         partyId:userAccount.partyId,preferredContactMechId:null,toAddresses:username,                         bodyParameters:[linkUrl:baseLinkUrl+'/settings/Organizations',                         title:emailTitle,baseLinkUrl:baseLinkUrl]]" out-map="[sentEmail:context.sentEmail,emailTemplateId:context.emailTemplateId]"/></if></actions></service>