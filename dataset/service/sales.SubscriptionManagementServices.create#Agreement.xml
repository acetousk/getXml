<!--Service Location sales.SubscriptionManagementServices.create#Agreement--><service verb="create" noun="Agreement"><in-parameters><parameter name="agreementDate" type="Timestamp" default="ec.user.nowTimestamp" entity-name="mantle.party.agreement.Agreement" field-name="agreementDate"/><parameter name="orderId" required="true"/></in-parameters><out-parameters><parameter name="agreementId" entity-name="mantle.party.agreement.Agreement" field-name="agreementId"/></out-parameters><actions><entity-find-one entity-name="mantle.order.OrderHeader" value-field="orderHeader"/><entity-find entity-name="mantle.order.OrderPart" list="orderPartList"><econdition field-name="orderId"/></entity-find><entity-find entity-name="mantle.order.OrderItem" list="orderItemList"><econdition field-name="orderId"/><econdition field-name="orderPartSeqId" from="orderPartList[0].orderPartSeqId"/></entity-find><entity-find entity-name="mantle.order.OrderPartParty" list="orderPartPartyList"><econdition field-name="orderId"/><econdition field-name="orderPartSeqId" from="orderPartList[0].orderPartSeqId"/></entity-find><set field="agreementTypeEnumId" value="AgrSales"/><set field="currencyUomId" from="orderHeader.currencyUomId"/><set field="otherPartyId" from="orderPartList[0].customerPartyId"/><set field="customerPartyId" from="otherPartyId"/><set field="otherRoleTypeId" value="Customer"/><set field="fromDate" from="orderPartList[0].validFromDate"/><set field="thruDate" from="orderPartList[0].validThruDate"/><set field="description" from="orderPartList[0].partName"/><set field="priceTypeEnumId" value="PptCurrent"/><set field="pricePurposeEnumId" value="PppUsage"/><service-call name="create#mantle.party.agreement.Agreement" out-map="[agreementId:context.agreementId,agreementTypeEnumId:context.agreementTypeEnumId,statusId:context.statusId,organizationPartyId:context.organizationPartyId,organizationRoleTypeId:context.organizationRoleTypeId,otherPartyId:context.otherPartyId,otherRoleTypeId:context.otherRoleTypeId,agreementDate:context.agreementDate,fromDate:context.fromDate,thruDate:context.thruDate,description:context.description,currencyUomId:context.currencyUomId,isTemplate:context.isTemplate,templateAgreementId:context.templateAgreementId,textData:context.textData,paymentMethodId:context.paymentMethodId,lastUpdatedStamp:context.lastUpdatedStamp]" in-map="context"/><iterate list="orderItemList" entry="orderItem"><entity-find-one entity-name="mantle.product.subscription.Subscription" value-field="subscription"><field-map field-name="orderId" from="orderItem.orderId"/><field-map field-name="orderItemSeqId" from="orderItem.orderItemSeqId"/></entity-find-one><set field="productId" from="orderItem.productId"/><set field="price" from="orderItem.unitAmount"/><if condition="subscription"><set field="subscriptionId" from="subscription.subscriptionId"/><service-call name="create#mantle.party.agreement.AgreementItem" out-map="[agreementId:context.agreementId,agreementItemSeqId:context.agreementItemSeqId,agreementItemTypeEnumId:context.agreementItemTypeEnumId,fromDate:context.fromDate,thruDate:context.thruDate,productId:context.productId,quantity:context.quantity,quantityUomId:context.quantityUomId,itemText:context.itemText,lastUpdatedStamp:context.lastUpdatedStamp]" in-map="context"/><service-call name="create#mantle.party.agreement.AgreementItemSubscription" out-map="[agreementItemSubscriptionId:context.agreementItemSubscriptionId,agreementId:context.agreementId,agreementItemSeqId:context.agreementItemSeqId,subscriptionId:context.subscriptionId,fromDate:context.fromDate,thruDate:context.thruDate,lastUpdatedStamp:context.lastUpdatedStamp]" in-map="context"/><set field="productId" value="XCU"/><set field="agreementItemTypeEnumId" value="AitPricing"/><set field="price" value="0"/><set field="fromDate" from="ec.user.nowTimestamp"/><set field="thruDate" from="new Timestamp(fromDate.time + (14*24*60*60*1000))"/><set field="agreementItemSeqId" from="agreementItemSeqId + 1"/><service-call name="create#mantle.party.agreement.AgreementItem" out-map="[agreementId:context.agreementId,agreementItemSeqId:context.agreementItemSeqId,agreementItemTypeEnumId:context.agreementItemTypeEnumId,fromDate:context.fromDate,thruDate:context.thruDate,productId:context.productId,quantity:context.quantity,quantityUomId:context.quantityUomId,itemText:context.itemText,lastUpdatedStamp:context.lastUpdatedStamp]" in-map="context"/><service-call name="create#mantle.product.ProductPrice" out-map="[productPriceId:context.productPriceId,productId:context.productId,productStoreId:context.productStoreId,vendorPartyId:context.vendorPartyId,customerPartyId:context.customerPartyId,priceTypeEnumId:context.priceTypeEnumId,pricePurposeEnumId:context.pricePurposeEnumId,fromDate:context.fromDate,thruDate:context.thruDate,minQuantity:context.minQuantity,price:context.price,priceUomId:context.priceUomId,termUomId:context.termUomId,taxInPrice:context.taxInPrice,taxAmount:context.taxAmount,taxPercentage:context.taxPercentage,taxAuthorityId:context.taxAuthorityId,agreementId:context.agreementId,agreementItemSeqId:context.agreementItemSeqId,otherPartyItemName:context.otherPartyItemName,otherPartyItemId:context.otherPartyItemId,comments:context.comments,quantityIncrement:context.quantityIncrement,quantityIncluded:context.quantityIncluded,quantityUomId:context.quantityUomId,preferredOrderEnumId:context.preferredOrderEnumId,supplierRatingTypeEnumId:context.supplierRatingTypeEnumId,standardLeadTimeDays:context.standardLeadTimeDays,canDropShip:context.canDropShip,lastUpdatedStamp:context.lastUpdatedStamp]" in-map="context"/><set field="fromDate" from="new Timestamp(thruDate.time + (24*60*60*1000))"/><set field="thruDate" value=""/><set field="price" value="1"/><set field="agreementItemSeqId" from="agreementItemSeqId + 1"/><service-call name="create#mantle.party.agreement.AgreementItem" out-map="[agreementId:context.agreementId,agreementItemSeqId:context.agreementItemSeqId,agreementItemTypeEnumId:context.agreementItemTypeEnumId,fromDate:context.fromDate,thruDate:context.thruDate,productId:context.productId,quantity:context.quantity,quantityUomId:context.quantityUomId,itemText:context.itemText,lastUpdatedStamp:context.lastUpdatedStamp]" in-map="context"/><set field="productPriceId" from="productPriceId + 1"/><service-call name="create#mantle.product.ProductPrice" out-map="[productPriceId:context.productPriceId,productId:context.productId,productStoreId:context.productStoreId,vendorPartyId:context.vendorPartyId,customerPartyId:context.customerPartyId,priceTypeEnumId:context.priceTypeEnumId,pricePurposeEnumId:context.pricePurposeEnumId,fromDate:context.fromDate,thruDate:context.thruDate,minQuantity:context.minQuantity,price:context.price,priceUomId:context.priceUomId,termUomId:context.termUomId,taxInPrice:context.taxInPrice,taxAmount:context.taxAmount,taxPercentage:context.taxPercentage,taxAuthorityId:context.taxAuthorityId,agreementId:context.agreementId,agreementItemSeqId:context.agreementItemSeqId,otherPartyItemName:context.otherPartyItemName,otherPartyItemId:context.otherPartyItemId,comments:context.comments,quantityIncrement:context.quantityIncrement,quantityIncluded:context.quantityIncluded,quantityUomId:context.quantityUomId,preferredOrderEnumId:context.preferredOrderEnumId,supplierRatingTypeEnumId:context.supplierRatingTypeEnumId,standardLeadTimeDays:context.standardLeadTimeDays,canDropShip:context.canDropShip,lastUpdatedStamp:context.lastUpdatedStamp]" in-map="context"/><else><service-call name="create#mantle.party.agreement.AgreementItem" out-map="[agreementId:context.agreementId,agreementItemSeqId:context.agreementItemSeqId,agreementItemTypeEnumId:context.agreementItemTypeEnumId,fromDate:context.fromDate,thruDate:context.thruDate,productId:context.productId,quantity:context.quantity,quantityUomId:context.quantityUomId,itemText:context.itemText,lastUpdatedStamp:context.lastUpdatedStamp]" in-map="context"/><service-call name="create#mantle.product.ProductPrice" out-map="[productPriceId:context.productPriceId,productId:context.productId,productStoreId:context.productStoreId,vendorPartyId:context.vendorPartyId,customerPartyId:context.customerPartyId,priceTypeEnumId:context.priceTypeEnumId,pricePurposeEnumId:context.pricePurposeEnumId,fromDate:context.fromDate,thruDate:context.thruDate,minQuantity:context.minQuantity,price:context.price,priceUomId:context.priceUomId,termUomId:context.termUomId,taxInPrice:context.taxInPrice,taxAmount:context.taxAmount,taxPercentage:context.taxPercentage,taxAuthorityId:context.taxAuthorityId,agreementId:context.agreementId,agreementItemSeqId:context.agreementItemSeqId,otherPartyItemName:context.otherPartyItemName,otherPartyItemId:context.otherPartyItemId,comments:context.comments,quantityIncrement:context.quantityIncrement,quantityIncluded:context.quantityIncluded,quantityUomId:context.quantityUomId,preferredOrderEnumId:context.preferredOrderEnumId,supplierRatingTypeEnumId:context.supplierRatingTypeEnumId,standardLeadTimeDays:context.standardLeadTimeDays,canDropShip:context.canDropShip,lastUpdatedStamp:context.lastUpdatedStamp]" in-map="context"/></else></if></iterate></actions></service>