<!--Service Location mantle.product.EquipmentServices.get#AssetMaintenanceNeeded--><service verb="get" noun="AssetMaintenanceNeeded"><in-parameters><parameter name="assetId" required="true"/><parameter name="productMaintenanceId" required="true"/></in-parameters><out-parameters><parameter name="lastAssetMeter" type="EntityValue"/><parameter name="lastReadingDate" type="Timestamp"/><parameter name="lastMeterValue" type="BigDecimal"/><parameter name="lastAssetMaintenance" type="EntityValue"/><parameter name="lastMaintenanceDate" type="Timestamp"/><parameter name="lastMaintenanceInterval" type="BigDecimal"/><parameter name="nextMaintenanceInterval" type="BigDecimal"/><parameter name="remainingInterval" type="BigDecimal"/></out-parameters><actions><entity-find-one entity-name="mantle.product.maintenance.ProductMaintenance" value-field="productMaintenance"/><if condition="productMaintenance.intervalProductMeterId"><entity-find entity-name="mantle.product.maintenance.AssetMeter" list="assetMeterList"><econdition field-name="assetId"/><econdition field-name="productMeterId" from="productMaintenance.intervalProductMeterId"/><order-by field-name="-meterValue"/></entity-find><set field="lastAssetMeter" from="assetMeterList?.getAt(0)"/><if condition="lastAssetMeter"><set field="lastReadingDate" from="lastAssetMeter.readingDate"/><set field="lastMeterValue" from="lastAssetMeter.meterValue"/></if></if><entity-find entity-name="mantle.product.maintenance.AssetMaintenance" list="assetMaintenanceList"><econdition field-name="assetId"/><econdition field-name="productMaintenanceId"/><order-by field-name="-maintenanceDate"/></entity-find><set field="lastAssetMaintenance" from="assetMaintenanceList?.getAt(0)"/><if condition="lastAssetMaintenance"><set field="lastMaintenanceDate" from="lastAssetMaintenance.maintenanceDate"/><set field="lastMaintenanceInterval" from="lastAssetMaintenance.intervalQuantity"/></if><set field="nextMaintenanceInterval" from="(lastMaintenanceInterval ?: 0) + productMaintenance.intervalQuantity"/><set field="remainingInterval" from="nextMaintenanceInterval - (lastMeterValue ?: 0)"/></actions></service>