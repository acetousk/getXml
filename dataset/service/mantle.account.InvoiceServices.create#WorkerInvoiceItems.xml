<!--Service Location mantle.account.InvoiceServices.create#WorkerInvoiceItems--><service verb="create" noun="WorkerInvoiceItems"><in-parameters><parameter name="workerPartyId" required="true"/><parameter name="vendorPartyId" required="true"><description><![CDATA[Matches TimeEntry.vendorPartyId, a Project Vendor or Employer]]></description></parameter><parameter name="invoiceId"><description><![CDATA[If specified add item(s) to this Invoice. If empty an Invoice will be created.]]></description></parameter><parameter name="thruDate" type="Timestamp" default="ec.user.nowTimestamp"><description><![CDATA[Only TimeEntry records before this date will be included. Defaults to now.]]></description></parameter><parameter name="invoiceDate" type="Timestamp" default="ec.user.nowTimestamp"/><parameter name="currencyUomId"/><parameter name="workEffortId"><description><![CDATA[If specified filter TimeEntry query by the specified WorkEffort and all WorkEfforts matching on rootWorkEffortId (for projects, etc) or parentWorkEffortId]]></description></parameter><parameter name="timesheetId"><description><![CDATA[If specified get TimeEntry records constrained on it.]]></description></parameter></in-parameters><out-parameters/><actions><entity-find-one entity-name="mantle.party.PartyDetail" value-field="workerParty"><field-map field-name="partyId" from="workerPartyId"/></entity-find-one><entity-find entity-name="mantle.party.PartyRelationship" list="employeeRelationshipList"><date-filter/><econdition field-name="fromPartyId" from="workerPartyId"/><econdition field-name="toPartyId" from="vendorPartyId"/><econdition field-name="relationshipTypeEnumId" value="PrtEmployee"/><econdition field-name="fromRoleTypeId" value="Employee"/></entity-find><set field="isEmployee" from="employeeRelationshipList.size() > 0"/><set field="invoiceTypeEnumId" from="workerParty?.partyTypeEnumId == 'PtyPerson' ?                     (isEmployee ? 'InvoicePayroll' : 'InvoicePayrollOther') : 'InvoiceSales'"/><set field="itemTypeEnumId" from="workerParty?.partyTypeEnumId == 'PtyPerson' && isEmployee ? 'ItemHourlyEarnings' : 'ItemTimeEntry'"/><if condition="!invoiceId"><if condition="!currencyUomId"><entity-find-one entity-name="mantle.ledger.config.PartyAcctgPreference" value-field="partyAcctgPreference"><field-map field-name="organizationPartyId" from="vendorPartyId"/></entity-find-one><set field="currencyUomId" from="partyAcctgPreference?.baseCurrencyUomId ?: 'USD'"/></if><set field="description" value="Invoice for worker ${ec.resource.expand('PartyNameTemplate','',workerParty)}"/><service-call name="mantle.account.InvoiceServices.create#Invoice" out-map="[invoiceId:context.invoiceId]" in-map="[invoiceTypeEnumId:invoiceTypeEnumId, fromPartyId:workerPartyId, toPartyId:vendorPartyId,                             invoiceDate:invoiceDate, currencyUomId:currencyUomId, description:description]"/></if><service-call name="mantle.account.InvoiceServices.create#TimeEntryInvoiceItems" out-map="[invoiceItemCreatedCount:createResult.invoiceItemCreatedCount]" in-map="[invoiceId:invoiceId, workEffortId:workEffortId, timesheetId:timesheetId, thruDate:thruDate,                         currencyUomId:currencyUomId, ratePurposeEnumId:'RaprVendor', itemTypeEnumId:itemTypeEnumId,                         workerPartyId:workerPartyId, vendorPartyId:vendorPartyId]"/><if condition="!createResult.invoiceItemCreatedCount"><then><message error="true"><![CDATA[No time entries found for worker ${ec.resource.expand('PartyNameTemplate','',workerParty)}, not creating invoice or adding items to existing invoice.]]></message></then><else><message><![CDATA[Added ${createResult.invoiceItemCreatedCount} items to Invoice ${invoiceId}]]></message></else></if></actions></service>