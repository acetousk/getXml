<!--Service Location coarchy.ProductEvaluationServices.add#ProductEvaluationParty--><service verb="add" noun="ProductEvaluationParty"><in-parameters><parameter name="productEvaluationId" required="true" entity-name="coarchy.product.ProductEvaluationParty" field-name="productEvaluationId"/><parameter name="organizationId" required="true" entity-name="coarchy.product.ProductEvaluationParty" field-name="organizationId"/><parameter name="emailAddress" required="true"/><parameter name="firstName"/><parameter name="lastName"/></in-parameters><out-parameters/><actions><entity-find-one entity-name="coarchy.product.ProductEvaluation" value-field="productEvaluation"/><if condition="!productEvaluation"><return error="true" message="Product Evaluation #${productEvaluationId} not found."/></if><set field="organizationId" from="productEvaluation.organizationId"/><entity-find-count entity-name="mantle.party.PartyRelationship" count-field="partyRelationshipCount"><date-filter/><econditions combine="or"><econditions><econdition field-name="relationshipTypeEnumId" value="PrtMember"/><econdition field-name="toRoleTypeId" value="OrgInternal"/></econditions><econditions><econdition field-name="relationshipTypeEnumId" value="PrtVendorRepresentative"/><econdition field-name="toRoleTypeId" value="VendorRepresentative"/></econditions></econditions><econdition field-name="fromPartyId" from="ec.user.userAccount.partyId"/><econdition field-name="toPartyId" from="organizationId"/></entity-find-count><if condition="!partyRelationshipCount"><return type="danger" error="true" message="${ec.resource.expand('CoarchyGeneralNotAllowed', null)}"/></if><if condition="!['PeRequirementsSelection', 'PeInviteVendors', 'PeAwaitingVendorResponse'].contains(productEvaluation.statusId)"><return error="true" message="Cannot add vendors in this status."/></if><entity-find entity-name="moqui.security.UserAccount" list="existingUaList"><econdition field-name="emailAddress" ignore-case="true"/></entity-find><if condition="!existingUaList"><then><service-call name="coarchy.CoarchyServices.create#Account" out-map="[userId:newUser.userId,partyId:newUser.partyId,emailContactMechId:newUser.emailContactMechId]" in-map="[emailAddress:emailAddress,firstName:firstName?:'Not',lastName:lastName?:'Set',username:emailAddress]"/><service-call name="create#mantle.party.PartyRole" in-map="[partyId:newUser.partyId,roleTypeId:'VendorRepresentative']"/><service-call name="create#moqui.security.UserGroupMember" in-map="[userGroupId:'COARCHY_USERS',                             userId:newUser.userId, fromDate:ec.user.nowTimestamp]"/><service-call name="create#moqui.security.UserGroupMember" in-map="[userGroupId:'COARCHY_VENDORS',                             userId:newUser.userId, fromDate:ec.user.nowTimestamp]"/><service-call name="org.moqui.impl.UserServices.set#Preference" in-map="[preferenceKey:'ACTIVE_ORGANIZATION',preferenceValue:organizationId]"/></then><else><set field="newUser" from="existingUaList?.getFirst()"/><entity-find entity-name="moqui.security.UserGroupMember" list="vendorGroupMemberList"><date-filter/><econdition field-name="userGroupId" value="COARCHY_VENDORS"/><econdition field-name="userId" from="newUser.userId"/></entity-find><if condition="!vendorGroupMemberList"><service-call name="create#moqui.security.UserGroupMember" in-map="[userGroupId:'COARCHY_VENDORS',                             userId:newUser.userId, fromDate:ec.user.nowTimestamp]"/></if></else></if><set field="newPartyId" from="newUser.partyId"/><set field="newUserId" from="newUser.userId"/><entity-find-count entity-name="mantle.party.PartyRelationship" count-field="partyRelationshipCount"><date-filter/><econdition field-name="relationshipTypeEnumId" value="PrtVendorRepresentative"/><econdition field-name="toRoleTypeId" value="VendorRepresentative"/><econdition field-name="fromPartyId" from="newPartyId"/><econdition field-name="toPartyId" from="organizationId"/></entity-find-count><set field="isInvitedUserOrgMember" from="partyRelationshipCount > 0"/><if condition="!isInvitedUserOrgMember"><then><service-call name="create#mantle.party.PartyRelationship" in-map="[relationshipTypeEnumId:'PrtVendorRepresentative',                         fromPartyId:newUser.partyId,toRoleTypeId:'VendorRepresentative',toPartyId:organizationId,fromDate:ec.user.nowTimestamp]"/></then></if><entity-find entity-name="coarchy.product.ProductEvaluationParty" list="evalPartyList"><date-filter/><econdition field-name="productEvaluationId"/><econdition field-name="partyId" from="newPartyId"/><econdition field-name="roleTypeId" value="VendorRepresentative"/><econdition field-name="statusId" operator="in" value="PepPlanned,PepInvited,PepAccepted,PepRejected"/><order-by field-name="-fromDate"/></entity-find><if condition="!evalPartyList"><service-call name="create#coarchy.product.ProductEvaluationParty" in-map="[productEvaluationId:productEvaluationId, roleTypeId:'VendorRepresentative', fromDate:ec.user.nowTimestamp, partyId:newPartyId, statusId: 'PepPlanned',organizationId:organizationId]"/><if condition="productEvaluation.statusId == 'PeAwaitingVendorResponse'"><service-call name="coarchy.ProductEvaluationServices.send#ProductEvaluationInvitations" in-map="[productEvaluationId:productEvaluationId]"/></if><else><entity-find-one entity-name="mantle.product.Product" value-field="product" auto-field-map="[productId:productEvaluation.productId]"/><return type="warning" message="${ec.resource.expand('CoarchyProductVendorAlreadyInvited', null, [emailAddress:emailAddress, productName:product.productName])}"/></else></if></actions></service>