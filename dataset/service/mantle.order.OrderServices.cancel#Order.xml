<!--Service Location mantle.order.OrderServices.cancel#Order--><service verb="cancel" noun="Order"><in-parameters><parameter name="orderId" required="true"/><parameter name="orderPartSeqId"/></in-parameters><out-parameters><parameter name="oldStatusId"/><parameter name="statusChanged" type="Boolean"/></out-parameters><actions><entity-find-one entity-name="mantle.order.OrderHeader" value-field="orderHeader" for-update="true"/><if condition="orderHeader == null"><return error="true" message="Order ${orderId} not found"/></if><if condition="orderHeader.statusId == 'OrderCompleted'"><return error="true" message="Cannot cancel order ${orderId}, already Completed"/></if><if condition="orderHeader.statusId in ['OrderRejected', 'OrderCancelled']"><return message="Order ${orderId} already Cancelled"/></if><entity-find entity-name="mantle.product.issuance.AssetIssuance" list="fullAssetIssuanceList"><econdition field-name="orderId"/></entity-find><entity-find entity-name="mantle.shipment.ShipmentItemSource" list="fullShipmentItemSourceList"><econdition field-name="orderId"/></entity-find><set field="quantityIssued" from="0.0"/><iterate list="fullAssetIssuanceList" entry="assetIssuance"><set field="quantityIssued" from="quantityIssued + assetIssuance.quantity"/></iterate><set field="hasIssuedQuantity" from="quantityIssued > 0.0"/><entity-find entity-name="mantle.order.OrderItem" list="orderItemList"><econdition field-name="orderId"/></entity-find><iterate list="orderItemList" entry="orderItem"><service-call name="mantle.order.OrderServices.cancel#OrderItem" out-map="[hasIssuedQuantity:itemOut.hasIssuedQuantity,quantityCancelled:itemOut.quantityCancelled]" out-map-add-to-existing="false" in-map="[orderId:orderId, orderItemSeqId:orderItem.orderItemSeqId, orderItem:orderItem, checkCancelPart:false,                             fullAssetIssuanceList:fullAssetIssuanceList, fullShipmentItemSourceList:fullShipmentItemSourceList]"/></iterate><set field="targetStatusId" from="hasIssuedQuantity ? 'OrderCompleted' : 'OrderCancelled'"/><entity-find entity-name="mantle.order.OrderPart" list="orderPartList"><econdition field-name="orderId"/></entity-find><iterate list="orderPartList" entry="orderPart"><service-call name="update#mantle.order.OrderPart" out-map="[orderId:context.orderId,orderPartSeqId:context.orderPartSeqId,parentPartSeqId:context.parentPartSeqId,partName:context.partName,statusId:context.statusId,vendorPartyId:context.vendorPartyId,customerPartyId:context.customerPartyId,otherPartyOrderId:context.otherPartyOrderId,otherPartyOrderDate:context.otherPartyOrderDate,facilityId:context.facilityId,carrierPartyId:context.carrierPartyId,shipmentMethodEnumId:context.shipmentMethodEnumId,tradeTermEnumId:context.tradeTermEnumId,settlementTermId:context.settlementTermId,postalContactMechId:context.postalContactMechId,telecomContactMechId:context.telecomContactMechId,trackingNumber:context.trackingNumber,shippingInstructions:context.shippingInstructions,maySplit:context.maySplit,signatureRequiredEnumId:context.signatureRequiredEnumId,giftMessage:context.giftMessage,isGift:context.isGift,isNewCustomer:context.isNewCustomer,partTotal:context.partTotal,priority:context.priority,shipAfterDate:context.shipAfterDate,shipBeforeDate:context.shipBeforeDate,estimatedShipDate:context.estimatedShipDate,estimatedDeliveryDate:context.estimatedDeliveryDate,estimatedPickUpDate:context.estimatedPickUpDate,validFromDate:context.validFromDate,validThruDate:context.validThruDate,autoCancelDate:context.autoCancelDate,dontCancelSetDate:context.dontCancelSetDate,dontCancelSetUserId:context.dontCancelSetUserId,disablePromotions:context.disablePromotions,disableShippingCalc:context.disableShippingCalc,disableTaxCalc:context.disableTaxCalc,reservationAutoEnumId:context.reservationAutoEnumId,checkoutId:context.checkoutId,checkoutUrl:context.checkoutUrl,lastUpdatedStamp:context.lastUpdatedStamp]" in-map="[orderId:orderId, orderPartSeqId:orderPart.orderPartSeqId, statusId:targetStatusId]"/></iterate><service-call name="update#mantle.order.OrderHeader" out-map="[orderId:context.orderId,orderName:context.orderName,entryDate:context.entryDate,placedDate:context.placedDate,approvedDate:context.approvedDate,completedDate:context.completedDate,statusId:context.statusId,processingStatusId:context.processingStatusId,orderRevision:context.orderRevision,currencyUomId:context.currencyUomId,billingAccountId:context.billingAccountId,productStoreId:context.productStoreId,salesChannelEnumId:context.salesChannelEnumId,terminalId:context.terminalId,displayId:context.displayId,externalId:context.externalId,externalRevision:context.externalRevision,originId:context.originId,originUrl:context.originUrl,syncStatusId:context.syncStatusId,systemMessageRemoteId:context.systemMessageRemoteId,visitId:context.visitId,enteredByPartyId:context.enteredByPartyId,parentOrderId:context.parentOrderId,recurCronExpression:context.recurCronExpression,lastOrderedDate:context.lastOrderedDate,recurAutoInvoice:context.recurAutoInvoice,remainingSubTotal:context.remainingSubTotal,grandTotal:context.grandTotal,lastUpdatedStamp:context.lastUpdatedStamp]" in-map="[orderId:orderId, statusId:targetStatusId]"/></actions></service>