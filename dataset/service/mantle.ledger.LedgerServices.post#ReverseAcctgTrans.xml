<!--Service Location mantle.ledger.LedgerServices.post#ReverseAcctgTrans--><service verb="post" noun="ReverseAcctgTrans"><in-parameters><parameter name="acctgTransId" required="true"/><parameter name="deleteIfNotPosted" type="Boolean" default="false"/><parameter name="createOnly" type="Boolean" default="false"/></in-parameters><out-parameters><parameter name="acctgTransId" required="true"/></out-parameters><actions><entity-find-one entity-name="mantle.ledger.transaction.AcctgTrans" value-field="acctgTrans" for-update="true"/><if condition="acctgTrans.isPosted != 'Y'"><if condition="deleteIfNotPosted"><then><service-call name="mantle.ledger.LedgerServices.delete#AcctgTrans" in-map="[acctgTransId:acctgTransId]"/><return message="Deleted unposted transaction ${acctgTransId} instead of creating new reverse transaction"/></then><else><return error="true" message="Not reversing transaction ${acctgTransId}, transaction is not posted"/></else></if></if><if condition="acctgTrans.reversedByAcctgTransId"><return error="true" message="Not reversing transaction ${acctgTransId}, already reversed by transaction ${acctgTrans.reversedByAcctgTransId}"/></if><entity-find entity-name="mantle.ledger.transaction.AcctgTransEntry" list="acctgTransEntryList"><econdition field-name="acctgTransId"/><order-by field-name="acctgTransEntrySeqId"/></entity-find><set field="reverseAcctgTrans" from="acctgTrans.clone()"/><set field="reverseAcctgTrans.acctgTransId" from="null"/><entity-sequenced-id-primary value-field="reverseAcctgTrans"/><set field="reverseAcctgTrans.reverseOfAcctgTransId" from="acctgTransId"/><set field="reverseAcctgTrans.isPosted" value="N"/><entity-create value-field="reverseAcctgTrans"/><set field="reverseAcctgTransId" from="reverseAcctgTrans.acctgTransId"/><set field="useErrorJournal" from="false"/><iterate list="acctgTransEntryList" entry="acctgTransEntry"><set field="reverseAcctgTransEntry" from="acctgTransEntry.clone()"/><set field="reverseAcctgTransEntry.acctgTransId" from="reverseAcctgTransId"/><set field="reverseAcctgTransEntry.reconcileStatusId" value="AterNot"/><set field="reverseAcctgTransEntry.debitCreditFlag" from="reverseAcctgTransEntry.debitCreditFlag == 'C' ? 'D' : 'C'"/><entity-create value-field="reverseAcctgTransEntry"/><if condition="!reverseAcctgTransEntry.glAccountId"><set field="useErrorJournal" from="true"/></if></iterate><message><![CDATA[Created GL transaction ${reverseAcctgTransId} to reverse transaction ${acctgTransId}]]></message><if condition="useErrorJournal"><then><service-call name="mantle.ledger.LedgerServices.find#PartyAcctgPreference" out-map="[partyAcctgPreference:context.partyAcctgPreference]" in-map="[organizationPartyId:acctgTrans.organizationPartyId]"/><if condition="partyAcctgPreference?.errorGlJournalId"><service-call name="update#mantle.ledger.transaction.AcctgTrans" in-map="[acctgTransId:reverseAcctgTrans.acctgTransId,                                 glJournalId:partyAcctgPreference.errorGlJournalId]"/></if></then><else-if condition="!createOnly"><service-call name="mantle.ledger.LedgerServices.post#AcctgTrans" in-map="[acctgTransId:reverseAcctgTransId]"/><message><![CDATA[Posted transaction ${reverseAcctgTransId}]]></message></else-if></if><set field="acctgTrans.reversedByAcctgTransId" from="reverseAcctgTransId"/><entity-update value-field="acctgTrans"/><set field="acctgTransId" from="reverseAcctgTransId"/></actions></service>