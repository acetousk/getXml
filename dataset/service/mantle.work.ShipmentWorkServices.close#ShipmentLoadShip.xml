<!--Service Location mantle.work.ShipmentWorkServices.close#ShipmentLoadShip--><service verb="close" noun="ShipmentLoadShip"><in-parameters><parameter name="workEffortId" required="true"/></in-parameters><out-parameters><parameter name="oldStatusId"/><parameter name="statusChanged" type="Boolean"/></out-parameters><actions><entity-find-one entity-name="mantle.work.effort.WorkEffort" value-field="workEffort" for-update="true"/><if condition="workEffort?.purposeEnumId != 'WepShipmentShip'"><return type="danger" message="Work Effort ${workEffortId} is not a Picklist (Shipment Load/Ship)"/></if><if condition="workEffort.statusId in ['WeClosed', 'WeCancelled']"><return type="danger" message="Cannot Close Picklist ${workEffortId} in status ${workEffort.status?.description ?: workEffort.statusId}"/></if><entity-find entity-name="mantle.shipment.Shipment" list="shipmentList"><econdition field-name="shipWorkEffortId" from="workEffortId"/></entity-find><set field="statusIdSet" from="new HashSet()"/><iterate list="shipmentList" entry="shipment"><if condition="shipment.statusId in ['ShipInput', 'ShipScheduled', 'ShipPicked', 'ShipPacked']"><then><set field="shipment.shipWorkEffortId" from="null"/><set field="shipment.binLocationNumber" from="null"/><entity-update value-field="shipment"/></then><else><script><![CDATA[statusIdSet.add(shipment.statusId)]]></script></else></if></iterate><if condition="statusIdSet.size() == 0 || (statusIdSet.size() == 1 && statusIdSet.contains('ShipCancelled'))"><then><service-call name="update#mantle.work.effort.WorkEffort" in-map="[workEffortId:workEffortId, statusId:'WeCancelled']"/></then><else><service-call name="update#mantle.work.effort.WorkEffort" in-map="[workEffortId:workEffortId, statusId:'WeClosed']"/></else></if></actions></service>