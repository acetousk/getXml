<!--Service Location mantle.order.ReturnServices.return#Shipment--><service verb="return" noun="Shipment"><in-parameters><parameter name="shipmentId" required="true" entity-name="mantle.shipment.Shipment" field-name="shipmentId"/><parameter name="returnReasonEnumId" required="true"/><parameter name="returnResponseEnumId" required="true"/><parameter name="responseImmediate"/></in-parameters><out-parameters><parameter name="returnId"/></out-parameters><actions><entity-find-one entity-name="mantle.shipment.Shipment" value-field="shipment"/><if condition="!(shipment.shipmentTypeEnumId in ['ShpTpSales', 'ShpTpPurchase'])"><return error="true" message="Shipment ${shipmentId} is not a Sales or Purchase shipment"/></if><if condition="!(shipment.statusId in ['ShipPacked', 'ShipShipped'])"><return error="true" message="Shipment ${shipmentId} is not in the Packed or Shipped status"/></if><set field="vendorPartyId" from="shipment.fromPartyId"/><set field="customerPartyId" from="shipment.toPartyId"/><entity-find entity-name="mantle.shipment.ShipmentRouteSegment" list="srsList"><econdition field-name="shipmentId"/></entity-find><set field="srs" from="srsList[0]"/><entity-find-one entity-name="mantle.party.PartyRole" value-field="customerOrgInternal"><field-map field-name="partyId" from="customerPartyId"/><field-map field-name="roleTypeId" value="OrgInternal"/></entity-find-one><if condition="customerOrgInternal"><then><set field="facilityId" from="srs.destinationFacilityId"/><set field="postalContactMechId" from="srs.originPostalContactMechId"/><set field="telecomContactMechId" from="srs.originTelecomContactMechId"/></then><else><set field="facilityId" from="srs.originFacilityId"/><set field="postalContactMechId" from="srs.destPostalContactMechId"/><set field="telecomContactMechId" from="srs.destTelecomContactMechId"/></else></if><service-call name="mantle.order.ReturnServices.create#Return" out-map="[returnId:context.returnId]" in-map="[vendorPartyId:vendorPartyId, customerPartyId:customerPartyId, facilityId:facilityId,                         postalContactMechId:postalContactMechId, telecomContactMechId:telecomContactMechId]"/><entity-find entity-name="mantle.shipment.ShipmentItemSource" list="sisList"><econdition field-name="shipmentId"/></entity-find><iterate list="sisList" entry="sis"><service-call name="mantle.order.ReturnServices.add#OrderItemToReturn" in-map="[returnId:returnId,                         orderId:sis.orderId, orderItemSeqId:sis.orderItemSeqId, returnQuantity:sis.quantity,                         returnReasonEnumId:returnReasonEnumId, returnResponseEnumId:returnResponseEnumId,                         responseImmediate:responseImmediate]"/></iterate></actions></service>