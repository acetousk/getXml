<!--Service Location mantle.work.ProjectServices.get#ProjectParties--><service verb="get" noun="ProjectParties"><in-parameters><parameter name="rootWorkEffortId" default="workEffortId"/><parameter name="workEffortId"/><parameter name="term"/><parameter name="roleTypeId"/><parameter name="searchIndexName" default-value="mantle"/><parameter name="searchPartyDocType" default-value="MantleParty"/><parameter name="pageIndex" type="Integer" default="0"/><parameter name="pageSize" type="Integer" default="20"/><parameter name="addOptional" type="Boolean" default="true"/><parameter name="onlyAssignable" type="Boolean" default="true"/></in-parameters><out-parameters><parameter name="resultList" type="List"><parameter name="result" type="Map"/></parameter></out-parameters><actions><if condition="onlyAssignable && !roleTypeId"><entity-find entity-name="mantle.party.RoleGroupMember" list="projectRoleList" cache="true"><econdition field-name="roleGroupEnumId" operator="in" value="RgpTask,RgpProject"/><order-by field-name="roleTypeId"/></entity-find><set field="roleTypeId" from="projectRoleList*.roleTypeId.join(',')"/></if><if condition="rootWorkEffortId"><then><entity-find entity-name="mantle.work.effort.WorkEffortAndPartyDetail" list="partyList" limit="20"><date-filter/><econdition field-name="workEffortId" from="rootWorkEffortId"/><econdition field-name="roleTypeId" operator="in" ignore-if-empty="true"/><econditions combine="or"><econdition field-name="firstName" operator="like" value="${term}%" ignore-case="true" ignore="!term"/><econdition field-name="lastName" operator="like" value="${term}%" ignore-case="true" ignore="!term"/><econdition field-name="organizationName" operator="like" value="${term}%" ignore-case="true" ignore="!term"/><econdition field-name="pseudoId" operator="like" value="${term}%" ignore-case="true" ignore="!term"/></econditions><order-by field-name="^firstName,^lastName,^organizationName"/></entity-find><script><![CDATA[resultList = []
                    if (addOptional) resultList.add([partyId:"", name:"None"])
                    for (party in partyList) resultList.add([partyId:party.partyId, name:ec.resource.expand('PartyNameTemplate', '', party)])]]></script></then><else><set field="term" from="term ?: '*'"/><entity-find-one entity-name="mantle.party.PartyDetail" value-field="partyDetail"><field-map field-name="partyId" from="term"/></entity-find-one><if condition="partyDetail != null"><then><script><![CDATA[def outList = [[partyId:partyDetail.partyId, name:ec.resource.expand("PartyNameTemplate", "", partyDetail)]]
                        ec.web.sendJsonResponse(outList)]]></script></then><else><set field="activeOrgId" from="ec.user.context?.activeOrgId"/><set field="filterOrgIds" from="ec.user.context?.filterOrgIds"/><set field="findFilters" from="ec.artifactExecution.getFindFiltersForUser('mantle.party.Party')"/><if condition="findFilters"><set field="entityFilterSetId" from="findFilters[0].entityFilterSetId"/></if><script><![CDATA[StringBuilder termSb = new StringBuilder('(')
                        if (term.contains('*')) termSb.append(term)
                        else term.split(' ').each({ termSb.append(it).append('* ') })
                        termSb.append(')')

                        if (roleTypeId) termSb.append(' AND roles.roleTypeId:(').append(roleTypeId.replaceAll(/,/, ' OR ')).append(')')
                        termSb.append(' AND (NOT disabled:Y)')

                        if ('MANTLE_USER_ORG'.equals(entityFilterSetId)) {
                            termSb.append(' AND ownerPartyId:(' + (filterOrgIds ? filterOrgIds.join(' OR ') + ' OR ' : '') + '_NA_)')
                        } else if ('MANTLE_ACTIVE_ORG'.equals(entityFilterSetId) && activeOrgId) {
                            termSb.append(' AND ownerPartyId:(' + activeOrgId + ' OR _NA_)')
                        }]]></script><service-call name="org.moqui.search.SearchServices.search#DataDocuments" out-map="[documentList:context.documentList,documentListCount:context.documentListCount,documentListPageIndex:context.documentListPageIndex,documentListPageSize:context.documentListPageSize,documentListPageMaxIndex:context.documentListPageMaxIndex,documentListPageRangeLow:context.documentListPageRangeLow,documentListPageRangeHigh:context.documentListPageRangeHigh]" in-map="[queryString:termSb.toString(), indexName:searchIndexName, documentType:searchPartyDocType]"/><script><![CDATA[def outList = []
                        for (document in documentList) outList.add([partyId:document._id, name:ec.resource.expand("PartyNameTemplate", "", document)])
                        ec.web.sendJsonResponse(outList)]]></script></else></if></else></if></actions></service>