<!--Service Location mantle.ledger.LedgerServices.update#GlAccountOrgSummariesForTx--><service verb="update" noun="GlAccountOrgSummariesForTx"><in-parameters><parameter name="acctgTransId" required="true"/><parameter name="isUnpost" type="Boolean" default="false"/><parameter name="timePeriodList" type="List"><parameter name="timePeriod" type="Map"/></parameter></in-parameters><out-parameters/><actions><entity-find-one entity-name="mantle.ledger.transaction.AcctgTrans" value-field="acctgTrans"/><entity-find entity-name="mantle.ledger.transaction.AcctgTransEntry" list="acctgTransEntryList"><econdition field-name="acctgTransId"/><order-by field-name="acctgTransEntrySeqId"/></entity-find><set field="glAccountIdList" from="new LinkedList(new HashSet(acctgTransEntryList*.glAccountId)).sort()"/><set field="glAccountById" from="new LinkedHashMap()"/><iterate list="glAccountIdList" entry="glAccountId"><entity-find-one entity-name="mantle.ledger.account.GlAccount" value-field="glAccount" cache="true"><field-map field-name="glAccountId" from="glAccountId"/></entity-find-one><script><![CDATA[glAccountById.put(glAccountId, glAccount)]]></script></iterate><if condition="!timePeriodList"><service-call name="mantle.ledger.LedgerServices.get#OrganizationFiscalTimePeriods" out-map="[timePeriodList:context.timePeriodList]" in-map="[organizationPartyId:acctgTrans.organizationPartyId, filterDate:acctgTrans.transactionDate]"/><if condition="!timePeriodList"><return message="Not un-posting transaction ${acctgTransId}, could not find time period for organization ${acctgTrans.organizationPartyId} at ${ec.l10n.format(acctgTrans.transactionDate, null)}"/></if></if><set field="subsequentPeriodListArray" from="new ArrayList()"/><iterate entry="timePeriod" list="timePeriodList"><script><![CDATA[List subsequentPeriodIds = []
                    subsequentPeriodListArray.add(subsequentPeriodIds)
                    String curSubPeriodId = timePeriod.timePeriodId
                    while (curSubPeriodId) {
                        Map subNextResult = ec.service.sync().name("mantle.party.TimeServices.get#NextTimePeriod")
                                .parameter("timePeriodId", curSubPeriodId).call()
                        curSubPeriodId = subNextResult.nextTimePeriodId
                        if (curSubPeriodId) subsequentPeriodIds.add(curSubPeriodId)
                    }]]></script></iterate><set field="glAccountOrganizationById" from="[:]"/><iterate list="glAccountIdList" entry="glAccountId"><entity-find-one entity-name="mantle.ledger.account.GlAccountOrganization" value-field="glAccountOrganization" for-update="true"><field-map field-name="glAccountId"/><field-map field-name="organizationPartyId" from="acctgTrans.organizationPartyId"/></entity-find-one><if condition="glAccountOrganization == null"><entity-find-one entity-name="mantle.ledger.account.GlAccount" value-field="glAccount" for-update="true"/><entity-find-one entity-name="mantle.ledger.account.GlAccountOrganization" value-field="glAccountOrganization" for-update="true"><field-map field-name="glAccountId"/><field-map field-name="organizationPartyId" from="acctgTrans.organizationPartyId"/></entity-find-one><if condition="glAccountOrganization == null"><entity-make-value entity-name="mantle.ledger.account.GlAccountOrganization" value-field="glAccountOrganization" map="[glAccountId:glAccountId, organizationPartyId:acctgTrans.organizationPartyId]"/><entity-create value-field="glAccountOrganization"/></if></if><script><![CDATA[glAccountOrganizationById.put(glAccountId, glAccountOrganization)]]></script></iterate><set field="isPeriodClosing" from="acctgTrans.acctgTransTypeEnumId == 'AttNetIncomeClosing'"/><iterate list="acctgTransEntryList" entry="acctgTransEntry"><set field="glAccountOrganization" from="glAccountOrganizationById.get(acctgTransEntry.glAccountId)"/><set field="postingAmount" from="0.0"/><set field="glAccount" from="glAccountById.get(acctgTransEntry.glAccountId)"/><if condition="glAccount.isDebit.equals('Y')"><then><set field="postingAmount" from="acctgTransEntry.debitCreditFlag == 'D' ? acctgTransEntry.amount : -acctgTransEntry.amount"/></then><else><set field="postingAmount" from="acctgTransEntry.debitCreditFlag == 'D' ? -acctgTransEntry.amount : acctgTransEntry.amount"/></else></if><if condition="isUnpost"><set field="postingAmount" from="-postingAmount"/></if><set field="glAccountOrganization.postedBalance" from="(glAccountOrganization.postedBalance ?: 0.0) + postingAmount"/><set field="glAccountOrganization.balanceLastUpdated" from="ec.user.nowTimestamp"/><entity-update value-field="glAccountOrganization"/><iterate list="timePeriodList" entry="timePeriod"><entity-find-one entity-name="mantle.ledger.account.GlAccountOrgTimePeriod" value-field="glAccountOrgTimePeriod" for-update="true"><field-map field-name="glAccountId" from="acctgTransEntry.glAccountId"/><field-map field-name="organizationPartyId" from="acctgTrans.organizationPartyId"/><field-map field-name="timePeriodId" from="timePeriod.timePeriodId"/></entity-find-one><if condition="glAccountOrgTimePeriod == null"><entity-find-one entity-name="mantle.ledger.account.GlAccountOrganization" value-field="glAccountOrgTemp" for-update="true"><field-map field-name="glAccountId" from="acctgTransEntry.glAccountId"/><field-map field-name="organizationPartyId" from="acctgTrans.organizationPartyId"/></entity-find-one><entity-find-one entity-name="mantle.ledger.account.GlAccountOrgTimePeriod" value-field="glAccountOrgTimePeriod" for-update="true"><field-map field-name="glAccountId" from="acctgTransEntry.glAccountId"/><field-map field-name="organizationPartyId" from="acctgTrans.organizationPartyId"/><field-map field-name="timePeriodId" from="timePeriod.timePeriodId"/></entity-find-one><if condition="glAccountOrgTimePeriod == null"><entity-make-value entity-name="mantle.ledger.account.GlAccountOrgTimePeriod" value-field="glAccountOrgTimePeriod" map="[glAccountId:acctgTransEntry.glAccountId,  organizationPartyId:acctgTrans.organizationPartyId,                                            timePeriodId:timePeriod.timePeriodId, beginningBalance:0.0, postedDebits:0.0, postedCredits:0.0,                                            postedDebitsNoClosing:0.0, postedCreditsNoClosing:0.0, endingBalance:0.0]"/></if></if><set field="dcTransEntryAmount" from="isUnpost ? -acctgTransEntry.amount : acctgTransEntry.amount"/><if condition="acctgTransEntry.debitCreditFlag == 'D'"><then><set field="glAccountOrgTimePeriod.postedDebits" from="(glAccountOrgTimePeriod.postedDebits ?: 0.0) + dcTransEntryAmount"/><if condition="!isPeriodClosing"><set field="glAccountOrgTimePeriod.postedDebitsNoClosing" from="(glAccountOrgTimePeriod.postedDebitsNoClosing ?: 0.0) + dcTransEntryAmount"/></if></then><else><set field="glAccountOrgTimePeriod.postedCredits" from="(glAccountOrgTimePeriod.postedCredits ?: 0.0) + dcTransEntryAmount"/><if condition="!isPeriodClosing"><set field="glAccountOrgTimePeriod.postedCreditsNoClosing" from="(glAccountOrgTimePeriod.postedCreditsNoClosing ?: 0.0) + dcTransEntryAmount"/></if></else></if><set field="glAccountOrgTimePeriod.endingBalance" from="(glAccountOrgTimePeriod.endingBalance ?: 0.0) + postingAmount"/><set field="glAccountOrgTimePeriod.balanceLastUpdated" from="ec.user.nowTimestamp"/><entity-create value-field="glAccountOrgTimePeriod" or-update="true"/><set field="subsequentPeriodList" from="subsequentPeriodListArray.get(timePeriod_index)"/><set field="lastGlAccountOrgTimePeriod" from="glAccountOrgTimePeriod"/><iterate list="subsequentPeriodList" entry="subsequentPeriodId"><entity-find-one entity-name="mantle.ledger.account.GlAccountOrgTimePeriod" value-field="nextGlAccountOrgTimePeriod" for-update="true"><field-map field-name="glAccountId" from="acctgTransEntry.glAccountId"/><field-map field-name="organizationPartyId" from="timePeriod.partyId"/><field-map field-name="timePeriodId" from="subsequentPeriodId"/></entity-find-one><if condition="nextGlAccountOrgTimePeriod == null"><entity-make-value entity-name="mantle.ledger.account.GlAccountOrgTimePeriod" value-field="nextGlAccountOrgTimePeriod" map="[glAccountId:glAccountOrgTimePeriod.glAccountId,  organizationPartyId:timePeriod.partyId,                                             timePeriodId:subsequentPeriodId, beginningBalance:0.0, postedDebits:0.0, postedCredits:0.0,                                             postedDebitsNoClosing:0.0, postedCreditsNoClosing:0.0, endingBalance:0.0]"/></if><set field="nextGlAccountOrgTimePeriod.endingBalance" from="((nextGlAccountOrgTimePeriod.endingBalance ?: 0.0) - (nextGlAccountOrgTimePeriod.beginningBalance ?: 0.0)) +                                     lastGlAccountOrgTimePeriod.endingBalance"/><set field="nextGlAccountOrgTimePeriod.beginningBalance" from="lastGlAccountOrgTimePeriod.endingBalance"/><set field="nextGlAccountOrgTimePeriod.balanceLastUpdated" from="ec.user.nowTimestamp"/><entity-create value-field="nextGlAccountOrgTimePeriod" or-update="true"/><set field="lastGlAccountOrgTimePeriod" from="nextGlAccountOrgTimePeriod"/></iterate></iterate></iterate></actions></service>