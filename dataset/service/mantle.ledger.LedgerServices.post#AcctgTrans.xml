<!--Service Location mantle.ledger.LedgerServices.post#AcctgTrans--><service verb="post" noun="AcctgTrans"><in-parameters><parameter name="acctgTransId" required="true" entity-name="mantle.ledger.transaction.AcctgTrans" field-name="acctgTransId"/><parameter name="verifyOnly" type="Boolean" default="false"/><parameter name="forcePost" type="Boolean" default="false"><description><![CDATA[Post the transaction even if period closed]]></description></parameter></in-parameters><out-parameters/><actions><entity-find-one entity-name="mantle.ledger.transaction.AcctgTrans" value-field="acctgTrans" for-update="true"/><entity-find entity-name="mantle.ledger.transaction.AcctgTransEntry" list="acctgTransEntryList"><econdition field-name="acctgTransId"/><order-by field-name="acctgTransEntrySeqId"/></entity-find><if condition="acctgTrans.isPosted == 'Y'"><return message="Transaction ${acctgTransId} already posted, not posting"/></if><set field="useErrorJournal" from="false"/><if condition="acctgTrans.scheduledPostingDate != null && ec.user.nowTimestamp.before(acctgTrans.scheduledPostingDate)"><message type="danger"><![CDATA[Not posting transaction ${acctgTransId}, before scheduled posting date.]]></message><set field="useErrorJournal" from="true"/></if><service-call name="mantle.ledger.LedgerServices.calculate#AcctgTransTrialBalance" out-map="[debitTotal:context.debitTotal,creditTotal:context.creditTotal,debitCreditDifference:context.debitCreditDifference]" in-map="[acctgTransId:acctgTransId]"/><if condition="debitTotal != creditTotal"><message type="danger"><![CDATA[Not posting transaction ${acctgTransId}, credit total ${creditTotal} and debit total ${debitTotal} not equal.]]></message><set field="useErrorJournal" from="true"/></if><set field="glAccountIdList" from="new LinkedList(new HashSet(acctgTransEntryList*.glAccountId)).sort()"/><set field="glAccountById" from="new LinkedHashMap()"/><iterate list="glAccountIdList" entry="glAccountId"><entity-find-one entity-name="mantle.ledger.account.GlAccount" value-field="glAccount" cache="true"><field-map field-name="glAccountId" from="glAccountId"/></entity-find-one><script><![CDATA[glAccountById.put(glAccountId, glAccount)]]></script><if condition="glAccount.disallowPosting == 'Y'"><message type="danger"><![CDATA[GL Account ${glAccount.glAccountId} does not allow posting]]></message><log message="In AcctgTrans ${acctgTransId} GL Account ${glAccount.glAccountId} does not allow posting"/><set field="useErrorJournal" from="true"/></if></iterate><service-call name="mantle.ledger.LedgerServices.find#PartyAcctgPreference" out-map="[partyAcctgPreference:context.partyAcctgPreference]" in-map="[organizationPartyId:acctgTrans.organizationPartyId]"/><set field="doRealTimeGlSummary" from="partyAcctgPreference?.realTimeGlSummary == 'Y'"/><if condition="useErrorJournal"><if condition="partyAcctgPreference?.errorGlJournalId"><then><service-call name="update#mantle.ledger.transaction.AcctgTrans" in-map="[acctgTransId:acctgTransId, glJournalId:partyAcctgPreference.errorGlJournalId]"/><message type="warning"><![CDATA[Accounting transaction ${acctgTransId} has been saved in Error Journal ${partyAcctgPreference.errorGlJournalId}.]]></message><return/></then><else><return error="true" message="No error journal, returning error instead"/></else></if></if><service-call name="mantle.ledger.LedgerServices.get#OrganizationFiscalTimePeriods" out-map="[timePeriodList:context.timePeriodList]" in-map="[organizationPartyId:acctgTrans.organizationPartyId, filterDate:acctgTrans.transactionDate]"/><if condition="!timePeriodList"><message><![CDATA[Not posting transaction ${acctgTransId}, could not find time period for organization ${acctgTrans.organizationPartyId} at ${ec.l10n.format(acctgTrans.transactionDate, null)}.]]></message><set field="useErrorJournal" from="true"/></if><iterate entry="timePeriod" list="timePeriodList"><if condition="timePeriod.isClosed == 'Y' && !(acctgTrans.acctgTransTypeEnumId in ['AttPeriodClosing', 'AttNetIncomeClosing'])"><if condition="forcePost"><then><if condition="!ec.user.hasPermission('GL_POST_CLOSED')"><message type="danger"><![CDATA[Not posting transaction ${acctgTransId}, time period closed ${ec.resource.expand('TimePeriodNameTemplate','',timePeriod)}.]]></message><message type="danger"><![CDATA[Ignoring force post because user does not have permission.]]></message><set field="useErrorJournal" from="true"/><break/></if></then><else><message type="danger"><![CDATA[Not posting transaction ${acctgTransId}, time period closed ${ec.resource.expand('TimePeriodNameTemplate','',timePeriod)}.]]></message><set field="useErrorJournal" from="true"/><break/></else></if></if></iterate><iterate entry="acctgTransEntry" list="acctgTransEntryList"><if condition="!acctgTransEntry.glAccountId"><message type="warning"><![CDATA[Accounting transaction entry ${acctgTransId}:${acctgTransEntry.acctgTransEntrySeqId} has no glAccountId.]]></message><set field="useErrorJournal" from="true"/></if><if condition="acctgTransEntry.amount == null"><message type="warning"><![CDATA[Accounting transaction entry ${acctgTransId}:${acctgTransEntry.acctgTransEntrySeqId} has no amount.]]></message><set field="useErrorJournal" from="true"/></if></iterate><if condition="verifyOnly"><if condition="useErrorJournal || ec.message.hasError()"><then><message type="danger"><![CDATA[Accounting transaction ${acctgTransId} has issues and may not be posted.]]></message></then><else><message type="success"><![CDATA[Accounting transaction ${acctgTransId} is verified for posting.]]></message></else></if><return/></if><if condition="useErrorJournal || ec.message.hasError()"><service-call name="mantle.ledger.LedgerServices.find#PartyAcctgPreference" out-map="[partyAcctgPreference:context.partyAcctgPreference]" in-map="[organizationPartyId:acctgTrans.organizationPartyId]"/><if condition="partyAcctgPreference?.errorGlJournalId"><then><service-call name="update#mantle.ledger.transaction.AcctgTrans" in-map="[acctgTransId:acctgTransId, glJournalId:partyAcctgPreference.errorGlJournalId]"/><message type="warning"><![CDATA[Accounting transaction ${acctgTransId} has been saved in Error Journal ${partyAcctgPreference.errorGlJournalId}.]]></message><script><![CDATA[ec.message.clearErrors()]]></script><return/></then><else><return/></else></if></if><check-errors/><set field="acctgTrans.isPosted" value="Y"/><set field="acctgTrans.postedDate" from="ec.user.nowTimestamp"/><entity-update value-field="acctgTrans"/><if condition="doRealTimeGlSummary"><service-call name="mantle.ledger.LedgerServices.update#GlAccountOrgSummariesForTx" in-map="[acctgTransId:acctgTransId, timePeriodList:timePeriodList, isUnpost:false]"/></if></actions></service>