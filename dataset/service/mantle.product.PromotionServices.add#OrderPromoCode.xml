<!--Service Location mantle.product.PromotionServices.add#OrderPromoCode--><service verb="add" noun="OrderPromoCode"><in-parameters><parameter name="orderId" required="true" entity-name="mantle.order.OrderPromoCode" field-name="orderId"/><parameter name="promoCode" required="true"/></in-parameters><out-parameters/><actions><set field="openStatusIdList" from="['OrderPlaced', 'OrderProcessing', 'OrderApproved', 'OrderSent', 'OrderCompleted', 'OrderHold']"/><entity-find entity-name="mantle.product.store.ProductStorePromoCode" list="storePromoCodeList"><econdition field-name="promoCode" ignore-case="true"/></entity-find><set field="storePromoCode" from="storePromoCodeList[0]"/><if condition="storePromoCode == null"><entity-find-one entity-name="mantle.product.store.ProductStorePromoCode" value-field="storePromoCode"><field-map field-name="promoCodeId" from="promoCode"/></entity-find-one></if><if condition="storePromoCode == null"><script><![CDATA[ec.message.addPublic("Promotion code ${promoCode} is not valid", "warning")]]></script><return/></if><entity-find-one entity-name="mantle.order.OrderPromoCode" value-field="existingOrderPromoCode"><field-map field-name="orderId"/><field-map field-name="promoCodeId" from="storePromoCode.promoCodeId"/></entity-find-one><if condition="existingOrderPromoCode != null"><script><![CDATA[ec.message.addPublic("Promotion code ${promoCode} is already on this order", "success")]]></script><return/></if><set field="storePromotion" from="storePromoCode.storePromotion"/><if condition="storePromotion == null"><script><![CDATA[ec.message.addPublic("No promotion found for code ${promoCode}", "warning")]]></script><return/></if><if condition="storePromotion.productStoreId"><entity-find-one entity-name="mantle.order.OrderHeader" value-field="orderHeader"/><if condition="orderHeader.productStoreId && storePromotion.productStoreId != orderHeader.productStoreId"><script><![CDATA[ec.message.addPublic("Promotion code ${promoCode} is not valid for this store", "warning")]]></script><return/></if></if><if condition="storePromoCode.fromDate != null && ec.user.nowTimestamp < storePromoCode.fromDate"><script><![CDATA[ec.message.addPublic("Promotion code ${promoCode} is not valid until ${ec.l10n.format(storePromoCode.fromDate, 'dd MMM yyyy h:mm a')}", "warning")]]></script><return/></if><if condition="storePromoCode.thruDate != null && ec.user.nowTimestamp > storePromoCode.thruDate"><script><![CDATA[ec.message.addPublic("Promotion code ${promoCode} expired at ${ec.l10n.format(storePromoCode.thruDate, 'dd MMM yyyy h:mm a')}", "warning")]]></script><return/></if><if condition="storePromotion.fromDate != null && ec.user.nowTimestamp < storePromotion.fromDate"><script><![CDATA[ec.message.addPublic("Promotion for code ${promoCode} is not valid until ${ec.l10n.format(storePromotion.fromDate, 'dd MMM yyyy h:mm a')}", "warning")]]></script><return/></if><if condition="storePromotion.thruDate != null && ec.user.nowTimestamp > storePromotion.thruDate"><script><![CDATA[ec.message.addPublic("Promotion for code ${promoCode} expired at ${ec.l10n.format(storePromotion.thruDate, 'dd MMM yyyy h:mm a')}", "warning")]]></script><return/></if><entity-find entity-name="mantle.order.OrderPart" list="orderPartList"><econdition field-name="orderId"/><order-by field-name="orderPartSeqId"/></entity-find><set field="firstOrderPart" from="orderPartList?.first"/><set field="customerPartyId" from="firstOrderPart?.customerPartyId"/><if condition="storePromoCode.requireParty == 'Y'"><if condition="!customerPartyId"><script><![CDATA[ec.message.addPublic("Promotion code ${promoCode} requires that a customer be set on the order", "warning")]]></script><return/></if><entity-find-one entity-name="mantle.product.store.ProductStorePromoCodeParty" value-field="promoCodeParty"><field-map field-name="promoCodeId" from="storePromoCode.promoCodeId"/><field-map field-name="partyId" from="customerPartyId"/></entity-find-one><if condition="promoCodeParty == null"><script><![CDATA[ec.message.addPublic("Customer not allowed to use promotion code ${promoCode}", "warning")]]></script><return/></if></if><if condition="storePromoCode.useLimitPerCode"><entity-find entity-name="mantle.order.OrderItemAndPartSummary" list="itemSummaryList"><econdition field-name="statusId" operator="in" from="openStatusIdList"/><econdition field-name="promoCodeId" from="storePromoCode.promoCodeId"/><select-field field-name="promoTimesUsed"/></entity-find><set field="promoTimesUsed" from="itemSummaryList?.first?.promoTimesUsed ?: 0.0"/><set field="curUseLimit" from="storePromoCode.useLimitPerCode - promoTimesUsed"/><if condition="curUseLimit <= 0.0"><script><![CDATA[ec.message.addPublic("Promotion code ${promoCode} has already been used the maximum times allowed", "warning")]]></script><return/></if></if><if condition="storePromoCode.useLimitPerCustomer"><if condition="customerPartyId"><then><entity-find entity-name="mantle.order.OrderItemAndPartSummary" list="itemSummaryList"><econdition field-name="statusId" operator="in" from="openStatusIdList"/><econdition field-name="customerPartyId"/><econdition field-name="promoCodeId" from="storePromoCode.promoCodeId"/><select-field field-name="promoTimesUsed"/></entity-find><set field="promoTimesUsed" from="itemSummaryList?.first?.promoTimesUsed ?: 0.0"/><set field="curUseLimit" from="storePromoCode.useLimitPerCustomer - promoTimesUsed"/></then><else><set field="curUseLimit" from="storePromoCode.useLimitPerCustomer"/></else></if><if condition="curUseLimit <= 0.0"><script><![CDATA[ec.message.addPublic("You have used promotion code ${promoCode} as many times as allowed (${storePromoCode.useLimitPerCustomer})", "warning")]]></script><return/></if></if><if condition="storePromotion.useLimitPerPromotion"><entity-find entity-name="mantle.order.OrderItemAndPartSummary" list="itemSummaryList"><econdition field-name="statusId" operator="in" from="openStatusIdList"/><econdition field-name="storePromotionId" from="storePromotion.storePromotionId"/><select-field field-name="promoTimesUsed"/></entity-find><set field="promoTimesUsed" from="itemSummaryList?.first?.promoTimesUsed ?: 0.0"/><set field="curUseLimit" from="storePromotion.useLimitPerPromotion - promoTimesUsed"/><if condition="curUseLimit <= 0.0"><script><![CDATA[ec.message.addPublic("Promotion for code ${promoCode} has already been used the maximum times allowed", "warning")]]></script><return/></if></if><if condition="storePromotion.useLimitPerCustomer"><if condition="customerPartyId"><then><entity-find entity-name="mantle.order.OrderItemAndPartSummary" list="itemSummaryList"><econdition field-name="statusId" operator="in" from="openStatusIdList"/><econdition field-name="customerPartyId"/><econdition field-name="storePromotionId" from="storePromotion.storePromotionId"/><select-field field-name="promoTimesUsed"/></entity-find><set field="promoTimesUsed" from="itemSummaryList?.first?.promoTimesUsed ?: 0.0"/><set field="curUseLimit" from="storePromotion.useLimitPerCustomer - promoTimesUsed"/></then><else><set field="curUseLimit" from="storePromotion.useLimitPerCustomer"/></else></if><if condition="curUseLimit <= 0.0"><script><![CDATA[ec.message.addPublic("You have used the promotion for code ${promoCode} as many times as allowed (${storePromotion.useLimitPerCustomer})", "warning")]]></script><return/></if></if><service-call name="create#mantle.order.OrderPromoCode" in-map="[orderId:orderId, promoCodeId:storePromoCode.promoCodeId]"/><iterate list="orderPartList" entry="orderPart"><service-call name="mantle.order.OrderServices.handle#OrderMajorChange" in-map="[orderId:orderId, orderPartSeqId:orderPart.orderPartSeqId]"/></iterate></actions></service>