<!--Service Location mantle.shipment.ShipmentServices.ensure#ShipmentItemQuantityRemaining--><service verb="ensure" noun="ShipmentItemQuantityRemaining"><in-parameters><parameter name="shipmentId" required="true"/><parameter name="productId" required="true"/><parameter name="newQuantityRemaining" type="BigDecimal" required="true"/></in-parameters><out-parameters/><actions><entity-find-one entity-name="mantle.shipment.ShipmentItem" value-field="shipmentItem"/><if condition="shipmentItem"><then><entity-find-one entity-name="mantle.shipment.ShipmentItemDetail" value-field="shipmentItemDetail"><field-map field-name="shipmentId"/><field-map field-name="productId"/></entity-find-one><set field="quantityRemaining" from="shipmentItem.quantity - (shipmentItemDetail.quantityAcceptedTotal ?: 0) - (shipmentItemDetail.quantityRejectedTotal ?: 0)"/><if condition="quantityRemaining < newQuantityRemaining"><set field="incrementQuantity" from="newQuantityRemaining - quantityRemaining"/><service-call name="mantle.shipment.ShipmentServices.update#ShipmentItem" in-map="[shipmentId:shipmentId, productId:productId,                                 quantity:(shipmentItem.quantity + incrementQuantity)]"/></if></then><else><service-call name="mantle.shipment.ShipmentServices.create#ShipmentItem" in-map="[shipmentId:shipmentId, productId:productId, quantity:newQuantityRemaining]"/></else></if></actions></service>