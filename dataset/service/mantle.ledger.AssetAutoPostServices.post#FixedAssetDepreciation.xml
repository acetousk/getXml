<!--Service Location mantle.ledger.AssetAutoPostServices.post#FixedAssetDepreciation--><service verb="post" noun="FixedAssetDepreciation"><in-parameters><parameter name="assetId" required="true"/><parameter name="timePeriodId" required="true"/><parameter name="transactionDate" type="Timestamp"/><parameter name="annualDepreciation" type="BigDecimal" required="true"><description><![CDATA[Used to update Asset.yearBeginDepreciation and stored on AssetDepreciation history record]]></description></parameter><parameter name="monthlyDepreciation" type="BigDecimal" required="true"><description><![CDATA[Used as the amount on
                TX entries and stored on the AssetDepreciation history record]]></description></parameter><parameter name="isLastYearPeriod" type="Boolean" default="false"/><parameter name="usefulLifeYears" type="Integer"><description><![CDATA[Used only to store on AssetDepreciation history record]]></description></parameter><parameter name="yearsRemaining" type="Integer"><description><![CDATA[Used only to store on AssetDepreciation history record]]></description></parameter></in-parameters><out-parameters><parameter name="acctgTransId"/></out-parameters><actions><entity-find-one entity-name="mantle.product.asset.Asset" value-field="asset" for-update="true"/><set field="organizationPartyId" from="asset.ownerPartyId"/><entity-find-one entity-name="moqui.basic.Enumeration" value-field="assetTypeEnum"><field-map field-name="enumId" from="asset.assetTypeEnumId"/></entity-find-one><if condition="assetTypeEnum.enumId != 'AstTpFixed' && assetTypeEnum.parentEnumId != 'AstTpFixed'"><log level="trace" message="Not posting Depreciation for Asset [${assetId}], is not a fixed asset"/><return/></if><service-call name="mantle.ledger.LedgerServices.find#PartyAcctgPreference" out-map="[partyAcctgPreference:papOut.partyAcctgPreference]" in-map="[organizationPartyId:organizationPartyId]"/><set field="partyAcctgPreference" from="papOut.partyAcctgPreference"/><if condition="!partyAcctgPreference"><log level="info" message="Not posting Depreciation for Asset [${assetId}], could not find PartyAcctgPreference for Owner Party [${organizationPartyId}]"/><return/></if><if condition="!transactionDate"><service-call name="mantle.party.TimeServices.get#TimePeriodInfo" in-map="[timePeriodId:timePeriodId]" out-map="[timePeriod:periodInfo.timePeriod,fromTimestamp:periodInfo.fromTimestamp,thruTimestamp:periodInfo.thruTimestamp,thruTimestampExclusive:periodInfo.thruTimestampExclusive,thruTimestampLate:periodInfo.thruTimestampLate]"/><set field="transactionDate" from="periodInfo.thruTimestampLate"/></if><entity-find-one entity-name="mantle.product.asset.AssetDepreciation" value-field="existingAssetDepreciation"/><if condition="existingAssetDepreciation"><log level="info" message="Not posting Depreciation for Asset [${assetId}], has already been posted (found existing AssetDepreciation record)"/><return/></if><service-call name="mantle.ledger.AssetAutoPostServices.get#AssetTypeGlAccount" out-map="[assetTypeGlAccount:context.assetTypeGlAccount]" in-map="[organizationPartyId:organizationPartyId, assetTypeEnumId:asset.assetTypeEnumId,                         classEnumId:asset.classEnumId, assetId:asset.assetId]"/><set field="accDepreciationGlAccountId" from="assetTypeGlAccount?.accDepreciationGlAccountId"/><if condition="!accDepreciationGlAccountId"><service-call name="mantle.ledger.LedgerServices.get#DefaultGlAccountByType" out-map="[glAccountId:accDepreciationGlAccountOut.glAccountId]" in-map="[glAccountTypeEnumId:'GatFaAccumDepreciation', acctgTransTypeEnumId:acctgTransTypeEnumId,                             organizationPartyId:organizationPartyId, otherPartyId:null]"/><set field="accDepreciationGlAccountId" from="accDepreciationGlAccountOut.glAccountId"/></if><if condition="accDepreciationGlAccountId"><entity-find-one entity-name="mantle.ledger.account.GlAccount" value-field="accDepreciationGlAccount" cache="true"><field-map field-name="glAccountId" from="accDepreciationGlAccountId"/></entity-find-one><set field="accDepreciationGlAccountTypeEnumId" from="accDepreciationGlAccount?.glAccountTypeEnumId"/></if><set field="depreciationGlAccountId" from="assetTypeGlAccount?.depreciationGlAccountId"/><if condition="!depreciationGlAccountId"><service-call name="mantle.ledger.LedgerServices.get#DefaultGlAccountByType" out-map="[glAccountId:depreciationGlAccountOut.glAccountId]" in-map="[glAccountTypeEnumId:'GatFaDepreciation', acctgTransTypeEnumId:acctgTransTypeEnumId,                             organizationPartyId:organizationPartyId, otherPartyId:null]"/><set field="depreciationGlAccountId" from="depreciationGlAccountOut.glAccountId"/></if><if condition="depreciationGlAccountId"><entity-find-one entity-name="mantle.ledger.account.GlAccount" value-field="depreciationGlAccount" cache="true"><field-map field-name="glAccountId" from="depreciationGlAccountId"/></entity-find-one><set field="depreciationGlAccountTypeEnumId" from="depreciationGlAccount?.glAccountTypeEnumId"/></if><set field="amount" from="monthlyDepreciation"/><service-call name="mantle.ledger.LedgerServices.create#AcctgTrans" out-map="[acctgTransId:context.acctgTransId]" in-map="[acctgTransTypeEnumId:'AttDepreciation', organizationPartyId:organizationPartyId,                         otherPartyId:null, amountUomId:asset.acquireCostUomId, assetIssuanceId:assetIssuanceId,                         assetId:asset.assetId, transactionDate:transactionDate]"/><set field="useErrorJournal" from="false"/><if condition="!accDepreciationGlAccountId"><set field="useErrorJournal" from="true"/></if><service-call name="mantle.ledger.LedgerServices.create#AcctgTransEntry" in-map="[acctgTransId:acctgTransId, debitCreditFlag:'C', glAccountTypeEnumId:accDepreciationGlAccountTypeEnumId,                         glAccountId:accDepreciationGlAccountId, amount:amount, productId:asset.productId, assetId:asset.assetId]"/><if condition="!depreciationGlAccountId"><set field="useErrorJournal" from="true"/></if><service-call name="mantle.ledger.LedgerServices.create#AcctgTransEntry" in-map="[acctgTransId:acctgTransId, debitCreditFlag:'D', glAccountTypeEnumId:depreciationGlAccountTypeEnumId,                         glAccountId:depreciationGlAccountId, amount:amount, productId:asset.productId, assetId:asset.assetId]"/><if condition="useErrorJournal"><then><if condition="partyAcctgPreference?.errorGlJournalId"><service-call name="update#mantle.ledger.transaction.AcctgTrans" in-map="[acctgTransId:acctgTransId, glJournalId:partyAcctgPreference.errorGlJournalId]"/></if></then><else><service-call name="mantle.ledger.LedgerServices.post#AcctgTrans" in-map="[acctgTransId:acctgTransId]"/></else></if><set field="asset.depreciation" from="(asset.depreciation ?: 0) + monthlyDepreciation"/><if condition="isLastYearPeriod"><set field="asset.yearBeginDepreciation" from="(asset.yearBeginDepreciation ?: 0) + annualDepreciation"/></if><entity-update value-field="asset"/><service-call name="create#mantle.product.asset.AssetDepreciation" in-map="[assetId:assetId,                     timePeriodId:timePeriodId, monthlyDepreciation:monthlyDepreciation, annualDepreciation:annualDepreciation,                     isLastYearPeriod:(isLastYearPeriod ? 'Y' : 'N'), yearBeginDepreciation:asset.yearBeginDepreciation,                     usefulLifeYears:usefulLifeYears, yearsRemaining:yearsRemaining, acctgTransId:acctgTransId]"/></actions></service>