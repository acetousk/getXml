<!--Service Location mantle.account.PaymentServices.apply#OrderPaymentsToInvoice--><service verb="apply" noun="OrderPaymentsToInvoice"><in-parameters><parameter name="orderId" required="true"/><parameter name="orderPartSeqId" required="true"/><parameter name="invoiceId" required="true"/></in-parameters><out-parameters><parameter name="paymentApplicationIdByPaymentId" type="Map"/></out-parameters><actions><set field="paymentApplicationIdByPaymentId" from="[:]"/><service-call name="mantle.account.InvoiceServices.get#InvoiceTotal" out-map="[invoiceTotal:invTotal.invoiceTotal,appliedPaymentsTotal:invTotal.appliedPaymentsTotal,unpaidTotal:invTotal.unpaidTotal]" in-map="[invoiceId:invoiceId]"/><entity-find entity-name="mantle.account.payment.Payment" list="paymentList"><econdition field-name="orderId"/><econdition field-name="orderPartSeqId" or-null="true"/><econdition field-name="paymentTypeEnumId" value="PtInvoicePayment"/><order-by field-name="paymentId"/></entity-find><set field="remainingAmount" from="invTotal.unpaidTotal"/><iterate list="paymentList" entry="payment"><if condition="remainingAmount == 0.0"><break/></if><service-call name="mantle.account.PaymentServices.get#PaymentTotals" out-map="[paymentTotal:context.paymentTotal,appliedTotal:context.appliedTotal,unappliedTotal:context.unappliedTotal]" in-map="[paymentId:payment.paymentId]"/><if condition="unappliedTotal > 0"><set field="amountToApply" from="unappliedTotal > remainingAmount ? remainingAmount : unappliedTotal"/><if condition="payment.statusId in ['PmntPromised', 'PmntAuthorized']"><service-call name="mantle.account.PaymentServices.capture#SinglePayment" out-map="[paymentGatewayResponseId:captOut.paymentGatewayResponseId,paymentGatewayResponse:captOut.paymentGatewayResponse]" in-map="[paymentId:payment.paymentId, amount:payment.amount]"/></if><if condition="payment.statusId in ['PmntDelivered', 'PmntConfirmed']"><service-call name="mantle.account.PaymentServices.apply#InvoicePayment" out-map="[paymentApplicationId:applyOut.paymentApplicationId,amountApplied:applyOut.amountApplied]" in-map="[paymentId:payment.paymentId, invoiceId:invoiceId, amount:amountToApply]"/><script><![CDATA[paymentApplicationIdByPaymentId.put(payment.paymentId, applyOut.paymentApplicationId)]]></script><set field="remainingAmount" from="remainingAmount - applyOut.amountApplied"/></if></if></iterate></actions></service>