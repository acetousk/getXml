<!--Service Location mantle.product.AssetServices.get#AvailableInventory--><service verb="get" noun="AvailableInventory"><in-parameters><parameter name="productId" required="true"/><parameter name="facilityId"/><parameter name="productStoreId"><description><![CDATA[If specified get facilities and vendor from store, must specify products or categories separately]]></description></parameter><parameter name="vendorPartyId"><description><![CDATA[Defaults to ProductStore.organizationPartyId; used for ownerPartyId filter and AssetPool lookup by Vendor]]></description></parameter><parameter name="customerPartyId"><description><![CDATA[Used for AssetPool lookup by Customer]]></description></parameter></in-parameters><out-parameters><parameter name="availableToPromiseTotal" type="BigDecimal"/></out-parameters><actions><entity-find-one entity-name="mantle.product.Product" value-field="product" cache="true"/><if condition="!(product?.productTypeEnumId in ['PtAsset', 'PtDigitalAsset', 'PtAssetUse', 'PtPickAssembly'])"><log level="warn" message="AssetServices.get#AvailableInventory called for Product ${productId} with type ${product?.productTypeEnumId}, only applicable for PtAsset, PtDigitalAsset, PtAssetUse, PtPickAssembly"/></if><set field="facilityIdSet" from="new HashSet()"/><if condition="facilityId"><script><![CDATA[facilityIdSet.add(facilityId)]]></script></if><if condition="productStoreId"><entity-find-one entity-name="mantle.product.store.ProductStore" value-field="productStore"/><if condition="!vendorPartyId"><set field="vendorPartyId" from="productStore?.organizationPartyId"/></if><if condition="facilityIdSet.size() == 0"><if condition="productStore.inventoryFacilityId"><script><![CDATA[facilityIdSet.add(productStore.inventoryFacilityId)]]></script></if><entity-find entity-name="mantle.product.store.ProductStoreFacility" list="productStoreFacilityList"><date-filter/><econdition field-name="productStoreId"/></entity-find><if condition="productStoreFacilityList"><script><![CDATA[facilityIdSet.addAll(productStoreFacilityList*.facilityId)]]></script></if></if></if><set field="ownerPartyIdSet" from="new HashSet()"/><if condition="vendorPartyId"><script><![CDATA[ownerPartyIdSet.add(vendorPartyId)]]></script><entity-find entity-name="mantle.party.PartyRelationship" list="parentRelList" cache="true"><date-filter/><econdition field-name="relationshipTypeEnumId" value="PrtOrgRollup"/><econdition field-name="fromPartyId" from="vendorPartyId"/><econdition field-name="toPartyId" operator="is-not-null"/></entity-find><script><![CDATA[if (parentRelList) ownerPartyIdSet.addAll(parentRelList*.toPartyId)]]></script></if><service-call name="mantle.product.AssetServices.get#AssetPools" out-map="[assetPoolIdSet:poolsOut.assetPoolIdSet]" in-map="[productStoreId:productStoreId, vendorPartyId:vendorPartyId, customerPartyId:customerPartyId]"/><set field="assetPoolIdSet" from="poolsOut.assetPoolIdSet"/><set field="availableToPromiseTotal" from="0.0"/><iterate list="facilityIdSet" entry="facilityId"><entity-find-one entity-name="mantle.facility.Facility" value-field="facility" cache="true"/><entity-find entity-name="mantle.product.asset.AssetQuantitySummary" list="quantSumList"><econdition field-name="productId"/><econdition field-name="facilityId"/><econdition field-name="ownerPartyId" operator="in" from="ownerPartyIdSet" ignore="facility?.assetAllowOtherOwner == 'Y' || !ownerPartyIdSet"/><econdition field-name="assetPoolId" operator="in" from="assetPoolIdSet" ignore="!assetPoolIdSet" or-null="true"/><econdition field-name="assetPoolId" operator="is-null" ignore="assetPoolIdSet"/><econdition field-name="statusId" value="AstAvailable"/><select-field field-name="availableToPromiseTotal"/></entity-find><if condition="quantSumList.size() > 0 && quantSumList[0].availableToPromiseTotal"><set field="availableToPromiseTotal" from="availableToPromiseTotal + quantSumList[0].availableToPromiseTotal"/></if><if condition="product.productTypeEnumId == 'PtPickAssembly'"><entity-find entity-name="mantle.product.ProductAssoc" list="assocList"><date-filter/><econdition field-name="productId" from="product.productId"/><econdition field-name="productAssocTypeEnumId" value="PatMfgBom"/></entity-find><set field="availableFromComponents" from="0.0"/><iterate list="assocList" entry="assoc"><service-call name="mantle.product.AssetServices.get#AvailableInventory" out-map="[availableToPromiseTotal:compAvailOut.availableToPromiseTotal]" out-map-add-to-existing="false" in-map="[productId:assoc.toProductId, facilityId:facilityId, productStoreId:productStoreId,                                     vendorPartyId:vendorPartyId, customerPartyId:customerPartyId]"/><set field="compScale" from="assoc.quantity != null ? assoc.quantity.scale() : 0"/><set field="componentAvailable" from="(compAvailOut.availableToPromiseTotal ?: 0.0).divide((assoc.quantity ?: 1.0), compScale, BigDecimal.ROUND_FLOOR)"/><if condition="availableFromComponents == 0.0 || availableFromComponents > componentAvailable"><set field="availableFromComponents" from="componentAvailable"/></if></iterate><set field="availableToPromiseTotal" from="availableToPromiseTotal + availableFromComponents"/></if></iterate></actions></service>