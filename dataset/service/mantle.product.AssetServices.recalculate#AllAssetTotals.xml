<!--Service Location mantle.product.AssetServices.recalculate#AllAssetTotals--><service verb="recalculate" noun="AllAssetTotals"><in-parameters><parameter name="facilityId"/><parameter name="productId"/></in-parameters><out-parameters/><actions><entity-find entity-name="mantle.product.asset.Asset" list="assetList"><econdition field-name="hasQuantity" value="Y"/><econdition field-name="facilityId" ignore-if-empty="true"/><econdition field-name="productId" ignore-if-empty="true"/><select-field field-name="assetId,productId,facilityId,availableToPromiseTotal,quantityOnHandTotal"/></entity-find><set field="recordsChecked" from="assetList.size()"/><set field="recordsUpdated" from="0"/><message><![CDATA[Checking ${recordsChecked} Asset record totals for Product ${productId?:'*'} Facility ${facilityId?:'*'}]]></message><iterate list="assetList" entry="asset"><entity-find entity-name="mantle.product.asset.AssetDetailSummary" list="assetDetailSummaryList"><econdition field-name="assetId" from="asset.assetId"/><select-field field-name="availableToPromiseTotal,quantityOnHandTotal"/></entity-find><if condition="assetDetailSummaryList.size() > 0"><then><set field="assetDetailSummary" from="assetDetailSummaryList[0]"/><set field="calcAtp" from="assetDetailSummary.availableToPromiseTotal ?: 0.0"/><set field="calcQoh" from="assetDetailSummary.quantityOnHandTotal ?: 0.0"/><if condition="asset.availableToPromiseTotal != calcAtp || asset.quantityOnHandTotal != calcQoh"><log message="Asset ${asset.assetId} Product ${asset.productId} Facility ${asset.facilityId} has incorrect totals: ATP is ${asset.availableToPromiseTotal}, should be ${calcAtp}; QOH is ${asset.quantityOnHandTotal}, should be ${calcQoh}; updating"/><set field="recordsUpdated" from="recordsUpdated + 1"/><set field="asset.availableToPromiseTotal" from="calcAtp"/><set field="asset.quantityOnHandTotal" from="calcQoh"/><entity-update value-field="asset"/></if></then><else><if condition="asset.availableToPromiseTotal != 0.0 || asset.quantityOnHandTotal != 0.0"><log message="Asset ${asset.assetId} Product ${asset.productId} Facility ${asset.facilityId} has no Detail records and non-zero totals: ATP is ${asset.availableToPromiseTotal}; QOH is ${asset.quantityOnHandTotal}; setting both to zero"/><set field="recordsUpdated" from="recordsUpdated + 1"/><set field="asset.availableToPromiseTotal" from="0.0"/><set field="asset.quantityOnHandTotal" from="0.0"/><entity-update value-field="asset"/></if></else></if></iterate><message><![CDATA[Checking ${recordsChecked} Asset record totals for Product ${productId?:'*'} Facility ${facilityId?:'*'}, updated ${recordsUpdated} with incorrect totals]]></message></actions></service>